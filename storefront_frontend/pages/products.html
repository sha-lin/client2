<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products - Storefront</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/storefront_frontend/css/styles.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="/storefront/">üõçÔ∏è Storefront</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/storefront/products/">Products</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/storefront/quote-builder/">Quote Builder</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/storefront/contact/">Contact</a>
                    </li>
                    <li class="nav-item" id="navbar-auth">
                        <a class="nav-link" href="/storefront/login/">Login</a>
                    </li>
                    <li class="nav-item d-none" id="navbar-profile-item">
                        <a class="nav-link" href="/storefront/dashboard/">Dashboard</a>
                    </li>
                    <li class="nav-item d-none" id="navbar-logout-item">
                        <a class="nav-link" href="#" id="logout-btn">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <section class="py-4 bg-light">
        <div class="container">
            <h1>Our Products</h1>
            <p class="text-muted">Browse our full catalog of high-quality products</p>
        </div>
    </section>

    <!-- Filters & Search -->
    <section class="py-4">
        <div class="container">
            <div class="row mb-4">
                <div class="col-md-3">
                    <input type="text" class="form-control" id="search-input" placeholder="Search products...">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="category-filter">
                        <option value="">All Categories</option>
                        <option value="printing">Printing</option>
                        <option value="packaging">Packaging</option>
                        <option value="design">Design</option>
                        <option value="fulfillment">Fulfillment</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="sort-select">
                        <option value="">Sort By</option>
                        <option value="name_asc">Name (A-Z)</option>
                        <option value="name_desc">Name (Z-A)</option>
                        <option value="price_asc">Price (Low to High)</option>
                        <option value="price_desc">Price (High to Low)</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-secondary w-100" id="reset-filters">Reset Filters</button>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="row" id="products-grid">
                <div class="col-12 text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            <div class="row mt-4">
                <div class="col-12" id="pagination-container"></div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>About Us</h5>
                    <p>We provide high-quality products and exceptional service to our customers worldwide.</p>
                </div>
                <div class="col-md-4">
                    <h5>Quick Links</h5>
                    <ul class="list-unstyled">
                        <li><a href="products.html" class="text-white-50">Products</a></li>
                        <li><a href="contact.html" class="text-white-50">Contact</a></li>
                        <li><a href="#" class="text-white-50">Privacy Policy</a></li>
                        <li><a href="#" class="text-white-50">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>Contact Info</h5>
                    <p class="mb-1"><strong>Email:</strong> support@storefront.com</p>
                    <p class="mb-1"><strong>Phone:</strong> +1 (555) 123-4567</p>
                    <p><strong>Hours:</strong> Mon-Fri 9AM-5PM</p>
                </div>
            </div>
            <hr class="bg-white-50">
            <div class="text-center text-white-50">
                <p>&copy; 2026 Storefront. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Product Detail Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="productModalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="add-to-quote-btn">Add to Quote</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/storefront_frontend/js/utils.js"></script>
    <script src="/static/storefront_frontend/js/api-client.js"></script>
    <script>
        const api = new StorefrontAPIClient();
        let currentPage = 1;
        let allProducts = [];
        let selectedProduct = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateAuthUI();
            loadProducts();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('search-input').addEventListener('input', debounceSearch);
            document.getElementById('category-filter').addEventListener('change', loadProducts);
            document.getElementById('sort-select').addEventListener('change', loadProducts);
            document.getElementById('reset-filters').addEventListener('click', resetFilters);
            document.getElementById('logout-btn')?.addEventListener('click', logout);
            document.getElementById('add-to-quote-btn')?.addEventListener('click', addToQuote);
        }

        const debounceSearch = StorefrontUtils.debounce(loadProducts, 300);

        async function loadProducts() {
            try {
                StorefrontUtils.showLoading('Loading products...');
                
                const params = {
                    search: document.getElementById('search-input').value,
                    category: document.getElementById('category-filter').value,
                    page: currentPage,
                    limit: 12
                };

                const response = await api.getProducts(params);
                allProducts = response.results || response;

                renderProducts();
                StorefrontUtils.hideLoading();
            } catch (error) {
                console.error('Error loading products:', error);
                StorefrontUtils.showToast('Error loading products', 'error');
                StorefrontUtils.hideLoading();
            }
        }

        function renderProducts() {
            const grid = document.getElementById('products-grid');
            
            if (allProducts.length === 0) {
                grid.innerHTML = '<div class="col-12 text-center"><p>No products found</p></div>';
                return;
            }

            grid.innerHTML = allProducts.map(product => `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="product-card">
                        <div class="product-image">
                            <div style="font-size: 3rem;">üì¶</div>
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            <div class="product-category">${product.category}</div>
                            <div class="product-price">${StorefrontUtils.formatCurrency(product.base_price)}</div>
                            ${product.featured ? '<span class="badge bg-success">Featured</span>' : ''}
                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-primary w-100" onclick="viewProductDetails(${product.id})">
                                    View Details
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function viewProductDetails(productId) {
            selectedProduct = allProducts.find(p => p.id === productId);
            if (!selectedProduct) return;

            const modal = document.getElementById('productModal');
            document.getElementById('productModalTitle').textContent = selectedProduct.name;
            
            const body = `
                <div class="product-image mb-3">üì¶</div>
                <p><strong>Category:</strong> ${selectedProduct.category}</p>
                <p><strong>Price:</strong> ${StorefrontUtils.formatCurrency(selectedProduct.base_price)}</p>
                <p><strong>Description:</strong> ${selectedProduct.description || 'No description available'}</p>
                <h6>Pricing Tiers</h6>
                <ul>
                    ${(selectedProduct.pricing_tiers || []).map(tier => `
                        <li>${tier.name}: ${StorefrontUtils.formatCurrency(tier.price)} (min ${tier.min_quantity})</li>
                    `).join('')}
                </ul>
                ${selectedProduct.customization_level ? `
                    <h6>Customization</h6>
                    <p>Level: ${selectedProduct.customization_level}</p>
                ` : ''}
                ${selectedProduct.turnaround_standard_days ? `
                    <h6>Turnaround Times</h6>
                    <ul>
                        <li>Standard: ${selectedProduct.turnaround_standard_days} days</li>
                        ${selectedProduct.turnaround_rush_days ? `<li>Rush: ${selectedProduct.turnaround_rush_days} days (+${StorefrontUtils.formatCurrency(selectedProduct.turnaround_rush_surcharge)} surcharge)</li>` : ''}
                    </ul>
                ` : ''}
            `;
            
            document.getElementById('productModalBody').innerHTML = body;
            new bootstrap.Modal(modal).show();
        }

        function addToQuote() {
            if (!selectedProduct) return;
            
            // Store product in session storage for quote builder
            const quoteItems = JSON.parse(sessionStorage.getItem('quote_items') || '[]');
            quoteItems.push({
                product_id: selectedProduct.id,
                product_name: selectedProduct.name,
                base_price: selectedProduct.base_price,
                quantity: 1
            });
            sessionStorage.setItem('quote_items', JSON.stringify(quoteItems));
            
            StorefrontUtils.showToast(`${selectedProduct.name} added to quote!`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
        }

        function resetFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('category-filter').value = '';
            currentPage = 1;
            loadProducts();
        }

        function updateAuthUI() {
            const authLink = document.getElementById('navbar-auth');
            const profileItem = document.getElementById('navbar-profile-item');
            const logoutItem = document.getElementById('navbar-logout-item');

            if (StorefrontUtils.isAuthenticated()) {
                authLink.classList.add('d-none');
                profileItem.classList.remove('d-none');
                logoutItem.classList.remove('d-none');
            }
        }

        function logout() {
            api.clearTokens();
            StorefrontUtils.clearCurrentUser();
            StorefrontUtils.showToast('Logged out successfully', 'success');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        }
    </script>
</body>
</html>
