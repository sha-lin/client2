

# ===== PRODUCT MANAGEMENT MODELS =====

class ProductCategory(models.Model):
    """Main product categories like Business Cards, Marketing Materials, Signs, etc."""
    name = models.CharField(max_length=200)
    slug = models.SlugField(unique=True)
    description = models.TextField(blank=True)
    icon = models.CharField(max_length=50, blank=True, help_text="FontAwesome icon class")
    display_order = models.IntegerField(default=0)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name_plural = "Product Categories"
        ordering = ['display_order', 'name']
    
    def __str__(self):
        return self.name


class ProductSubCategory(models.Model):
    """Subcategories like Standard Cards, Premium Cards, Flyers, Brochures"""
    category = models.ForeignKey(ProductCategory, on_delete=models.CASCADE, related_name='subcategories')
    name = models.CharField(max_length=200)
    slug = models.SlugField(unique=True)
    description = models.TextField(blank=True)
    display_order = models.IntegerField(default=0)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name_plural = "Product Subcategories"
        ordering = ['display_order', 'name']
        unique_together = ['category', 'slug']
    
    def __str__(self):
        return f"{self.category.name} - {self.name}"


class Product(models.Model):
    """Base product model"""
    PRODUCT_TYPE_CHOICES = [
        ('non_custom', 'Non-Custom'),
        ('semi_custom', 'Semi-Custom'),
        ('custom', 'Fully Custom'),
    ]
    
    AVAILABILITY_CHOICES = [
        ('always', 'Always Available'),
        ('in_stock', 'In Stock'),
        ('low_stock', 'Low Stock'),
        ('out_of_stock', 'Out of Stock'),
        ('lead_time', 'Lead Time Required'),
    ]
    
    # Basic Information
    category = models.ForeignKey(ProductCategory, on_delete=models.CASCADE, related_name='products')
    subcategory = models.ForeignKey(ProductSubCategory, on_delete=models.SET_NULL, null=True, blank=True, related_name='products')
    sku = models.CharField(max_length=100, unique=True)
    name = models.CharField(max_length=300)
    slug = models.SlugField(unique=True)
    description = models.TextField()
    short_description = models.CharField(max_length=500, blank=True)
    
    # Product Type
    product_type = models.CharField(max_length=20, choices=PRODUCT_TYPE_CHOICES, default='non_custom')
    
    # Pricing
    base_price = models.DecimalField(max_digits=10, decimal_places=2, validators=[MinValueValidator(Decimal('0.01'))])
    cost_price = models.DecimalField(max_digits=10, decimal_places=2, default=0, help_text="Cost to produce")
    
    # Inventory
    availability = models.CharField(max_length=20, choices=AVAILABILITY_CHOICES, default='in_stock')
    stock_quantity = models.IntegerField(default=0, validators=[MinValueValidator(0)])
    low_stock_threshold = models.IntegerField(default=10)
    lead_time = models.CharField(max_length=100, blank=True, help_text="e.g., 3-5 business days")
    
    # Images
    primary_image = models.ImageField(upload_to='products/', blank=True, null=True)
    
    # Status
    is_active = models.BooleanField(default=True)
    is_featured = models.BooleanField(default=False)
    display_order = models.IntegerField(default=0)
    
    # Metadata
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        ordering = ['display_order', 'name']
        indexes = [
            models.Index(fields=['category', 'is_active']),
            models.Index(fields=['sku']),
        ]
    
    def __str__(self):
        return f"{self.sku} - {self.name}"


class ProductImage(models.Model):
    """Additional product images"""
    product = models.ForeignKey(Product, on_delete=models.CASCADE, related_name='images')
    image = models.ImageField(upload_to='products/gallery/')
    alt_text = models.CharField(max_length=200, blank=True)
    display_order = models.IntegerField(default=0)
    is_primary = models.BooleanField(default=False)
    
    class Meta:
        ordering = ['display_order']
    
    def __str__(self):
        return f"{self.product.name} - Image {self.display_order}"


class PropertyType(models.Model):
    """Types of properties like Size, Finish, Paper Stock, Corners, etc."""
    PROPERTY_TYPE_CHOICES = [
        ('size', 'Size'),
        ('finish', 'Finish'),
        ('paper_stock', 'Paper Stock'),
        ('thickness', 'Thickness'),
        ('corners', 'Corners'),
        ('shape', 'Shape'),
        ('coating', 'Coating'),
        ('color', 'Color'),
        ('orientation', 'Orientation'),
        ('folding', 'Folding Style'),
        ('quantity', 'Quantity'),
        ('special_finish', 'Special Finish'),
        ('material', 'Material'),
        ('other', 'Other'),
    ]
    
    name = models.CharField(max_length=100)
    property_type = models.CharField(max_length=50, choices=PROPERTY_TYPE_CHOICES)
    description = models.TextField(blank=True)
    is_required = models.BooleanField(default=False, help_text="Is this property required for the product?")
    affects_price = models.BooleanField(default=True)
    display_order = models.IntegerField(default=0)
    
    class Meta:
        ordering = ['display_order', 'name']
        verbose_name_plural = "Property Types"
    
    def __str__(self):
        return f"{self.name} ({self.get_property_type_display()})"


class PropertyValue(models.Model):
    """Specific values for each property type"""
    property_type = models.ForeignKey(PropertyType, on_delete=models.CASCADE, related_name='values')
    value = models.CharField(max_length=200)
    value_code = models.CharField(max_length=50, blank=True, help_text="Short code for internal use")
    description = models.TextField(blank=True)
    display_order = models.IntegerField(default=0)
    is_active = models.BooleanField(default=True)
    
    class Meta:
        ordering = ['property_type', 'display_order', 'value']
        unique_together = ['property_type', 'value']
    
    def __str__(self):
        return f"{self.property_type.name}: {self.value}"


class ProductProperty(models.Model):
    """Links products to their available property values with pricing"""
    product = models.ForeignKey(Product, on_delete=models.CASCADE, related_name='properties')
    property_value = models.ForeignKey(PropertyValue, on_delete=models.CASCADE)
    price_modifier = models.DecimalField(
        max_digits=10, 
        decimal_places=2, 
        default=0,
        help_text="Additional price for this property (+/-)"
    )
    is_default = models.BooleanField(default=False)
    is_available = models.BooleanField(default=True)
    stock_quantity = models.IntegerField(default=0, help_text="Stock specific to this property variant")
    
    class Meta:
        unique_together = ['product', 'property_value']
        verbose_name_plural = "Product Properties"
    
    def __str__(self):
        return f"{self.product.name} - {self.property_value}"
    
    def get_total_price(self):
        """Calculate total price including modifier"""
        return self.product.base_price + self.price_modifier


class QuantityPricing(models.Model):
    """Quantity-based pricing tiers"""
    product = models.ForeignKey(Product, on_delete=models.CASCADE, related_name='quantity_pricing')
    min_quantity = models.IntegerField(validators=[MinValueValidator(1)])
    max_quantity = models.IntegerField(null=True, blank=True, help_text="Leave blank for no upper limit")
    unit_price = models.DecimalField(max_digits=10, decimal_places=2, validators=[MinValueValidator(Decimal('0.01'))])
    percentage_discount = models.DecimalField(
        max_digits=5, 
        decimal_places=2, 
        default=0,
        validators=[MinValueValidator(0)],
        help_text="Discount percentage (0-100)"
    )
    
    class Meta:
        ordering = ['product', 'min_quantity']
        verbose_name_plural = "Quantity Pricing Tiers"
        unique_together = ['product', 'min_quantity']
    
    def __str__(self):
        if self.max_quantity:
            return f"{self.product.name}: {self.min_quantity}-{self.max_quantity} units @ KES {self.unit_price}"
        return f"{self.product.name}: {self.min_quantity}+ units @ KES {self.unit_price}"


class ProductTemplate(models.Model):
    """Design templates available for products"""
    product = models.ForeignKey(Product, on_delete=models.CASCADE, related_name='templates')
    name = models.CharField(max_length=200)
    description = models.TextField(blank=True)
    template_file = models.FileField(upload_to='templates/')
    thumbnail = models.ImageField(upload_to='templates/thumbnails/', blank=True)
    category_tags = models.CharField(max_length=500, blank=True, help_text="Comma-separated tags")
    is_premium = models.BooleanField(default=False)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        ordering = ['-created_at']
    
    def __str__(self):
        return f"{self.product.name} - {self.name}"


class TurnAroundTime(models.Model):
    """Production turnaround times with pricing"""
    product = models.ForeignKey(Product, on_delete=models.CASCADE, related_name='turnaround_times')
    name = models.CharField(max_length=100, help_text="e.g., Standard, 2-Day, Next-Day")
    business_days = models.IntegerField(help_text="Number of business days")
    price_modifier = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    is_default = models.BooleanField(default=False)
    is_available = models.BooleanField(default=True)
    display_order = models.IntegerField(default=0)
    
    class Meta:
        ordering = ['display_order', 'business_days']
        unique_together = ['product', 'name']
    
    def __str__(self):
        return f"{self.product.name} - {self.name} ({self.business_days} days)"
