{% extends 'base.html' %}
{% load static %}

{% block title %}{{ client.name }} - Client Profile{% endblock %}

{% block content %}
<!-- Client Profile Header (New Black & White Design) -->
<div class="bg-white border-b border-gray-200 px-8 py-6">
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
            <div
                class="w-16 h-16 bg-gray-100 text-gray-900 rounded-full flex items-center justify-center text-2xl font-bold border border-gray-200">
                {{ client.name|slice:":1"|upper }}
            </div>
            <div>
                <h1 class="text-3xl font-bold text-gray-900">{{ client.name }}</h1>
                <div class="flex items-center gap-4 mt-2">
                    <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm border border-gray-200">
                        {{ client.get_client_type_display }}
                    </span>
                    <span
                        class="px-3 py-1 {% if client.status == 'Active' %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %} rounded-full text-sm">
                        {{ client.status }}
                    </span>
                    <span class="text-sm text-gray-500">Client ID: {{ client.client_id }}</span>
                </div>
            </div>
        </div>
        <div class="flex gap-3">
            <a href="{% url 'edit_client' client.pk %}"
                class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                Edit Profile
            </a>
            <a href="{% url 'create_quote' %}?client_id={{ client.id }}"
                class="px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 transition-colors">
                Create Quote
            </a>
        </div>
    </div>
</div>

<!-- Tabs Navigation -->
<div class="bg-white border-b border-gray-200">
    <div class="px-8">
        <nav class="flex gap-8">
            <button class="tab-btn active" data-tab="overview">Overview</button>
            <button class="tab-btn" data-tab="quotes">Quotes & Jobs</button>
            <button class="tab-btn" data-tab="financials">Financials</button>
            <button class="tab-btn" data-tab="documents">Documents</button>
            <button class="tab-btn" data-tab="activity">Activity</button>
            <button class="tab-btn" data-tab="contacts">Contacts</button>
        </nav>
    </div>
</div>

<!-- Tab Content -->
<div class="px-8 py-6">
    <!-- Overview Tab -->
    <div id="overview-tab" class="tab-content active">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Contact Information -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">Contact Information</h3>
                <div class="space-y-3">
                    <div>
                        <p class="text-sm text-gray-600">Email</p>
                        <p class="font-medium">{{ client.email }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Phone</p>
                        <p class="font-medium">{{ client.phone }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Company</p>
                        <p class="font-medium">{{ client.company|default:"-" }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Address</p>
                        <p class="font-medium">{{ client.address|default:"-" }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Delivery Address</p>
                        <p class="font-medium">{{ client.delivery_address|default:"-" }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Delivery Instructions</p>
                        <p class="font-medium text-sm whitespace-pre-wrap">{{ client.delivery_instructions|default:"-"
                            }}</p>
                    </div>
                </div>
            </div>

            <!-- Business Metrics (Fixed Variables) -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">Business Metrics</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Total Jobs</span>
                        <span class="text-2xl font-bold text-gray-900">{{ total_jobs }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Total Revenue</span>
                        <span class="text-2xl font-bold text-gray-900">KES {{ total_revenue|floatformat:0 }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Conversion Rate</span>
                        <span class="text-2xl font-bold text-gray-900">{{ conversion_rate }}%</span>
                    </div>
                </div>
            </div>

            <!-- Account Health -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">Account Health</h3>
                <div class="space-y-3">
                    <div>
                        <p class="text-sm text-gray-600">Account Manager</p>
                        <p class="font-medium">{{
                            client.account_manager.get_full_name|default:client.account_manager.username }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Last Activity</p>
                        <p class="font-medium">{{ client.last_activity_date|date:"M d, Y" }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Payment Terms</p>
                        <p class="font-medium">{{ client.payment_terms|default:"Net 30" }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activities -->
        <div class="mt-6 bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-4">Recent Activities</h3>
            <div class="space-y-3">
                {% for activity in recent_activities %}
                <div class="flex items-start gap-3 pb-3 border-b border-gray-100">
                    <div class="w-2 h-2 bg-blue-500 rounded-full mt-2"></div>
                    <div class="flex-1">
                        <p class="font-medium">{{ activity.title }}</p>
                        <p class="text-sm text-gray-600">{{ activity.description }}</p>
                        <p class="text-xs text-gray-500 mt-1">{{ activity.created_at|timesince }} ago</p>
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-500 text-center py-4">No recent activities</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Quotes & Jobs Tab -->
    <div id="quotes-tab" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold">Quotes History</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quote ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for quote in client_quotes %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 text-sm font-medium">{{ quote.quote_id }}</td>
                            <td class="px-6 py-4 text-sm">{{ quote.product_name }}</td>
                            <td class="px-6 py-4 text-sm font-semibold">KES {{ quote.total_amount|floatformat:0 }}</td>
                            <td class="px-6 py-4">
                                <span class="px-2 py-1 text-xs rounded-full 
                                    {% if quote.status == 'Approved' %}bg-green-100 text-green-700
                                    {% elif quote.status == 'Lost' %}bg-red-100 text-red-700
                                    {% elif quote.status == 'Quoted' %}bg-blue-100 text-blue-700
                                    {% else %}bg-gray-100 text-gray-700{% endif %}">
                                    {{ quote.status }}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-600">{{ quote.created_at|date:"M d, Y" }}</td>
                            <td class="px-6 py-4">
                                <a href="{% url 'quote_detail' quote.quote_id %}"
                                    class="text-blue-600 hover:text-blue-800 text-sm font-medium">View</a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="px-6 py-8 text-center text-gray-500">No quotes found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Financials Tab (Fixed Variable) -->
    <div id="financials-tab" class="tab-content hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">Payment Overview</h3>
                <div class="space-y-4">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Total Invoiced</span>
                        <span class="font-bold">KES {{ total_revenue|floatformat:0 }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Outstanding</span>
                        <span class="font-bold text-orange-600">KES 0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Credit Limit</span>
                        <span class="font-bold">{{ client.credit_limit|default:"Not Set" }}</span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">Payment Terms</h3>
                <p class="text-gray-700">{{ client.payment_terms|default:"Net 30 Days" }}</p>
            </div>
        </div>
    </div>

    <!-- Documents Tab -->
    <div id="documents-tab" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-4">Compliance Documents</h3>
            {% if compliance_documents %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for doc in compliance_documents %}
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-medium">{{ doc.get_document_type_display }}</p>
                            <p class="text-sm text-gray-600">Uploaded: {{ doc.uploaded_at|date:"M d, Y" }}</p>
                        </div>
                        <a href="{{ doc.document.url }}" class="text-blue-600 hover:text-blue-800">Download</a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-8">No documents uploaded</p>
            {% endif %}
        </div>
    </div>

    <!-- Activity Tab -->
    <div id="activity-tab" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-4">Activity Timeline</h3>
            <div class="space-y-4">
                {% for activity in all_activities %}
                <div class="flex gap-4 border-l-2 border-blue-500 pl-4 pb-4">
                    <div>
                        <p class="font-medium">{{ activity.title }}</p>
                        <p class="text-sm text-gray-600">{{ activity.description }}</p>
                        <p class="text-xs text-gray-500 mt-1">{{ activity.created_at|date:"M d, Y H:i" }}</p>
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-500 text-center py-8">No activity recorded</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Contacts Tab -->
    <div id="contacts-tab" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Client Contacts</h3>
                <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Contact</button>
            </div>
            <div class="space-y-4">
                {% for contact in client_contacts %}
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-medium">{{ contact.full_name }}</p>
                            <p class="text-sm text-gray-600">{{ contact.job_title }}</p>
                            <div class="mt-2 space-y-1">
                                <p class="text-sm"><span class="text-gray-600">Email:</span> {{ contact.email }}</p>
                                <p class="text-sm"><span class="text-gray-600">Phone:</span> {{ contact.phone }}</p>
                            </div>
                        </div>
                        {% if contact.is_primary %}
                        <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">Primary</span>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-500 text-center py-8">No contacts added</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
    .tab-btn {
        padding: 16px 0;
        border-bottom: 3px solid transparent;
        font-weight: 500;
        color: #6B7280;
        transition: all 0.3s;
    }

    .tab-btn:hover {
        color: #111827;
    }

    .tab-btn.active {
        border-bottom-color: #000000;
        color: #000000;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }
</style>

<script>
    // Tab switching functionality
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // Remove active class from all buttons and contents
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // Add active class to clicked button and corresponding content
            btn.classList.add('active');
            document.getElementById(btn.dataset.tab + '-tab').classList.add('active');
        });
    });
</script>
{% endblock %}