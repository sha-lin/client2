{% extends 'base.html' %}

{% block title %}Client Profile - {{ client.name }} - Client MIS{% endblock %}

{% block content %}
<style>
    .timeline {
    position: relative;
    padding-left: 2rem;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 0.5rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e5e7eb;
}

.timeline-item {
    position: relative;
    margin-bottom: 1.5rem;
}

.timeline-dot {
    position: absolute;
    left: -1.55rem;
    width: 0.75rem;
    height: 0.75rem;
    border-radius: 50%;
    background: #3b82f6;
    border: 2px solid white;
    box-shadow: 0 0 0 2px #e5e7eb;
    z-index: 1;
}

.timeline-dot.success {
    background: #10b981;
}

.timeline-dot.warning {
    background: #f59e0b;
}

.timeline-dot.danger {
    background: #ef4444;
}

/* Activity Item Hover Effect */
.activity-item:hover .timeline-dot {
    transform: scale(1.3);
    transition: transform 0.2s ease;
}
/* Profile Tabs */
.profile-tabs {
    display: flex;
    gap: 0.5rem;
    border-bottom: 2px solid #e5e7eb;
    margin-bottom: 1.5rem;
}

.profile-tab {
    padding: 0.75rem 1.5rem;
    font-size: 0.95rem;
    font-weight: 500;
    color: #6b7280;
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-bottom: -2px;
}

.profile-tab:hover {
    color: #111827;
}

.profile-tab.active {
    color: #1d4ed8;
    border-bottom-color: #1d4ed8;
    font-weight: 600;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* Stats Cards */
.stat-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 1.25rem;
}

.stat-label {
    font-size: 0.875rem;
    color: #6b7280;
    margin-bottom: 0.5rem;
}

.stat-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: #111827;
}

.stat-change {
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

.stat-change.positive {
    color: #10b981;
}

.stat-change.negative {
    color: #ef4444;
}

/* Timeline */
.timeline {
    position: relative;
    padding-left: 2rem;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 0.5rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e5e7eb;
}

.timeline-item {
    position: relative;
    margin-bottom: 1.5rem;
}

.timeline-dot {
    position: absolute;
    left: -1.55rem;
    width: 0.75rem;
    height: 0.75rem;
    border-radius: 50%;
    background: #3b82f6;
    border: 2px solid white;
    box-shadow: 0 0 0 2px #e5e7eb;
}

.timeline-dot.success {
    background: #10b981;
}

.timeline-dot.warning {
    background: #f59e0b;
}

.timeline-dot.danger {
    background: #ef4444;
}

/* Quote Cards */
.quote-card {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 1rem;
    transition: all 0.2s ease;
}

.quote-card:hover {
    border-color: #3b82f6;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.quote-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
}

.quote-status-badge.draft {
    background: #f3f4f6;
    color: #6b7280;
}

.quote-status-badge.quoted {
    background: #dbeafe;
    color: #1d4ed8;
}

.quote-status-badge.approved {
    background: #d1fae5;
    color: #065f46;
}

.quote-status-badge.lost {
    background: #fee2e2;
    color: #991b1b;
}

/* Info Grid */
.info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
}

.info-item label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #6b7280;
    display: block;
    margin-bottom: 0.25rem;
}

.info-item .value {
    font-size: 1rem;
    color: #111827;
}

/* Product Table */
.product-mini-card {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    margin-bottom: 0.5rem;
}

.product-icon {
    width: 2.5rem;
    height: 2.5rem;
    background: #f3f4f6;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Progress Bar */
.progress-bar-container {
    width: 100%;
    height: 0.5rem;
    background: #e5e7eb;
    border-radius: 9999px;
    overflow: hidden;
}

.progress-bar-fill {
    height: 100%;
    background: #3b82f6;
    transition: width 0.3s ease;
}
</style>

<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-start justify-between">
        <div class="flex items-start gap-4">
            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center">
                <svg class="w-8 h-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            </div>
            <div>
                <div class="flex items-center gap-3">
                    <h1 class="text-2xl font-semibold text-gray-900">{{ client.name|default:"Acme Corporation" }}</h1>
                    <span class="badge badge-success">Active</span>
                    <span class="badge badge-secondary">B2B</span>
                </div>
                <p class="text-gray-600 mt-1">Client ID: <span class="font-mono">{{ client.client_id|default:"CL-2024-001" }}</span></p>
                <p class="text-gray-600">Account Manager: <span class="font-medium">John Doe</span></p>
            </div>
        </div>
        <div class="flex gap-2">
            <button class="btn btn-secondary">
                <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Edit Profile
            </button>
            <button class="btn btn-primary">
                <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                New Quote
            </button>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-4 gap-4">
        
        <div class="stat-card">
            <div class="stat-label">Total Quotes</div>
            <div class="stat-value">24</div>
            <div class="stat-change positive">
                <svg class="w-4 h-4 inline" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                    <polyline points="17 6 23 6 23 12"></polyline>
                </svg>
                +12% from last month
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Conversion Rate</div>
            <div class="stat-value">68%</div>
            <div class="stat-change positive">
                <svg class="w-4 h-4 inline" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                    <polyline points="17 6 23 6 23 12"></polyline>
                </svg>
                +5% from last month
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Revenue</div>
            <div class="stat-value">KES 2.4M</div>
            <div class="stat-change positive">
                <svg class="w-4 h-4 inline" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                    <polyline points="17 6 23 6 23 12"></polyline>
                </svg>
                +18% from last month
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Avg. Margin</div>
            <div class="stat-value">32%</div>
            <div class="stat-change negative">
                <svg class="w-4 h-4 inline" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
                    <polyline points="17 18 23 18 23 12"></polyline>
                </svg>
                -3% from last month
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="card">
        <div class="px-6 pt-4">
            <div class="profile-tabs">
                <button class="profile-tab active" onclick="switchTab('overview')">Overview</button>
                <button class="profile-tab" onclick="switchTab('quotes')">Quotes & Pricing</button>
                <button class="profile-tab" onclick="switchTab('products')">Products & Orders</button>
                <button class="profile-tab" onclick="switchTab('financial')">Financial</button>
                <button class="profile-tab" onclick="switchTab('documents')">Documents</button>
                <button class="profile-tab" onclick="switchTab('activity')">Activity Log</button>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="p-6">
            <!-- Overview Tab -->
            <div id="tab-overview" class="tab-content active">
                <div class="grid grid-cols-3 gap-6">
                    <!-- Left Column: Client Info -->
                    <div class="col-span-2 space-y-6">
                        <!-- Contact Information -->
                        <div>
                            <h3 class="text-lg font-semibold mb-4">Contact Information</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>Primary Email</label>
                                    <div class="value">{{ client.email|default:"contact@acme.com" }}</div>
                                </div>
                                <div class="info-item">
                                    <label>Phone Number</label>
                                    <div class="value">{{ client.phone|default:"+254 712 345 678" }}</div>
                                </div>
                                <div class="info-item">
                                    <label>Company</label>
                                    <div class="value">{{ client.company|default:"Acme Corporation Ltd" }}</div>
                                </div>
                                <div class="info-item">
                                    <label>Industry</label>
                                    <div class="value">Technology</div>
                                </div>
                                <div class="info-item">
                                    <label>Address</label>
                                    <div class="value">123 Business Park, Nairobi</div>
                                </div>
                                <div class="info-item">
                                    <label>Preferred Channel</label>
                                    <div class="value">Email</div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Quotes -->
                        <div>
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold">Recent Quotes</h3>
                                <button class="text-blue-600 text-sm font-medium hover:text-blue-700">View All →</button>
                            </div>
                            <div class="space-y-3">
                                <div class="quote-card">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-2">
                                                <span class="font-semibold">QT-2024-045</span>
                                                <span class="quote-status-badge quoted">Quoted</span>
                                            </div>
                                            <p class="text-sm text-gray-600 mb-2">Business Cards - Premium Finish</p>
                                            <div class="flex items-center gap-4 text-sm text-gray-600">
                                                <span>Qty: 5,000</span>
                                                <span>•</span>
                                                <span>Due: Jan 30, 2024</span>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-gray-900">KES 125,000</div>
                                            <div class="text-sm text-gray-600">Margin: 35%</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="quote-card">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-2">
                                                <span class="font-semibold">QT-2024-038</span>
                                                <span class="quote-status-badge approved">Approved</span>
                                            </div>
                                            <p class="text-sm text-gray-600 mb-2">Company Brochures - A4 Tri-fold</p>
                                            <div class="flex items-center gap-4 text-sm text-gray-600">
                                                <span>Qty: 1,000</span>
                                                <span>•</span>
                                                <span>Approved: Jan 15, 2024</span>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-gray-900">KES 85,000</div>
                                            <div class="text-sm text-green-600">In Production</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="quote-card">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-2">
                                                <span class="font-semibold">QT-2024-021</span>
                                                <span class="quote-status-badge lost">Lost</span>
                                            </div>
                                            <p class="text-sm text-gray-600 mb-2">Promotional Banners</p>
                                            <div class="flex items-center gap-4 text-sm text-gray-600">
                                                <span>Reason: Price too high</span>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-gray-400">KES 65,000</div>
                                            <div class="text-sm text-gray-600">Jan 5, 2024</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Quick Actions & Stats -->
                    <div class="space-y-6">
                        <!-- Account Health -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-semibold mb-3">Account Health</h4>
                            <div class="space-y-3">
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>Credit Utilization</span>
                                        <span class="font-medium">45%</span>
                                    </div>
                                    <div class="progress-bar-container">
                                        <div class="progress-bar-fill" style="width: 45%; background: #10b981;"></div>
                                    </div>
                                </div>
                                <div class="text-sm space-y-1">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Credit Limit:</span>
                                        <span class="font-medium">KES 500,000</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Used:</span>
                                        <span class="font-medium">KES 225,000</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Available:</span>
                                        <span class="font-medium text-green-600">KES 275,000</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Terms -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-semibold mb-3">Payment Terms</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Terms:</span>
                                    <span class="font-medium">Net 30</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Risk Rating:</span>
                                    <span class="badge badge-success">Low</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">VAT Number:</span>
                                    <span class="font-mono text-xs">P051234567X</span>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-semibold mb-3">Quick Actions</h4>
                            <div class="space-y-2">
                                <button class="w-full btn btn-secondary text-sm justify-start">
                                    <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                    </svg>
                                    Generate Quote
                                </button>
                                <button class="w-full btn btn-secondary text-sm justify-start">
                                    <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="16" y1="2" x2="16" y2="6"></line>
                                        <line x1="8" y1="2" x2="8" y2="6"></line>
                                        <line x1="3" y1="10" x2="21" y2="10"></line>
                                    </svg>
                                    Schedule Meeting
                                </button>
                                <button class="w-full btn btn-secondary text-sm justify-start">
                                    <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                        <polyline points="22,6 12,13 2,6"></polyline>
                                    </svg>
                                    Send Email
                                </button>
                            </div>
                        </div>

                        <!-- Key Contacts -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-semibold mb-3">Key Contacts</h4>
                            <div class="space-y-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                        <span class="text-blue-600 font-semibold text-sm">JD</span>
                                    </div>
                                    <div class="flex-1">
                                        <div class="font-medium text-sm">Jane Doe</div>
                                        <div class="text-xs text-gray-600">Marketing Director</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                        <span class="text-green-600 font-semibold text-sm">RS</span>
                                    </div>
                                    <div class="flex-1">
                                        <div class="font-medium text-sm">Robert Smith</div>
                                        <div class="text-xs text-gray-600">Procurement Officer</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quotes & Pricing Tab -->
            <!-- Quotes & Pricing Tab - Updated to show real data -->
<div id="tab-quotes" class="tab-content">
    <div class="space-y-6">
        <!-- Quote Pipeline -->
        <div>
            <h3 class="text-lg font-semibold mb-4">Quote Pipeline</h3>
            <div class="grid grid-cols-5 gap-4">
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="text-sm text-gray-600 mb-2">Draft</div>
                    <div class="text-2xl font-bold">{{ quote_stats.draft.count }}</div>
                    <div class="text-sm text-gray-600 mt-1">KES {{ quote_stats.draft.value|floatformat:0|default:"0" }}</div>
                </div>
                <div class="border border-blue-200 bg-blue-50 rounded-lg p-4">
                    <div class="text-sm text-blue-600 mb-2">Quoted</div>
                    <div class="text-2xl font-bold text-blue-600">{{ quote_stats.quoted.count }}</div>
                    <div class="text-sm text-blue-600 mt-1">KES {{ quote_stats.quoted.value|floatformat:0|default:"0" }}</div>
                </div>
                <div class="border border-yellow-200 bg-yellow-50 rounded-lg p-4">
                    <div class="text-sm text-yellow-600 mb-2">Client Review</div>
                    <div class="text-2xl font-bold text-yellow-600">{{ quote_stats.client_review.count }}</div>
                    <div class="text-sm text-yellow-600 mt-1">KES {{ quote_stats.client_review.value|floatformat:0|default:"0" }}</div>
                </div>
                <div class="border border-green-200 bg-green-50 rounded-lg p-4">
                    <div class="text-sm text-green-600 mb-2">Approved</div>
                    <div class="text-2xl font-bold text-green-600">{{ quote_stats.approved.count }}</div>
                    <div class="text-sm text-green-600 mt-1">KES {{ quote_stats.approved.value|floatformat:0|default:"0" }}</div>
                </div>
                <div class="border border-red-200 bg-red-50 rounded-lg p-4">
                    <div class="text-sm text-red-600 mb-2">Lost</div>
                    <div class="text-2xl font-bold text-red-600">{{ quote_stats.lost.count }}</div>
                    <div class="text-sm text-red-600 mt-1">KES {{ quote_stats.lost.value|floatformat:0|default:"0" }}</div>
                </div>
            </div>
        </div>

        <!-- Detailed Quote List -->
        <div>
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">All Quotes</h3>
                <div class="flex gap-2">
                    <select class="form-select text-sm" id="quoteStatusFilter">
                        <option value="all">All Status</option>
                        <option value="Draft">Draft</option>
                        <option value="Quoted">Quoted</option>
                        <option value="Client Review">Client Review</option>
                        <option value="Approved">Approved</option>
                        <option value="Lost">Lost</option>
                    </select>
                    <a href="{% url 'create_quote' %}?client={{ client.id }}" class="btn btn-primary text-sm">
                        <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        New Quote
                    </a>
                </div>
            </div>

            {% if quotes %}
            <div class="border border-gray-200 rounded-lg overflow-hidden">
                <table>
                    <thead class="bg-gray-50">
                        <tr>
                            <th>Quote ID</th>
                            <th>Product/Service</th>
                            <th>Items</th>
                            <th>Quote Value</th>
                            <th>Margin %</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Valid Until</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="quotesTableBody">
                        {% for quote_group in quotes %}
                        <tr class="quote-row" data-status="{{ quote_group.quote.status }}">
                            <td><span class="font-mono text-sm">{{ quote_group.quote.quote_id }}</span></td>
                            <td>
                                {% if quote_group.items|length == 1 %}
                                    {{ quote_group.items.0.product_name }}
                                {% else %}
                                    {{ quote_group.items.0.product_name|truncatewords:3 }}
                                    <span class="text-xs text-gray-500">(+{{ quote_group.items|length|add:"-1" }} more)</span>
                                {% endif %}
                            </td>
                            <td>{{ quote_group.items|length }}</td>
                            <td class="font-semibold">KES {{ quote_group.total_amount|floatformat:0 }}</td>
                            <td>
                                {% with first_item=quote_group.items.0 %}
                                    <span class="{% if first_item.margin_percentage >= 30 %}text-green-600{% elif first_item.margin_percentage >= 20 %}text-yellow-600{% else %}text-red-600{% endif %} font-medium">
                                        {{ first_item.margin_percentage }}%
                                    </span>
                                {% endwith %}
                            </td>
                            <td>
                                {% if quote_group.quote.status == 'Draft' %}
                                    <span class="quote-status-badge draft">Draft</span>
                                {% elif quote_group.quote.status == 'Quoted' %}
                                    <span class="quote-status-badge quoted">Quoted</span>
                                {% elif quote_group.quote.status == 'Client Review' %}
                                    <span class="quote-status-badge quoted">Client Review</span>
                                {% elif quote_group.quote.status == 'Approved' %}
                                    <span class="quote-status-badge approved">Approved</span>
                                {% elif quote_group.quote.status == 'Lost' %}
                                    <span class="quote-status-badge lost">Lost</span>
                                {% endif %}
                            </td>
                            <td class="text-sm text-gray-600">{{ quote_group.quote.quote_date|date:"M d, Y" }}</td>
                            <td class="text-sm text-gray-600">
                                {{ quote_group.quote.valid_until|date:"M d, Y" }}
                                {% if quote_group.quote.is_expired %}
                                    <span class="text-xs text-red-600">(Expired)</span>
                                {% elif quote_group.quote.days_until_expiry <= 7 %}
                                    <span class="text-xs text-orange-600">({{ quote_group.quote.days_until_expiry }}d left)</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="flex gap-1">
                                    <a href="{% url 'quote_detail' quote_group.quote.quote_id %}" 
                                       class="btn btn-secondary text-sm py-1 px-2">View</a>
                                    <button onclick="updateQuoteStatus('{{ quote_group.quote.quote_id }}')" 
                                            class="btn btn-secondary text-sm py-1 px-2">Update</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="border border-gray-200 rounded-lg p-8 text-center">
                <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p class="text-gray-600 mb-4">No quotes yet for this client</p>
                <a href="{% url 'create_quote' %}?client={{ client.id }}" class="btn btn-primary">
                    Create First Quote
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Pricing History -->
        <div>
            <h3 class="text-lg font-semibold mb-4">Pricing History & Trends</h3>
            <div class="border border-gray-200 rounded-lg p-6">
                <div class="grid grid-cols-3 gap-6 mb-6">
                    <div>
                        <div class="text-sm text-gray-600 mb-1">Average Margin</div>
                        <div class="text-2xl font-bold">{{ avg_margin }}%</div>
                        <div class="text-sm {% if avg_margin >= 30 %}text-green-600{% else %}text-red-600{% endif %} mt-1">
                            {% if avg_margin >= 30 %}
                                <svg class="w-4 h-4 inline" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                                </svg>
                                Above target
                            {% else %}
                                <svg class="w-4 h-4 inline" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
                                </svg>
                                Below target (30%)
                            {% endif %}
                        </div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600 mb-1">Average Deal Size</div>
                        <div class="text-2xl font-bold">
                            {% if total_quotes > 0 %}
                                KES {% widthratio total_revenue 1 total_quotes|floatformat:0 %}
                            {% else %}
                                KES 0
                            {% endif %}
                        </div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600 mb-1">Conversion Rate</div>
                        <div class="text-2xl font-bold">{{ conversion_rate }}%</div>
                        <div class="text-sm {% if conversion_rate >= 60 %}text-green-600{% else %}text-orange-600{% endif %} mt-1">
                            {% if conversion_rate >= 60 %}
                                Good performance
                            {% else %}
                                Needs improvement
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Update Quote Status Modal -->
<div id="updateQuoteModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Update Quote Status</h3>
            <form id="updateQuoteForm">
                <input type="hidden" id="updateQuoteId" name="quote_id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">New Status</label>
                    <select id="newQuoteStatus" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                        <option value="Draft">Draft</option>
                        <option value="Quoted">Quoted</option>
                        <option value="Client Review">Client Review</option>
                        <option value="Approved">Approved</option>
                        <option value="Lost">Lost</option>
                    </select>
                </div>
                <div id="lossReasonDiv" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Loss</label>
                    <textarea id="lossReason" class="w-full border border-gray-300 rounded-lg px-3 py-2" rows="3"></textarea>
                </div>
                <div class="flex gap-2 justify-end">
                    <button type="button" onclick="closeUpdateModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Update Status
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Quote status filter
document.getElementById('quoteStatusFilter')?.addEventListener('change', function() {
    const filterValue = this.value;
    const rows = document.querySelectorAll('.quote-row');
    
    rows.forEach(row => {
        if (filterValue === 'all' || row.dataset.status === filterValue) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Update quote status functions
function updateQuoteStatus(quoteId) {
    document.getElementById('updateQuoteId').value = quoteId;
    document.getElementById('updateQuoteModal').classList.remove('hidden');
}

function closeUpdateModal() {
    document.getElementById('updateQuoteModal').classList.add('hidden');
    document.getElementById('updateQuoteForm').reset();
    document.getElementById('lossReasonDiv').classList.add('hidden');
}

// Show/hide loss reason
document.getElementById('newQuoteStatus')?.addEventListener('change', function() {
    const lossReasonDiv = document.getElementById('lossReasonDiv');
    if (this.value === 'Lost') {
        lossReasonDiv.classList.remove('hidden');
    } else {
        lossReasonDiv.classList.add('hidden');
    }
});

// Submit status update
document.getElementById('updateQuoteForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const quoteId = document.getElementById('updateQuoteId').value;
    const status = document.getElementById('newQuoteStatus').value;
    const lossReason = document.getElementById('lossReason').value;
    
    try {
        const response = await fetch(`/quotes/${quoteId}/update-status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                status: status,
                loss_reason: lossReason
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Quote status updated successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error updating quote status: ' + error);
    }
});
</script>

            <!-- Products & Orders Section -->
<div id="tab-products" class="tab-content">
    <div class="space-y-6">
        <!-- Header with Action Button -->
        <div class="flex justify-between items-center">
            <div>
                <h3 class="text-lg font-semibold text-gray-800">Production Jobs</h3>
                <p class="text-sm text-gray-600 mt-1">All jobs and orders for {{ client.name }}</p>
            </div>
            <a href="{% url 'create_job' %}?client={{ client.id }}" class="btn btn-primary">
                <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Create New Job
            </a>
        </div>

        {% if jobs %}
            <!-- Jobs Statistics -->
            <div class="grid grid-cols-4 gap-4">
                <div class="stat-card">
                    <div class="stat-label">Total Jobs</div>
                    <div class="stat-value">{{ jobs|length }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">In Progress</div>
                    <div class="stat-value text-yellow-600">
                        {{ jobs|length }}
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Completed</div>
                    <div class="stat-value text-green-600">
                        0
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">On Hold</div>
                    <div class="stat-value text-orange-600">
                        0
                    </div>
                </div>
            </div>

            <!-- Jobs Table -->
            <div class="border border-gray-200 rounded-lg overflow-hidden">
                <table>
                    <thead class="bg-gray-50">
                        <tr>
                            <th>Job Number</th>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Person In Charge</th>
                            <th>Status</th>
                            <th>Start Date</th>
                            <th>Expected Completion</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in jobs %}
                        <tr>
                            <td>
                                <span class="font-mono text-sm font-semibold">{{ job.job_number }}</span>
                            </td>
                            <td>
                                <div class="font-medium">{{ job.product }}</div>
                            </td>
                            <td>{{ job.quantity }}</td>
                            <td>{{ job.person_in_charge }}</td>
                            <td>
                                {% if job.status == 'completed' %}
                                    <span class="quote-status-badge approved">Completed</span>
                                {% elif job.status == 'in_progress' %}
                                    <span class="quote-status-badge quoted">In Progress</span>
                                {% elif job.status == 'on_hold' %}
                                    <span class="quote-status-badge lost">On Hold</span>
                                {% else %}
                                    <span class="quote-status-badge draft">Pending</span>
                                {% endif %}
                            </td>
                            <td class="text-sm text-gray-600">{{ job.start_date|date:"M d, Y" }}</td>
                            <td class="text-sm text-gray-600">{{ job.expected_completion|date:"M d, Y" }}</td>
                            <td>
                                <button class="btn btn-secondary text-sm py-1 px-2">View Details</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Recent Activity for Jobs -->
            <div>
                <h4 class="text-lg font-semibold mb-4">Recent Job Activity</h4>
                <div class="timeline">
                    {% for job in jobs|slice:":5" %}
                    <div class="timeline-item">
                        <div class="timeline-dot {% if job.status == 'completed' %}success{% elif job.status == 'in_progress' %}{% else %}warning{% endif %}"></div>
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-start justify-between mb-2">
                                <div class="font-semibold">Job {{ job.job_number }} - {{ job.product }}</div>
                                <span class="text-sm text-gray-600">{{ job.created_at|timesince }} ago</span>
                            </div>
                            <p class="text-sm text-gray-600">
                                Quantity: {{ job.quantity }} | Person in Charge: {{ job.person_in_charge }}
                            </p>
                            <div class="flex items-center gap-2 mt-2">
                                {% if job.status == 'completed' %}
                                    <span class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded">Completed</span>
                                {% elif job.status == 'in_progress' %}
                                    <span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded">In Progress</span>
                                {% elif job.status == 'on_hold' %}
                                    <span class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded">On Hold</span>
                                {% else %}
                                    <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">Pending</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>


            <!-- Financial Tab -->
            <!-- Financial Tab - Updated with Real Data -->
<div id="tab-financial" class="tab-content">
    <div class="space-y-6">
        <!-- Financial Overview -->
        <div class="grid grid-cols-3 gap-6">
            <div class="border border-gray-200 rounded-lg p-6">
                <div class="text-sm text-gray-600 mb-2">Outstanding Balance</div>
                <div class="text-3xl font-bold {% if outstanding_balance > 0 %}text-orange-600{% else %}text-gray-900{% endif %}">
                    KES {{ outstanding_balance|floatformat:0|default:"0" }}
                </div>
                <div class="text-sm text-gray-600 mt-2">
                    {{ quote_stats.quoted.count|add:quote_stats.client_review.count }} pending quote{{ quote_stats.quoted.count|add:quote_stats.client_review.count|pluralize }}
                </div>
            </div>
            <div class="border border-gray-200 rounded-lg p-6">
                <div class="text-sm text-gray-600 mb-2">Lifetime Value</div>
                <div class="text-3xl font-bold text-gray-900">
                    KES {{ lifetime_value|floatformat:0|default:"0" }}
                </div>
                <div class="text-sm text-gray-600 mt-2">
                    Since {{ client.created_at|date:"M Y" }}
                </div>
            </div>
            <div class="border border-gray-200 rounded-lg p-6">
                <div class="text-sm text-gray-600 mb-2">Payment Performance</div>
                <div class="text-3xl font-bold text-green-600">{{ payment_performance }}%</div>
                <div class="text-sm text-gray-600 mt-2">On-time payments</div>
            </div>
        </div>

        <!-- Credit Information -->
        <div>
            <h3 class="text-lg font-semibold mb-4">Credit & Payment Terms</h3>
            <div class="border border-gray-200 rounded-lg p-6">
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="text-sm font-medium text-gray-600">Credit Limit</label>
                        <div class="text-2xl font-bold mt-1">KES {{ credit_limit|floatformat:0 }}</div>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-600">Available Credit</label>
                        <div class="text-2xl font-bold text-green-600 mt-1">KES {{ available_credit|floatformat:0 }}</div>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-600">Payment Terms</label>
                        <div class="text-xl font-semibold mt-1">{{ client.payment_terms }}</div>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-600">Risk Rating</label>
                        <div class="mt-1">
                            <span class="badge 
                                {% if client.risk_rating == 'Low' %}badge-success
                                {% elif client.risk_rating == 'Medium' %}badge-warning
                                {% else %}badge-danger{% endif %}">
                                {{ client.risk_rating }} Risk
                            </span>
                        </div>
                    </div>
                    {% if client.vat_tax_id %}
                    <div>
                        <label class="text-sm font-medium text-gray-600">VAT/Tax ID</label>
                        <div class="text-lg font-mono mt-1">{{ client.vat_tax_id }}</div>
                    </div>
                    {% endif %}
                    {% if client.kra_pin %}
                    <div>
                        <label class="text-sm font-medium text-gray-600">KRA PIN</label>
                        <div class="text-lg font-mono mt-1">{{ client.kra_pin }}</div>
                    </div>
                    {% endif %}
                </div>

                <div class="mt-6">
                    <label class="text-sm font-medium text-gray-600 block mb-2">Credit Utilization</label>
                    <div class="progress-bar-container h-3">
                        <div class="progress-bar-fill" style="width: {{ credit_utilization }}%; 
                            background: {% if credit_utilization < 50 %}#10b981{% elif credit_utilization < 80 %}#f59e0b{% else %}#ef4444{% endif %};"></div>
                    </div>
                    <div class="flex justify-between text-sm text-gray-600 mt-1">
                        <span>KES {{ credit_used|floatformat:0 }} used</span>
                        <span>{{ credit_utilization }}% utilization</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quote History (Financial View) -->
        <div>
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Quote History</h3>
                <div class="flex gap-2">
                    <select class="form-select text-sm">
                        <option>All Status</option>
                        <option>Approved</option>
                        <option>Pending</option>
                    </select>
                </div>
            </div>
            
            {% if quotes %}
            <div class="border border-gray-200 rounded-lg overflow-hidden">
                <table>
                    <thead class="bg-gray-50">
                        <tr>
                            <th>Quote ID</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Amount</th>
                            <th>Payment</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for quote_group in quotes %}
                        <tr>
                            <td><span class="font-mono text-sm">{{ quote_group.quote.quote_id }}</span></td>
                            <td>{{ quote_group.quote.quote_date|date:"M d, Y" }}</td>
                            <td>
                                {% if quote_group.quote.status == 'Approved' %}
                                    <span class="badge badge-success">Approved</span>
                                {% elif quote_group.quote.status == 'Quoted' or quote_group.quote.status == 'Client Review' %}
                                    <span class="badge badge-warning">Pending</span>
                                {% elif quote_group.quote.status == 'Lost' %}
                                    <span class="badge badge-danger">Lost</span>
                                {% else %}
                                    <span class="badge badge-secondary">{{ quote_group.quote.status }}</span>
                                {% endif %}
                            </td>
                            <td class="font-semibold">KES {{ quote_group.total_amount|floatformat:0 }}</td>
                            <td>
                                {% if quote_group.quote.status == 'Approved' %}
                                    <span class="text-green-600 text-sm">✓ Paid</span>
                                {% else %}
                                    <span class="text-gray-500 text-sm">Pending</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="border border-gray-200 rounded-lg p-8 text-center text-gray-500">
                <p>No quotes found</p>
            </div>
            {% endif %}
        </div>

        <!-- Payment Timeline (if you have payment records) -->
        <div>
            <h3 class="text-lg font-semibold mb-4">Recent Transactions</h3>
            <div class="border border-gray-200 rounded-lg">
                <div class="divide-y divide-gray-200">
                    {% for quote_group in quotes %}
                    {% if quote_group.quote.status == 'Approved' %}
                    <div class="p-4 flex items-center justify-between hover:bg-gray-50">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <div class="font-medium">Payment Received</div>
                                <div class="text-sm text-gray-600">Quote {{ quote_group.quote.quote_id }}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-green-600">+KES {{ quote_group.total_amount|floatformat:0 }}</div>
                            <div class="text-sm text-gray-600">{{ quote_group.quote.approved_at|date:"M d, Y"|default:"Recent" }}</div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                    
                    {% if not quotes %}
                    <div class="p-8 text-center text-gray-500">
                        <p>No transactions yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

            <!-- Documents Tab -->
            <div id="tab-documents" class="tab-content">
                <div class="space-y-6">
                    <!-- Document Upload -->
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                        <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <p class="text-gray-600 mb-2">Drag and drop files here, or click to browse</p>
                        <button class="btn btn-secondary mt-2">Choose Files</button>
                    </div>

                    <!-- Document Categories -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-10 h-10 bg-blue-100 rounded flex items-center justify-center">
                                    <svg class="w-5 h-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                    </svg>
                                </div>
                                <div>
                                    <div class="font-semibold">Contracts</div>
                                    <div class="text-sm text-gray-600">4 files</div>
                                </div>
                            </div>
                            <button class="text-blue-600 text-sm font-medium hover:text-blue-700">View All →</button>
                        </div>

                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-10 h-10 bg-green-100 rounded flex items-center justify-center">
                                    <svg class="w-5 h-5 text-green-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                    </svg>
                                </div>
                                <div>
                                    <div class="font-semibold">Compliance</div>
                                    <div class="text-sm text-gray-600">6 files</div>
                                </div>
                            </div>
                            <button class="text-blue-600 text-sm font-medium hover:text-blue-700">View All →</button>
                        </div>

                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-10 h-10 bg-purple-100 rounded flex items-center justify-center">
                                    <svg class="w-5 h-5 text-purple-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                    </svg>
                                </div>
                                <div>
                                    <div class="font-semibold">Brand Assets</div>
                                    <div class="text-sm text-gray-600">12 files</div>
                                </div>
                            </div>
                            <button class="text-blue-600 text-sm font-medium hover:text-blue-700">View All →</button>
                        </div>
                    </div>

                    <!-- Recent Documents -->
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Recent Documents</h3>
                        <div class="border border-gray-200 rounded-lg">
                            <div class="divide-y divide-gray-200">
                                <div class="p-4 hover:bg-gray-50 flex items-center justify-between">
                                    <div class="flex items-center gap-3 flex-1">
                                        <div class="w-10 h-10 bg-red-100 rounded flex items-center justify-center">
                                            <svg class="w-5 h-5 text-red-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                                <polyline points="14 2 14 8 20 8"></polyline>
                                            </svg>
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-medium">Service Agreement 2024.pdf</div>
                                            <div class="text-sm text-gray-600">Uploaded Jan 15, 2024 • 2.4 MB</div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button class="btn btn-secondary text-sm py-1 px-3">
                                            <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                <polyline points="7 10 12 15 17 10"></polyline>
                                                <line x1="12" y1="15" x2="12" y2="3"></line>
                                            </svg>
                                            Download
                                        </button>
                                    </div>
                                </div>

                                <div class="p-4 hover:bg-gray-50 flex items-center justify-between">
                                    <div class="flex items-center gap-3 flex-1">
                                        <div class="w-10 h-10 bg-blue-100 rounded flex items-center justify-center">
                                            <svg class="w-5 h-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                                <polyline points="14 2 14 8 20 8"></polyline>
                                            </svg>
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-medium">Certificate of Incorporation.pdf</div>
                                            <div class="text-sm text-gray-600">Uploaded Jan 3, 2024 • 1.2 MB</div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button class="btn btn-secondary text-sm py-1 px-3">
                                            <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                <polyline points="7 10 12 15 17 10"></polyline>
                                                <line x1="12" y1="15" x2="12" y2="3"></line>
                                            </svg>
                                            Download
                                        </button>
                                    </div>
                                </div>

                                <div class="p-4 hover:bg-gray-50 flex items-center justify-between">
                                    <div class="flex items-center gap-3 flex-1">
                                        <div class="w-10 h-10 bg-green-100 rounded flex items-center justify-center">
                                            <svg class="w-5 h-5 text-green-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                                <polyline points="14 2 14 8 20 8"></polyline>
                                            </svg>
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-medium">KRA PIN Certificate.pdf</div>
                                            <div class="text-sm text-gray-600">Uploaded Jan 3, 2024 • 856 KB</div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button class="btn btn-secondary text-sm py-1 px-3">
                                            <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                <polyline points="7 10 12 15 17 10"></polyline>
                                                <line x1="12" y1="15" x2="12" y2="3"></line>
                                            </svg>
                                            Download
                                        </button>
                                    </div>
                                </div>

                                <div class="p-4 hover:bg-gray-50 flex items-center justify-between">
                                    <div class="flex items-center gap-3 flex-1">
                                        <div class="w-10 h-10 bg-purple-100 rounded flex items-center justify-center">
                                            <svg class="w-5 h-5 text-purple-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                                <polyline points="21 15 16 10 5 21"></polyline>
                                            </svg>
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-medium">Company Logo - Vector.ai</div>
                                            <div class="text-sm text-gray-600">Uploaded Dec 20, 2023 • 3.1 MB</div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button class="btn btn-secondary text-sm py-1 px-3">
                                            <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                <polyline points="7 10 12 15 17 10"></polyline>
                                                <line x1="12" y1="15" x2="12" y2="3"></line>
                                            </svg>
                                            Download
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Log Tab -->
            <div id="tab-activity" class="tab-content">
    <div class="space-y-6">
        <!-- Header with Filter -->
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Activity Timeline</h3>
            <div class="flex items-center gap-3">
                <select id="activityFilter" class="form-select text-sm border border-gray-300 rounded-lg px-3 py-2">
                    <option value="all">All Activities</option>
                    <option value="Quote">Quotes</option>
                    <option value="Order">Orders/Jobs</option>
                    <option value="Payment">Payments</option>
                    <option value="Meeting">Meetings</option>
                    <option value="Email">Emails</option>
                    <option value="Call">Phone Calls</option>
                    <option value="Note">Notes</option>
                </select>
                <button class="btn btn-primary text-sm" onclick="openAddActivityModal()">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Log Activity
                </button>
            </div>
        </div>

        {% if activities %}
        <!-- Activity Timeline -->
        <div class="timeline">
            {% for activity in activities %}
            <div class="timeline-item activity-item" data-type="{{ activity.activity_type }}">
                <!-- Timeline Dot with Color Based on Activity Type -->
                <div class="timeline-dot 
                    {% if activity.activity_type == 'Quote' %}success
                    {% elif activity.activity_type == 'Order' %}{% elif activity.activity_type == 'Payment' %}success
                    {% elif activity.activity_type == 'Meeting' %}warning
                    {% elif activity.activity_type == 'Email' %}{% elif activity.activity_type == 'Call' %}warning
                    {% else %}{% endif %}"></div>
                
                <div class="border border-gray-200 rounded-lg p-4 bg-white hover:shadow-md transition">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <!-- Activity Type Badge -->
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium
                                {% if activity.activity_type == 'Quote' %}bg-blue-100 text-blue-700
                                {% elif activity.activity_type == 'Order' %}bg-green-100 text-green-700
                                {% elif activity.activity_type == 'Payment' %}bg-emerald-100 text-emerald-700
                                {% elif activity.activity_type == 'Meeting' %}bg-purple-100 text-purple-700
                                {% elif activity.activity_type == 'Email' %}bg-indigo-100 text-indigo-700
                                {% elif activity.activity_type == 'Call' %}bg-orange-100 text-orange-700
                                {% elif activity.activity_type == 'Note' %}bg-gray-100 text-gray-700
                                {% else %}bg-gray-100 text-gray-700{% endif %}">
                                
                                <!-- Icon for Activity Type -->
                                {% if activity.activity_type == 'Quote' %}
                                    📋 Quote
                                {% elif activity.activity_type == 'Order' %}
                                    📦 Order
                                {% elif activity.activity_type == 'Payment' %}
                                    💰 Payment
                                {% elif activity.activity_type == 'Meeting' %}
                                    🤝 Meeting
                                {% elif activity.activity_type == 'Email' %}
                                    📧 Email
                                {% elif activity.activity_type == 'Call' %}
                                    📞 Call
                                {% elif activity.activity_type == 'Note' %}
                                    📝 Note
                                {% else %}
                                    {{ activity.activity_type }}
                                {% endif %}
                            </span>
                            
                            <div class="font-semibold text-gray-900">{{ activity.title }}</div>
                        </div>
                        
                        <span class="text-sm text-gray-600">{{ activity.created_at|timesince }} ago</span>
                    </div>
                    
                    <p class="text-sm text-gray-700 mb-2 whitespace-pre-line">{{ activity.description|truncatewords:30 }}</p>
                    
                    <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-100">
                        <div class="flex items-center gap-3 text-xs text-gray-600">
                            {% if activity.created_by %}
                            <span class="flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                {{ activity.created_by.get_full_name|default:activity.created_by.username }}
                            </span>
                            {% endif %}
                            
                            <span class="flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                {{ activity.created_at|date:"M d, Y - h:i A" }}
                            </span>
                            
                            {% if activity.related_quote %}
                            <span class="flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                </svg>
                                <a href="{% url 'quote_detail' activity.related_quote.quote_id %}" class="text-blue-600 hover:underline">
                                    {{ activity.related_quote.quote_id }}
                                </a>
                            </span>
                            {% endif %}
                        </div>
                        
                        <button onclick="viewActivityDetails({{ activity.id }})" class="text-xs text-blue-600 hover:text-blue-700 font-medium">
                            View Details →
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Load More Button -->
        {% if activities.count > 20 %}
        <div class="text-center">
            <button class="btn btn-secondary" onclick="loadMoreActivities()">
                Load More Activities
            </button>
        </div>
        {% endif %}

        {% else %}
        <!-- Empty State -->
        <div class="border border-gray-200 rounded-lg p-12 text-center">
            <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">No Activity Yet</h3>
            <p class="text-gray-600 mb-4">Start tracking interactions with this client</p>
            <button class="btn btn-primary" onclick="openAddActivityModal()">
                Log First Activity
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Activity Detail Modal -->
<div id="activityDetailModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-2xl shadow-lg rounded-md bg-white max-w-2xl">
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-lg font-semibold">Activity Details</h3>
            <button onclick="closeActivityModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="activityDetailContent">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Activity Filter
    const activityFilter = document.getElementById('activityFilter');
    if (activityFilter) {
        activityFilter.addEventListener('change', function() {
            const filterValue = this.value;
            const activityItems = document.querySelectorAll('.activity-item');
            
            activityItems.forEach(item => {
                if (filterValue === 'all' || item.dataset.type === filterValue) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }
});

function viewActivityDetails(activityId) {
    // Show modal with activity details
    const modal = document.getElementById('activityDetailModal');
    modal.classList.remove('hidden');
    
    // You can fetch more details via AJAX if needed
    // For now, we'll just show a simple message
    document.getElementById('activityDetailContent').innerHTML = `
        <p class="text-gray-600">Loading activity details...</p>
    `;
}

function closeActivityModal() {
    document.getElementById('activityDetailModal').classList.add('hidden');
}

function openAddActivityModal() {
    // You can implement a form to add new activities
    alert('Add activity form coming soon!');
}

function loadMoreActivities() {
    // Implement pagination or load more activities
    alert('Load more functionality coming soon!');
}

function switchTab(tabName) {
    // Hide all tab contents
    const allTabs = document.querySelectorAll('.tab-content');
    allTabs.forEach(tab => tab.classList.remove('active'));

    // Remove active class from all tab buttons
    const allButtons = document.querySelectorAll('.profile-tab');
    allButtons.forEach(btn => btn.classList.remove('active'));

    // Activate the selected tab and button
    const targetTab = document.getElementById(`tab-${tabName}`);
    if (targetTab) {
        targetTab.classList.add('active');
        event.currentTarget.classList.add('active');
    }
}
</script>
{% endif%}
{% endblock %}


