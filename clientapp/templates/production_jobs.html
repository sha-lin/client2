{% extends 'base.html' %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h2 class="text-2xl font-bold text-gray-800">Production Jobs</h2>
        <a href="{% url 'create_job' %}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            New Job
        </a>
    </div>

    <!-- Filters & Search -->
    <div class="bg-white rounded-lg shadow p-4 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                <input type="text" id="searchInput" placeholder="Search by job #, client, or product..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                <select id="statusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="in_progress">In Progress</option>
                    <option value="on_hold">On Hold</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                <select id="priorityFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">All Priorities</option>
                    <option value="normal">Normal</option>
                    <option value="high">High</option>
                    <option value="urgent">Urgent</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                <select id="sortBy" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="-created_at">Newest First</option>
                    <option value="expected_completion">Due Date (Soonest)</option>
                    <option value="job_number">Job Number</option>
                </select>
            </div>
        </div>
        <button onclick="applyFilters()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Apply Filters</button>
    </div>

    <!-- Jobs Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Job #</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Client</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Priority</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Due Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200" id="jobsTableBody">
                <!-- Populated by JavaScript -->
            </tbody>
        </table>
        <div id="noJobsMessage" class="text-center text-gray-500 py-12 hidden">
            No jobs found. <a href="{% url 'create_job' %}" class="text-blue-600 hover:text-blue-900">Create a new job</a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// API Configuration
const API_BASE = '/api/v1';

// Status badge configuration
const statusBadges = {
    'pending': { bg: 'bg-gray-100', text: 'text-gray-800', icon: '⏳', label: 'Pending' },
    'in_progress': { bg: 'bg-blue-100', text: 'text-blue-800', icon: '▶️', label: 'In Progress' },
    'on_hold': { bg: 'bg-yellow-100', text: 'text-yellow-800', icon: '⏸️', label: 'On Hold' },
    'completed': { bg: 'bg-green-100', text: 'text-green-800', icon: '✓', label: 'Completed' }
};

// Priority badge configuration
const priorityBadges = {
    'normal': { bg: 'bg-gray-100', text: 'text-gray-800', label: 'Normal' },
    'high': { bg: 'bg-orange-100', text: 'text-orange-800', label: 'High' },
    'urgent': { bg: 'bg-red-100', text: 'text-red-800', label: 'Urgent' }
};

// Load jobs from API with filters
async function loadJobs() {
    try {
        // Build query parameters
        const params = new URLSearchParams();
        
        const search = document.getElementById('searchInput')?.value;
        if (search) params.append('search', search);
        
        const status = document.getElementById('statusFilter')?.value;
        if (status) params.append('status', status);
        
        const priority = document.getElementById('priorityFilter')?.value;
        if (priority) params.append('priority', priority);
        
        const sort = document.getElementById('sortBy')?.value || '-created_at';
        if (sort) params.append('ordering', sort);
        
        const url = `${API_BASE}/jobs/?${params.toString()}`;
        const response = await fetch(url);
        
        if (!response.ok) throw new Error(`API Error: ${response.status}`);
        
        const data = await response.json();
        const jobs = data.results || data;
        
        const tbody = document.getElementById('jobsTableBody');
        const noJobsMsg = document.getElementById('noJobsMessage');
        
        if (!jobs || jobs.length === 0) {
            tbody.innerHTML = '';
            noJobsMsg.classList.remove('hidden');
            return;
        }
        
        noJobsMsg.classList.add('hidden');
        
        tbody.innerHTML = jobs.map(job => {
            const statusBadge = statusBadges[job.status] || statusBadges['pending'];
            const priorityBadge = priorityBadges[job.priority] || priorityBadges['normal'];
            const jobType = job.job_type ? job.job_type.charAt(0).toUpperCase() + job.job_type.slice(1) : 'Unknown';
            const dueDate = job.expected_completion ? new Date(job.expected_completion).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'}) : '-';
            
            return `
                <tr class="hover:bg-gray-50 cursor-pointer" onclick="viewJobDetail(${job.id})">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${job.job_number}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${job.client_name || job.client || '-'}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">
                        ${job.product} (${job.quantity} pcs)
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${jobType}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusBadge.bg} ${statusBadge.text}">
                            ${statusBadge.icon} ${statusBadge.label}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${priorityBadge.bg} ${priorityBadge.text}">
                            ${priorityBadge.label}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${dueDate}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="event.stopPropagation(); viewJobDetail(${job.id})" class="text-blue-600 hover:text-blue-900 mr-3">View</button>
                        <button onclick="event.stopPropagation(); editJob(${job.id})" class="text-green-600 hover:text-green-900 mr-3">Edit</button>
                        <button onclick="event.stopPropagation(); deleteJob(${job.id})" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Error loading jobs:', error);
        document.getElementById('jobsTableBody').innerHTML = `
            <tr>
                <td colspan="8" class="px-6 py-4 text-center text-red-600">
                    Error loading jobs. Please try again.
                </td>
            </tr>
        `;
    }
}

// Apply filters
function applyFilters() {
    loadJobs();
}

// View job detail
function viewJobDetail(jobId) {
    window.location.href = `/job-detail/${jobId}/`;
}

// Edit job
function editJob(jobId) {
    window.location.href = `/edit-job/${jobId}/`;
}

// Delete job
async function deleteJob(jobId) {
    if (!confirm('Are you sure you want to delete this job?')) return;
    
    try {
        const response = await fetch(`${API_BASE}/jobs/${jobId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        if (!response.ok) throw new Error('Failed to delete job');
        
        await loadJobs();
        alert('Job deleted successfully');
        
    } catch (error) {
        console.error('Error deleting job:', error);
        alert('Failed to delete job');
    }
}

// Get CSRF token
function getCsrfToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Search with debounce
let searchTimeout;
document.getElementById('searchInput')?.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(loadJobs, 300);
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadJobs();
});
</script>
{% endblock %}