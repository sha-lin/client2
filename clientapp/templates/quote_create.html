{% extends 'base.html' %}
{% load static %}

{% block title %}New Quote{% endblock %}

{% block content %}
<style>
    .zoho-input {
        border: 1px solid #d1d5db;
        transition: all 0.2s;
    }

    .zoho-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .table-input {
        border: none;
        background: transparent;
        padding: 4px 8px;
    }

    .table-input:focus {
        background: #f9fafb;
        border: 1px solid #3b82f6;
        outline: none;
    }

    #inlineSearchResults {
        max-height: 300px;
        overflow-y: auto;
        z-index: 100;
    }

    .search-result-item:hover {
        background-color: #f3f4f6;
    }
</style>

<div class="min-h-screen bg-white">
    <!-- Top Bar -->
    <div class="bg-white border-b border-gray-200 px-6 py-3">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <button type="button" onclick="window.history.back()" class="text-gray-600 hover:text-gray-900">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </button>
                <h1 class="text-xl font-semibold text-gray-900">New Quote</h1>
            </div>
            <div class="flex items-center gap-3">
                <button type="submit" form="quoteForm" name="action" value="save_draft"
                    class="px-5 py-2 bg-white border border-gray-300 text-gray-700 rounded hover:bg-gray-50 font-medium text-sm">
                     Save as Draft
                </button>
                <button type="submit" form="quoteForm" name="action" value="save_send_pt"
                    class="px-5 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-medium text-sm">
                     Sen to PT for Costing
                </button>
                <button type="submit" form="quoteForm" name="action" value="send_to_customer"
                    class="px-5 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-medium text-sm">
                    Email Client
                </button>
            </div>
        </div>
    </div>

    <form method="POST" action="{% url 'quote_create' %}" id="quoteForm" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="client_id" id="client_id">
        <input type="hidden" name="lead_id" id="lead_id">
        <input type="hidden" name="subtotal" id="hiddenSubtotal">
        <input type="hidden" name="discount_total" id="hiddenDiscount">
        <input type="hidden" name="tax_total" id="hiddenTax">
        <input type="hidden" name="total" id="hiddenTotal">
        <input type="hidden" name="existing_quote_id" id="existing_quote_id" value="{{ quote_id|default:'' }}">
        <!-- Store existing line items data for JavaScript -->
        <div id="existingLineItemsData" style="display: none;">
            {% if existing_line_items %}
                {% for item in existing_line_items %}
                    <div class="line-item-data" 
                         data-product-id="{{ item.product.id }}"
                         data-product-name="{{ item.product.name }}"
                         data-product-sku="{{ item.product.internal_code }}"
                         data-customization="{{ item.product.customization_level }}"
                         data-quantity="{{ item.quantity }}"
                         data-rate="{{ item.base_price }}"
                         data-discount="{{ item.discount_amount }}"
                         data-discount-type="{% if item.product.discount_type %}{{ item.product.discount_type }}{% else %}percent{% endif %}"
                         data-description="{{ item.description }}"
                         data-variable-amount="{{ item.variable_amount }}"
                         data-price="{{ item.product.unit_price|default:item.product.base_price }}">
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <div class="max-w-[1400px] mx-auto px-6 py-6">
            <div class="flex gap-6">
                <!-- Main Content -->
                <div class="flex-1">
                    <!-- Header Section -->
                    <div class="grid grid-cols-2 gap-8 mb-6">
                        <!-- Left: Client Info -->
                        <div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Customer Name *</label>
                                <select name="client_name" id="client_select" required
                                    class="zoho-input w-full px-3 py-2 rounded text-sm focus:outline-none">
                                    <option value="">Select a Customer</option>
                                    <optgroup label="Clients">
                                        {% for client in clients %}
                                        <option value="client-{{ client.id }}" {% if existing_quote.client_id == client.id %}selected{% endif %}>{{ client.name }}</option>
                                        {% endfor %}
                                    </optgroup>
                                    <optgroup label="Leads">
                                        {% for lead in leads %}
                                        <option value="lead-{{ lead.id }}" {% if existing_quote.lead_id == lead.id %}selected{% endif %}>{{ lead.name }}</option>
                                        {% endfor %}
                                    </optgroup>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Reference Number</label>
                                <input type="text" name="reference_number"
                                    value="{% if existing_quote %}{{ existing_quote.reference_number }}{% endif %}"
                                    placeholder="Client PO/LPO reference"
                                    class="zoho-input w-full px-3 py-2 rounded text-sm focus:outline-none">
                            </div>
                        </div>

                        <!-- Right: Quote Details -->
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Quote Date</label>
                                    <input type="date" name="valid_until" id="todays_date" required
                                        value="{% if existing_quote %}{{ existing_quote.valid_until|date:'Y-m-d' }}{% endif %}"
                                        class="zoho-input w-full px-3 py-2 rounded text-sm focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Expiry Date</label>
                                    <input type="date" name="delivery_deadline"
                                        value="{% if existing_quote %}{{ existing_quote.valid_until|date:'Y-m-d' }}{% endif %}"
                                        class="zoho-input w-full px-3 py-2 rounded text-sm focus:outline-none">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Salesperson</label>
                                <input type="text" name="account_manager"
                                    value="{% if existing_quote and existing_quote.created_by %}{{ existing_quote.created_by.get_full_name }}{% else %}{{ request.user.get_full_name }}{% endif %}"
                                    readonly class="zoho-input w-full px-3 py-2 rounded text-sm bg-gray-50">
                            </div>
                        </div>
                    </div>

                    <!-- Line Items Table -->
                    <div class="border border-gray-200 rounded-lg mb-6">
    <table class="w-full overflow-hidden rounded-lg">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="text-left px-4 py-3 text-xs font-semibold text-gray-700 uppercase w-6">#</th>
                                    <th class="text-left px-4 py-3 text-xs font-semibold text-gray-700 uppercase">Item Details</th>
                                    <th class="text-right px-4 py-3 text-xs font-semibold text-gray-700 uppercase w-24">Quantity</th>
                                    <th class="text-right px-4 py-3 text-xs font-semibold text-gray-700 uppercase w-32">Rate</th>
                                    <th class="text-right px-4 py-3 text-xs font-semibold text-gray-700 uppercase w-28">Discount</th>
                                    <th class="text-right px-4 py-3 text-xs font-semibold text-gray-700 uppercase w-32">Amount</th>
                                    <th class="w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="lineItemsBody" class="bg-white">
                                <tr id="emptyRow">
                                    <td colspan="7" class="px-4 py-8 text-center">
                                        <div class="text-gray-400 mb-2">
                                            <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2"></i>
                                        </div>
                                        <p class="text-sm text-gray-500">No items added</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Inline Search Row -->
                        <div class="bg-gray-50 border-t border-gray-200 px-4 py-3 relative">
                            <div class="flex items-center gap-3">
                                <div class="relative flex-1">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i data-lucide="search" class="w-4 h-4 text-gray-400"></i>
                                    </div>
                                    <input type="text" id="inlineProductSearch" 
                                        placeholder="Type to search products (SKU, Name)..."
                                        class="zoho-input w-full pl-10 pr-4 py-2 rounded text-sm focus:outline-none bg-white border-gray-300">
                                    
                                    <!-- Search Results Dropdown -->
                                    <div id="inlineSearchResults" 
     style="display: none;"
     class="absolute z-50 left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-xl max-h-80 overflow-y-auto">
    <!-- Results will be injected here -->
</div>
                                </div>
                                <button type="button" id="addLineBtn"
                                    class="text-blue-600 hover:text-blue-700 text-sm font-medium inline-flex items-center gap-1">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                    Add another line
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Customer Notes</label>
                            <textarea name="special_instructions" rows="3"
                                placeholder="Looking forward to your business."
                                class="zoho-input w-full px-3 py-2 rounded text-sm focus:outline-none resize-none">{% if existing_quote %}{{ existing_quote.notes }}{% endif %}</textarea>
                            <p class="text-xs text-gray-500 mt-1">This will be displayed on the quote</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Terms & Conditions</label>
                            <textarea name="terms_conditions" rows="3"
                                placeholder="Enter the terms and conditions of your business."
                                class="zoho-input w-full px-3 py-2 rounded text-sm focus:outline-none resize-none">{% if existing_quote %}{{ existing_quote.custom_terms }}{% endif %}</textarea>
                        </div>

                        <!-- File Attachments -->
                        <div class="pt-4 border-t border-gray-100">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Attachments</label>
                            <div class="flex items-center justify-center w-full">
                                <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                        <i data-lucide="upload-cloud" class="w-8 h-8 text-gray-400 mb-2"></i>
                                        <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                                        <p class="text-xs text-gray-500">Briefs, Artwork, Specs (MAX. 10MB)</p>
                                    </div>
                                    <input type="file" name="attachments" multiple class="hidden" id="fileInput" />
                                </label>
                            </div>
                            <div id="fileList" class="mt-3 space-y-2">
                                <!-- Selected files will be listed here -->
                                {% if existing_quote and existing_quote.attachments.all %}
                                    {% for attachment in existing_quote.attachments.all %}
                                        <div class="flex items-center justify-between p-2 bg-blue-50 rounded text-xs">
                                            <span class="text-blue-700 font-medium">{{ attachment.filename }}</span>
                                            <span class="text-gray-500">{{ attachment.file_size|filesizeformat }}</span>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar - Totals -->
                <div class="w-80 flex-shrink-0">
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-5 sticky top-6">
                        <div class="space-y-3 pb-4 mb-4 border-b border-gray-300">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Sub Total</span>
                                <span class="text-sm font-semibold text-gray-900" id="summarySubtotal">KSh 0.00</span>
                            </div>

                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Discount</span>
                                <span class="text-sm font-semibold text-gray-900" id="summaryDiscount">KSh 0.00</span>
                            </div>
                        </div>

                        <!-- Tax Section -->
                        <div class="pb-4 mb-4 border-b border-gray-300">
                            <div class="flex items-center justify-between mb-3">
                                <label class="flex items-center gap-2 text-sm text-gray-700">
                                    <input type="checkbox" id="enableTax" {% if existing_quote and existing_quote.tax_total > 0 %}checked{% endif %}
                                        class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span>VAT (16%)</span>
                                </label>
                            </div>
                            <div id="taxSection" class="{% if not existing_quote or existing_quote.tax_total == 0 %}hidden{% endif %}">
                                <div class="flex items-center justify-between mb-2">
                                    <input type="number" id="taxRate" name="tax_rate" value="{% if existing_quote %}{{ existing_quote.tax_rate }}{% else %}16{% endif %}" step="0.01" min="0" max="100"
                                        class="zoho-input w-20 px-2 py-1 rounded text-sm text-right focus:outline-none">
                                    <span class="text-xs text-gray-600 ml-2">%</span>
                                </div>
                                <div class="flex justify-between items-center mt-3">
                                    <span class="text-sm text-gray-600">VAT</span>
                                    <span class="text-sm font-semibold text-gray-900" id="summaryTax">KSh 0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Shipping Charges -->
                        <div class="pb-4 mb-4 border-b border-gray-300">
                            <div class="flex items-center justify-between mb-2">
                                <label class="flex items-center gap-2 text-sm text-gray-700">
                                    <input type="checkbox" id="enableShipping" {% if existing_quote and existing_quote.shipping_charges > 0 %}checked{% endif %}
                                        class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span>Shipping Charges</span>
                                </label>
                            </div>
                            <div id="shippingSection" class="{% if not existing_quote or existing_quote.shipping_charges == 0 %}hidden{% endif %} space-y-2">
                                <input type="number" id="shippingCharges" name="shipping_charges" 
                                    value="{% if existing_quote %}{{ existing_quote.shipping_charges }}{% else %}0.00{% endif %}"
                                    step="0.01" class="zoho-input w-full px-3 py-2 rounded text-sm focus:outline-none">
                            </div>
                        </div>

                        <!-- Adjustment -->
                        <div class="pb-4 mb-4 border-b border-gray-300">
                            <div class="flex items-center justify-between mb-2">
                                <label class="flex items-center gap-2 text-sm text-gray-700">
                                    <input type="checkbox" id="enableAdjustment" {% if existing_quote and existing_quote.adjustment_amount != 0 %}checked{% endif %}
                                        class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span>Adjustment</span>
                                </label>
                            </div>
                            <div id="adjustmentSection" class="{% if not existing_quote or existing_quote.adjustment_amount == 0 %}hidden{% endif %} space-y-2">
                                <input type="number" id="adjustmentAmount" name="adjustment_amount" 
                                    value="{% if existing_quote %}{{ existing_quote.adjustment_amount }}{% else %}0.00{% endif %}"
                                    step="0.01" class="zoho-input w-full px-3 py-2 rounded text-sm focus:outline-none">
                                <input type="text" id="adjustmentReason" name="adjustment_reason" 
                                    value="{% if existing_quote %}{{ existing_quote.adjustment_reason }}{% endif %}"
                                    placeholder="Reason"
                                    class="zoho-input w-full px-3 py-2 rounded text-sm focus:outline-none">
                            </div>
                        </div>

                        <!-- Total -->
                        <div class="pt-2">
                            <div class="flex justify-between items-center">
                                <span class="text-base font-semibold text-gray-900">Total (KSh)</span>
                                <span class="text-2xl font-bold text-gray-900" id="summaryTotal">0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

{% endblock %}
{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
    lucide.createIcons();

    // Set today's date if not already set
    const dateInput = document.getElementById('todays_date');
    if (dateInput && !dateInput.value) {
        dateInput.value = new Date().toISOString().split('T')[0];
    }

    let lineCounter = 0;
    const tbody = document.getElementById('lineItemsBody');
    const emptyRow = document.getElementById('emptyRow');
    const inlineSearch = document.getElementById('inlineProductSearch');
    const searchResults = document.getElementById('inlineSearchResults');
    const addLineBtn = document.getElementById('addLineBtn');

    // 1. Client/Lead selection logic
    document.getElementById('client_select')?.addEventListener('change', function () {
        const val = this.value;
        document.getElementById('client_id').value = val.startsWith('client-') ? val.replace('client-', '') : '';
        document.getElementById('lead_id').value = val.startsWith('lead-') ? val.replace('lead-', '') : '';
    });

    // Trigger change on load to set initial hidden IDs if pre-selected
    document.getElementById('client_select')?.dispatchEvent(new Event('change'));

    // ===== LOAD EXISTING LINE ITEMS (for editing existing quotes) =====
    function loadExistingLineItems() {
        const existingItemsContainer = document.getElementById('existingLineItemsData');
        if (!existingItemsContainer) return;

        const lineItemDivs = existingItemsContainer.querySelectorAll('.line-item-data');
        console.log(`Found ${lineItemDivs.length} existing line items to load`);

        lineItemDivs.forEach((div) => {
            const productData = {
                id: div.dataset.productId,
                name: div.dataset.productName,
                internal_code: div.dataset.productSku,
                customization: div.dataset.customization,
                price: parseFloat(div.dataset.price) || 0,
                desc: div.dataset.description || '',
            };

            // Create a pseudo-product object that matches what addLine expects
            const lineData = {
                ...productData,
                quantity: parseFloat(div.dataset.quantity) || 1,
                rate: parseFloat(div.dataset.rate) || 0,
                discount: parseFloat(div.dataset.discount) || 0,
                discountType: div.dataset.discountType || 'percent',
                variableAmount: parseFloat(div.dataset.variableAmount) || 0,
            };

            // Add the line item
            addLineWithData(lineData);
        });

        // Recalculate totals after loading all items
        if (lineItemDivs.length > 0) {
            calcAll();
        }
    }

    // Modified addLine function that accepts pre-filled data
    function addLineWithData(lineData) {
        if (emptyRow) emptyRow.style.display = 'none';
        lineCounter++;
        const isCustomizable = lineData.customization !== 'non_customizable';

        let rateValue = lineData.rate || lineData.price || 0;
        const rateReadonly = (lineData.customization === 'non_customizable') ? 'readonly' :
            (lineData.customization === 'fully_customizable') ? '' : '';

        const customizationLabel = lineData.customization.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

        const tr = document.createElement('tr');
        tr.className = 'border-b border-gray-100 hover:bg-gray-50 line-row';
        tr.dataset.customizable = isCustomizable;
        tr.innerHTML = `
            <td class="px-4 py-2 text-sm text-gray-500">${lineCounter}</td>
            <td class="px-4 py-2">
                <input type="hidden" name="product_id[]" value="${lineData.id}">
                <input type="hidden" name="customization_level[]" value="${lineData.customization}">
                <div class="font-medium text-sm text-gray-900 mb-1">${lineData.name}</div>
                <div class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">${customizationLabel}</div>
                <input type="text" name="description[]" value="${lineData.desc || ''}" placeholder="Description"
                    class="table-input w-full text-xs text-gray-600 rounded">
            </td>
            <td class="px-4 py-2">
                <input type="number" name="quantity[]" value="${lineData.quantity}" min="1" step="1" required
                    class="qty table-input w-full text-sm text-right rounded">
            </td>
            <td class="px-4 py-2">
                <div class="relative">
                    <input type="number" name="rate[]" value="${rateValue ? Number(rateValue).toFixed(2) : ''}" min="0" step="0.01" required ${rateReadonly}
                        class="rate table-input w-full text-sm text-right rounded ${(isCustomizable) ? 'bg-gray-50 text-gray-400' : ''}">
                </div>
            </td>
            <td class="px-4 py-2">
                <div class="flex items-center gap-1">
                    <input type="number" name="discount[]" value="${lineData.discount}" min="0" step="0.01"
                        class="disc table-input w-16 text-sm text-right rounded">
                    <select name="discount_type[]" class="disc-type table-input w-12 text-xs rounded">
                        <option value="percent" ${lineData.discountType === 'percent' ? 'selected' : ''}>%</option>
                        <option value="fixed" ${lineData.discountType === 'fixed' ? 'selected' : ''}>KSh</option>
                    </select>
                </div>
            </td>
            <td class="px-4 py-2 text-right text-sm font-semibold text-gray-900 amt">KSh 0.00</td>
            <td class="px-4 py-2 text-center">
                <button type="button" class="delete-line text-red-500 hover:text-red-700" title="Delete row">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </td>
        `;

        tbody.appendChild(tr);

        // Attach event listeners to the new row
        const qtyInput = tr.querySelector('.qty');
        const rateInput = tr.querySelector('.rate');
        const discInput = tr.querySelector('.disc');
        const discTypeSelect = tr.querySelector('.disc-type');
        const deleteBtn = tr.querySelector('.delete-line');

        [qtyInput, rateInput, discInput, discTypeSelect].forEach(input => {
            input?.addEventListener('input', function () { calcLine(tr); });
            input?.addEventListener('change', function () { calcLine(tr); });
        });

        deleteBtn?.addEventListener('click', function (e) {
            e.preventDefault();
            tr.remove();
            calcAll();
            if (tbody.querySelectorAll('.line-row').length === 0 && emptyRow) {
                emptyRow.style.display = 'table-row';
                lineCounter = 0;
            }
            lucide.createIcons();
        });

        lucide.createIcons();
        calcLine(tr);
    }

    // Call this function on page load to restore existing line items
    loadExistingLineItems();

    // MOVED OUTSIDE: Define renderSearchResults at the top level
    function renderSearchResults(products) {
        console.log('Rendering', products.length, 'products'); // Debug
        
        const html = products.map(p => `
            <div class="search-result-item p-3 border-b border-gray-100 cursor-pointer flex items-center justify-between gap-3 hover:bg-gray-50" 
                 data-id="${p.id}" 
                 data-name="${p.name}" 
                 data-sku="${p.internal_code || ''}" 
                 data-customization="${p.customization_level}"
                 data-price="${p.unit_price || p.base_price || 0}">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-gray-100 rounded flex items-center justify-center">
                        <i data-lucide="package" class="w-4 h-4 text-gray-400"></i>
                    </div>
                    <div>
                        <div class="text-sm font-medium text-gray-900">${p.name}</div>
                        <div class="text-xs text-gray-500">${p.internal_code || 'No SKU'} | ${p.customization_level.replace(/_/g, ' ')}</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-sm font-semibold text-blue-600">KSh ${Number(p.unit_price || p.base_price || 0).toLocaleString()}</div>
                </div>
            </div>
        `).join('');
        
        searchResults.innerHTML = html;
        searchResults.style.display = 'block'; // CHANGED: Use style.display instead of classList
        
        console.log('HTML length:', html.length); // Debug
        console.log('Display style:', searchResults.style.display); // Debug
        
        lucide.createIcons();

        // Attach click listeners to search result items
        document.querySelectorAll('.search-result-item').forEach(item => {
            item.addEventListener('click', async function () {
                const productId = this.dataset.id;
                
                try {
                    const response = await fetch(`/api/product-price/${productId}/`);
                    const data = await response.json();

                    if (data.success) {
                        let price = 0;
                        if (data.customization_level === 'non_customizable') {
                            price = data.base_price || data.unit_price || 0;
                        } else {
                            price = data.base_price || 0;
                        }

                        addLine({
                            id: data.id,
                            name: data.name,
                            sku: data.internal_code,
                            desc: '',
                            price: price,
                            customization: data.customization_level
                        });

                        inlineSearch.value = '';
                        searchResults.style.display = 'none'; // CHANGED: Use style.display
                    }
                } catch (error) {
                    console.error('Error fetching product price:', error);
                    alert('Failed to load product details. Please try again.');
                }
            });
        });
    }

    // 2. Add Line Button - Show all products immediately
    addLineBtn?.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent the click from bubbling up
        
        if (inlineSearch) {
            inlineSearch.value = '';
            inlineSearch.focus();

            searchResults.innerHTML = '<div class="p-4 text-sm text-gray-500">Loading products...</div>';
            searchResults.style.display = 'block'; // CHANGED: Use style.display

            fetch(`/api/product-catalog/`)
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    console.log('API Response:', data); // Debug log
                    console.log('Products count:', data.products.length); // Debug log
                    
                    if (data.success && data.products && data.products.length > 0) {
                        renderSearchResults(data.products);
                        console.log('Products rendered, dropdown visible'); // Debug
                    } else {
                        searchResults.innerHTML = '<div class="p-4 text-sm text-gray-500">No products available</div>';
                        searchResults.style.display = 'block'; // CHANGED: Use style.display
                    }
                })
                .catch(error => {
                    console.error('Error fetching products:', error);
                    searchResults.innerHTML = '<div class="p-4 text-sm text-red-500">Error loading products. Please try again.</div>';
                    searchResults.style.display = 'block'; // CHANGED: Use style.display
                });
        }
    });

    // 3. Inline Search Logic
    let searchTimeout;
    inlineSearch?.addEventListener('input', function () {
        clearTimeout(searchTimeout);
        const query = this.value.trim();

        if (query.length < 2) {
            searchResults.style.display = 'none'; // CHANGED: Use style.display
            return;
        }

        searchTimeout = setTimeout(() => {
            fetch(`/api/product-catalog/?search=${encodeURIComponent(query)}`)
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    if (data.success && data.products.length > 0) {
                        renderSearchResults(data.products);
                    } else {
                        searchResults.innerHTML = '<div class="p-4 text-sm text-gray-500">No products found</div>';
                        searchResults.style.display = 'block'; // CHANGED: Use style.display
                    }
                })
                .catch(error => {
                    console.error('Error searching products:', error);
                    searchResults.innerHTML = '<div class="p-4 text-sm text-red-500">Search failed. Please try again.</div>';
                    searchResults.style.display = 'block'; // CHANGED: Use style.display
                });
        }, 300);
    });

    // Close search results when clicking outside
    document.addEventListener('click', (e) => {
        // Don't close if clicking on the search input, results dropdown, or add line button
        if (inlineSearch && 
            !inlineSearch.contains(e.target) && 
            !searchResults.contains(e.target) &&
            !addLineBtn.contains(e.target)) {
            searchResults.style.display = 'none'; // CHANGED: Use style.display
        }
    });

    // 4. Add Line Item Row logic
    function addLine(prod, isCosted = false) {
        if (emptyRow) emptyRow.style.display = 'none';
        lineCounter++;
        const isCustomizable = prod.customization !== 'non_customizable';

        let rateValue = prod.price;
        const rateReadonly = (prod.customization === 'non_customizable') ? 'readonly' :
            (prod.customization === 'fully_customizable' && !isCosted) ? 'readonly' : '';

        const customizationLabel = prod.customization.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

        const tr = document.createElement('tr');
        tr.className = 'border-b border-gray-100 hover:bg-gray-50 line-row';
        tr.dataset.customizable = isCustomizable;
        tr.innerHTML = `
            <td class="px-4 py-2 text-sm text-gray-500">${lineCounter}</td>
            <td class="px-4 py-2">
                <input type="hidden" name="product_id[]" value="${prod.id}">
                <input type="hidden" name="customization_level[]" value="${prod.customization}">
                <div class="font-medium text-sm text-gray-900 mb-1">${prod.name}</div>
                <div class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">${customizationLabel}</div>
                <input type="text" name="description[]" value="${prod.desc || ''}" placeholder="Description"
                    class="table-input w-full text-xs text-gray-600 rounded">
            </td>
            <td class="px-4 py-2">
                <input type="number" name="quantity[]" value="1" min="1" step="1" required
                    class="qty table-input w-full text-sm text-right rounded">
            </td>
            <td class="px-4 py-2">
                <div class="relative">
                    <input type="number" name="rate[]" value="${rateValue ? Number(rateValue).toFixed(2) : ''}" min="0" step="0.01" required ${rateReadonly}
                        class="rate table-input w-full text-sm text-right rounded ${(isCustomizable && !isCosted) ? 'bg-gray-50 text-gray-400' : ''}">
                </div>
            </td>
            <td class="px-4 py-2">
                <div class="flex items-center gap-1">
                    <input type="number" name="discount[]" value="0" min="0" step="0.01"
                        class="disc table-input w-16 text-sm text-right rounded">
                    <select name="discount_type[]" class="disc-type table-input w-12 text-xs rounded">
                        <option value="percent">%</option>
                        <option value="fixed">KSh</option>
                    </select>
                </div>
            </td>
            <td class="px-4 py-2 text-right">
                <span class="amt text-sm font-semibold text-gray-900">KSh ${rateValue ? Number(rateValue).toFixed(2) : '0.00'}</span>
            </td>
            <td class="px-4 py-2">
                <button type="button" class="del text-gray-400 hover:text-red-600">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </td>
        `;

        tbody.appendChild(tr);
        lucide.createIcons();

        // Attach listeners for calculations
        tr.querySelectorAll('.qty, .rate, .disc, .disc-type').forEach(inp => {
            inp.addEventListener('input', () => calcRow(tr));
        });

        tr.querySelector('.del').addEventListener('click', () => {
            tr.remove();
            if (tbody.querySelectorAll('.line-row').length === 0 && emptyRow) emptyRow.style.display = '';
            calcAll();
            updateSubmitButtons();
        });

        calcRow(tr);
        updateSubmitButtons();
    }

    // 5. Submit Button UI logic
    function updateSubmitButtons() {
        const hasCustomizable = Array.from(document.querySelectorAll('.line-row')).some(tr => tr.dataset.customizable === 'true');
        const sendBtn = document.querySelector('button[value="save_send_pt"]');
        if (!sendBtn) return;

        if (hasCustomizable) {
            sendBtn.innerHTML = 'ðŸ“‹ Save & Send to PT for Costing';
            sendBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            sendBtn.classList.add('bg-orange-600', 'hover:bg-orange-700');
        } else {
            sendBtn.innerHTML = 'ðŸ“‹ Save & Send for Approval';
            sendBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            sendBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
        }
    }

    // 6. Calculations
    function calcRow(tr) {
        const qty = parseFloat(tr.querySelector('.qty').value) || 0;
        const rate = parseFloat(tr.querySelector('.rate').value) || 0;
        const disc = parseFloat(tr.querySelector('.disc').value) || 0;
        const type = tr.querySelector('.disc-type').value;

        let total = qty * rate;
        if (disc > 0) {
            total -= (type === 'percent') ? (total * disc / 100) : disc;
        }
        total = Math.max(0, total);

        tr.querySelector('.amt').textContent = `KSh ${total.toFixed(2)}`;
        calcAll();
    }

    function calcAll() {
        let sub = 0, discTotal = 0;

        document.querySelectorAll('.line-row').forEach(tr => {
            const qty = parseFloat(tr.querySelector('.qty').value) || 0;
            const rate = parseFloat(tr.querySelector('.rate').value) || 0;
            const disc = parseFloat(tr.querySelector('.disc').value) || 0;
            const type = tr.querySelector('.disc-type').value;

            const lineSub = qty * rate;
            sub += lineSub;

            if (disc > 0) {
                discTotal += (type === 'percent') ? (lineSub * disc / 100) : disc;
            }
        });

        const afterDisc = sub - discTotal;
        let tax = 0;

        if (document.getElementById('enableTax')?.checked) {
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            tax = (afterDisc * taxRate / 100);
        }

        let ship = 0;
        if (document.getElementById('enableShipping')?.checked) {
            ship = parseFloat(document.getElementById('shippingCharges').value) || 0;
        }

        let adj = 0;
        if (document.getElementById('enableAdjustment')?.checked) {
            adj = parseFloat(document.getElementById('adjustmentAmount').value) || 0;
        }

        const total = afterDisc + tax + ship + adj;

        document.getElementById('summarySubtotal').textContent = `KSh ${sub.toFixed(2)}`;
        document.getElementById('summaryDiscount').textContent = `KSh ${discTotal.toFixed(2)}`;
        document.getElementById('summaryTax').textContent = `KSh ${tax.toFixed(2)}`;
        document.getElementById('summaryTotal').textContent = total.toFixed(2);

        document.getElementById('hiddenSubtotal').value = sub.toFixed(2);
        document.getElementById('hiddenDiscount').value = discTotal.toFixed(2);
        document.getElementById('hiddenTax').value = tax.toFixed(2);
        document.getElementById('hiddenTotal').value = total.toFixed(2);
    }

    // 7. Sidebar Toggles
    document.getElementById('enableTax')?.addEventListener('change', function () {
        document.getElementById('taxSection')?.classList.toggle('hidden', !this.checked);
        calcAll();
    });
    document.getElementById('taxRate')?.addEventListener('input', calcAll);

    document.getElementById('enableShipping')?.addEventListener('change', function () {
        document.getElementById('shippingSection')?.classList.toggle('hidden', !this.checked);
        calcAll();
    });
    document.getElementById('shippingCharges')?.addEventListener('input', calcAll);

    document.getElementById('enableAdjustment')?.addEventListener('change', function () {
        document.getElementById('adjustmentSection')?.classList.toggle('hidden', !this.checked);
        calcAll();
    });
    document.getElementById('adjustmentAmount')?.addEventListener('input', calcAll);

    // 8. File list preview
    document.getElementById('fileInput')?.addEventListener('change', function () {
        const list = document.getElementById('fileList');
        if (!list) return;
        list.innerHTML = '';
        Array.from(this.files).forEach(f => {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-2 bg-gray-50 rounded text-xs';
            div.innerHTML = `<span>${f.name}</span><span class="text-gray-400">${(f.size / 1024).toFixed(1)} KB</span>`;
            list.appendChild(div);
        });
    });

    // 10. Form validation
    document.getElementById('quoteForm')?.addEventListener('submit', function (e) {
        const clientId = document.getElementById('client_id').value;
        const leadId = document.getElementById('lead_id').value;

        if (!clientId && !leadId) {
            e.preventDefault();
            alert('Please select a client or lead');
            return false;
        }

        if (tbody.querySelectorAll('.line-row').length === 0) {
            e.preventDefault();
            alert('Please add at least one product to the quote');
            return false;
        }
    });
});
</script>
{% endblock %}
<script src="/static/js/quote-create.js"></script>
