{% extends 'base.html' %}
{% load static %}

{% block title %}Create Multi-Product Quote{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Create Multi-Product Quote</h1>
            <p class="text-gray-600 mt-2">Build a comprehensive quote with multiple products</p>
        </div>

        <form method="POST" action="{% url 'quote_create' %}" id="quoteForm">
            {% csrf_token %}
            {% if existing_quote_obj %}
            <input type="hidden" name="existing_quote_id" value="{{ existing_quote_obj.quote_id }}">
            {% endif %}
            <input type="hidden" name="client_id" id="client_id">
            <input type="hidden" name="lead_id" id="lead_id">

            <!-- Client Information Card -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Client Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Client/Lead Name *</label>
                        <select name="client_name" id="client_select" required
                            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Select client or lead...</option>
                            <optgroup label="Active Clients">
                                {% for client in clients %}
                                <option value="client-{{ client.id }}">{{ client.name }} (Client)</option>
                                {% endfor %}
                            </optgroup>
                            <optgroup label="Active Leads">
                                {% for lead in leads %}
                                <option value="lead-{{ lead.id }}">{{ lead.name }} (Lead)</option>
                                {% endfor %}
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Account Manager</label>
                        <input type="text" name="account_manager" value="{{ request.user.get_full_name }}" readonly
                            class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-100 cursor-not-allowed">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Today's Date</label>
                        <input type="date" name="valid_until" id="todays_date" required readonly
                            class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-100 cursor-not-allowed">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Deadline</label>
                        <input type="date" name="delivery_deadline"
                            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
            </div>

            <!-- Products Section -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-900">Products</h2>
                    <button type="button" id="addProductBtn"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <span>Add Product</span>
                    </button>
                </div>

                <!-- Products List -->
                <div id="productsList" class="space-y-4">
                    <div id="emptyState" class="text-center py-12 border-2 border-dashed border-gray-300 rounded-lg">
                        <i data-lucide="package" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No products added yet</h3>
                        <p class="text-gray-500 mb-4">Click "Add Product" to start building your quote</p>
                        <button type="button" id="addFirstProductBtn"
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            Add Your First Product
                        </button>
                    </div>
                </div>

                <!-- Summary -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <div class="flex justify-between items-center text-sm text-gray-600 mb-2">
                        <span>Line Items:</span>
                        <span id="summaryLineItems" class="font-semibold">0</span>
                    </div>
                </div>
            </div>

            <!-- Special Instructions -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Special Instructions</h2>
                <textarea name="special_instructions" rows="4"
                    placeholder="Add any special instructions or notes for this quote..."
                    class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                <button type="button" onclick="window.history.back()"
                    class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>

                <button type="submit" name="action" value="save_draft"
                    class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                    ðŸ’¾ Save Draft
                </button>

                <button type="submit" name="action" value="save_send_pt"
                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    ðŸ“‹ Save & Send to PT for Approval
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Product Modal -->
<div id="addProductModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
            <h3 class="text-xl font-semibold text-gray-900">Select Product from Catalog</h3>
            <button type="button" id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <div class="p-6">
            <div class="mb-6">
                <input type="text" id="productSearch" placeholder="Search products..."
                    class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div id="productList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for product in products %}
                <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-500 cursor-pointer transition-colors product-item"
                    data-product-id="{{ product.id }}" data-product-name="{{ product.name }}"
                    data-product-sku="{{ product.sku }}">
                    <div class="flex gap-4">
                        <div class="w-16 h-16 bg-gray-100 rounded flex-shrink-0 flex items-center justify-center">
                            {% if product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.name }}"
                                class="w-full h-full object-cover rounded">
                            {% else %}
                            <i data-lucide="package" class="w-8 h-8 text-gray-400"></i>
                            {% endif %}
                        </div>
                        <div class="flex-1">
                            <h4 class="text-sm font-medium text-gray-900 mb-1">{{ product.name }}</h4>
                            <p class="text-xs text-gray-500 mb-2">{{ product.sku }} - {{
                                product.description|truncatewords:8 }}</p>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-span-2 text-center py-8 text-gray-500">
                    <i data-lucide="package-x" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                    <p>No products available in the catalog</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        lucide.createIcons();

        // Set today's date automatically
        const todaysDateInput = document.getElementById('todays_date');
        const today = new Date();
        const formattedDate = today.toISOString().split('T')[0];
        todaysDateInput.value = formattedDate;

        const quoteForm = document.getElementById('quoteForm');
        const productsList = document.getElementById('productsList');
        const emptyState = document.getElementById('emptyState');
        const addProductBtn = document.getElementById('addProductBtn');
        const addFirstProductBtn = document.getElementById('addFirstProductBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modal = document.getElementById('addProductModal');

        function openModal() { modal.classList.remove('hidden'); document.body.style.overflow = 'hidden'; }
        function closeModal() { modal.classList.add('hidden'); document.body.style.overflow = 'auto'; }
        addProductBtn?.addEventListener('click', openModal);
        addFirstProductBtn?.addEventListener('click', openModal);
        closeModalBtn?.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

        // Product search functionality
        const productSearch = document.getElementById('productSearch');
        productSearch?.addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase();
            document.querySelectorAll('.product-item').forEach(item => {
                const name = item.dataset.productName.toLowerCase();
                const sku = item.dataset.productSku.toLowerCase();
                if (name.includes(searchTerm) || sku.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });

        // Client/Lead selection
        const clientSelect = document.getElementById('client_select');
        const clientIdInput = document.getElementById('client_id');
        const leadIdInput = document.getElementById('lead_id');

        clientSelect?.addEventListener('change', function () {
            const val = this.value;
            clientIdInput.value = '';
            leadIdInput.value = '';
            if (val.startsWith('client-')) clientIdInput.value = val.replace('client-', '');
            if (val.startsWith('lead-')) leadIdInput.value = val.replace('lead-', '');
        });

        // Product selection from modal
        document.querySelectorAll('.product-item').forEach(item => {
            item.addEventListener('click', function () {
                addProductToList(
                    this.dataset.productId,
                    this.dataset.productName,
                    this.dataset.productSku
                );
                closeModal();
            });
        });

        function addProductToList(id, name, sku) {
            if (emptyState) emptyState.classList.add('hidden');

            const card = document.createElement('div');
            card.className = 'border border-gray-200 rounded-lg p-4 line-item';
            card.innerHTML = `
            <input type="hidden" name="product_id[]" value="${id}">
            
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1">
                    <h4 class="font-medium text-gray-900">${name}</h4>
                    <p class="text-sm text-gray-500">SKU: ${sku}</p>
                </div>
                <button type="button" class="remove-item text-red-600 hover:text-red-800">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label class="block text-xs text-gray-600 mb-1">Quantity *</label>
                    <input type="number" name="quantity[]" value="1" min="1" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
        `;
            productsList.appendChild(card);

            // Refresh icons for the new trash bin
            lucide.createIcons();

            // Remove functionality
            card.querySelector('.remove-item').addEventListener('click', () => {
                card.remove();
                if (productsList.querySelectorAll('.line-item').length === 0 && emptyState) emptyState.classList.remove('hidden');
                updateSummary();
            });

            updateSummary();
        }

        function updateSummary() {
            document.getElementById('summaryLineItems').textContent = productsList.querySelectorAll('.line-item').length;
        }

        // Form submit validation
        quoteForm.addEventListener('submit', function (e) {
            if (!clientIdInput.value && !leadIdInput.value) {
                e.preventDefault();
                alert('Please select a valid client or lead');
                return false;
            }
            // Check for products using the correct selector
            const productInputs = quoteForm.querySelectorAll('input[name="product_id[]"]');
            if (productInputs.length === 0) {
                e.preventDefault();
                alert('Please add at least one product to the quote');
                return false;
            }
        });

        updateSummary();
    });

</script>
{% endblock %}