{% extends 'base.html' %}

{% block title %}Client Onboarding - Client MIS{% endblock %}

{% block content %}
<style>
    .segmented-progress-container {
        background-color: #f3f4f6;
        border-radius: 16px;
        padding: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .segmented-progress {
        display: flex;
        justify-content: space-between;
        gap: 0.5rem;
    }

    .progress-segment {
        flex: 1;
        text-align: center;
        background-color: transparent;
        border: none;
        font-size: 0.95rem;
        font-weight: 600;
        color: #374151;
        cursor: pointer;
        transition: all 0.25s ease-in-out;
        height: 25px;
    }

    .progress-segment.active {
        background-color: #ffffff;
        color: #111827;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        height: 25px;
    }

    .progress-segment:hover:not(.active) {
        background-color: #e5e7eb;
    }

    .progress-segment:first-child {
        border-top-left-radius: 12px;
        border-bottom-left-radius: 12px;
    }

    .progress-segment:last-child {
        border-top-right-radius: 12px;
        border-bottom-right-radius: 12px;
    }
</style>

<div>
    <div class="space-y-6">
        <div>
            <h1 class="text-2xl font-semibold text-gray-900">Client Onboarding</h1>
            <p class="text-gray-600">
                {% if prefilled_lead %}
                Converting lead: {{ prefilled_lead.name }}
                {% else %}
                Create new client profile
                {% endif %}
            </p>
        </div>

        <div class="card">
            <div class="border-b border-gray-200 px-6 py-4">
                <!-- Progress Navigation Bar - Only for B2B -->
                <div class="segmented-progress-container" id="progressContainer">
                    <div class="segmented-progress">
                        <button class="progress-segment active" data-step="1">Core Details</button>
                        <button class="progress-segment" data-step="2">Contacts & Brand</button>
                        <button class="progress-segment" data-step="3">Compliance</button>
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold">Step <span id="currentStep">1</span> of <span
                                id="totalSteps">3</span></h3>
                        <p class="text-sm text-gray-600" id="stepDescription">Core client details</p>
                    </div>
                    <span id="clientTypeBadge" class="badge badge-primary">B2B</span>
                </div>
            </div>

            <div class="p-6 space-y-6">
                <form method="post" id="onboardingForm" novalidate>
                    {% csrf_token %}

                    <!-- Step 1: Core Details -->
                    <div id="step1" class="step-content">
                        <div class="space-y-6">
                            <div class="space-y-4">
                                <div>
                                    <label class="text-sm font-medium">Client Type *</label>
                                    <div class="flex gap-4 mt-2">
                                        <div class="flex items-center space-x-2 border rounded-lg p-4 flex-1 cursor-pointer hover:bg-gray-50 client-type-option"
                                            data-type="B2B">
                                            <input type="radio" name="client_type" value="B2B" id="b2b" checked
                                                class="w-4 h-4">
                                            <label for="b2b" class="flex items-center gap-2 cursor-pointer flex-1">
                                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg"
                                                    viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                    stroke-width="2">
                                                    <path d="M3 21h18"></path>
                                                    <path d="M3 10h18"></path>
                                                    <path
                                                        d="M5 6h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z">
                                                    </path>
                                                </svg>
                                                B2B Business
                                            </label>
                                        </div>
                                        <div class="flex items-center space-x-2 border rounded-lg p-4 flex-1 cursor-pointer hover:bg-gray-50 client-type-option"
                                            data-type="B2C">
                                            <input type="radio" name="client_type" value="B2C" id="b2c" class="w-4 h-4">
                                            <label for="b2c" class="flex items-center gap-2 cursor-pointer flex-1">
                                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg"
                                                    viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                    stroke-width="2">
                                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                                    <circle cx="12" cy="7" r="4"></circle>
                                                </svg>
                                                B2C Retail
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <hr class="border-gray-200">

                                <!-- B2B Fields -->
                                <div id="b2bFields">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="space-y-2">
                                            <label for="id_company" class="text-sm font-medium">Company Name *</label>
                                            {{ form.company }}
                                        </div>
                                        <div class="space-y-2">
                                            <label for="id_name" class="text-sm font-medium">Contact Person *</label>
                                            {{ form.name }}
                                        </div>
                                        <div class="space-y-2">
                                            <label for="id_email" class="text-sm font-medium">Email *</label>
                                            {{ form.email }}
                                        </div>
                                        <div class="space-y-2">
                                            <label for="id_phone" class="text-sm font-medium">Phone *</label>
                                            {{ form.phone }}
                                        </div>
                                        <div class="space-y-2">
                                            <label for="id_preferred_channel" class="text-sm font-medium">Preferred
                                                Channel</label>
                                            {{ form.preferred_channel }}
                                        </div>
                                        <div class="space-y-2">
                                            <label for="id_lead_source" class="text-sm font-medium">Lead Source</label>
                                            {{ form.lead_source }}
                                        </div>
                                        <script>
                                            // Make B2B lead source field readonly
                                            document.addEventListener('DOMContentLoaded', function () {
                                                const leadSourceField = document.getElementById('id_lead_source');
                                                if (leadSourceField) {
                                                    leadSourceField.setAttribute('readonly', 'readonly');
                                                    leadSourceField.classList.add('bg-gray-100');
                                                }
                                            });
                                        </script>
                                    </div>

                                    <!-- Financial & Credit Control - B2B Only -->
                                    <div class="mt-6">
                                        <h3 class="text-lg font-semibold">Financial & Credit Control</h3>
                                        <p class="text-sm text-gray-600 mb-4">Set up payment terms and credit limits</p>

                                        <div class="grid grid-cols-2 gap-4">
                                            <div class="space-y-2">
                                                <label for="id_vat_tax_id" class="text-sm font-medium">VAT / Tax
                                                    ID</label>
                                                {{ form.vat_tax_id }}
                                            </div>
                                            <div class="space-y-2">
                                                <label for="id_payment_terms" class="text-sm font-medium">Payment Terms
                                                    *</label>
                                                {{ form.payment_terms }}
                                            </div>
                                            <div class="space-y-2">
                                                <label for="id_risk_rating" class="text-sm font-medium">Risk
                                                    Rating</label>
                                                {{ form.risk_rating }}
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between p-4 border rounded-lg mt-4">
                                            <div class="space-y-1">
                                                <label class="text-sm font-medium">Agency / Reseller</label>
                                                <p class="text-sm text-gray-600">Mark if this client manages multiple
                                                    brands</p>
                                            </div>
                                            <label class="toggle-switch">
                                                {{ form.is_reseller }}
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>

                                        <!-- Delivery Details - B2B Only -->
                                        <div id="b2bDeliverySection" class="mt-6">
                                            <h3 class="text-lg font-semibold">Delivery Details</h3>
                                            <p class="text-sm text-gray-600 mb-4">Set up default delivery information
                                            </p>

                                            <div class="grid grid-cols-1 gap-4">
                                                <div class="space-y-2">
                                                    <label for="id_delivery_address"
                                                        class="text-sm font-medium">Delivery Address</label>
                                                    {{ form.delivery_address }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- B2C Fields -->
                                <div id="b2cFields" class="hidden">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="space-y-2">
                                            <label for="id_company_b2c" class="text-sm font-medium">Company Name
                                                (Optional)</label>
                                            <input type="text" name="company_b2c" id="id_company_b2c"
                                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                        </div>
                                        <div class="space-y-2">
                                            <label for="id_name_b2c" class="text-sm font-medium">Contact Person
                                                *</label>
                                            <input type="text" name="name_b2c" id="id_name_b2c"
                                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                required>
                                        </div>
                                        <div class="space-y-2">
                                            <label for="id_email_b2c" class="text-sm font-medium">Email
                                                (Optional)</label>
                                            <input type="email" name="email_b2c" id="id_email_b2c"
                                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                        </div>
                                        <div class="space-y-2">
                                            <label for="id_phone_b2c" class="text-sm font-medium">Phone *</label>
                                            <input type="text" name="phone_b2c" id="id_phone_b2c"
                                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                required>
                                        </div>
                                        <div class="space-y-2">
                                            <label for="id_preferred_channel_b2c" class="text-sm font-medium">Preferred
                                                Channel</label>
                                            <select name="preferred_channel_b2c" id="id_preferred_channel_b2c"
                                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                                <option value="Email">Email</option>
                                                <option value="Phone">Phone</option>
                                                <option value="WhatsApp">WhatsApp</option>
                                                <option value="In-Person">In-Person</option>
                                            </select>
                                        </div>
                                        <div class="space-y-2">
                                            <label for="id_lead_source_b2c" class="text-sm font-medium">Lead
                                                Source</label>
                                            <input type="text" name="lead_source_b2c" id="id_lead_source_b2c"
                                                class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-100 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                readonly>
                                        </div>
                                    </div>

                                    <!-- Delivery Details - B2C -->
                                    <div class="mt-6">
                                        <h3 class="text-lg font-semibold">Delivery Details</h3>
                                        <p class="text-sm text-gray-600 mb-4">Set up default delivery information</p>

                                        <div class="grid grid-cols-1 gap-4">
                                            <div class="space-y-2">
                                                <label for="id_delivery_address_b2c"
                                                    class="text-sm font-medium">Delivery Address</label>
                                                <input type="text" name="delivery_address_b2c"
                                                    id="id_delivery_address_b2c"
                                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                    placeholder="Enter delivery address">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="validationErrors" class="hidden alert alert-error"></div>
                        </div>
                    </div>

                    <!-- Step 2: Contacts & Brand (B2B Only) -->
                    <div id="step2" class="step-content hidden">
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 space-y-6">
                            <div>
                                <h2 class="text-xl font-semibold text-gray-900">Contact Management & Approvals</h2>
                                <p class="text-gray-600">Manage multiple contacts and assign approval roles for quotes
                                    and artwork</p>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                                    <input type="text"
                                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                        placeholder="Enter full name">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email"
                                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                        placeholder="Enter email">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                    <input type="text"
                                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                        placeholder="Enter phone number">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                                    <select
                                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                        <option>None</option>
                                        <option>Approve Quotes</option>
                                        <option>Approve Artwork</option>
                                        <option>Billing Contact</option>
                                    </select>
                                </div>
                                <div>
                                    <button type="button" id="addContactBtn"
                                        class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition">
                                        + Add New Contact
                                    </button>
                                </div>
                            </div>

                            <div
                                class="border border-dashed border-gray-300 rounded-lg p-6 text-center text-gray-500 bg-gray-50">
                                <p>No contacts added yet.</p>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 space-y-6 mt-8">
                            <div>
                                <h2 class="text-xl font-semibold text-gray-900">Brand Asset Library</h2>
                                <p class="text-gray-600">Upload brand guidelines, logos, and assets accessible to Design
                                    & Production teams</p>
                            </div>

                            <div
                                class="border-2 border-dashed border-gray-300 rounded-xl p-10 text-center cursor-pointer hover:border-blue-400 transition">
                                <input type="file" id="brandFiles" multiple class="hidden" />
                                <label for="brandFiles" class="block text-gray-500 cursor-pointer">
                                    <span class="text-gray-700 font-medium">Drag and drop files here, or click to
                                        browse</span>
                                </label>
                            </div>

                            <div class="text-gray-500 text-sm text-center">
                                Upload brand guides, logos, color palettes, and fonts
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Compliance (B2B Only) -->
                    <div id="step3" class="step-content hidden">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 space-y-6">
                            <div>
                                <h2 class="text-xl font-semibold text-gray-900">Compliance & Legal Documents</h2>
                                <p class="text-gray-600">Upload compliance documents for B2B clients</p>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Document Type</label>
                                    <select id="doc_type" name="doc_type"
                                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white">
                                        <option value="">Select Document Type</option>
                                        <option value="COI">Certificate of Incorporation (COI)</option>
                                        <option value="KRA">KRA Pin Certificate</option>
                                        <option value="PO Terms">Purchase Order Terms (PO Terms)</option>
                                        <option value="NDA">Non-Disclosure Agreement (NDA)</option>
                                        <option value="Other">Other Legal Document</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Expiry Date</label>
                                    <input id="doc_expiry" name="doc_expiry" type="date"
                                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white" />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Upload Document</label>
                                    <div class="flex gap-2">
                                        <button type="button" id="uploadBtn"
                                            class="bg-blue-600 text-white px-5 py-2 rounded-lg font-medium hover:bg-blue-700 transition">
                                            Choose Files
                                        </button>
                                        <input id="complianceFiles" name="compliance_files" type="file" multiple
                                            accept=".pdf,.doc,.docx,.jpg,.png" class="hidden" />
                                        <span id="filesCount" class="text-sm text-gray-600 self-center"></span>
                                    </div>
                                </div>
                            </div>

                            <div id="selectedFiles"
                                class="bg-gray-50 border border-dashed border-gray-300 p-4 rounded-lg">
                                <p id="noFiles" class="text-gray-600">No files selected</p>
                                <ul id="filesList" class="mt-2 space-y-2"></ul>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="flex justify-between pt-4 border-t border-gray-200">
                        <button type="button" id="prevBtn" onclick="previousStep(event)" class="btn btn-secondary"
                            disabled>Previous</button>
                        <button type="button" id="nextBtn" onclick="nextStep(event)"
                            class="btn btn-primary">Next</button>
                        <button type="submit" id="submitBtn" class="btn btn-primary hidden">
                            <svg class="w-4 h-4 mr-2 inline" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                            Save Client
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    let currentStep = 1;
    let totalSteps = 3;
    let clientType = 'B2B';
    
    // Global file storage Maps
    let brandFiles = new Map();  // For brand assets
    let complianceFiles = new Map();  // For compliance documents

    // Initialize fields on page load (B2B is default)
    window.addEventListener('load', function() {
        // Enable B2B fields by default
        addRequiredToB2B();
        // Disable B2C fields by default
        removeRequiredFromB2C();
    });

    // Client Type Selection
    document.querySelectorAll('.client-type-option').forEach(option => {
        option.addEventListener('click', function () {
            const type = this.dataset.type;
            clientType = type;

            // Update radio button
            document.getElementById(type.toLowerCase()).checked = true;

            // Update badge
            document.getElementById('clientTypeBadge').textContent = type;
            document.getElementById('clientTypeBadge').className = type === 'B2B'
                ? 'badge badge-primary'
                : 'badge badge-success';

            // Toggle fields and handle required attributes
            if (type === 'B2C') {
                // Hide B2B fields
                document.getElementById('b2bFields').classList.add('hidden');
                document.getElementById('b2cFields').classList.remove('hidden');
                document.getElementById('progressContainer').classList.add('hidden');

                // Remove 'required' from B2B fields (they're hidden)
                removeRequiredFromB2B();

                // Add 'required' to B2C fields
                addRequiredToB2C();

                totalSteps = 1;
                document.getElementById('totalSteps').textContent = '1';
                document.getElementById('stepDescription').textContent = 'Client contact information';
            } else {
                // Show B2B fields
                document.getElementById('b2bFields').classList.remove('hidden');
                document.getElementById('b2cFields').classList.add('hidden');
                document.getElementById('progressContainer').classList.remove('hidden');

                // Remove 'required' from B2C fields (they're hidden)
                removeRequiredFromB2C();

                // Add 'required' to B2B fields
                addRequiredToB2B();

                totalSteps = 3;
                document.getElementById('totalSteps').textContent = '3';
                document.getElementById('stepDescription').textContent = 'Core client details';
            }

            updateButtons();
        });
    });

    // Helper functions to manage required attributes
    function removeRequiredFromB2B() {
        // All B2B fields including B2B-only fields
        const b2bFields = [
            'id_company', 'id_name', 'id_email', 'id_phone',
            'id_vat_tax_id', 'id_kra_pin', 'id_industry', 'id_payment_terms',
            'id_credit_limit', 'id_default_markup', 'id_risk_rating', 'id_is_reseller',
            'id_delivery_address'
        ];
        b2bFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.removeAttribute('required');
                field.disabled = true; // Disable so they don't submit
            }
        });
    }

    function addRequiredToB2B() {
        // All B2B fields including B2B-only fields
        const b2bFields = [
            'id_company', 'id_name', 'id_email', 'id_phone',
            'id_vat_tax_id', 'id_kra_pin', 'id_industry', 'id_payment_terms',
            'id_credit_limit', 'id_default_markup', 'id_risk_rating', 'id_is_reseller',
            'id_delivery_address'
        ];
        b2bFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.setAttribute('required', 'required');
                field.disabled = false; // Enable for submission
            }
        });
    }

    function removeRequiredFromB2C() {
        const b2cFields = ['id_name_b2c', 'id_phone_b2c'];
        b2cFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.removeAttribute('required');
                field.disabled = true; // Disable so they don't submit
            }
        });

        const emailField = document.getElementById('id_email_b2c');
        if (emailField) {
            emailField.removeAttribute('required');
        }
    }

    function addRequiredToB2C() {
        const b2cFields = ['id_name_b2c', 'id_phone_b2c'];
        b2cFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.setAttribute('required', 'required');
                field.disabled = false; // Enable for submission
            }
        });

        const emailField = document.getElementById('id_email_b2c');
        if (emailField) {
            emailField.removeAttribute('required');
        }
    }

    // Clickable step segments (B2B only)
    document.querySelectorAll('.progress-segment').forEach(tab => {
        tab.addEventListener('click', function () {
            if (clientType === 'B2B') {
                const targetStep = parseInt(this.dataset.step);
                goToStep(targetStep);
            }
        });
    });

    function goToStep(step) {
        if (clientType === 'B2C') return;

        // Hide all steps
        document.querySelectorAll('.step-content').forEach(c => c.classList.add('hidden'));

        // Show target step
        const target = document.getElementById('step' + step);
        if (target) target.classList.remove('hidden');

        // Update progress bar
        document.querySelectorAll('.progress-segment').forEach(t => t.classList.remove('active'));
        const seg = document.querySelector(`.progress-segment[data-step="${step}"]`);
        if (seg) seg.classList.add('active');

        currentStep = step;
        updateProgress();
        updateButtons();
    }

    function nextStep(e) {
        e.preventDefault();

        if (!validateStep(currentStep)) {
            return;
        }

        if (clientType === 'B2C') {
            return;
        }

        // B2B flow - move to next step
        if (currentStep < totalSteps) {
            document.getElementById('step' + currentStep).classList.add('hidden');
            currentStep++;
            document.getElementById('step' + currentStep).classList.remove('hidden');

            // Update progress segment
            document.querySelectorAll('.progress-segment').forEach(t => t.classList.remove('active'));
            const seg = document.querySelector(`.progress-segment[data-step="${currentStep}"]`);
            if (seg) seg.classList.add('active');
        }

        updateProgress();
        updateButtons();
    }

    function previousStep(e) {
        e.preventDefault();
        if (clientType === 'B2C' || currentStep === 1) return;

        document.getElementById('step' + currentStep).classList.add('hidden');
        currentStep--;
        document.getElementById('step' + currentStep).classList.remove('hidden');

        // Update progress segment
        document.querySelectorAll('.progress-segment').forEach(t => t.classList.remove('active'));
        const seg = document.querySelector(`.progress-segment[data-step="${currentStep}"]`);
        if (seg) seg.classList.add('active');

        updateProgress();
        updateButtons();
    }

    function validateStep(step) {
        const errors = [];
        const errorDiv = document.getElementById('validationErrors');

        if (clientType === 'B2B') {
            if (step === 1) {
                const company = document.getElementById('id_company');
                const name = document.getElementById('id_name');
                const email = document.getElementById('id_email');
                const phone = document.getElementById('id_phone');

                if (company && !company.value.trim()) errors.push('Company Name is required');
                if (name && !name.value.trim()) errors.push('Contact Person is required');
                if (email && !email.value.trim()) errors.push('Email is required');
                if (phone && !phone.value.trim()) errors.push('Phone is required');
            }
        } else {
            const name = document.getElementById('id_name_b2c');
            const phone = document.getElementById('id_phone_b2c');

            if (name && !name.value.trim()) errors.push('Contact Person is required');
            if (phone && !phone.value.trim()) errors.push('Phone is required');
        }

        if (errors.length > 0) {
            const html = '<strong>Please fix the following:</strong><ul>' +
                errors.map(e => `<li>${e}</li>`).join('') + '</ul>';

            if (errorDiv) {
                errorDiv.innerHTML = html;
                errorDiv.classList.remove('hidden');
            } else {
                alert('Please fix the following:\n' + errors.join('\n'));
            }
            return false;
        } else {
            if (errorDiv) errorDiv.classList.add('hidden');
            return true;
        }
    }

    function updateButtons() {
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');

        if (!prevBtn || !nextBtn || !submitBtn) return;

        prevBtn.disabled = currentStep === 1;

        if (clientType === 'B2C') {
            nextBtn.classList.add('hidden');
            submitBtn.classList.remove('hidden');
            prevBtn.classList.add('hidden');
        } else {
            prevBtn.classList.remove('hidden');
            if (currentStep === totalSteps) {
                nextBtn.classList.add('hidden');
                submitBtn.classList.remove('hidden');
            } else {
                nextBtn.classList.remove('hidden');
                submitBtn.classList.add('hidden');
            }
        }
    }

    function updateProgress() {
        const currentStepEl = document.getElementById('currentStep');
        if (currentStepEl) {
            currentStepEl.textContent = currentStep;
        }

        const descriptions = {
            1: 'Core client details',
            2: 'Contacts & Brand',
            3: 'Compliance'
        };
        const stepDescEl = document.getElementById('stepDescription');
        if (stepDescEl && descriptions[currentStep]) {
            stepDescEl.textContent = descriptions[currentStep];
        }
    }

    // Prefill Data Handling
    {% if prefilled_lead %}
    document.addEventListener('DOMContentLoaded', function () {
        const prefilledData = {{ prefilled_lead| safe
    }};

    if (prefilledData.name) {
        const b2bName = document.getElementById('id_name');
        const b2cName = document.getElementById('id_name_b2c');
        if (b2bName) b2bName.value = prefilledData.name;
        if (b2cName) b2cName.value = prefilledData.name;
    }
    if (prefilledData.email) {
        const b2bEmail = document.getElementById('id_email');
        const b2cEmail = document.getElementById('id_email_b2c');
        if (b2bEmail) b2bEmail.value = prefilledData.email;
        if (b2cEmail) b2cEmail.value = prefilledData.email;
    }
    if (prefilledData.phone) {
        const b2bPhone = document.getElementById('id_phone');
        const b2cPhone = document.getElementById('id_phone_b2c');
        if (b2bPhone) b2bPhone.value = prefilledData.phone;
        if (b2cPhone) b2cPhone.value = prefilledData.phone;
    }
    if (prefilledData.preferred_channel) {
        const b2bChannel = document.getElementById('id_preferred_channel');
        const b2cChannel = document.getElementById('id_preferred_channel_b2c');
        if (b2bChannel) b2bChannel.value = prefilledData.preferred_channel;
        if (b2cChannel) b2cChannel.value = prefilledData.preferred_channel;
    }
    if (prefilledData.lead_source) {
        const b2bSource = document.getElementById('id_lead_source');
        const b2cSource = document.getElementById('id_lead_source_b2c');
        if (b2bSource) b2bSource.value = prefilledData.lead_source;
        if (b2cSource) b2cSource.value = prefilledData.lead_source;
    }
    });
    {% endif %}

    // Contact Management
    document.addEventListener('DOMContentLoaded', function () {
        const addContactBtn = document.getElementById('addContactBtn');
        if (addContactBtn) {
            addContactBtn.addEventListener('click', function (e) {
                e.preventDefault();

                const step2 = document.getElementById('step2');
                const inputs = step2.querySelectorAll('input');
                const nameInput = inputs[0];
                const emailInput = inputs[1];
                const phoneInput = inputs[2];
                const roleSelect = step2.querySelector('select');

                const currentName = nameInput ? nameInput.value : '';
                const currentEmail = emailInput ? emailInput.value : '';
                const currentPhone = phoneInput ? phoneInput.value : '';
                const currentRole = roleSelect ? roleSelect.value : 'None';

                if (!currentName) {
                    alert('Please enter a contact name');
                    return;
                }

                const container = document.createElement('div');
                container.classList.add('contact-item', 'p-4', 'border', 'rounded-lg', 'mt-4', 'bg-gray-50');
                container.innerHTML = `
                <div class="grid grid-cols-4 gap-4">
                    <input type="text" name="contact_name[]" placeholder="Full Name" class="border rounded-lg px-3 py-2" value="${currentName}" required>
                    <input type="email" name="contact_email[]" placeholder="Email" class="border rounded-lg px-3 py-2" value="${currentEmail}">
                    <input type="text" name="contact_phone[]" placeholder="Phone" class="border rounded-lg px-3 py-2" value="${currentPhone}">
                    <select name="contact_role[]" class="border rounded-lg px-3 py-2">
                        <option value="None" ${currentRole === 'None' ? 'selected' : ''}>None</option>
                        <option value="Approve Quotes" ${currentRole === 'Approve Quotes' ? 'selected' : ''}>Approve Quotes</option>
                        <option value="Approve Artwork" ${currentRole === 'Approve Artwork' ? 'selected' : ''}>Approve Artwork</option>
                        <option value="Billing Contact" ${currentRole === 'Billing Contact' ? 'selected' : ''}>Billing Contact</option>
                    </select>
                </div>
                <button type="button" class="mt-2 text-red-600 text-sm hover:underline remove-contact">Remove</button>
            `;

                container.querySelector('.remove-contact').addEventListener('click', function () {
                    container.remove();
                });

                const target = document.querySelector('#step2 .border-dashed');
                if (target) {
                    target.parentNode.insertBefore(container, target);
                    target.classList.add('hidden');
                }

                if (nameInput) nameInput.value = '';
                if (emailInput) emailInput.value = '';
                if (phoneInput) phoneInput.value = '';
                if (roleSelect) roleSelect.value = 'None';
            });
        }
    });

    // Brand Asset Upload
    document.addEventListener('DOMContentLoaded', function () {
        const brandDropZone = document.querySelector('.border-2.border-dashed');
        const brandFileInput = document.getElementById('brandFiles');
        const brandAssetTypeSelect = document.createElement('select');
        brandAssetTypeSelect.id = 'brand_asset_type';
        brandAssetTypeSelect.name = 'brand_asset_type';
        brandAssetTypeSelect.className = 'w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white';
        brandAssetTypeSelect.innerHTML = `
        <option value="Logo">Logo</option>
        <option value="Brand Guide">Brand Guidelines</option>
        <option value="Color Palette">Color Palette</option>
        <option value="Font">Font Files</option>
        <option value="Other">Other</option>
    `;

        if (brandDropZone) {
            const typeContainer = document.createElement('div');
            typeContainer.className = 'mb-4';
            typeContainer.innerHTML = '<label class="block text-sm font-medium text-gray-700 mb-1">Asset Type</label>';
            typeContainer.appendChild(brandAssetTypeSelect);
            brandDropZone.parentNode.insertBefore(typeContainer, brandDropZone);
        }

        if (brandDropZone && brandFileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                brandDropZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
            });

            brandDropZone.addEventListener('drop', e => {
                handleBrandFiles(e.dataTransfer.files);
            }, false);

            brandDropZone.addEventListener('click', () => brandFileInput.click());
            brandFileInput.addEventListener('change', (e) => handleBrandFiles(e.target.files));

            function handleBrandFiles(files) {
                Array.from(files).forEach(file => {
                    const key = `${file.name}_${file.size}_${file.lastModified}`;
                    if (!brandFiles.has(key)) brandFiles.set(key, file);
                });
                renderBrandFiles();
            }

            function renderBrandFiles() {
                const fileList = document.createElement('div');
                fileList.className = 'mt-4 space-y-2';
                fileList.id = 'brandFileList';

                brandFiles.forEach((file, key) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'flex items-center justify-between bg-white p-2 rounded border';
                    fileItem.innerHTML = `
                        <div class="text-sm">
                            <div>${file.name}</div>
                            <div class="text-xs text-gray-500">${(file.size / 1024).toFixed(1)} KB</div>
                        </div>
                        <button type="button" class="text-red-600 text-sm hover:underline remove-brand-file" data-key="${key}">Remove</button>
                    `;
                    fileList.appendChild(fileItem);
                });

                const existingList = document.getElementById('brandFileList');
                if (existingList) existingList.remove();
                if (brandFiles.size > 0) {
                    brandDropZone.parentNode.appendChild(fileList);
                    document.querySelectorAll('.remove-brand-file').forEach(btn => {
                        btn.addEventListener('click', function () {
                            brandFiles.delete(this.getAttribute('data-key'));
                            renderBrandFiles();
                        });
                    });
                }
            }
        }

        // Compliance Upload
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('complianceFiles');
        const filesList = document.getElementById('filesList');
        const noFiles = document.getElementById('noFiles');
        const filesCount = document.getElementById('filesCount');

        if (uploadBtn && fileInput) {
            uploadBtn.addEventListener('click', e => { e.preventDefault(); fileInput.click(); });
            fileInput.addEventListener('change', e => {
                Array.from(e.target.files).forEach(file => {
                    const key = `${file.name}__${file.size}__${file.lastModified}`;
                    if (!complianceFiles.has(key)) complianceFiles.set(key, file);
                });
                renderFiles();
                fileInput.value = '';
            });

            function renderFiles() {
                if (!filesList || !noFiles || !filesCount) return;
                filesList.innerHTML = '';
                if (complianceFiles.size === 0) {
                    noFiles.style.display = 'block';
                    filesCount.textContent = '';
                    return;
                }
                noFiles.style.display = 'none';
                filesCount.textContent = `${complianceFiles.size} file(s) selected`;

                complianceFiles.forEach((file, key) => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between bg-white p-2 rounded border';
                    li.innerHTML = `
                        <div class="text-sm">
                            <div>${file.name}</div>
                            <div class="text-xs text-gray-500">${Math.round(file.size / 1024)} KB</div>
                        </div>
                        <button type="button" class="text-red-600 text-sm hover:underline remove-file" data-key="${key}">Remove</button>
                    `;
                    li.querySelector('.remove-file').addEventListener('click', function () {
                        complianceFiles.delete(this.getAttribute('data-key'));
                        renderFiles();
                    });
                    filesList.appendChild(li);
                });
            }

            const form = document.getElementById('onboardingForm');
            if (form) {
                form.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    if (!validateStep(currentStep)) {
                        return;
                    }

                    const submitBtn = document.getElementById('submitBtn');
                    const originalText = submitBtn?.innerHTML;
                    
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = 'Saving...';
                    }

                    try {
                        // Collect form data BEFORE disabling fields
                        const formData = new FormData(form);
                        const clientData = {};
                        
                        // Get client type to know which fields are allowed
                        const clientType = formData.get('client_type') || 'B2B';

                        // Map B2C field names to API field names
                        const fieldNameMap = {
                            'name_b2c': 'name',
                            'company_b2c': 'company',
                            'email_b2c': 'email',
                            'phone_b2c': 'phone',
                            'preferred_channel_b2c': 'preferred_channel',
                            'lead_source_b2c': 'lead_source',
                            'delivery_address_b2c': 'delivery_address',
                        };

                        // Collect all fields (only client fields, not contact fields)
                        const allFormData = new FormData(form);
                        for (let [key, value] of allFormData.entries()) {
                            // Skip contact fields, button values, and file inputs
                            if (!key.includes('contact_') && !key.startsWith('submit') && !(value instanceof File)) {
                                // Convert to string and trim, only add if not empty
                                const stringValue = String(value).trim();
                                if (stringValue !== '') {
                                    // Map B2C field names to standard names
                                    const apiKey = fieldNameMap[key] || key;
                                    
                                    // For B2C clients, exclude B2B-only fields
                                    if (clientType === 'B2C') {
                                        const b2bOnlyFields = [
                                            'company', 'vat_tax_id', 'kra_pin', 'industry',
                                            'credit_limit', 'default_markup', 'risk_rating', 'is_reseller'
                                        ];
                                        if (b2bOnlyFields.includes(apiKey)) {
                                            continue; // Skip this field for B2C
                                        }
                                    }
                                    
                                    if (key === 'is_reseller') {
                                        // Handle checkbox
                                        clientData[apiKey] = stringValue === 'on' || stringValue === 'true';
                                    } else {
                                        clientData[apiKey] = stringValue;
                                    }
                                }
                            }
                        }
                        
                        // Validate required fields
                        if (!clientData.name) {
                            showToast('Contact Person is required', 'warning');
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalText;
                            }
                            return;
                        }
                        
                        // Email is required for B2B, optional for B2C
                        if (clientType === 'B2B' && !clientData.email) {
                            showToast('Email is required for B2B clients', 'warning');
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalText;
                            }
                            return;
                        }
                        
                        if (!clientData.phone) {
                            showToast('Phone is required', 'warning');
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalText;
                            }
                            return;
                        }
                        
                        // For B2B, ensure company is set
                        if (clientType === 'B2B' && !clientData.company) {
                            showToast('Company Name is required for B2B clients', 'warning');
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalText;
                            }
                            return;
                        }

                        // Collect contacts for later (contacts field is read-only, must be created separately)
                        const contacts = [];
                        const contactNames = formData.getAll('contact_name[]') || [];
                        const contactEmails = formData.getAll('contact_email[]') || [];
                        const contactPhones = formData.getAll('contact_phone[]') || [];
                        const contactRoles = formData.getAll('contact_role[]') || [];

                        for (let i = 0; i < contactNames.length; i++) {
                            if (contactNames[i]) {
                                contacts.push({
                                    full_name: contactNames[i],
                                    email: contactEmails[i] || '',
                                    phone: contactPhones[i] || '',
                                    role: contactRoles[i] || 'General Contact',
                                    is_primary: i === 0
                                });
                            }
                        }

                        console.log('Client data to send:', clientData);

                        // Create client via API (DO NOT include contacts - field is read-only)
                        const response = await api.post('/clients/', clientData);

                        showToast('Client created successfully!', 'success');

                        // For B2B clients, save contacts, brand assets, and compliance documents
                        if (clientType === 'B2B') {
                            try {
                                // Save contacts
                                for (const contact of contacts) {
                                    contact.client = response.id;
                                    await api.post('/client-contacts/', contact);
                                }

                                // Save brand assets (files)
                                if (brandFiles.size > 0) {
                                    for (const [key, file] of brandFiles.entries()) {
                                        const brandFormData = new FormData();
                                        brandFormData.append('file', file);
                                        brandFormData.append('client', response.id);
                                        brandFormData.append('asset_type', document.getElementById('brand_asset_type')?.value || 'Logo');
                                        
                                        // Upload brand asset
                                        const csrfToken = getCookie('csrftoken');
                                        const brandResponse = await fetch('/api/v1/brand-assets/', {
                                            method: 'POST',
                                            headers: {
                                                'X-CSRFToken': csrfToken,
                                            },
                                            body: brandFormData
                                        });
                                        if (!brandResponse.ok) {
                                            console.error('Failed to upload brand asset:', file.name);
                                        }
                                    }
                                }

                                // Save compliance documents (files)
                                const docType = document.getElementById('doc_type')?.value;
                                const docExpiry = document.getElementById('doc_expiry')?.value;
                                
                                if (complianceFiles.size > 0 && docType) {
                                    for (const [key, file] of complianceFiles.entries()) {
                                        const complianceFormData = new FormData();
                                        complianceFormData.append('file', file);
                                        complianceFormData.append('client', response.id);
                                        complianceFormData.append('document_type', docType);
                                        if (docExpiry) {
                                            complianceFormData.append('expiry_date', docExpiry);
                                        }
                                        
                                        // Upload compliance document
                                        const csrfToken = getCookie('csrftoken');
                                        const compResponse = await fetch('/api/v1/compliance-documents/', {
                                            method: 'POST',
                                            headers: {
                                                'X-CSRFToken': csrfToken,
                                            },
                                            body: complianceFormData
                                        });
                                        if (!compResponse.ok) {
                                            console.error('Failed to upload compliance document:', file.name);
                                        }
                                    }
                                }

                                showToast('All client data saved successfully!', 'success');
                            } catch (error) {
                                console.error('Error saving contacts/assets/documents:', error);
                                showToast('Client created but some attachments could not be saved', 'warning');
                            }
                        }
                        
                        setTimeout(() => {
                            window.location.href = `/clients/${response.id}/`;
                        }, 1500);

                    } catch (error) {
                        console.error('Error creating client:', error);
                        console.error('Error details:', error.data || error.message);
                        
                        // Show detailed error message
                        let errorMsg = 'Failed to create client';
                        if (error.data && typeof error.data === 'object') {
                            // If error.data has field-specific errors
                            if (error.data.detail) {
                                errorMsg = error.data.detail;
                            } else {
                                // Show first error if it's a dict of field errors
                                const firstError = Object.values(error.data)[0];
                                if (Array.isArray(firstError)) {
                                    errorMsg = firstError[0];
                                } else if (typeof firstError === 'string') {
                                    errorMsg = firstError;
                                } else {
                                    errorMsg = JSON.stringify(error.data).substring(0, 200);
                                }
                            }
                        } else if (error.message) {
                            errorMsg = error.message;
                        }
                        
                        showToast(`Error: ${errorMsg}`, 'error');
                        
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalText;
                        }
                    }
                });
            }
        }
    });
</script>
{% endblock %}