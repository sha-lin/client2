{% extends 'base.html' %}

{% block title %}Client Onboarding - Client MIS{% endblock %}

{% block content %}
<style>
.segmented-progress-container {
    background-color: #f3f4f6; 
    border-radius: 16px; 
    padding: 0.5rem;
    margin-bottom: 1.5rem;
}

.segmented-progress {
    display: flex;
    justify-content: space-between;
    gap: 0.5rem;

}

.progress-segment {
    flex: 1;
    text-align: center;
    background-color: transparent;
    border: none;
    /* border-radius: 10px;
    padding: 0.9rem 1.2rem; */
    font-size: 0.95rem;
    font-weight: 600;
    color: #374151;
    cursor: pointer;
    transition: all 0.25s ease-in-out;
    height: 25px;
}

.progress-segment.active {
    background-color: #ffffff; 
    color: #111827;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
    height: 25px;
}

.progress-segment:hover:not(.active) {
    background-color: #e5e7eb; 
}

.progress-segment:first-child {
    border-top-left-radius: 12px;
    border-bottom-left-radius: 12px;
}

.progress-segment:last-child {
    border-top-right-radius: 12px;
    border-bottom-right-radius: 12px;
}

</style>
<!-- Top Navigation Bar -->
<div class="fixed top-0 left-0 right-0 bg-blue-900 text-white h-14 flex items-center justify-between px-6 z-50">
    <div class="flex items-center gap-8">
        <h1 class="text-xl font-bold">Print Duka</h1>
        
    </div>
    <div class="flex items-center gap-4">
        <button class="relative hover:bg-blue-800 p-2 rounded-lg">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        </button>
        <button class="relative hover:bg-blue-800 p-2 rounded-lg">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
            </svg>
            <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
        </button>
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-700 rounded-full flex items-center justify-center font-semibold text-sm">
                JK
            </div>
            <div class="text-sm">
                <p class="font-medium">Jane Kamau</p>
                <p class="text-xs text-blue-300">Account Manager</p>
            </div>
        </div>
    </div>
</div>

<div class="pt-14">

<div class="space-y-6">
    <div>
        <h1 class="text-2xl font-semibold text-gray-900">Client Onboarding</h1>
        <p class="text-gray-600">
            {% if prefilled_lead %}
            Converting lead: {{ prefilled_lead.name }}
            {% else %}
            Create new client profile
            {% endif %}
        </p>
    </div>
    
    <div class="card">
        <div class="border-b border-gray-200 px-6 py-4">
            <!-- Step Navigation Bar -->
<!-- Progress Navigation Bar -->
<div class="segmented-progress-container">
  <div class="segmented-progress">
    <button class="progress-segment active" data-step="1">Core Details</button>
    <button class="progress-segment" data-step="2">Contacts & Brand</button>
    <button class="progress-segment" data-step="3">Compliance</button>
    
  </div>
</div>


            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold">Step <span id="currentStep">1</span> of <span id="totalSteps">3</span></h3>
                    <p class="text-sm text-gray-600" id="stepDescription">Core client details</p>
                </div>
                <span id="clientTypeBadge" class="badge badge-primary">B2B</span>
            </div>
        </div>
        
        <div class="p-6 space-y-6">
            <!-- Progress Bar -->
            
            
            <form method="post" id="onboardingForm">
                {% csrf_token %}
                
                <!-- Step 1: Core Details -->
                <div id="step1" class="step-content">
                    <div class="space-y-6">
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm font-medium">Client Type *</label>
                                <div class="flex gap-4 mt-2">
                                    <div class="flex items-center space-x-2 border rounded-lg p-4 flex-1 cursor-pointer hover:bg-gray-50 client-type-option" data-type="B2B">
                                        <input type="radio" name="client_type" value="B2B" id="b2b" checked class="w-4 h-4">
                                        <label for="b2b" class="flex items-center gap-2 cursor-pointer flex-1">
                                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18"></path><path d="M3 10h18"></path><path d="M5 6h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z"></path></svg>
                                            B2B Company
                                        </label>
                                    </div>
                                    <div class="flex items-center space-x-2 border rounded-lg p-4 flex-1 cursor-pointer hover:bg-gray-50 client-type-option" data-type="B2C">
                                        <input type="radio" name="client_type" value="B2C" id="b2c" class="w-4 h-4">
                                        <label for="b2c" class="flex items-center gap-2 cursor-pointer flex-1">
                                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                            B2C Individual
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <hr class="border-gray-200">
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-2" id="companyField">
                                    <label for="id_company" class="text-sm font-medium">Company Name *</label>
                                    {{ form.company }}
                                </div>
                                <div class="space-y-2">
                                    <label for="id_name" class="text-sm font-medium" id="nameLabel">Contact Person *</label>
                                    {{ form.name }}
                                </div>
                                <div class="space-y-2">
                                    <label for="id_email" class="text-sm font-medium">Email *</label>
                                    {{ form.email }}
                                </div>
                                <div class="space-y-2">
                                    <label for="id_phone" class="text-sm font-medium">Phone *</label>
                                    {{ form.phone }}
                                </div>
                                <div class="space-y-2">
                                    <label for="id_preferred_channel" class="text-sm font-medium">Preferred Channel</label>
                                    {{ form.preferred_channel }}
                                </div>
                                <div class="space-y-2">
                                    <label for="id_lead_source" class="text-sm font-medium">Lead Source</label>
                                    {{ form.lead_source }}
                                </div>
                            </div>
                        </div>
                        
                        <div id="validationErrors" class="hidden alert alert-error"></div>
                    </div>
                
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold">Financial & Credit Control</h3>
                            <p class="text-sm text-gray-600">Set up payment terms and credit limits</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label for="id_vat_tax_id" class="text-sm font-medium">VAT / Tax ID</label>
                                {{ form.vat_tax_id }}
                            </div>
                            <div class="space-y-2">
                                <label for="id_payment_terms" class="text-sm font-medium">Payment Terms *</label>
                                {{ form.payment_terms }}
                            </div>
                            <div class="space-y-2">
                                <label for="id_credit_limit" class="text-sm font-medium">Default AM Markup(%)</label>
                                {{ form.credit_limit }}
                            </div>
                            <div class="space-y-2">
                                <label for="id_risk_rating" class="text-sm font-medium">Risk Rating</label>
                                {{ form.risk_rating }}
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between p-4 border rounded-lg">
                            <div class="space-y-1">
                                <label class="text-sm font-medium">Agency / Reseller</label>
                                <p class="text-sm text-gray-600">Mark if this client manages multiple brands</p>
                            </div>
                            <label class="toggle-switch">
                                {{ form.is_reseller }}
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Step 2 for B2C (Complete) -->
                <div id="step2B2C" class="step-content hidden">
                    <div class="space-y-6">
                        <div class="text-center p-8 border rounded-lg bg-blue-50">
                            <svg class="w-16 h-16 mx-auto mb-4 text-green-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                            <h3 class="text-lg font-semibold">Quick Setup Complete!</h3>
                            <p class="text-gray-600 mt-2">B2C clients are set to <strong>Prepaid Before Production</strong> by default.</p>
                            <p class="text-sm text-gray-600 mt-4">Click "Activate Client" to complete onboarding.</p>
                        </div>
                        
                        <div class="p-4 border rounded-lg space-y-3">
                            <h4 class="font-semibold">Summary</h4>
                            <div class="grid grid-cols-2 gap-3 text-sm">
                                <div>
                                    <span class="text-gray-600">Name:</span>
                                    <p id="summaryName"></p>
                                </div>
                                <div>
                                    <span class="text-gray-600">Email:</span>
                                    <p id="summaryEmail"></p>
                                </div>
                                <div>
                                    <span class="text-gray-600">Phone:</span>
                                    <p id="summaryPhone"></p>
                                </div>
                                <div>
                                    <span class="text-gray-600">Payment:</span>
                                    <p><span class="badge badge-primary">Prepaid</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 3: Contacts & Brand (B2B) -->
<div id="step2" class="step-content hidden">
  <!-- CONTACT MANAGEMENT -->
  <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 space-y-6">
    <div>
      <h2 class="text-xl font-semibold text-gray-900">Contact Management & Approvals</h2>
      <p class="text-gray-600">
        Manage multiple contacts and assign approval roles for quotes and artwork
      </p>
    </div>

   

    <!-- Form Fields -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
        <input type="text"
          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
          placeholder="Enter full name">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
        <input type="email"
          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
          placeholder="Enter email">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
        <input type="text"
          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
          placeholder="Enter phone number">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
        <select
          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
          <option>None</option>
          <option>Approve Quotes</option>
          <option>Approve Artwork</option>
          <option>Billing Contact</option>
        </select>
      </div>
       <!-- Add New Contact Button -->
    <div>
      <button
        type="button"
        class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition">
        + Add New Contact
      </button>
    </div>
    </div>

    <!-- Empty State -->
    <div
      class="border border-dashed border-gray-300 rounded-lg p-6 text-center text-gray-500 bg-gray-50">
      <p>No contacts added yet.</p>
    </div>
  </div>

  <!-- BRAND ASSET LIBRARY -->
  <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 space-y-6 mt-8">
    <div>
      <h2 class="text-xl font-semibold text-gray-900">Brand Asset Library</h2>
      <p class="text-gray-600">
        Upload brand guidelines, logos, and assets accessible to Design & Production teams
      </p>
    </div>

    <!-- Upload Box -->
    <div
      class="border-2 border-dashed border-gray-300 rounded-xl p-10 text-center cursor-pointer hover:border-blue-400 transition">
      <input type="file" id="brandFiles" multiple class="hidden" />
      <label for="brandFiles" class="block text-gray-500 cursor-pointer">
        <span class="text-gray-700 font-medium">
          Drag and drop files here, or click to browse
        </span>
      </label>
    </div>

    <!-- Helper Text -->
    <div class="text-gray-500 text-sm text-center">
      Upload brand guides, logos, color palettes, and fonts
    </div>
  </div>
</div>


<!-- Step 3: Compliance & Activation (B2B) -->
<div id="step3" class="step-content hidden">
  <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 space-y-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
      <!-- Document Type -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Document Type</label>
        <select id="doc_type" name="doc_type"
          class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white">
          <option value="">Select Document Type</option>
          <option value="coi">Certificate of Incorporation (COI)</option>
          <option value="kra">KRA Pin Certificate</option>
          <option value="po_terms">Purchase Order Terms (PO Terms)</option>
          <option value="nda">Non-Disclosure Agreement (NDA)</option>
          <option value="other">Other Legal Document</option>
        </select>
      </div>

      <!-- Expiry Date -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Expiry Date</label>
        <input id="doc_expiry" name="doc_expiry" type="date"
          class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white" />
      </div>

      <!-- Upload -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Upload Document</label>
        <div class="flex gap-2">
          <button type="button" id="uploadBtn"
            class="bg-blue-600 text-white px-5 py-2 rounded-lg font-medium hover:bg-blue-700 transition">
            Choose Files
          </button>
          <input id="complianceFiles" name="compliance_files" type="file" multiple accept=".pdf,.doc,.docx,.jpg,.png" class="hidden" />
          <span id="filesCount" class="text-sm text-gray-600 self-center"></span>
        </div>
      </div>
    </div>

    <div id="selectedFiles" class="bg-gray-50 border border-dashed border-gray-300 p-4 rounded-lg">
      <p id="noFiles" class="text-gray-600">No files selected</p>
      <ul id="filesList" class="mt-2 space-y-2"></ul>
    </div>
  </div>
</div>





                
                <!-- Navigation Buttons -->
                <div class="flex justify-between pt-4 border-t border-gray-200">
                    <button type="button" id="prevBtn" onclick="previousStep(event)" class="btn btn-secondary" disabled>Previous</button>
                    <button type="button" id="nextBtn" onclick="nextStep(event)" class="btn btn-primary">Next</button>
                    <button type="submit" id="submitBtn" class="btn btn-primary hidden">
                        <svg class="w-4 h-4 mr-2 inline" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                        Activate Client
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block extra_js %}

<script>
let currentStep = 1;
let totalSteps = 3;

// Clickable step segments
document.querySelectorAll('.progress-segment').forEach(tab => {
  tab.addEventListener('click', function () {
    const targetStep = parseInt(this.dataset.step);
    goToStep(targetStep);
  });
});

function goToStep(step) {
  // Hide all steps
  document.querySelectorAll('.step-content').forEach(c => c.classList.add('hidden'));

  // Show appropriate one
  const target = document.getElementById('step' + step);
  if (target) {
    target.classList.remove('hidden');
  }

  // Update progress bar
  document.querySelectorAll('.progress-segment').forEach(t => t.classList.remove('active'));
  const seg = document.querySelector(`.progress-segment[data-step="${step}"]`);
  if (seg) seg.classList.add('active');

  currentStep = step;
  updateProgress();
  updateButtons();
}

function nextStep(e) {
  e.preventDefault();
  if (!validateStep(currentStep)) return;

  const clientType = document.querySelector('input[name="client_type"]:checked')?.value;

  // Determine next step based on client type
  if (currentStep === 1) {
    if (clientType === "B2C") {
      document.getElementById('step1').classList.add('hidden');
      document.getElementById('step2B2C').classList.remove('hidden');
      currentStep = 2; // treat B2C step as step2
    } else {
      document.getElementById('step1').classList.add('hidden');
      document.getElementById('step2').classList.remove('hidden');
      currentStep = 2;
    }
  } else if (currentStep === 2 && clientType === "B2B") {
    document.getElementById('step2').classList.add('hidden');
    document.getElementById('step3').classList.remove('hidden');
    currentStep = 3;
  }

  updateProgress();
  updateButtons();
}

function previousStep(e) {
  e.preventDefault();

  const clientType = document.querySelector('input[name="client_type"]:checked')?.value;

  if (currentStep === 2) {
    document.getElementById('step2').classList.add('hidden');
    document.getElementById('step2B2C').classList.add('hidden');
    document.getElementById('step1').classList.remove('hidden');
    currentStep = 1;
  } else if (currentStep === 3 && clientType === "B2B") {
    document.getElementById('step3').classList.add('hidden');
    document.getElementById('step2').classList.remove('hidden');
    currentStep = 2;
  }

  updateProgress();
  updateButtons();
}

// Validation for Step 1
function validateStep(step) {
  const errors = [];
  if (step === 1) {
    const requiredFields = ["id_name", "id_email", "id_phone", "id_company"];
    requiredFields.forEach(id => {
      const el = document.getElementById(id);
      if (!el || !el.value.trim()) errors.push(`${id.replace("id_", "").replace("_", " ")} is required`);
    });
  }

  const errorDiv = document.getElementById('validationErrors');
  if (errors.length > 0) {
    errorDiv.innerHTML = '<strong>Please fix the following:</strong><ul>' + errors.map(e => `<li>${e}</li>`).join('') + '</ul>';
    errorDiv.classList.remove('hidden');
    return false;
  } else {
    errorDiv.classList.add('hidden');
    return true;
  }
}

// Buttons update
function updateButtons() {
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const submitBtn = document.getElementById('submitBtn');
  const clientType = document.querySelector('input[name="client_type"]:checked')?.value;

  prevBtn.disabled = currentStep === 1;

  // B2C flow: only Step1 → Step2B2C → Submit
  if (clientType === "B2C") {
    if (currentStep === 2) {
      nextBtn.classList.add('hidden');
      submitBtn.classList.remove('hidden');
    } else {
      nextBtn.classList.remove('hidden');
      submitBtn.classList.add('hidden');
    }
  }
  // B2B flow: Step1 → Step2 → Step3 → Submit
  else {
    if (currentStep === totalSteps) {
      nextBtn.classList.add('hidden');
      submitBtn.classList.remove('hidden');
    } else {
      nextBtn.classList.remove('hidden');
      submitBtn.classList.add('hidden');
    }
  }
}

function updateProgress() {
  document.getElementById('currentStep').textContent = currentStep;
}

updateButtons();
updateProgress();


(function(){
  const uploadBtn = document.getElementById('uploadBtn');
  const fileInput = document.getElementById('complianceFiles');
  const filesList = document.getElementById('filesList');
  const noFiles = document.getElementById('noFiles');
  const filesCount = document.getElementById('filesCount');

  // Keep a Map of selected files (so we can remove before submit)
  const selected = new Map();

  uploadBtn.addEventListener('click', (e) => {
    e.preventDefault();
    fileInput.click();
  });

  fileInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    files.forEach(file => {
      // Use unique key (name + size + lastModified) to avoid duplicates
      const key = `${file.name}__${file.size}__${file.lastModified}`;
      if (!selected.has(key)) {
        selected.set(key, file);
      }
    });
    renderFiles();
    // Reset the native input so same file can be re-selected after removal
    fileInput.value = '';
  });

  function renderFiles() {
    filesList.innerHTML = '';
    if (selected.size === 0) {
      noFiles.style.display = 'block';
      filesCount.textContent = '';
      return;
    }
    noFiles.style.display = 'none';
    filesCount.textContent = `${selected.size} file(s) selected`;

    selected.forEach((file, key) => {
      const li = document.createElement('li');
      li.className = 'flex items-center justify-between bg-white p-2 rounded border';
      const left = document.createElement('div');
      left.className = 'text-sm';
      const name = document.createElement('div');
      name.textContent = file.name;
      const meta = document.createElement('div');
      meta.className = 'text-xs text-gray-500';
      meta.textContent = `${Math.round(file.size/1024)} KB`;
      left.appendChild(name);
      left.appendChild(meta);

      const right = document.createElement('div');
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'text-red-600 text-sm hover:underline';
      removeBtn.textContent = 'Remove';
      removeBtn.addEventListener('click', () => {
        selected.delete(key);
        renderFiles();
      });
      right.appendChild(removeBtn);

      li.appendChild(left);
      li.appendChild(right);
      filesList.appendChild(li);
    });
  }

  const form = document.getElementById('onboardingForm');
  form.addEventListener('submit', function(e) {
    // If no files selected, allow normal submit
    if (selected.size === 0) return;

    // Prevent default form submit and send via fetch (so files are included)
    e.preventDefault();

    const url = form.action || window.location.href; // submit to same URL if action not set
    const fd = new FormData(form);

    // Append each selected file under compliance_files (use array name)
    let i = 0;
    selected.forEach((file) => {
      fd.append('compliance_files', file);
      i++;
    });

    // You may want to append the doc_type and expiry if they live outside the form fields (they are in form)
    // Send with fetch
    fetch(url, {
      method: 'POST',
      body: fd,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      },
      credentials: 'same-origin'
    }).then(resp => {
      if (resp.redirected) {
        window.location = resp.url;
        return;
      }
      return resp.json().catch(()=>resp.text());
    }).then(data => {
      // handle response (if your view returns JSON)
      // fallback: reload the page to show saved documents
      window.location.reload();
    }).catch(err => {
      console.error(err);
      alert('Upload failed — check console for details.');
    });
  });

})();
</script>

{% endblock %}
