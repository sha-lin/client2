{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Client - {{ client.client_id }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-5xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">Edit Client Profile</h1>
          <p class="text-gray-600 mt-2">Update details for <span class="font-semibold">{{ client.company|default:client.name }}</span></p>
        </div>
        <div class="text-right">
          <span class="inline-block px-4 py-2 bg-white text-gray-800 rounded-lg text-sm font-medium border-2 border-gray-900 shadow-sm">
            {{ client.get_client_type_display }}
          </span>
        </div>
      </div>
    </div>

    <!-- Client Type Selector -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Client Type</h2>
      <form method="post" id="editClientForm" class="space-y-6">
        {% csrf_token %}

        <!-- Client Type Selection -->
        <div class="flex gap-4">
          <div class="flex-1">
            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition-all"
              id="b2bLabel" data-type="B2B">
              <input type="radio" name="client_type" value="B2B" id="id_client_type_b2b"
                class="w-5 h-5 mr-3" {% if client.client_type == 'B2B' %}checked{% endif %}>
              <div>
                <div class="font-semibold text-gray-900">B2B Business</div>
                <div class="text-sm text-gray-600">Business-to-Business clients</div>
              </div>
            </label>
          </div>
          <div class="flex-1">
            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition-all"
              id="b2cLabel" data-type="B2C">
              <input type="radio" name="client_type" value="B2C" id="id_client_type_b2c"
                class="w-5 h-5 mr-3" {% if client.client_type == 'B2C' %}checked{% endif %}>
              <div>
                <div class="font-semibold text-gray-900">B2C Retail</div>
                <div class="text-sm text-gray-600">Retail/Individual customers</div>
              </div>
            </label>
          </div>
        </div>

        <!-- ========== COMMON FIELDS ========== -->
        <div class="border-t pt-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Contact Information</h2>
          <div class="grid grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Contact Person Name <span class="text-red-500">*</span>
              </label>
              {{ form.name }}
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Email Address
              </label>
              {{ form.email }}
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Phone Number <span class="text-red-500">*</span>
              </label>
              {{ form.phone }}
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Preferred Channel
              </label>
              {{ form.preferred_channel }}
            </div>
          </div>
        </div>

        <!-- ========== B2B ONLY FIELDS ========== -->
        <div id="b2bSection" class="space-y-6">
          <!-- Core Details -->
          <div class="border-t pt-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Core Business Details</h2>
            <div class="grid grid-cols-2 gap-6">
              <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Company Name <span class="text-red-500">*</span>
                </label>
                {{ form.company }}
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Industry
                </label>
                {{ form.industry }}
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Business Address
                </label>
                {{ form.address }}
              </div>
            </div>
          </div>

          <!-- Compliance & Tax -->
          <div class="border-t pt-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Compliance & Tax</h2>
            <div class="grid grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  VAT Tax ID
                </label>
                {{ form.vat_tax_id }}
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  KRA PIN
                </label>
                {{ form.kra_pin }}
              </div>
            </div>
          </div>

          <!-- Financial Terms -->
          <div class="border-t pt-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Financial & Credit</h2>
            <div class="grid grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Payment Terms
                </label>
                {{ form.payment_terms }}
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Credit Limit
                </label>
                {{ form.credit_limit }}
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Default Markup (%)
                </label>
                {{ form.default_markup }}
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Risk Rating
                </label>
                {{ form.risk_rating }}
              </div>
            </div>
            <div class="mt-4 flex items-center gap-2">
              {{ form.is_reseller }}
              <label for="id_is_reseller" class="text-sm font-medium text-gray-700">
                This is a Reseller
              </label>
            </div>
          </div>

          <!-- Delivery Details -->
          <div class="border-t pt-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Delivery Details</h2>
            <div class="grid grid-cols-1 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Delivery Address
                </label>
                {{ form.delivery_address }}
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Special Delivery Instructions
                </label>
                {{ form.delivery_instructions }}
              </div>
            </div>
          </div>

          <!-- B2B Contacts Management -->
          {% if client.client_type == 'B2B' %}
          <div class="border-t pt-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-semibold text-gray-900">Contacts</h2>
              <button type="button" class="px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-all text-sm font-medium"
                onclick="openAddContactModal()">
                <svg class="w-4 h-4 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Add Contact
              </button>
            </div>
            <div id="contactsList" class="space-y-3">
              {% if contacts %}
                {% for contact in contacts %}
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 flex items-between justify-between">
                  <div class="flex-1">
                    <div class="font-semibold text-gray-900">{{ contact.full_name }}</div>
                    <div class="text-sm text-gray-600">{{ contact.get_role_display }} • {{ contact.email }}</div>
                    <div class="text-sm text-gray-600">{{ contact.phone }}</div>
                  </div>
                  <div class="flex gap-2">
                    <button type="button" onclick="editContact({{ contact.id }})"
                      class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-all">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                      </svg>
                    </button>
                    <button type="button" onclick="deleteContact({{ contact.id }})"
                      class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-all">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                      </svg>
                    </button>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 text-center text-gray-600">
                  No contacts added yet. Click "Add Contact" to create one.
                </div>
              {% endif %}
            </div>
          </div>

          <!-- B2B Brand Assets Management -->
          <div class="border-t pt-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-semibold text-gray-900">Brand Assets</h2>
              <button type="button" class="px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-all text-sm font-medium"
                onclick="openAddBrandModal()">
                <svg class="w-4 h-4 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Upload Asset
              </button>
            </div>
            <div id="brandAssetsList" class="grid grid-cols-2 gap-4">
              {% if brand_assets %}
                {% for asset in brand_assets %}
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                  <div class="flex items-start justify-between mb-2">
                    <span class="text-xs font-medium text-gray-500 uppercase">{{ asset.get_asset_type_display }}</span>
                    <button type="button" onclick="deleteBrandAsset({{ asset.id }})"
                      class="p-1 text-red-600 hover:bg-red-50 rounded transition-all">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                      </svg>
                    </button>
                  </div>
                  <div class="font-semibold text-gray-900 truncate">{{ asset.file_name }}</div>
                  <div class="text-xs text-gray-600 mt-1">
                    Uploaded {{ asset.uploaded_at|date:"M d, Y" }}
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <div class="col-span-2 p-4 bg-gray-50 rounded-lg border border-gray-200 text-center text-gray-600">
                  No brand assets uploaded yet. Click "Upload Asset" to add logos, images, or documents.
                </div>
              {% endif %}
            </div>
          </div>

          <!-- B2B Compliance Documents Management -->
          <div class="border-t pt-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-semibold text-gray-900">Compliance Documents</h2>
              <button type="button" class="px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-all text-sm font-medium"
                onclick="openAddComplianceModal()">
                <svg class="w-4 h-4 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Add Document
              </button>
            </div>
            <div id="complianceList" class="space-y-3">
              {% if compliance_documents %}
                {% for doc in compliance_documents %}
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 flex items-between justify-between">
                  <div class="flex-1">
                    <div class="font-semibold text-gray-900">{{ doc.document_type }}</div>
                    <div class="text-sm text-gray-600">
                      Status: <span class="font-medium">{{ doc.get_status_display }}</span> • Expires: {{ doc.expiration_date|date:"M d, Y"|default:"Not set" }}
                    </div>
                  </div>
                  <div class="flex gap-2">
                    <a href="{{ doc.file_url }}" target="_blank"
                      class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-all" title="Download">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                      </svg>
                    </a>
                    <button type="button" onclick="deleteComplianceDoc({{ doc.id }})"
                      class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-all">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                      </svg>
                    </button>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 text-center text-gray-600">
                  No compliance documents added yet. Click "Add Document" to upload certificates, licenses, or other documents.
                </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>

        <!-- ========== B2C ONLY FIELDS ========== -->
        <div id="b2cSection" class="hidden space-y-6">
          <!-- B2C Retail Details -->
          <div class="border-t pt-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Additional Information</h2>
            <div class="grid grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Company/Business Name (Optional)
                </label>
                {{ form.company }}
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Lead Source
                </label>
                {{ form.lead_source }}
              </div>
            </div>
          </div>

          <!-- Delivery Details for B2C -->
          <div class="border-t pt-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Delivery Details</h2>
            <div class="grid grid-cols-1 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Delivery Address
                </label>
                {{ form.delivery_address }}
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Special Delivery Instructions
                </label>
                {{ form.delivery_instructions }}
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="border-t pt-6 flex justify-end gap-3">
          <a href="{% url 'client_profile' client.pk %}"
            class="px-6 py-3 bg-white text-gray-900 border-2 border-gray-900 rounded-lg hover:bg-gray-100 transition-all duration-200 font-medium">
            Cancel
          </a>
          <button type="submit"
            class="px-6 py-3 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-all duration-200 font-medium shadow-lg">
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  /* Form field styling */
  input[type="text"],
  input[type="email"],
  input[type="number"],
  textarea,
  select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  input[type="text"]:focus,
  input[type="email"]:focus,
  input[type="number"]:focus,
  textarea:focus,
  select:focus {
    outline: none;
    border-color: #1f2937;
    box-shadow: 0 0 0 3px rgba(31, 41, 55, 0.1);
  }

  textarea {
    resize: vertical;
    min-height: 100px;
  }

  /* Client type selector styling */
  label[data-type] {
    border-color: #e5e7eb;
    transition: all 0.3s ease;
  }

  input[type="radio"]:checked + div + input[type="radio"]:checked ~ label[data-type],
  label[data-type]:has(input[type="radio"]:checked) {
    border-color: #1f2937;
    background-color: #f3f4f6;
  }

  /* Smooth transitions for section visibility */
  #b2bSection,
  #b2cSection {
    transition: opacity 0.3s ease, max-height 0.3s ease;
  }

  #b2bSection.hidden,
  #b2cSection.hidden {
    opacity: 0;
    max-height: 0;
    overflow: hidden;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const clientTypeRadios = document.querySelectorAll('input[name="client_type"]');
  const b2bSection = document.getElementById('b2bSection');
  const b2cSection = document.getElementById('b2cSection');
  const b2bLabel = document.getElementById('b2bLabel');
  const b2cLabel = document.getElementById('b2cLabel');
  const companyField = document.getElementById('id_company');

  // B2B-specific required fields
  const b2bRequiredFields = [
    'id_name',
    'id_phone',
    'id_company',
  ];

  // B2C-specific required fields
  const b2cRequiredFields = [
    'id_name',
    'id_phone',
  ];

  function updateFieldVisibility() {
    const selectedType = document.querySelector('input[name="client_type"]:checked').value;

    if (selectedType === 'B2B') {
      // Show B2B, hide B2C
      b2bSection.classList.remove('hidden');
      b2cSection.classList.add('hidden');

      // Update label styling
      b2bLabel.classList.add('border-gray-900', 'bg-gray-50');
      b2bLabel.classList.remove('border-gray-300');
      b2cLabel.classList.add('border-gray-300');
      b2cLabel.classList.remove('border-gray-900', 'bg-gray-50');

      // Set required fields for B2B
      b2bRequiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) field.required = true;
      });
      b2cRequiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && !b2bRequiredFields.includes(fieldId)) {
          field.required = false;
        }
      });

      // Make company required for B2B
      if (companyField) companyField.required = true;

    } else if (selectedType === 'B2C') {
      // Show B2C, hide B2B
      b2cSection.classList.remove('hidden');
      b2bSection.classList.add('hidden');

      // Update label styling
      b2cLabel.classList.add('border-gray-900', 'bg-gray-50');
      b2cLabel.classList.remove('border-gray-300');
      b2bLabel.classList.add('border-gray-300');
      b2bLabel.classList.remove('border-gray-900', 'bg-gray-50');

      // Set required fields for B2C
      b2cRequiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) field.required = true;
      });
      b2bRequiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && !b2cRequiredFields.includes(fieldId)) {
          field.required = false;
        }
      });

      // Make company optional for B2C
      if (companyField) companyField.required = false;
    }
  }

  // Add event listeners to client type radios
  clientTypeRadios.forEach(radio => {
    radio.addEventListener('change', updateFieldVisibility);
  });

  // Initialize visibility on page load
  updateFieldVisibility();

  // Form submission handler
  document.getElementById('editClientForm').addEventListener('submit', function(e) {
    const selectedType = document.querySelector('input[name="client_type"]:checked').value;
    
    // Clear B2B-only fields if B2C is selected
    if (selectedType === 'B2C') {
      const b2bOnlyFields = ['vat_tax_id', 'kra_pin', 'industry', 'payment_terms', 'credit_limit', 'default_markup', 'risk_rating', 'is_reseller'];
      b2bOnlyFields.forEach(fieldName => {
        const field = document.querySelector(`input[name="${fieldName}"], select[name="${fieldName}"]`);
        if (field) {
          if (field.type === 'checkbox') {
            field.checked = false;
          } else {
            field.value = '';
          }
        }
      });
    }
  });

  // ==================== CONTACTS MANAGEMENT ====================
  function openAddContactModal() {
    const modal = document.getElementById('contactModal');
    if (modal) {
      document.getElementById('contactForm').reset();
      document.getElementById('contactId').value = '';
      modal.classList.remove('hidden');
    }
  }

  function editContact(contactId) {
    // Fetch contact data and populate form
    fetch(`/api/clients/{{ client.id }}/contacts/${contactId}/`, {
      method: 'GET',
    })
    .then(response => response.json())
    .then(data => {
      document.getElementById('contactModalTitle').textContent = 'Edit Contact';
      document.getElementById('contactRole').value = data.role;
      document.getElementById('contactName').value = data.full_name;
      document.getElementById('contactEmail').value = data.email;
      document.getElementById('contactPhone').value = data.phone;
      document.getElementById('contactId').value = data.id;
      document.getElementById('contactModal').classList.remove('hidden');
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error loading contact');
    });
  }

  function deleteContact(contactId) {
    if (confirm('Are you sure you want to delete this contact?')) {
      // API call to delete contact
      fetch(`/api/clients/{{ client.id }}/contacts/${contactId}/`, {
        method: 'DELETE',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
      })
      .then(response => {
        if (response.ok) {
          location.reload();
        } else {
          alert('Error deleting contact');
        }
      })
      .catch(error => console.error('Error:', error));
    }
  }

  // ==================== BRAND ASSETS MANAGEMENT ====================
  function openAddBrandModal() {
    const modal = document.getElementById('brandModal');
    if (modal) {
      modal.classList.remove('hidden');
    }
  }

  function deleteBrandAsset(assetId) {
    if (confirm('Are you sure you want to delete this brand asset?')) {
      // API call to delete brand asset
      fetch(`/api/clients/{{ client.id }}/brand-assets/${assetId}/`, {
        method: 'DELETE',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
      })
      .then(response => {
        if (response.ok) {
          location.reload();
        } else {
          alert('Error deleting asset');
        }
      })
      .catch(error => console.error('Error:', error));
    }
  }

  // ==================== COMPLIANCE DOCUMENTS MANAGEMENT ====================
  function openAddComplianceModal() {
    const modal = document.getElementById('complianceModal');
    if (modal) {
      modal.classList.remove('hidden');
    }
  }

  function deleteComplianceDoc(docId) {
    if (confirm('Are you sure you want to delete this compliance document?')) {
      // API call to delete compliance doc
      fetch(`/api/clients/{{ client.id }}/compliance-documents/${docId}/`, {
        method: 'DELETE',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
      })
      .then(response => {
        if (response.ok) {
          location.reload();
        } else {
          alert('Error deleting document');
        }
      })
      .catch(error => console.error('Error:', error));
    }
  }
});
</script>

<!-- Include modals for managing contacts, brands, and compliance -->
{% include 'client_edit_modals.html' %}

{% endblock %}