{% extends 'base.html' %}

{% block title %}Vendors - Production Management{% endblock %}

{% block content %}
<div class="p-8 max-w-7xl mx-auto">
    <div class="mb-6 flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-semibold text-gray-900">Vendors</h1>
            <p class="text-sm text-gray-600">Master list of all vendors and where they are used in processes.</p>
        </div>
                <button type="button" id="add-vendor-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none">
            <span class="mr-2">+</span> Add Vendor
        </button>
    </div>

    <!-- Vendors table -->
    <div class="bg-white rounded-lg border border-gray-200 mb-8 overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">VPS</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rating</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for vendor in vendors %}
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm font-medium text-blue-600 hover:underline">
                        <a href="{% url 'vendor_profile' vendor.id %}" class="text-blue-600 hover:underline">{{ vendor.name }}</a>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-700">
                        <div>{{ vendor.email }}</div>
                        <div class="text-xs text-gray-500">{{ vendor.phone }}</div>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold
                            {% if vendor.vps_score == 'A' %}bg-green-100 text-green-700
                            {% elif vendor.vps_score == 'B' %}bg-yellow-100 text-yellow-700
                            {% else %}bg-red-100 text-red-700{% endif %}">
                            VPS {{ vendor.vps_score }} ({{ vendor.vps_score_value }})
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-700">
                        {{ vendor.rating|floatformat:1 }} â˜…
                    </td>
                    <td class="px-4 py-3 text-sm">
                        {% if vendor.active %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">
                            Active
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-600">
                            Inactive
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                        {{ vendor.created_at|date:"M d, Y" }}
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <button type="button" 
                           class="inline-flex items-center gap-1 px-2 py-1 text-sm text-blue-600 hover:bg-blue-50 rounded transition-colors edit-vendor-btn"
                           data-vendor-id="{{ vendor.id }}"
                           data-vendor-name="{{ vendor.name|escapejs }}"
                           data-vendor-contact-person="{{ vendor.contact_person|escapejs }}"
                           data-vendor-email="{{ vendor.email|escapejs }}"
                           data-vendor-phone="{{ vendor.phone|escapejs }}"
                           data-vendor-business-address="{{ vendor.business_address|escapejs }}"
                           data-vendor-tax-pin="{{ vendor.tax_pin|escapejs }}"
                           data-vendor-payment-terms="{{ vendor.payment_terms|escapejs }}"
                           data-vendor-payment-method="{{ vendor.payment_method|escapejs }}"
                           data-vendor-services="{{ vendor.services|escapejs }}"
                           data-vendor-specialization="{{ vendor.specialization|escapejs }}"
                           data-vendor-minimum-order="{{ vendor.minimum_order }}"
                           data-vendor-lead-time="{{ vendor.lead_time|escapejs }}"
                           data-vendor-rush-capable="{{ vendor.rush_capable|yesno:'true,false' }}"
                           data-vendor-quality-rating="{{ vendor.quality_rating|escapejs }}"
                           data-vendor-reliability-rating="{{ vendor.reliability_rating|escapejs }}"
                           data-vendor-vps-score="{{ vendor.vps_score|escapejs }}"
                           data-vendor-vps-score-value="{{ vendor.vps_score_value }}"
                           data-vendor-rating="{{ vendor.rating }}"
                           data-vendor-recommended="{{ vendor.recommended|yesno:'true,false' }}"
                           title="Edit Vendor">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                            Edit
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="px-4 py-6 text-center text-sm text-gray-500">
                        No vendors have been added yet. Add a vendor from the Process editor, or via the admin.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Process/vendor links - HIDDEN -->
    <!-- This section has been moved to individual vendor profiles -->
    
</div>
<!-- Add Vendor Modal -->
<div id="add-vendor-modal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: white; margin: 5% auto; padding: 2rem; border-radius: 8px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="font-size: 1.5rem; font-weight: 600; color: #1f2937;" id="modal-title">Add New Vendor</h2>
            <button type="button" id="close-modal" style="font-size: 1.5rem; color: #6b7280; background: none; border: none; cursor: pointer;">&times;</button>
        </div>
        
        <form id="vendor-form" method="POST" action="{% url 'ajax_create_vendor' %}">
            {% csrf_token %}
            <input type="hidden" id="vendor-id" name="vendor_id" value="">
            
            <!-- Hidden fields for VPS score, rating, and recommended (required by backend) -->
            <input type="hidden" id="vps-score" name="vps_score" value="B">
            <input type="hidden" id="vps-score-value" name="vps_score_value" value="5.0">
            <input type="hidden" id="rating" name="rating" value="4.0">
            <input type="hidden" id="recommended" name="recommended" value="false">
            
            <!-- BASIC INFORMATION -->
            <div style="margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 2px solid #e5e7eb;">
                <div style="font-weight: 600; color: #1f2937; margin-bottom: 1rem; font-size: 14px;">BASIC INFORMATION</div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                        Vendor Name <span style="color: #dc2626;">*</span>
                    </label>
                    <input type="text" name="name" id="vendor-name" required 
                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem;">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                        Contact Person
                    </label>
                    <input type="text" name="contact_person" id="vendor-contact-person"
                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem;">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                        Email <span style="color: #dc2626;">*</span>
                    </label>
                    <input type="email" name="email" id="vendor-email" required 
                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem;">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                        Phone Number <span style="color: #dc2626;">*</span>
                    </label>
                    <input type="tel" name="phone" id="vendor-phone" required 
                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem;"
                        placeholder="+254...">
                </div>
            </div>
            
            <!-- BUSINESS DETAILS -->
            <div style="margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 2px solid #e5e7eb;">
                <div style="font-weight: 600; color: #1f2937; margin-bottom: 1rem; font-size: 14px;">BUSINESS DETAILS</div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                        Business Address
                    </label>
                    <textarea name="business_address" id="vendor-business-address" rows="3"
                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem; resize: vertical; font-family: inherit;"></textarea>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                        Tax PIN
                    </label>
                    <input type="text" name="tax_pin" id="vendor-tax-pin"
                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem;">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                            Payment Terms
                        </label>
                        <select name="payment_terms" id="vendor-payment-terms"
                            style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem;">
                            <option value="">Select Payment Terms</option>
                            <option value="Net 7">Net 7 Days</option>
                            <option value="Net 14">Net 14 Days</option>
                            <option value="Net 30">Net 30 Days</option>
                            <option value="Prepaid">Prepaid</option>
                            <option value="Cash on Delivery">Cash on Delivery</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                            Payment Method
                        </label>
                        <select name="payment_method" id="vendor-payment-method"
                            style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem;">
                            <option value="">Select Payment Method</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Mobile Money">Mobile Money</option>
                            <option value="Cash">Cash</option>
                            <option value="Check">Check</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- SERVICES -->
            <div style="margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 2px solid #e5e7eb;">
                <div style="font-weight: 600; color: #1f2937; margin-bottom: 1rem; font-size: 14px;">SERVICES</div>
                <label style="display: block; font-weight: 500; margin-bottom: 0.75rem; color: #374151;">What services does this vendor provide?</label>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;" id="process-services-container">
                    {% for process in processes %}
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" name="services" value="{{ process.process_name }}" style="width: 1.125rem; height: 1.125rem; margin-right: 0.5rem;">
                        <span style="color: #374151; font-size: 14px;">{{ process.process_name }}</span>
                    </label>
                    {% empty %}
                    <div style="grid-column: 1 / -1; color: #6b7280; font-size: 14px; font-style: italic;">
                        No processes have been created yet. Create processes first to assign them to vendors.
                    </div>
                    {% endfor %}
                </div>
                
                <div style="margin-top: 1rem;">
                    <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">Specialization</label>
                    <textarea name="specialization" id="vendor-specialization" rows="2" placeholder="What they do best"
                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem; resize: vertical; font-family: inherit;"></textarea>
                </div>
            </div>
            
            <!-- CAPACITY -->
            <div style="margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 2px solid #e5e7eb;">
                <div style="font-weight: 600; color: #1f2937; margin-bottom: 1rem; font-size: 14px;">CAPACITY</div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                        Minimum Order Value
                    </label>
                    <input type="number" name="minimum_order" id="vendor-minimum-order" step="0.01" min="0" value="0"
                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem;"
                        placeholder="KES 0.00">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                        Lead Time
                    </label>
                    <input type="text" name="lead_time" id="vendor-lead-time"
                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem;"
                        placeholder="e.g., 5 days">
                </div>
                
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" name="rush_capable" id="vendor-rush-capable" value="true"
                        style="width: 1.25rem; height: 1.25rem; margin-right: 0.5rem;">
                    <span style="font-weight: 500; color: #374151;">Rush Capable: Yes</span>
                </label>
            </div>
            
            <!-- INITIAL RATING -->
            <div style="margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 2px solid #e5e7eb;">
                <div style="font-weight: 600; color: #1f2937; margin-bottom: 1rem; font-size: 14px;">INITIAL RATING</div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                        Overall Quality
                    </label>
                    <div style="display: flex; gap: 8px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="quality_rating" value="Excellent" style="width: 1.125rem; height: 1.125rem; margin-right: 0.5rem;">
                            <span style="color: #374151; font-size: 14px;">Excellent</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="quality_rating" value="Very Good" style="width: 1.125rem; height: 1.125rem; margin-right: 0.5rem;">
                            <span style="color: #374151; font-size: 14px;">Very Good</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="quality_rating" value="Good" style="width: 1.125rem; height: 1.125rem; margin-right: 0.5rem;">
                            <span style="color: #374151; font-size: 14px;">Good</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="quality_rating" value="Fair" style="width: 1.125rem; height: 1.125rem; margin-right: 0.5rem;">
                            <span style="color: #374151; font-size: 14px;">Fair</span>
                        </label>
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                        Reliability
                    </label>
                    <div style="display: flex; gap: 8px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="reliability_rating" value="Excellent" style="width: 1.125rem; height: 1.125rem; margin-right: 0.5rem;">
                            <span style="color: #374151; font-size: 14px;">Excellent</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="reliability_rating" value="Very Good" style="width: 1.125rem; height: 1.125rem; margin-right: 0.5rem;">
                            <span style="color: #374151; font-size: 14px;">Very Good</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="reliability_rating" value="Good" style="width: 1.125rem; height: 1.125rem; margin-right: 0.5rem;">
                            <span style="color: #374151; font-size: 14px;">Good</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="reliability_rating" value="Fair" style="width: 1.125rem; height: 1.125rem; margin-right: 0.5rem;">
                            <span style="color: #374151; font-size: 14px;">Fair</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- VPS & SCORING -->
            <div style="margin-bottom: 2rem;">
                <div style="font-weight: 600; color: #1f2937; margin-bottom: 1rem; font-size: 14px;">VPS SCORE</div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                            VPS Score
                        </label>
                        <select name="vps_score" id="vendor-vps-score"
                            style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem;">
                            <option value="B" selected>B - Good</option>
                            <option value="A">A - Excellent</option>
                            <option value="C">C - Acceptable</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                            VPS Value (0-10)
                        </label>
                        <input type="number" name="vps_score_value" id="vendor-vps-value" step="0.1" min="0" max="10" value="5.0"
                            style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem;">
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                        Rating (1-5 stars)
                    </label>
                    <input type="number" name="rating" id="vendor-rating" step="0.1" min="1" max="5" value="4.0"
                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem;">
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" name="recommended" id="vendor-recommended" value="true"
                            style="width: 1.25rem; height: 1.25rem; margin-right: 0.5rem;">
                        <span style="font-weight: 500; color: #374151;">Mark as Recommended Vendor</span>
                    </label>
                </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 2rem;">
                <button type="button" id="cancel-vendor-btn" 
                    style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; border-radius: 4px; background: white; cursor: pointer; font-size: 1rem; font-weight: 500;">
                    Cancel
                </button>
                <button type="submit" id="save-vendor-btn"
                    style="padding: 0.75rem 1.5rem; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: 500;">
                    <span id="save-btn-text">Save Vendor</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Modal functionality
const addVendorBtn = document.getElementById('add-vendor-btn');
const modal = document.getElementById('add-vendor-modal');
const closeModalBtn = document.getElementById('close-modal');
const cancelBtn = document.getElementById('cancel-vendor-btn');
const vendorForm = document.getElementById('vendor-form');

// Function to load vendor data into form
function loadVendorData(vendorData) {
    const elements = {
        'vendor-id': vendorData.vendorId || '',
        'vendor-name': vendorData.name || '',
        'vendor-contact-person': vendorData.contactPerson || '',
        'vendor-email': vendorData.email || '',
        'vendor-phone': vendorData.phone || '',
        'vendor-business-address': vendorData.businessAddress || '',
        'vendor-tax-pin': vendorData.taxPin || '',
        'vendor-payment-terms': vendorData.paymentTerms || '',
        'vendor-payment-method': vendorData.paymentMethod || '',
        'vendor-specialization': vendorData.specialization || '',
        'vendor-minimum-order': vendorData.minimumOrder || '0',
        'vendor-lead-time': vendorData.leadTime || '',
        'vps-score': vendorData.vpsScore || 'B',
        'vps-score-value': vendorData.vpsScoreValue || '5.0',
        'rating': vendorData.rating || '4.0'
    };
    
    // Set text input values
    Object.keys(elements).forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.value = elements[id];
        }
    });
    
    // Set hidden field for recommended
    const recommendedHiddenEl = document.getElementById('recommended');
    if (recommendedHiddenEl) {
        recommendedHiddenEl.value = (vendorData.recommended === 'true' || vendorData.recommended === true) ? 'true' : 'false';
    }
    
    // Set checkbox values
    const rushCapableEl = document.getElementById('vendor-rush-capable');
    if (rushCapableEl) {
        rushCapableEl.checked = vendorData.rushCapable === 'true';
    }
    
    const recommendedEl = document.getElementById('vendor-recommended');
    if (recommendedEl) {
        recommendedEl.checked = vendorData.recommended === 'true';
    }
    
    // Handle quality rating radio buttons
    if (vendorData.qualityRating) {
        const qualityRadio = document.querySelector(`input[name="quality_rating"][value="${vendorData.qualityRating}"]`);
        if (qualityRadio) qualityRadio.checked = true;
    }
    
    // Handle reliability rating radio buttons
    if (vendorData.reliabilityRating) {
        const reliabilityRadio = document.querySelector(`input[name="reliability_rating"][value="${vendorData.reliabilityRating}"]`);
        if (reliabilityRadio) reliabilityRadio.checked = true;
    }
    
    // Handle services checkboxes
    document.querySelectorAll('input[name="services"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    if (vendorData.services) {
        const servicesList = vendorData.services.split(',').map(s => s.trim());
        servicesList.forEach(serviceName => {
            const checkbox = document.querySelector(`input[name="services"][value="${serviceName}"]`);
            if (checkbox) checkbox.checked = true;
        });
    }
}

// Function to reset form
function resetVendorForm() {
    document.getElementById('vendor-form').reset();
    document.getElementById('vendor-id').value = '';
    document.querySelectorAll('input[name="services"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    document.querySelectorAll('input[name="quality_rating"]').forEach(radio => {
        radio.checked = false;
    });
    document.querySelectorAll('input[name="reliability_rating"]').forEach(radio => {
        radio.checked = false;
    });
}

// Open modal for adding new vendor
if (addVendorBtn) {
    addVendorBtn.addEventListener('click', function() {
        if (modal) {
            modal.style.display = 'block';
        }
        const titleEl = document.getElementById('modal-title');
        const btnTextEl = document.getElementById('save-btn-text');
        if (titleEl) titleEl.textContent = 'Add New Vendor';
        if (btnTextEl) btnTextEl.textContent = 'Save Vendor';
        resetVendorForm();
        const nameInput = document.getElementById('vendor-name');
        if (nameInput) nameInput.focus();
        // Initialize lucide icons for edit icon - only if elements exist
        if (typeof lucide !== 'undefined') {
            try {
                setTimeout(() => {
                    try {
                        const lucideElements = document.querySelectorAll('[data-lucide]');
                        if (lucideElements.length > 0) {
                            lucide.createIcons();
                        }
                    } catch (e) {
                        console.warn('Error initializing lucide icons:', e);
                    }
                }, 100);
            } catch (e) {
                console.warn('Error setting up lucide icons:', e);
            }
        }
    });
}

// Open modal for editing existing vendor
document.querySelectorAll('.edit-vendor-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const vendorData = {
            vendorId: this.dataset.vendorId,
            name: this.dataset.vendorName,
            contactPerson: this.dataset.vendorContactPerson,
            email: this.dataset.vendorEmail,
            phone: this.dataset.vendorPhone,
            businessAddress: this.dataset.vendorBusinessAddress,
            taxPin: this.dataset.vendorTaxPin,
            paymentTerms: this.dataset.vendorPaymentTerms,
            paymentMethod: this.dataset.vendorPaymentMethod,
            services: this.dataset.vendorServices,
            specialization: this.dataset.vendorSpecialization,
            minimumOrder: this.dataset.vendorMinimumOrder,
            leadTime: this.dataset.vendorLeadTime,
            rushCapable: this.dataset.vendorRushCapable,
            qualityRating: this.dataset.vendorQualityRating,
            reliabilityRating: this.dataset.vendorReliabilityRating,
            vpsScore: this.dataset.vendorVpsScore,
            vpsScoreValue: this.dataset.vendorVpsScoreValue,
            rating: this.dataset.vendorRating,
            recommended: this.dataset.vendorRecommended
        };
        
        modal.style.display = 'block';
        document.getElementById('modal-title').textContent = 'Edit Vendor';
        document.getElementById('save-btn-text').textContent = 'Update Vendor';
        loadVendorData(vendorData);
        document.getElementById('vendor-name').focus();
        
        // Initialize lucide icons - only if elements exist
        if (typeof lucide !== 'undefined') {
            try {
                setTimeout(() => {
                    try {
                        const lucideElements = document.querySelectorAll('[data-lucide]');
                        if (lucideElements.length > 0) {
                            lucide.createIcons();
                        }
                    } catch (e) {
                        console.warn('Error initializing lucide icons:', e);
                    }
                }, 100);
            } catch (e) {
                console.warn('Error setting up lucide icons:', e);
            }
        }
    });
});

// Close modal
function closeModal() {
    if (modal) {
        modal.style.display = 'none';
    }
    resetVendorForm();
}

// Safely add event listeners
if (closeModalBtn) {
    closeModalBtn.addEventListener('click', closeModal);
}
if (cancelBtn) {
    cancelBtn.addEventListener('click', closeModal);
}

// Close on outside click
window.addEventListener('click', function(event) {
    if (event.target === modal) {
        closeModal();
    }
});

// Handle form submission
if (vendorForm) {
    vendorForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const saveBtn = document.getElementById('save-vendor-btn');
        const saveBtnText = document.getElementById('save-btn-text');
        const vendorIdField = document.getElementById('vendor-id');
        
        if (!saveBtn || !saveBtnText || !vendorIdField) {
            console.error('Required form elements not found');
            alert('Error: Form elements not found. Please refresh the page.');
            return;
        }
        
        const vendorId = vendorIdField.value;
        const isEditing = vendorId && vendorId !== '';
        
        saveBtnText.textContent = isEditing ? 'Updating...' : 'Creating...';
        saveBtn.disabled = true;
        
        const formData = new FormData(vendorForm);
        
        // Collect selected services
        const services = [];
        document.querySelectorAll('input[name="services"]:checked').forEach(checkbox => {
            services.push(checkbox.value);
        });
        
        const data = {
            vendor_id: vendorId || null,
            name: formData.get('name'),
            contact_person: formData.get('contact_person') || '',
            email: formData.get('email'),
            phone: formData.get('phone'),
            business_address: formData.get('business_address') || '',
            tax_pin: formData.get('tax_pin') || '',
            payment_terms: formData.get('payment_terms') || '',
            payment_method: formData.get('payment_method') || '',
            services: services.join(', '),
            specialization: formData.get('specialization') || '',
            minimum_order: parseFloat(formData.get('minimum_order')) || 0,
            lead_time: formData.get('lead_time') || '',
            rush_capable: formData.get('rush_capable') === 'true',
            quality_rating: formData.get('quality_rating') || '',
            reliability_rating: formData.get('reliability_rating') || '',
            vps_score: formData.get('vps_score'),
            vps_score_value: parseFloat(formData.get('vps_score_value')),
            rating: parseFloat(formData.get('rating')),
            recommended: formData.get('recommended') === 'true',
            address: formData.get('business_address') || ''  // For backward compatibility
        };
        
        const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfTokenElement) {
            console.error('CSRF token not found');
            alert('Error: CSRF token not found. Please refresh the page.');
            saveBtnText.textContent = 'Save Vendor';
            saveBtn.disabled = false;
            return;
        }
        
        const csrfToken = csrfTokenElement.value;
        
        fetch('/ajax/create-vendor/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                alert(`Vendor "${result.name}" ${isEditing ? 'updated' : 'created'} successfully!`);
                // Close modal safely
                try {
                    closeModal();
                } catch (e) {
                    console.warn('Error closing modal:', e);
                }
                // Reload page to show updated vendor in list
                setTimeout(() => {
                    location.reload();
                }, 500);
            } else {
                alert('Error: ' + (result.message || `Failed to ${isEditing ? 'update' : 'create'} vendor`));
                if (saveBtnText) saveBtnText.textContent = 'Save Vendor';
                if (saveBtn) saveBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error ' + (isEditing ? 'updating' : 'creating') + ' vendor: ' + (error.message || 'Unknown error'));
            if (saveBtnText) saveBtnText.textContent = 'Save Vendor';
            if (saveBtn) saveBtn.disabled = false;
        });
    });
}

// Initialize lucide icons after page load - only on existing elements
document.addEventListener('DOMContentLoaded', function() {
    if (typeof lucide !== 'undefined') {
        try {
            // Only initialize icons on elements that exist
            const lucideElements = document.querySelectorAll('[data-lucide]');
            if (lucideElements.length > 0) {
                lucide.createIcons();
            }
        } catch (e) {
            console.warn('Error initializing lucide icons on page load:', e);
        }
    }
});

// Also initialize icons immediately if DOM is already loaded
if (typeof lucide !== 'undefined' && document.readyState === 'loading') {
    // DOM is still loading, wait for DOMContentLoaded
} else if (typeof lucide !== 'undefined') {
    // DOM is already loaded
    try {
        const lucideElements = document.querySelectorAll('[data-lucide]');
        if (lucideElements.length > 0) {
            lucide.createIcons();
        }
    } catch (e) {
        console.warn('Error initializing lucide icons:', e);
    }
}
</script>
{% endblock %}


