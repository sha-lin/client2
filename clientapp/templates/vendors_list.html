{% extends 'base.html' %}

{% block title %}Vendors - Production Management{% endblock %}

{% block content %}
<div class="p-8 max-w-7xl mx-auto">
    <div class="mb-6 flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-semibold text-gray-900">Vendors</h1>
            <p class="text-sm text-gray-600">Master list of all vendors and where they are used in processes.</p>
        </div>
                <button type="button" id="add-vendor-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none">
            <span class="mr-2">+</span> Add Vendor
        </button>
    </div>

    <!-- Vendors table -->
    <div class="bg-white rounded-lg border border-gray-200 mb-8 overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">VPS</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rating</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for vendor in vendors %}
                <tr>
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">
                        {{ vendor.name }}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-700">
                        <div>{{ vendor.email }}</div>
                        <div class="text-xs text-gray-500">{{ vendor.phone }}</div>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold
                            {% if vendor.vps_score == 'A' %}bg-green-100 text-green-700
                            {% elif vendor.vps_score == 'B' %}bg-yellow-100 text-yellow-700
                            {% else %}bg-red-100 text-red-700{% endif %}">
                            VPS {{ vendor.vps_score }} ({{ vendor.vps_score_value }})
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-700">
                        {{ vendor.rating|floatformat:1 }} ★
                    </td>
                    <td class="px-4 py-3 text-sm">
                        {% if vendor.active %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">
                            Active
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-600">
                            Inactive
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                        {{ vendor.created_at|date:"M d, Y" }}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="px-4 py-6 text-center text-sm text-gray-500">
                        No vendors have been added yet. Add a vendor from the Process editor, or via the admin.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Process/vendor links -->
    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
            <h2 class="text-sm font-semibold text-gray-900">Vendor Rates by Process</h2>
            <p class="text-xs text-gray-500">These rows come from the Process → Vendor configuration.</p>
        </div>
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendor</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendor ID</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Process</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Minimum Order</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lead Time</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for link in process_links %}
                <tr>
                    <td class="px-4 py-3 text-sm text-gray-900">
                        {{ link.vendor_name }}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-700">
                        {{ link.vendor_id }}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-700">
                        {{ link.process__process_id }} — {{ link.process__process_name }}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-700">
                        KES {{ link.minimum_order|default:0|floatformat:2 }}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-700">
                        {{ link.standard_lead_time }} days{% if link.rush_lead_time %} (rush: {{ link.rush_lead_time }}d){% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="px-4 py-6 text-center text-sm text-gray-500">
                        No vendors have been linked to processes yet.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
</div>
<!-- Add Vendor Modal -->
<div id="add-vendor-modal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: white; margin: 5% auto; padding: 2rem; border-radius: 8px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="font-size: 1.5rem; font-weight: 600; color: #1f2937;">Add New Vendor</h2>
            <button type="button" id="close-modal" style="font-size: 1.5rem; color: #6b7280; background: none; border: none; cursor: pointer;">&times;</button>
        </div>
        
        <form id="vendor-form" method="POST" action="{% url 'ajax_create_vendor' %}">
            {% csrf_token %}
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                    Vendor Name <span style="color: #dc2626;">*</span>
                </label>
                <input type="text" name="name" id="vendor-name" required 
                    style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem;">
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                    Email <span style="color: #dc2626;">*</span>
                </label>
                <input type="email" name="email" id="vendor-email" required 
                    style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem;">
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                    Phone <span style="color: #dc2626;">*</span>
                </label>
                <input type="tel" name="phone" id="vendor-phone" required 
                    style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem;"
                    placeholder="+254...">
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                    Address
                </label>
                <textarea name="address" id="vendor-address" rows="3"
                    style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem; resize: vertical; font-family: inherit;"></textarea>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                        VPS Score
                    </label>
                    <select name="vps_score" id="vendor-vps-score"
                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem;">
                        <option value="B" selected>B - Good</option>
                        <option value="A">A - Excellent</option>
                        <option value="C">C - Acceptable</option>
                    </select>
                </div>
                
                <div>
                    <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                        VPS Value (0-10)
                    </label>
                    <input type="number" name="vps_score_value" id="vendor-vps-value" step="0.1" min="0" max="10" value="5.0"
                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem;">
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                    Rating (1-5 stars)
                </label>
                <input type="number" name="rating" id="vendor-rating" step="0.1" min="1" max="5" value="4.0"
                    style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem;">
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" name="recommended" id="vendor-recommended" value="true"
                        style="width: 1.25rem; height: 1.25rem; margin-right: 0.5rem;">
                    <span style="font-weight: 500; color: #374151;">Mark as Recommended Vendor</span>
                </label>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 2rem;">
                <button type="button" id="cancel-vendor-btn" 
                    style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; border-radius: 4px; background: white; cursor: pointer; font-size: 1rem; font-weight: 500;">
                    Cancel
                </button>
                <button type="submit" id="save-vendor-btn"
                    style="padding: 0.75rem 1.5rem; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: 500;">
                    Save Vendor
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Modal functionality
const addVendorBtn = document.getElementById('add-vendor-btn');
const modal = document.getElementById('add-vendor-modal');
const closeModalBtn = document.getElementById('close-modal');
const cancelBtn = document.getElementById('cancel-vendor-btn');
const vendorForm = document.getElementById('vendor-form');

// Open modal
addVendorBtn.addEventListener('click', function() {
    modal.style.display = 'block';
    document.getElementById('vendor-name').focus();
});

// Close modal
function closeModal() {
    modal.style.display = 'none';
    vendorForm.reset();
}

closeModalBtn.addEventListener('click', closeModal);
cancelBtn.addEventListener('click', closeModal);

// Close on outside click
window.addEventListener('click', function(event) {
    if (event.target === modal) {
        closeModal();
    }
});

// Handle form submission
vendorForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const saveBtn = document.getElementById('save-vendor-btn');
    saveBtn.textContent = 'Creating...';
    saveBtn.disabled = true;
    
    const formData = new FormData(vendorForm);
    const data = {
        name: formData.get('name'),
        email: formData.get('email'),
        phone: formData.get('phone'),
        address: formData.get('address') || '',
        vps_score: formData.get('vps_score'),
        vps_score_value: parseFloat(formData.get('vps_score_value')),
        rating: parseFloat(formData.get('rating')),
        recommended: formData.get('recommended') === 'true'
    };
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('/ajax/create-vendor/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(`✅ Vendor "${result.name}" created successfully!`);
            closeModal();
            location.reload(); // Reload to show new vendor in list
        } else {
            alert('Error: ' + (result.message || 'Failed to create vendor'));
            saveBtn.textContent = 'Save Vendor';
            saveBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating vendor: ' + error.message);
        saveBtn.textContent = 'Save Vendor';
        saveBtn.disabled = false;
    });
});
</script>
{% endblock %}


