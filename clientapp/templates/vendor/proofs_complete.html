{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QC Proofs - Vendor Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-500: #6b7280;
            --gray-900: #111827;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--gray-50); color: var(--gray-900); }

        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        .header { margin-bottom: 32px; }
        .header h1 { font-size: 2rem; font-weight: 700; margin-bottom: 8px; }
        .header p { color: var(--gray-500); font-size: 0.9rem; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        @media (max-width: 1024px) { .grid-2 { grid-template-columns: 1fr; } }

        .card { background: white; border-radius: 12px; border: 1px solid var(--gray-200); overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .card-header { padding: 16px; border-bottom: 1px solid var(--gray-100); background: var(--gray-50); }
        .card-title { font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .card-title i { color: var(--primary); }
        .card-body { padding: 20px; }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.875rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px 12px; border-radius: 6px; border: 1px solid var(--gray-200); font-family: 'Inter', sans-serif; font-size: 0.875rem; }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); background: #eff6ff; }

        .file-drop-zone { border: 2px dashed var(--primary); border-radius: 8px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.2s; background: white; }
        .file-drop-zone:hover { background: #eff6ff; border-color: #0284c7; }
        .file-drop-zone.active { background: #eff6ff; border-color: var(--success); }
        .file-drop-icon { font-size: 2rem; color: var(--primary); margin-bottom: 12px; }
        .file-drop-text { font-size: 0.875rem; color: var(--gray-500); margin-bottom: 4px; }
        .file-drop-hint { font-size: 0.75rem; color: var(--gray-500); }

        .file-list { margin-top: 16px; max-height: 300px; overflow-y: auto; }
        .file-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--gray-50); border-radius: 6px; margin-bottom: 8px; border-left: 3px solid var(--primary); }
        .file-item-info { flex: 1; }
        .file-item-name { font-weight: 600; font-size: 0.875rem; }
        .file-item-size { font-size: 0.75rem; color: var(--gray-500); margin-top: 2px; }
        .file-item-remove { background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.2rem; }

        .button { padding: 10px 16px; border-radius: 6px; border: none; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: var(--gray-200); color: var(--gray-900); }
        .btn-secondary:hover { background: var(--gray-300); }

        .proofs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; margin-top: 20px; }
        .proof-card { background: white; border-radius: 8px; border: 1px solid var(--gray-200); overflow: hidden; }
        .proof-thumbnail { width: 100%; height: 200px; background: var(--gray-100); display: flex; align-items: center; justify-content: center; font-size: 3rem; color: var(--gray-200); }
        .proof-thumbnail img { width: 100%; height: 100%; object-fit: cover; }
        .proof-info { padding: 12px; }
        .proof-name { font-weight: 700; font-size: 0.875rem; margin-bottom: 4px; }
        .proof-date { font-size: 0.75rem; color: var(--gray-500); margin-bottom: 8px; }
        .proof-status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
        .proof-status.pending { background: #fef3c7; color: #92400e; }
        .proof-status.approved { background: #d1fae5; color: #065f46; }
        .proof-status.rejected { background: #fee2e2; color: #991b1b; }
        .proof-actions { display: flex; gap: 8px; margin-top: 12px; font-size: 0.875rem; }
        .proof-actions button { flex: 1; padding: 6px; border-radius: 4px; border: 1px solid var(--gray-200); background: white; cursor: pointer; }
        .proof-actions a { flex: 1; display: flex; align-items: center; justify-content: center; padding: 6px; border-radius: 4px; border: 1px solid var(--gray-200); background: white; text-decoration: none; color: var(--primary); }

        .po-selector { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
        .po-option { padding: 12px; border-radius: 8px; border: 2px solid var(--gray-200); background: white; cursor: pointer; text-align: center; transition: all 0.2s; }
        .po-option:hover { border-color: var(--primary); background: #eff6ff; }
        .po-option.selected { border-color: var(--success); background: #d1fae5; }
        .po-option-number { font-weight: 700; font-size: 0.875rem; margin-bottom: 4px; }
        .po-option-type { font-size: 0.75rem; color: var(--gray-500); }

        .section { margin-bottom: 24px; }
        .section-title { font-size: 0.9rem; font-weight: 700; margin-bottom: 12px; }

        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 0.875rem; display: flex; gap: 12px; align-items: flex-start; }
        .alert.success { background: #d1fae5; border: 1px solid #6ee7b7; color: #065f46; }
        .alert.error { background: #fee2e2; border: 1px solid #fca5a5; color: #991b1b; }
        .alert.warning { background: #fef3c7; border: 1px solid #fcd34d; color: #92400e; }
        .alert i { margin-top: 2px; flex-shrink: 0; }

        .loading { text-align: center; padding: 40px; color: var(--gray-500); }
        .spinner { font-size: 2rem; color: var(--primary); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .empty-state { text-align: center; padding: 40px; color: var(--gray-500); }
        .empty-state i { font-size: 3rem; color: var(--gray-200); margin-bottom: 16px; display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Quality Control Proofs</h1>
            <p>Upload and track QC documentation for your purchase orders</p>
        </div>

        <div id="alertContainer" style="margin-bottom: 24px;"></div>

        <div class="grid-2">
            <!-- Upload Section -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-cloud-upload-alt"></i> Submit New Proof</div>
                </div>
                <div class="card-body">
                    <div class="section">
                        <div class="section-title">Select Purchase Order</div>
                        <div id="poSelector" class="po-selector"></div>
                    </div>

                    <div class="section">
                        <div class="section-title">Upload Files</div>
                        <div class="file-drop-zone" id="fileDropZone">
                            <div class="file-drop-icon"><i class="fas fa-images"></i></div>
                            <div class="file-drop-text">Drag files here or click to browse</div>
                            <div class="file-drop-hint">Supports: JPG, PNG, PDF (Max 10MB per file)</div>
                            <input type="file" id="fileInput" multiple accept="image/*,.pdf" style="display: none;">
                        </div>
                        <div class="file-list" id="fileList"></div>
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="proofDescription" placeholder="Describe what the proof shows, quality metrics, etc."></textarea>
                    </div>

                    <button class="button btn-primary" onclick="submitProof()" style="width: 100%;">
                        <i class="fas fa-check"></i> Submit Proof
                    </button>
                </div>
            </div>

            <!-- Proofs List Section -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-list"></i> Your Proofs</div>
                </div>
                <div class="card-body">
                    <div id="proofsList"></div>
                </div>
            </div>
        </div>

        <!-- Detailed Proofs Gallery -->
        <div class="card" style="margin-top: 24px;">
            <div class="card-header">
                <div class="card-title"><i class="fas fa-gallery"></i> All Proofs Gallery</div>
            </div>
            <div class="card-body">
                <div id="proofsGallery" class="proofs-grid"></div>
            </div>
        </div>
    </div>

    <script src="{% static 'js/vendor_api.js' %}"></script>
    <script>
        const vendorId = "{{ vendor.id }}" || "1";
        let vendorAPI;
        let allPOs = [];
        let selectedPOId = null;
        let selectedFiles = [];
        let allProofs = [];

        async function initPage() {
            try {
                vendorAPI = new VendorAPI(vendorId);
                await Promise.all([loadPOs(), loadProofs()]);
                setupFileUpload();
            } catch (error) {
                showAlert('Error initializing page: ' + error.message, 'error');
            }
        }

        async function loadPOs() {
            try {
                const data = await vendorAPI.getPurchaseOrders({ 
                    status: 'in_production,quality_check',
                    limit: 100 
                });
                allPOs = Array.isArray(data) ? data : (data.results || []);
                renderPOSelector();
            } catch (error) {
                console.warn('Failed to load POs:', error);
            }
        }

        async function loadProofs() {
            try {
                // Load proofs for all selected POs
                let allProofsData = [];
                for (const po of allPOs) {
                    const data = await vendorAPI.getProofs(po.id);
                    allProofsData = allProofsData.concat(Array.isArray(data) ? data : (data.results || []));
                }
                allProofs = allProofsData;
                renderProofsList();
                renderProofsGallery();
            } catch (error) {
                console.warn('Failed to load proofs:', error);
            }
        }

        function renderPOSelector() {
            if (allPOs.length === 0) {
                document.getElementById('poSelector').innerHTML = '<p style="grid-column: 1/-1; color: var(--gray-500);">No active POs found</p>';
                return;
            }

            let html = '';
            allPOs.forEach(po => {
                html += `
                    <div class="po-option" onclick="selectPO(${po.id})">
                        <div class="po-option-number">${po.po_number}</div>
                        <div class="po-option-type">${po.product_type || 'N/A'}</div>
                    </div>
                `;
            });
            document.getElementById('poSelector').innerHTML = html;
        }

        function selectPO(poId) {
            selectedPOId = selectedPOId === poId ? null : poId;
            document.querySelectorAll('.po-option').forEach((el, idx) => {
                if (allPOs[idx].id === poId) {
                    el.classList.toggle('selected');
                } else {
                    el.classList.remove('selected');
                }
            });
        }

        function setupFileUpload() {
            const dropZone = document.getElementById('fileDropZone');
            const fileInput = document.getElementById('fileInput');

            dropZone.addEventListener('click', () => fileInput.click());
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('active');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('active');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('active');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.size > 10 * 1024 * 1024) {
                    showAlert(`${file.name} is too large (max 10MB)`, 'warning');
                    return;
                }
                selectedFiles.push(file);
            });
            renderFileList();
        }

        function renderFileList() {
            const html = selectedFiles.map((file, idx) => `
                <div class="file-item">
                    <div class="file-item-info">
                        <div class="file-item-name">${file.name}</div>
                        <div class="file-item-size">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                    </div>
                    <button class="file-item-remove" onclick="removeFile(${idx})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');

            document.getElementById('fileList').innerHTML = html || '<p style="color: var(--gray-500); text-align: center; padding: 20px;">No files selected</p>';
        }

        function removeFile(idx) {
            selectedFiles.splice(idx, 1);
            renderFileList();
        }

        async function submitProof() {
            if (!selectedPOId) {
                showAlert('Please select a Purchase Order', 'warning');
                return;
            }

            if (selectedFiles.length === 0) {
                showAlert('Please select files to upload', 'warning');
                return;
            }

            try {
                for (const file of selectedFiles) {
                    await vendorAPI.uploadProof(
                        selectedPOId,
                        file,
                        document.getElementById('proofDescription').value
                    );
                }

                showAlert('Proofs submitted successfully!', 'success');
                selectedFiles = [];
                document.getElementById('fileInput').value = '';
                renderFileList();
                document.getElementById('proofDescription').value = '';
                await loadProofs();
            } catch (error) {
                showAlert('Failed to submit proofs: ' + error.message, 'error');
            }
        }

        function renderProofsList() {
            if (allProofs.length === 0) {
                document.getElementById('proofsList').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No proofs submitted yet</p>
                    </div>
                `;
                return;
            }

            const html = allProofs.slice(0, 5).map(proof => `
                <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--gray-100);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div style="font-weight: 700; font-size: 0.875rem;">PO: ${proof.purchase_order_number || 'N/A'}</div>
                        <span class="proof-status ${proof.status}">${getProofStatusDisplay(proof.status)}</span>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 4px;">${formatDate(proof.submitted_at)}</div>
                    ${proof.rejection_reason ? `<div style="font-size: 0.8rem; color: var(--danger); padding: 8px; background: #fee2e2; border-radius: 4px; margin-bottom: 8px;"><strong>Rejection Reason:</strong> ${proof.rejection_reason}</div>` : ''}
                    <div style="font-size: 0.8rem; color: var(--gray-500);">${proof.description || 'No description'}</div>
                </div>
            `).join('');

            document.getElementById('proofsList').innerHTML = html;
        }

        function renderProofsGallery() {
            if (allProofs.length === 0) {
                document.getElementById('proofsGallery').innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-image"></i>
                        <p>No proof images to display</p>
                    </div>
                `;
                return;
            }

            const html = allProofs.map(proof => `
                <div class="proof-card">
                    <div class="proof-thumbnail">
                        ${proof.proof_file ? `<img src="${proof.proof_file}" alt="Proof">` : '<i class="fas fa-file"></i>'}
                    </div>
                    <div class="proof-info">
                        <div class="proof-name">PO: ${proof.purchase_order_number || 'N/A'}</div>
                        <div class="proof-date">${formatDate(proof.submitted_at)}</div>
                        <span class="proof-status ${proof.status}">${getProofStatusDisplay(proof.status)}</span>
                        <div class="proof-actions">
                            ${proof.proof_file ? `<a href="${proof.proof_file}" target="_blank" title="Download"><i class="fas fa-download"></i></a>` : ''}
                            <button onclick="viewProofDetails(${proof.id})" title="Details">Info</button>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('proofsGallery').innerHTML = html;
        }

        function getProofStatusDisplay(status) {
            const map = {
                'pending': 'Pending Review',
                'approved': 'Approved',
                'rejected': 'Rejected'
            };
            return map[status] || status;
        }

        function viewProofDetails(proofId) {
            const proof = allProofs.find(p => p.id === proofId);
            if (!proof) return;

            alert(`
PO: ${proof.purchase_order_number}
Status: ${getProofStatusDisplay(proof.status)}
Submitted: ${formatDate(proof.submitted_at)}
${proof.reviewed_at ? 'Reviewed: ' + formatDate(proof.reviewed_at) : ''}
${proof.rejection_reason ? 'Rejection: ' + proof.rejection_reason : ''}

Description: ${proof.description || 'No description'}
            `);
        }

        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            document.getElementById('alertContainer').appendChild(alert);
            setTimeout(() => alert.remove(), 4000);
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-KE', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
