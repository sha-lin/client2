{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Partner Portal - Print Duka</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sidebar-bg: #0f172a;
            --sidebar-hover: #f1f5f9;
            --sidebar-active: #3b82f6;
            --body-bg: #f8fafc;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--body-bg); color: var(--text-main); display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar { width: 240px; background-color: white; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 1000; }
        .sidebar-header { padding: 24px; border-bottom: 1px solid var(--border-color); }
        .sidebar-header h1 { font-size: 1.25rem; font-weight: 800; color: #0f172a; }
        .sidebar-header p { font-size: 0.75rem; color: var(--text-muted); font-weight: 500; }
        .sidebar-nav { flex: 1; padding: 20px 0; }
        .nav-item { display: flex; align-items: center; padding: 12px 24px; color: var(--text-muted); text-decoration: none; font-size: 0.875rem; font-weight: 500; transition: all 0.2s; gap: 12px; }
        .nav-item:hover { background-color: var(--sidebar-hover); color: var(--text-main); }
        .nav-item.active { background-color: #eff6ff; color: var(--sidebar-active); border-right: 3px solid var(--sidebar-active); }
        .nav-item i { width: 20px; text-align: center; font-size: 1.1rem; }
        .sidebar-footer { padding: 20px; border-top: 1px solid var(--border-color); background: #f8fafc; }
        .vendor-name { font-size: 0.8125rem; font-weight: 700; color: var(--text-main); }
        .vendor-status { font-size: 0.7rem; color: var(--success); font-weight: 600; margin-top: 2px; }

        /* Main Content */
        .main-wrapper { margin-left: 240px; flex: 1; padding: 24px; display: flex; gap: 24px; }
        .content-area { flex: 1; max-width: calc(100% - 320px); }

        /* Urgent Actions */
        .urgent-section { background: white; border: 1px solid #fee2e2; border-radius: 12px; padding: 16px; margin-bottom: 24px; box-shadow: var(--shadow); }
        .urgent-header { display: flex; align-items: center; gap: 8px; color: #991b1b; font-weight: 700; font-size: 0.85rem; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.025em; }
        .urgent-alert { display: flex; align-items: center; justify-content: space-between; padding: 10px 16px; border-radius: 8px; margin-bottom: 8px; font-size: 0.8125rem; border: 1px solid transparent; }
        .urgent-alert.red { background-color: #fff5f5; border-color: #feb2b2; color: #c53030; }
        .urgent-alert.orange { background-color: #fffaf0; border-color: #fbd38d; color: #9a3412; }
        .urgent-alert.blue { background-color: #eff6ff; border-color: #bfdbfe; color: #1e40af; }
        .btn-action { padding: 6px 16px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; cursor: pointer; border: none; transition: opacity 0.2s; }
        .btn-red { background: #e53e3e; color: white; }
        .btn-blue { background: #3b82f6; color: white; }

        /* PO Header & Controls */
        .po-header { margin-bottom: 24px; }
        .po-header h2 { font-size: 1.25rem; font-weight: 700; margin-bottom: 16px; }
        .po-controls { display: flex; align-items: center; gap: 12px; }
        .search-container { flex: 1; position: relative; }
        .search-container i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .search-container input { width: 100%; padding: 10px 12px 10px 36px; border-radius: 8px; border: 1px solid var(--border-color); background: white; font-size: 0.8125rem; outline: none; }
        .filter-btn { padding: 8px 16px; background: white; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.75rem; font-weight: 600; cursor: pointer; }
        .filter-btn.active { background: #1e293b; color: white; border-color: #1e293b; }

        /* KPI Cards */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .kpi-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: var(--shadow); }
        .kpi-card.performance { grid-column: span 1; grid-row: span 2; background: white; }
        .kpi-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .kpi-value { font-size: 1.5rem; font-weight: 700; }
        .kpi-value.large { font-size: 2.5rem; color: var(--success); display: flex; align-items: center; gap: 8px; }
        .perf-stats { margin-top: 15px; font-size: 0.75rem; }
        .perf-row { display: flex; justify-content: space-between; margin-bottom: 8px; color: var(--text-muted); }
        .perf-row strong { color: var(--text-main); }

        /* Kanban Board */
        .kanban-board { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px; }
        .kanban-col { display: flex; flex-direction: column; gap: 12px; }
        .col-title { display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem; font-weight: 700; padding-bottom: 10px; border-bottom: 2px solid var(--border-color); }
        .col-count { background: #f1f5f9; color: #64748b; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; }
        
        .po-card { background: white; border-radius: 10px; padding: 16px; border: 1px solid var(--border-color); border-top: 4px solid var(--info); box-shadow: var(--shadow); }
        .po-card.green { border-top-color: var(--success); }
        .po-card.yellow { border-top-color: var(--warning); }
        .po-card.red { border-top-color: var(--danger); }
        .po-id { font-size: 0.8125rem; font-weight: 700; margin-bottom: 4px; }
        .po-type { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 12px; }
        .po-meta { display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 12px; }
        .po-meta .time { background: #f1f5f9; padding: 2px 6px; border-radius: 4px; color: var(--text-muted); }
        .po-meta .overdue { background: #fee2e2; color: #ef4444; font-weight: 700; padding: 2px 6px; border-radius: 4px; }
        .po-btn-group { display: flex; gap: 8px; }
        .po-btn { flex: 1; padding: 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; cursor: pointer; border: 1px solid var(--border-color); background: #f8fafc; }
        .po-btn.primary { background: var(--info); color: white; border: none; }

        /* Blocked Jobs */
        .blocked-box { background: #fffbeb; border: 1px solid #fde68a; border-radius: 12px; padding: 20px; display: flex; justify-content: space-between; align-items: center; margin-top: 24px; }
        .blocked-info h4 { font-size: 0.9rem; font-weight: 700; color: #92400e; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
        .blocked-info p { font-size: 0.8125rem; color: #b45309; }

        /* Right Panel */
        .right-panel { width: 300px; display: flex; flex-direction: column; gap: 20px; }
        .panel-card { background: white; border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); box-shadow: var(--shadow); }
        .panel-title { font-size: 0.875rem; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .deadline-item { padding: 12px 0; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
        .deadline-item:hover { background: #f8fafc; padding: 12px; margin: 0 -12px; border-radius: 6px; }
        .deadline-time { font-size: 0.75rem; color: var(--danger); font-weight: 700; margin-bottom: 4px; }
        .deadline-id { font-size: 0.8125rem; font-weight: 700; }
        .activity-item { display: flex; gap: 12px; margin-bottom: 16px; }
        .activity-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; flex-shrink: 0; }
        .activity-icon.blue { background: #dbeafe; color: #1e40af; }
        .activity-text { font-size: 0.8125rem; line-height: 1.4; }
        .activity-time { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }

        /* Loading and Error States */
        .loading { text-align: center; padding: 40px; }
        .spinner { font-size: 2rem; color: #3b82f6; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 1400px) { .kanban-board { grid-template-columns: repeat(3, 1fr); } }
    </style>
</head>

<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <h1>Print Duka</h1>
            <p>Vendor Partner Portal</p>
        </div>
        <nav class="sidebar-nav">
            <a href="{% url 'vendor_dashboard' %}" class="nav-item active"><i class="fas fa-th-large"></i> Dashboard</a>
            <a href="{% url 'active_jobs' %}" class="nav-item"><i class="fas fa-tasks"></i> Active Jobs</a>
            <a href="{% url 'vendor_proofs' %}" class="nav-item"><i class="fas fa-file-pdf"></i> QC Proofs</a>
            <a href="{% url 'invoices' %}" class="nav-item"><i class="fas fa-file-invoice-dollar"></i> Invoices</a>
            <a href="{% url 'performance' %}" class="nav-item"><i class="fas fa-chart-line"></i> Performance</a>
            <a href="#" class="nav-item"><i class="fas fa-question-circle"></i> Help Center</a>
        </nav>
        <div class="sidebar-footer">
            <div class="vendor-name">{{ vendor.name }}</div>
            <div class="vendor-status"><i class="fas fa-certificate"></i> Certified Vendor</div>
        </div>
    </aside>

    <div class="main-wrapper">
        <div class="content-area">
            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="loading" style="display: none;">
                <i class="fas fa-spinner fa-spin spinner"></i>
                <p style="margin-top: 16px; color: #64748b;">Loading dashboard data...</p>
            </div>

            <!-- Content Container (hidden until loaded) -->
            <div id="contentContainer" style="display: none;">
                <!-- Urgent Actions -->
                <div id="urgentActionsContainer" class="urgent-section" style="display: none;">
                    <div class="urgent-header"><i class="fas fa-exclamation-triangle"></i> Urgent Actions Required</div>
                    <div id="urgentActionsContent"></div>
                </div>

                <!-- PO Header -->
                <div class="po-header">
                    <h2>Purchase Orders</h2>
                    <div class="po-controls">
                        <div class="search-container">
                            <i class="fas fa-search"></i>
                            <input type="text" id="poSearch" placeholder="Search by PO Number or Product Type...">
                        </div>
                        <button class="filter-btn active" onclick="filterPOs('all')">Show All</button>
                        <button class="filter-btn" onclick="filterPOs('action_needed')">Action Needed</button>
                        <button class="filter-btn" onclick="filterPOs('overdue')">Overdue</button>
                    </div>
                </div>

                <!-- Kanban Board -->
                <div id="kanbanBoard" class="kanban-board"></div>

                <!-- KPI Grid -->
                <div id="kpiGrid" class="kpi-grid"></div>

                <!-- Blocked Jobs -->
                <div id="blockedJobsContainer" style="display: none;">
                    <div class="blocked-box">
                        <div class="blocked-info">
                            <h4><i class="fas fa-pause-circle"></i> Blocked Jobs (<span id="blockedCount">0</span>)</h4>
                            <div id="blockedList"></div>
                        </div>
                        <button class="btn-action" style="background: white; border: 1px solid var(--border-color);">Send Reminder</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <aside class="right-panel">
            <div class="panel-card">
                <div class="panel-title"><i class="far fa-clock"></i> Upcoming Deadlines</div>
                <div id="upcomingDeadlines">
                    <div class="loading"><i class="fas fa-spinner fa-spin spinner"></i></div>
                </div>
            </div>

            <div class="panel-card">
                <div class="panel-title"><i class="fas fa-history"></i> Recent Activity</div>
                <div id="recentActivity">
                    <div class="loading"><i class="fas fa-spinner fa-spin spinner"></i></div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Load Vendor API Service -->
    <script src="{% static 'js/vendor_api.js' %}"></script>

    <!-- Vendor ID for API -->
    <script>
        // Get vendor ID - adjust based on your auth system
        const vendorId = "{{ vendor.id }}" || "1";
    </script>

    <script>
        // ============================================================================
        // VENDOR DASHBOARD - COMPLETE API INTEGRATION
        // ============================================================================

        let vendorAPI;
        let allPOs = [];
        let allInvoices = [];
        let performanceData = {};
        let currentFilter = 'all';

        // Initialize dashboard on page load
        async function initDashboard() {
            try {
                document.getElementById('loadingIndicator').style.display = 'block';

                // Initialize API service
                vendorAPI = new VendorAPI(vendorId);

                // Load all data in parallel
                const [poStats, purchases, performance] = await Promise.all([
                    vendorAPI.getDashboardStats().catch(err => {
                        console.warn('Dashboard stats error:', err);
                        return null;
                    }),
                    vendorAPI.getPurchaseOrders({ limit: 100 }).catch(err => {
                        console.warn('POs error:', err);
                        return [];
                    }),
                    vendorAPI.getPerformanceScorecard().catch(err => {
                        console.warn('Performance error:', err);
                        return {};
                    })
                ]);

                allPOs = Array.isArray(purchases) ? purchases : (purchases.results || []);
                performanceData = performance || {};

                // Render all sections
                renderKPICards(poStats);
                renderKanbanBoard(allPOs);
                renderUrgentActions(allPOs);
                renderUpcomingDeadlines(allPOs);
                renderRecentActivity(allPOs);
                renderBlockedJobs(allPOs);

                // Setup event listeners
                setupEventListeners();

                // Show content, hide loading
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('contentContainer').style.display = 'block';

            } catch (error) {
                console.error('Dashboard initialization error:', error);
                document.getElementById('loadingIndicator').innerHTML = `
                    <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: #ef4444;"></i>
                    <p style="margin-top: 16px; color: #ef4444;">Error loading dashboard. Please refresh the page.</p>
                `;
            }
        }

        // ============================================================================
        // RENDER FUNCTIONS
        // ============================================================================

        function renderKPICards(stats) {
            if (!stats) return;

            const html = `
                <div class="kpi-card performance">
                    <div class="kpi-label">Performance Score</div>
                    <div class="kpi-value large">${performanceData.score || 'N/A'}% <i class="fas fa-trending-up" style="font-size: 1rem;"></i></div>
                    <div class="perf-stats">
                        <div class="perf-row"><span>Jobs completed:</span><strong>${stats.completed_pos || 0}</strong></div>
                        <div class="perf-row"><span>On-time rate:</span><strong>${performanceData.on_time_rate || 'N/A'}%</strong></div>
                        <div class="perf-row"><span>Quality score:</span><strong>${performanceData.quality_score || 'N/A'}%</strong></div>
                        <a href="{% url 'performance' %}" style="color: var(--info); text-decoration: none; font-weight: 700; font-size: 0.75rem; display: block; margin-top: 12px;">Full Scorecard →</a>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label"><i class="far fa-clock"></i> Active Jobs</div>
                    <div class="kpi-value">${stats.active_pos || 0}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label"><i class="fas fa-exclamation-circle"></i> Awaiting Response</div>
                    <div class="kpi-value" style="color: var(--danger);">${stats.delayed_pos || 0}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label"><i class="far fa-file-alt"></i> Pending Invoices</div>
                    <div class="kpi-value" style="color: var(--warning);">${stats.pending_invoices || 0}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label"><i class="fas fa-dollar-sign"></i> Total Value</div>
                    <div class="kpi-value">KES ${formatCurrency(stats.total_value || 0)}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label"><i class="far fa-hourglass"></i> Avg Completion</div>
                    <div class="kpi-value">${performanceData.avg_completion_days || 'N/A'} days</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label"><i class="far fa-calendar-alt"></i> Total POs</div>
                    <div class="kpi-value">${stats.total_pos || 0}</div>
                </div>
            `;

            document.getElementById('kpiGrid').innerHTML = html;
        }

        function renderKanbanBoard(pos) {
            const statusMap = {
                'new': { title: 'New POs', color: 'blue' },
                'in_production': { title: 'In Production', color: 'green' },
                'quality_check': { title: 'Quality Check', color: 'yellow' },
                'completed': { title: 'Completed', color: 'green' },
                'cancelled': { title: 'Cancelled', color: 'gray' }
            };

            const grouped = {};
            Object.keys(statusMap).forEach(key => grouped[key] = []);
            
            pos.forEach(po => {
                const status = po.status || 'new';
                if (grouped[status]) grouped[status].push(po);
            });

            let html = '';
            Object.entries(statusMap).forEach(([status, meta]) => {
                const items = grouped[status] || [];
                html += `
                    <div class="kanban-col">
                        <div class="col-title">${meta.title} <span class="col-count">${items.length}</span></div>
                        ${items.map(po => renderPOCard(po, meta.color)).join('')}
                    </div>
                `;
            });

            document.getElementById('kanbanBoard').innerHTML = html;
        }

        function renderPOCard(po, color = 'blue') {
            const daysUntilDue = getDaysUntilDue(po.required_by);
            const statusBadge = po.status === 'completed' ? '<div style="color: var(--success); font-size: 0.7rem; font-weight: 700; margin-bottom: 8px;">COMPLETED</div>' : '';
            
            return `
                <div class="po-card ${color === 'red' ? 'red' : color === 'yellow' ? 'yellow' : color === 'green' ? 'green' : ''}">
                    <div class="po-id">${po.po_number}</div>
                    <div class="po-type">${po.product_type || 'N/A'}</div>
                    ${statusBadge}
                    <div class="po-meta">
                        <span>Qty: ${po.quantity || 0}</span>
                        <span class="time">${daysUntilDue}d</span>
                    </div>
                    <div class="po-btn-group" style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="po-btn" onclick="viewPODetail(${po.id})" style="flex: 1;">View</button>
                        ${po.status === 'new' ? `<button class="po-btn primary" onclick="acceptPO(${po.id})" style="flex: 1;">Accept</button>` : ''}
                    </div>
                </div>
            `;
        }

        function renderUrgentActions(pos) {
            const today = new Date();
            const newPOs = pos.filter(p => p.status === 'new');
            const overduePOs = pos.filter(p => {
                if (['completed', 'cancelled'].includes(p.status)) return false;
                return p.required_by && new Date(p.required_by) < today;
            });
            const atRiskPOs = pos.filter(p => {
                if (['completed', 'cancelled'].includes(p.status)) return false;
                const daysUntilDue = getDaysUntilDue(p.required_by);
                return daysUntilDue <= 3 && daysUntilDue >= 0;
            });

            let urgentHTML = '';

            if (overduePOs.length > 0) {
                urgentHTML += `
                    <div class="urgent-alert red">
                        <span><i class="fas fa-clock"></i> ${overduePOs.length} PO(s) overdue - immediate action required</span>
                        <button class="btn-action btn-red" onclick="filterPOs('overdue')">View POs</button>
                    </div>
                `;
            }

            if (atRiskPOs.length > 0) {
                urgentHTML += `
                    <div class="urgent-alert orange">
                        <span><i class="fas fa-bolt"></i> ${atRiskPOs.length} PO(s) at risk - due within 3 days</span>
                        <button class="btn-action btn-red" onclick="filterPOs('at_risk')">Review</button>
                    </div>
                `;
            }

            if (newPOs.length > 0) {
                urgentHTML += `
                    <div class="urgent-alert blue">
                        <span><i class="fas fa-plus-circle"></i> ${newPOs.length} new PO(s) awaiting Accept/Decline</span>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn-action btn-blue" onclick="acceptAllNewPOs()">Accept All</button>
                            <button class="btn-action" style="background: white; border: 1px solid #3b82f6; color: #3b82f6;" onclick="filterPOs('new')">Review</button>
                        </div>
                    </div>
                `;
            }

            if (urgentHTML) {
                document.getElementById('urgentActionsContainer').style.display = 'block';
                document.getElementById('urgentActionsContent').innerHTML = urgentHTML;
            }
        }

        function renderUpcomingDeadlines(pos) {
            const upcoming = pos
                .filter(p => p.required_by && !['completed', 'cancelled'].includes(p.status))
                .sort((a, b) => new Date(a.required_by) - new Date(b.required_by))
                .slice(0, 5);

            if (upcoming.length === 0) {
                document.getElementById('upcomingDeadlines').innerHTML = '<p style="font-size: 0.75rem; color: var(--text-muted);">No upcoming deadlines</p>';
                return;
            }

            let html = '';
            upcoming.forEach(po => {
                const daysUntil = getDaysUntilDue(po.required_by);
                html += `
                    <div class="deadline-item" onclick="viewPODetail(${po.id})">
                        <div class="deadline-time" style="color: ${daysUntil <= 3 ? '#ef4444' : '#64748b'};">Due in ${daysUntil} day${daysUntil !== 1 ? 's' : ''}</div>
                        <div class="deadline-id">${po.po_number}</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">${po.product_type}</div>
                    </div>
                `;
            });

            document.getElementById('upcomingDeadlines').innerHTML = html;
        }

        function renderRecentActivity(pos) {
            const recent = pos
                .filter(p => p.updated_at)
                .sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at))
                .slice(0, 5);

            if (recent.length === 0) {
                document.getElementById('recentActivity').innerHTML = '<p style="font-size: 0.75rem; color: var(--text-muted);">No recent activity</p>';
                return;
            }

            let html = '';
            recent.forEach(po => {
                const timeAgo = getTimeAgo(new Date(po.updated_at));
                const statusDisplay = getStatusDisplay(po.status);
                html += `
                    <div class="activity-item">
                        <div class="activity-icon blue"><i class="fas fa-sync"></i></div>
                        <div class="activity-text">
                            PO <strong>${po.po_number}</strong> → ${statusDisplay}
                            <div class="activity-time">${timeAgo}</div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('recentActivity').innerHTML = html;
        }

        function renderBlockedJobs(pos) {
            const blocked = pos.filter(p => p.status === 'cancelled' || p.blocked);
            
            if (blocked.length === 0) {
                document.getElementById('blockedJobsContainer').style.display = 'none';
                return;
            }

            document.getElementById('blockedJobsContainer').style.display = 'block';
            document.getElementById('blockedCount').textContent = blocked.length;

            let html = '';
            blocked.forEach(po => {
                html += `<p><strong>${po.po_number}</strong>: ${po.blocked_reason || 'No reason provided'}</p>`;
            });

            document.getElementById('blockedList').innerHTML = html;
        }

        // ============================================================================
        // EVENT HANDLERS
        // ============================================================================

        function setupEventListeners() {
            document.getElementById('poSearch').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                const filtered = allPOs.filter(po => 
                    po.po_number?.toLowerCase().includes(query) || 
                    po.product_type?.toLowerCase().includes(query)
                );
                renderKanbanBoard(filtered);
            });
        }

        function filterPOs(filter) {
            currentFilter = filter;
            const today = new Date();
            let filtered = [...allPOs];

            switch(filter) {
                case 'new':
                    filtered = filtered.filter(p => p.status === 'new');
                    break;
                case 'action_needed':
                    filtered = filtered.filter(p => p.status === 'new' || (p.required_by && new Date(p.required_by) < today));
                    break;
                case 'overdue':
                    filtered = filtered.filter(p => p.required_by && new Date(p.required_by) < today && p.status !== 'completed' && p.status !== 'cancelled');
                    break;
                case 'at_risk':
                    filtered = filtered.filter(p => {
                        if (['completed', 'cancelled'].includes(p.status)) return false;
                        const daysUntilDue = getDaysUntilDue(p.required_by);
                        return daysUntilDue <= 3 && daysUntilDue >= 0;
                    });
                    break;
            }

            renderKanbanBoard(filtered);
        }

        async function acceptPO(poId) {
            try {
                const result = await vendorAPI.acceptPO(poId);
                showSuccess('Purchase Order accepted!');
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                showError('Failed to accept PO: ' + error.message);
            }
        }

        async function acceptAllNewPOs() {
            try {
                const newPOs = allPOs.filter(p => p.status === 'new');
                for (const po of newPOs) {
                    await vendorAPI.acceptPO(po.id);
                }
                showSuccess(`Accepted ${newPOs.length} Purchase Orders!`);
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                showError('Failed to accept POs: ' + error.message);
            }
        }

        function viewPODetail(poId) {
            window.location.href = `/purchase-orders/${poId}/`;
        }

        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================

        function getDaysUntilDue(dueDate) {
            if (!dueDate) return '?';
            const due = new Date(dueDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            due.setHours(0, 0, 0, 0);
            const diff = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
            return diff < 0 ? '0' : diff;
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        function getStatusDisplay(status) {
            const map = {
                'new': 'New',
                'in_production': 'In Production',
                'quality_check': 'Quality Check',
                'completed': 'Completed',
                'cancelled': 'Cancelled'
            };
            return map[status] || status;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-KE', { 
                style: 'decimal', 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0 
            }).format(Math.round(amount));
        }

        function showSuccess(message) {
            const alert = document.createElement('div');
            alert.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 16px 24px; border-radius: 8px; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
            alert.textContent = message;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }

        function showError(message) {
            const alert = document.createElement('div');
            alert.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 16px 24px; border-radius: 8px; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
            alert.textContent = message;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDashboard);
        } else {
            initDashboard();
        }
    </script>
</body>

</html>
