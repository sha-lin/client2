{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Scorecard - Vendor Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-500: #6b7280;
            --gray-900: #111827;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--gray-50); color: var(--gray-900); }

        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        .header { margin-bottom: 32px; }
        .header h1 { font-size: 2rem; font-weight: 700; margin-bottom: 8px; }
        .header p { color: var(--gray-500); font-size: 0.9rem; }

        .score-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 32px; }
        
        .score-card { background: white; border-radius: 12px; border: 1px solid var(--gray-200); overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .score-card-header { padding: 20px; border-bottom: 1px solid var(--gray-100); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .score-card-header.success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .score-card-header.warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .score-card-header.danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .score-card-header.info { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); }
        .score-label { font-size: 0.875rem; opacity: 0.9; margin-bottom: 8px; font-weight: 600; }
        .score-value { font-size: 2.5rem; font-weight: 700; margin-bottom: 4px; }
        .score-suffix { font-size: 1rem; opacity: 0.8; }

        .score-card-body { padding: 20px; }
        .score-meta { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--gray-500); margin-bottom: 12px; }
        .score-meta-item { }
        .score-meta-label { font-weight: 600; }

        .progress-bar { width: 100%; height: 8px; background: var(--gray-100); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); border-radius: 4px; transition: width 0.3s; }

        .breakdown { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-100); }
        .breakdown-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.875rem; }
        .breakdown-label { color: var(--gray-500); }
        .breakdown-value { font-weight: 700; color: var(--gray-900); }

        .section { background: white; border-radius: 12px; border: 1px solid var(--gray-200); overflow: hidden; margin-bottom: 32px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .section-header { padding: 20px; border-bottom: 1px solid var(--gray-100); background: var(--gray-50); }
        .section-title { font-size: 1.125rem; font-weight: 700; display: flex; align-items: center; gap: 12px; }
        .section-title i { color: var(--primary); font-size: 1.25rem; }
        .section-body { padding: 20px; }

        .chart-container { height: 300px; display: flex; align-items: flex-end; gap: 12px; }
        .bar { flex: 1; background: linear-gradient(180deg, #3b82f6 0%, #1e40af 100%); border-radius: 8px 8px 0 0; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-top: 20px; color: white; font-weight: 700; font-size: 0.875rem; position: relative; min-height: 50px; }
        .bar-label { position: absolute; bottom: -30px; font-size: 0.75rem; color: var(--gray-500); white-space: nowrap; }

        .timeline { position: relative; padding-left: 24px; }
        .timeline-item { margin-bottom: 24px; position: relative; }
        .timeline-item::before { content: ''; position: absolute; left: -24px; top: 0; width: 12px; height: 12px; border-radius: 50%; background: var(--primary); border: 3px solid white; box-shadow: 0 0 0 1px var(--gray-200); }
        .timeline-item:first-child::after { content: ''; position: absolute; left: -18px; top: 12px; width: 2px; height: calc(100% - 12px); background: var(--gray-200); }
        .timeline-date { font-size: 0.75rem; color: var(--gray-500); font-weight: 600; margin-bottom: 4px; }
        .timeline-event { font-size: 0.875rem; font-weight: 600; margin-bottom: 2px; }
        .timeline-details { font-size: 0.8rem; color: var(--gray-500); }

        .metric-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--gray-100); }
        .metric-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .metric-label { color: var(--gray-500); font-size: 0.875rem; font-weight: 600; }
        .metric-value { font-size: 1.25rem; font-weight: 700; color: var(--primary); }
        .metric-value.success { color: var(--success); }
        .metric-value.warning { color: var(--warning); }
        .metric-value.danger { color: var(--danger); }

        .rating { display: flex; align-items: center; gap: 8px; }
        .stars { display: flex; gap: 4px; }
        .star { color: var(--warning); font-size: 1.2rem; }
        .star.empty { color: var(--gray-200); }

        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 0.875rem; display: flex; gap: 12px; align-items: center; }
        .alert.success { background: #d1fae5; border: 1px solid #6ee7b7; color: #065f46; }
        .alert.warning { background: #fef3c7; border: 1px solid #fcd34d; color: #92400e; }
        .alert.info { background: #dbeafe; border: 1px solid #93c5fd; color: #1e40af; }

        .loading { text-align: center; padding: 60px 20px; color: var(--gray-500); }
        .spinner { font-size: 2rem; color: var(--primary); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .score-grid { grid-template-columns: 1fr; }
            .metric-row { grid-template-columns: 1fr; }
            .chart-container { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Performance Scorecard</h1>
            <p>View your vendor performance metrics and historical trends</p>
        </div>

        <div id="loadingIndicator" class="loading">
            <i class="fas fa-spinner fa-spin spinner"></i>
            <p style="margin-top: 16px;">Loading performance data...</p>
        </div>

        <div id="contentContainer" style="display: none;">
            <!-- Main Scores -->
            <div class="score-grid">
                <div class="score-card">
                    <div class="score-card-header success">
                        <div class="score-label">Overall Performance</div>
                        <div><span class="score-value" id="scoreOverall">0</span><span class="score-suffix">%</span></div>
                    </div>
                    <div class="score-card-body">
                        <div class="progress-bar"><div class="progress-fill" id="progressOverall" style="width: 0%;"></div></div>
                        <div class="breakdown">
                            <div class="breakdown-item">
                                <span class="breakdown-label">Rating:</span>
                                <span class="breakdown-value" id="ratingOverall">N/A</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Last Updated:</span>
                                <span class="breakdown-value" id="lastUpdated">N/A</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="score-card">
                    <div class="score-card-header">
                        <div class="score-label">On-Time Delivery</div>
                        <div><span class="score-value" id="scoreOnTime">0</span><span class="score-suffix">%</span></div>
                    </div>
                    <div class="score-card-body">
                        <div class="progress-bar"><div class="progress-fill" id="progressOnTime" style="width: 0%; background: var(--info);"></div></div>
                        <div class="breakdown">
                            <div class="breakdown-item">
                                <span class="breakdown-label">On-Time POs:</span>
                                <span class="breakdown-value" id="onTimePOs">0</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Total POs:</span>
                                <span class="breakdown-value" id="totalPOs">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="score-card">
                    <div class="score-card-header warning">
                        <div class="score-label">Quality Score</div>
                        <div><span class="score-value" id="scoreQuality">0</span><span class="score-suffix">%</span></div>
                    </div>
                    <div class="score-card-body">
                        <div class="progress-bar"><div class="progress-fill" id="progressQuality" style="width: 0%; background: var(--warning);"></div></div>
                        <div class="breakdown">
                            <div class="breakdown-item">
                                <span class="breakdown-label">Approved Proofs:</span>
                                <span class="breakdown-value" id="approvedProofs">0</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Rejection Rate:</span>
                                <span class="breakdown-value" id="rejectionRate">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="score-card">
                    <div class="score-card-header info">
                        <div class="score-label">Communication</div>
                        <div><span class="score-value" id="scoreCommunication">0</span><span class="score-suffix">%</span></div>
                    </div>
                    <div class="score-card-body">
                        <div class="progress-bar"><div class="progress-fill" id="progressCommunication" style="width: 0%; background: var(--info);"></div></div>
                        <div class="breakdown">
                            <div class="breakdown-item">
                                <span class="breakdown-label">Response Time:</span>
                                <span class="breakdown-value" id="responseTime">N/A</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Issues Resolved:</span>
                                <span class="breakdown-value" id="issuesResolved">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Summary -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title"><i class="fas fa-chart-bar"></i> Performance Summary</div>
                </div>
                <div class="section-body">
                    <div class="metric-row">
                        <div>
                            <div class="metric-label">Total POs Completed</div>
                            <div class="metric-value success" id="totalCompleted">0</div>
                        </div>
                        <div>
                            <div class="metric-label">Average Completion Days</div>
                            <div class="metric-value" id="avgCompletionDays">0</div>
                        </div>
                    </div>
                    <div class="metric-row">
                        <div>
                            <div class="metric-label">Total Invoiced</div>
                            <div class="metric-value success" id="totalInvoiced">KES 0</div>
                        </div>
                        <div>
                            <div class="metric-label">Total Paid</div>
                            <div class="metric-value" id="totalPaid">KES 0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trends -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title"><i class="fas fa-chart-line"></i> Performance Trends (Last 6 Months)</div>
                </div>
                <div class="section-body">
                    <div class="chart-container" id="trendsChart"></div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title"><i class="fas fa-history"></i> Recent Milestones</div>
                </div>
                <div class="section-body">
                    <div class="timeline" id="milestonesTimeline"></div>
                </div>
            </div>

            <!-- Certifications & Recognition -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title"><i class="fas fa-star"></i> Recognition & Awards</div>
                </div>
                <div class="section-body">
                    <div id="recognitionContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'js/vendor_api.js' %}"></script>
    <script>
        const vendorId = "{{ vendor.id }}" || "1";
        let vendorAPI;

        async function initPage() {
            try {
                vendorAPI = new VendorAPI(vendorId);
                const scorecard = await vendorAPI.getPerformanceScorecard();
                const trends = await vendorAPI.getPerformanceTrends();
                
                renderScorecard(scorecard);
                renderTrends(trends);
                renderMilestones(scorecard);
                renderRecognition(scorecard);
                
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('contentContainer').style.display = 'block';
            } catch (error) {
                console.error('Error loading performance data:', error);
                document.getElementById('loadingIndicator').innerHTML = `
                    <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: var(--danger);"></i>
                    <p style="margin-top: 16px; color: var(--danger);">Error loading performance data</p>
                `;
            }
        }

        function renderScorecard(data) {
            if (!data) return;

            const overall = Math.round((
                (data.on_time_rate || 0) * 0.4 +
                (data.quality_score || 0) * 0.3 +
                (data.communication_score || 0) * 0.3
            ) / 100) * 100;

            // Overall Score
            document.getElementById('scoreOverall').textContent = overall;
            document.getElementById('progressOverall').style.width = overall + '%';
            document.getElementById('ratingOverall').textContent = getRating(overall);
            document.getElementById('lastUpdated').textContent = formatDate(new Date());

            // On-Time Delivery
            document.getElementById('scoreOnTime').textContent = Math.round(data.on_time_rate || 0);
            document.getElementById('progressOnTime').style.width = (data.on_time_rate || 0) + '%';
            document.getElementById('onTimePOs').textContent = data.on_time_pos || 0;
            document.getElementById('totalPOs').textContent = data.total_pos || 0;

            // Quality Score
            document.getElementById('scoreQuality').textContent = Math.round(data.quality_score || 0);
            document.getElementById('progressQuality').style.width = (data.quality_score || 0) + '%';
            document.getElementById('approvedProofs').textContent = data.approved_proofs || 0;
            document.getElementById('rejectionRate').textContent = ((data.rejection_rate || 0) * 100).toFixed(1) + '%';

            // Communication
            document.getElementById('scoreCommunication').textContent = Math.round(data.communication_score || 0);
            document.getElementById('progressCommunication').style.width = (data.communication_score || 0) + '%';
            document.getElementById('responseTime').textContent = data.avg_response_time || 'N/A';
            document.getElementById('issuesResolved').textContent = ((data.issues_resolved || 0) * 100).toFixed(0) + '%';

            // Summary
            document.getElementById('totalCompleted').textContent = data.total_completed || 0;
            document.getElementById('avgCompletionDays').textContent = (data.avg_completion_days || 0).toFixed(1) + ' days';
            document.getElementById('totalInvoiced').textContent = 'KES ' + formatCurrency(data.total_invoiced || 0);
            document.getElementById('totalPaid').textContent = 'KES ' + formatCurrency(data.total_paid || 0);
        }

        function renderTrends(trends) {
            if (!trends || trends.length === 0) {
                document.getElementById('trendsChart').innerHTML = '<p style="color: var(--gray-500); text-align: center; padding: 40px;">No trend data available</p>';
                return;
            }

            const maxValue = Math.max(...trends.map(t => t.score), 100);
            let html = '';
            trends.slice(-6).forEach(trend => {
                const height = (trend.score / maxValue) * 250;
                html += `
                    <div class="bar" style="height: ${height}px; background: linear-gradient(180deg, #3b82f6 0%, #1e40af 100%);">
                        <span>${Math.round(trend.score)}%</span>
                        <div class="bar-label">${new Date(trend.month).toLocaleDateString('en-KE', { month: 'short', year: '2-digit' })}</div>
                    </div>
                `;
            });
            document.getElementById('trendsChart').innerHTML = html;
        }

        function renderMilestones(data) {
            if (!data || !data.recent_milestones) {
                document.getElementById('milestonesTimeline').innerHTML = '<p style="color: var(--gray-500);">No milestones yet</p>';
                return;
            }

            let html = '';
            data.recent_milestones.forEach(milestone => {
                html += `
                    <div class="timeline-item">
                        <div class="timeline-date">${formatDate(milestone.date)}</div>
                        <div class="timeline-event">${milestone.event}</div>
                        <div class="timeline-details">${milestone.description || ''}</div>
                    </div>
                `;
            });
            document.getElementById('milestonesTimeline').innerHTML = html;
        }

        function renderRecognition(data) {
            if (!data || !data.certifications) {
                document.getElementById('recognitionContent').innerHTML = '<p style="color: var(--gray-500);">No certifications or awards yet</p>';
                return;
            }

            let html = '';
            if (data.certifications.length > 0) {
                html += '<div style="margin-bottom: 16px;"><strong>Certifications:</strong></div>';
                data.certifications.forEach(cert => {
                    html += `<div style="margin-bottom: 8px; padding: 8px; background: var(--gray-50); border-radius: 6px;">✓ ${cert}</div>`;
                });
            }

            if (data.awards && data.awards.length > 0) {
                html += '<div style="margin-top: 16px; margin-bottom: 16px;"><strong>Awards & Recognition:</strong></div>';
                data.awards.forEach(award => {
                    html += `<div style="margin-bottom: 8px; padding: 8px; background: #fef3c7; border-left: 3px solid var(--warning); border-radius: 6px;"><i class="fas fa-trophy" style="color: var(--warning);"></i> ${award}</div>`;
                });
            }

            if (!html) {
                html = '<p style="color: var(--gray-500);">No certifications or awards yet. Keep up the great work!</p>';
            }

            document.getElementById('recognitionContent').innerHTML = html;
        }

        function getRating(score) {
            if (score >= 90) return '⭐⭐⭐⭐⭐ Excellent';
            if (score >= 75) return '⭐⭐⭐⭐ Very Good';
            if (score >= 60) return '⭐⭐⭐ Good';
            if (score >= 45) return '⭐⭐ Fair';
            return '⭐ Needs Improvement';
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-KE', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(Math.round(amount));
        }

        function formatDate(date) {
            if (typeof date === 'string') {
                date = new Date(date);
            }
            return date.toLocaleDateString('en-KE', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
