{% extends "base.html" %}
{% load static %}

{% block title %}Create New Process - Vendor Management{% endblock %}

{% block content %}
<div class="p-8">

    <!-- Page Title -->
    <h1 class="text-3xl font-semibold mb-6">CREATE NEW PROCESS</h1>

    <form method="POST">
        {% csrf_token %}
        
        <!-- Hidden field for pricing method -->
        <input type="hidden" name="pricing_method" value="tier" id="pricing-method-input">

        <!-- ====================== BASIC INFORMATION ====================== -->
        <div class="bg-white border rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-6 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                BASIC INFORMATION
            </h2>

            <!-- Process Name -->
            <div class="mb-5">
                <label class="block font-medium mb-2">Process Name: <span class="text-red-500">*</span></label>
                <input type="text" name="process_name" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Hoodie Embroidery" required>
            </div>

            <!-- Process ID -->
            <div class="mb-5">
                <label class="block font-medium mb-2">Process ID: <span class="text-sm text-gray-500">(auto-generated)</span></label>
                <input type="text" name="process_id" class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100 text-gray-500" value="Generated from name" readonly>
            </div>

            <!-- Description -->
            <div class="mb-5">
                <label class="block font-medium mb-2">Description:</label>
                <textarea name="description" rows="3" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Embroidery service specifically for hoodies. Pricing based on stitch count, positions, and quantity."></textarea>
            </div>

            <!-- Category -->
            <div class="mb-5">
                <label class="block font-medium mb-2">Category: <span class="text-red-500">*</span></label>
                <div class="space-y-2">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="radio" name="category" value="outsourced" checked class="w-4 h-4 text-purple-600">
                        <div>
                            <div class="font-medium">Outsourced</div>
                            <div class="text-sm text-gray-500">Uses external vendors</div>
                        </div>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="radio" name="category" value="in-house" class="w-4 h-4 text-purple-600">
                        <div>
                            <div class="font-medium">In-house</div>
                            <div class="text-sm text-gray-500">Internal production</div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Standard Lead Time -->
            <div>
                <label class="block font-medium mb-2">Standard Lead Time: <span class="text-red-500">*</span></label>
                <div class="flex items-center gap-2">
                    <input type="number" name="standard_lead_time" class="border border-gray-300 rounded px-3 py-2 w-20" value="5" required>
                    <span class="text-gray-600">days</span>
                </div>
            </div>
        </div>

        <!-- ====================== VENDOR MANAGEMENT ====================== -->
        <div class="bg-white border rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-6 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
                VENDOR MANAGEMENT
            </h2>
            <p class="text-gray-600 mb-6">Link vendors from your vendor system to this process</p>

            <div id="vendors-container">
                <!-- VENDOR 1: PREFERRED -->
                <div class="border border-green-300 rounded-lg p-5 mb-4 bg-green-50 relative vendor-card">
                    <h4 class="font-semibold text-green-700 mb-4">VENDOR 1: PREFERRED</h4>

                    <!-- Vendor Selection -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block font-medium mb-2">Vendor:</label>
                            <select name="vendor1_id" class="w-full border border-gray-300 rounded px-3 py-2 bg-white vendor-select">
                                <option value="">Select vendor...</option>
                                {% for vendor in vendors %}
                                <option value="{{ vendor.id }}" data-vps="{{ vendor.vps_score_value }}" data-vendor-id="{{ vendor.id }}">
                                    {{ vendor.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <button type="button" id="open-new-vendor" class="mt-2 text-xs text-blue-600 hover:text-blue-800">
                                + Add New Vendor
                            </button>
                        </div>
                        <div>
                            <label class="block font-medium mb-2">Vendor ID:</label>
                            <input type="text" name="vendor1_vendor_id" class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100" readonly>
                        </div>
                    </div>

                    <!-- VPS Score Display -->
                    <div class="mb-4">
                        <span class="text-sm font-medium">VPS:</span>
                        <span class="font-semibold text-green-600 vendor-vps">--%</span>
                        <span class="ml-2 vendor-stars text-yellow-500">â˜†â˜†â˜†â˜†â˜†</span>
                    </div>

                    <!-- Base Cost -->
                    <div class="mb-4">
                        <label class="block font-medium mb-2">Base Cost:</label>
                        <div class="flex items-center gap-2">
                            <input type="number" step="0.01" name="vendor1_base_cost" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="50">
                            <span class="text-gray-600">KES</span>
                        </div>
                    </div>

                    <!-- Rush Fees -->
                    <div class="mb-4">
                        <h5 class="font-semibold mb-3">Rush Fees:</h5>
                        <div class="flex items-center gap-2 mb-3">
                            <input type="checkbox" name="vendor1_rush_enabled" id="vendor1_rush" value="1" class="w-4 h-4">
                            <label for="vendor1_rush" class="font-medium">Enable rush pricing</label>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm mb-1">Rush fee =</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" name="vendor1_rush_fee" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="60" value="60">
                                    <span class="text-gray-600">% for lead time <</span>
                                    <input type="number" name="vendor1_rush_threshold" class="w-20 border border-gray-300 rounded px-3 py-2" value="3">
                                    <span class="text-gray-600">days</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Minimum Order & Lead Time -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block font-medium mb-2">Minimum Order:</label>
                            <div class="flex items-center gap-2">
                                <input type="number" name="vendor1_min_order" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="100" value="100">
                                <span class="text-gray-600">KES</span>
                            </div>
                        </div>
                        <div>
                            <label class="block font-medium mb-2">Lead Time:</label>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="flex items-center gap-2">
                                    <input type="number" name="vendor1_standard_days" class="w-full border border-gray-300 rounded px-3 py-2" value="5">
                                    <span class="text-sm text-gray-600">days (standard)</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="number" name="vendor1_rush_days" class="w-full border border-gray-300 rounded px-3 py-2" value="2">
                                    <span class="text-sm text-gray-600">days (rush)</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label class="block font-medium mb-2">Notes:</label>
                        <textarea name="vendor1_notes" rows="2" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Preferred vendor for premium embroidery. Excellent quality and reliable delivery."></textarea>
                    </div>
                </div>
            </div>

            <!-- Default Vendor Selection Logic -->
            <div class="border-t pt-6">
                <h4 class="font-semibold mb-4">Default Vendor Selection Logic:</h4>
                <div class="space-y-2">
                    <label class="flex items-center gap-2">
                        <input type="radio" name="vendor_selection_logic" value="highest_vps" class="w-4 h-4" checked>
                        <span>Auto-select highest VPS vendor</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="radio" name="vendor_selection_logic" value="lowest_cost" class="w-4 h-4">
                        <span>Auto-select lowest cost vendor</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="radio" name="vendor_selection_logic" value="manual" class="w-4 h-4">
                        <span>Always require manual selection</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- ====================== PRICING METHOD ====================== -->
        <div class="bg-white border rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                PRICING METHOD
            </h2>
            <p class="text-gray-600 mb-6">Choose how this process will be priced</p>

            <div class="grid grid-cols-2 gap-4">
                <!-- Tier-Based Pricing -->
                <div class="border-2 border-blue-500 rounded-lg p-5 bg-blue-50">
                    <div class="flex items-center gap-2 mb-3">
                        <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                            <circle cx="10" cy="10" r="8"></circle>
                        </svg>
                        <h3 class="font-semibold text-base">TIER-BASED PRICING</h3>
                    </div>

                    <div class="mb-3">
                        <p class="text-sm font-medium mb-1">Best for:</p>
                        <ul class="text-sm text-gray-700 list-disc list-inside space-y-1">
                            <li>Fixed-spec products</li>
                            <li>Quantity discounts</li>
                            <li>Simple pricing</li>
                        </ul>
                    </div>

                    <div class="mb-3">
                        <p class="text-sm font-medium mb-1">Examples:</p>
                        <ul class="text-sm text-gray-700 list-disc list-inside space-y-1">
                            <li>Business cards</li>
                            <li>Flyers</li>
                            <li>Standard products</li>
                        </ul>
                    </div>

                    <button type="button" onclick="selectTierBased()" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                        SELECT
                    </button>
                </div>

                <!-- Formula-Based Pricing -->
                <div class="border-2 border-gray-300 rounded-lg p-5 bg-white">
                    <div class="flex items-center gap-2 mb-3">
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <circle cx="10" cy="10" r="8"></circle>
                        </svg>
                        <h3 class="font-semibold text-base">FORMULA-BASED PRICING</h3>
                    </div>

                    <div class="mb-3">
                        <p class="text-sm font-medium mb-1">Best for:</p>
                        <ul class="text-sm text-gray-700 list-disc list-inside space-y-1">
                            <li>Variable specifications</li>
                            <li>Complex calculations</li>
                            <li>Custom products</li>
                        </ul>
                    </div>

                    <div class="mb-3">
                        <p class="text-sm font-medium mb-1">Examples:</p>
                        <ul class="text-sm text-gray-700 list-disc list-inside space-y-1">
                            <li>Embroidery (stitch count)</li>
                            <li>Printing (size-based)</li>
                            <li>Custom fabrication</li>
                        </ul>
                    </div>

                    <button type="button" onclick="selectFormulaBased()" class="w-full bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition">
                        SELECT
                    </button>
                </div>
            </div>
        </div>

        <!-- ====================== TIER-BASED PRICING CONFIGURATION ====================== -->
        <div class="bg-white border rounded-lg p-6 mb-6" id="tier-pricing-section" style="display: block;">
            <h2 class="text-lg font-semibold mb-6 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                </svg>
                TIER-BASED PRICING CONFIGURATION
            </h2>

            <!-- Unit of Measure -->
            <div class="mb-6">
                <label class="block font-medium mb-2">Unit of Measure: <span class="text-red-500">*</span></label>
                <select name="unit_of_measure" class="w-64 border border-gray-300 rounded px-3 py-2">
                    <option value="per_piece" selected>Per Piece</option>
                    <option value="per_set">Per Set</option>
                    <option value="per_box">Per Box</option>
                    <option value="per_ream">Per Ream</option>
                    <option value="custom">Custom</option>
                </select>
            </div>

            <!-- Quantity Tiers Container -->
            <div class="mb-6">
                <h3 class="font-semibold text-base mb-4">QUANTITY TIERS:</h3>
                <div id="tiers-container">
                    <!-- Tier 1 (Default) -->
                    <div class="border border-red-300 rounded-lg p-5 mb-4 bg-red-50 relative tier-card" data-tier="1">
                        <button type="button" class="absolute top-3 right-3 text-red-500 hover:text-red-700 remove-tier-btn hidden">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                        
                        <h4 class="font-semibold text-red-700 mb-4">TIER 1</h4>

                        <div class="mb-4">
                            <label class="block font-medium mb-2">Quantity Range:</label>
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-600">From:</span>
                                <input type="number" name="tier1_from" class="border border-gray-300 rounded px-3 py-2 w-24" value="1" min="1" required>
                                <span class="text-sm text-gray-600">To:</span>
                                <input type="number" name="tier1_to" class="border border-gray-300 rounded px-3 py-2 w-24" value="500" min="1" required>
                                <span class="text-gray-600">pieces</span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block font-medium mb-2">Price:</label>
                            <div class="flex items-center gap-2">
                                <input type="number" name="tier1_price" step="0.01" class="border border-gray-300 rounded px-3 py-2 w-32" value="3000" required>
                                <span class="text-gray-600">KES</span>
                            </div>
                        </div>

                        <div>
                            <label class="block font-medium mb-2">Cost:</label>
                            <div class="flex items-center gap-2 mb-2">
                                <input type="number" name="tier1_cost" step="0.01" class="border border-gray-300 rounded px-3 py-2 w-32" value="2000" required>
                                <span class="text-gray-600">KES</span>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="button" id="add-tier-btn" class="w-full border-2 border-dashed border-gray-300 rounded-lg py-3 text-gray-600 font-medium hover:border-blue-400 hover:text-blue-600 transition">
                    + Add Another Tier
                </button>
            </div>

            <!-- TEST CALCULATOR FOR TIER-BASED -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-5">
                <h3 class="font-semibold text-blue-900 mb-4">TEST CALCULATOR (TIER-BASED):</h3>
                <p class="text-sm text-gray-600 mb-4">Test your tier pricing with a specific quantity</p>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block font-medium mb-2">Test Quantity:</label>
                        <input type="number" id="tier_test_quantity" class="w-full border border-gray-300 rounded px-3 py-2 bg-white" value="250" min="1">
                    </div>
                </div>

                <button type="button" id="tier-calculate-btn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
                    Calculate Tier Price
                </button>

                <div id="tier-test-result" class="mt-4 hidden">
                    <p class="text-lg font-semibold text-blue-900">Matched Tier: <span id="tier-matched" class="text-green-600">-</span></p>
                    <p class="text-lg font-semibold text-blue-900">Total Price: <span id="tier-result-value" class="text-green-600">KES 0.00</span></p>
                    <p class="text-sm text-gray-600 mt-1">Per Unit: <span id="tier-per-unit" class="font-semibold">KES 0.00</span></p>
                    <p class="text-sm text-gray-600">Margin: <span id="tier-margin" class="font-semibold">0%</span></p>
                </div>
            </div>
        </div>

        <!-- ====================== FORMULA-BASED PRICING CONFIGURATION ====================== -->
        <!-- ====================== FORMULA-BASED PRICING CONFIGURATION ====================== -->
<div class="bg-white border rounded-lg p-6 mb-6" id="formula-pricing-section" style="display: none;">
    <h2 class="text-lg font-semibold mb-6 flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
        </svg>
        FORMULA-BASED PRICING CONFIGURATION
    </h2>
    <p class="text-gray-600 mb-6">Define variables for cost calculation</p>

    <!-- REQUIRED VARIABLES -->
    <div class="mb-8">
        <h3 class="font-semibold text-blue-900 mb-4">VARIABLES:</h3>
        <p class="text-sm text-gray-600 mb-4">Define the variables that affect pricing</p>

        <div id="variables-container">
            <!-- VARIABLE 1 (Default) -->
            <div class="border border-gray-300 rounded-lg p-5 mb-4 bg-white relative variable-card" data-var-num="1">
                <button type="button" class="absolute top-3 right-3 text-red-500 hover:text-red-700 remove-variable-btn">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>

                <h4 class="font-semibold mb-4">VARIABLE 1</h4>

                <!-- Variable Name -->
                <div class="mb-4">
                    <label class="block font-medium mb-2">Variable Name: <span class="text-red-500">*</span></label>
                    <input type="text" name="variable1_name" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="e.g., Stitch Count, Size, Position" value="Stitch Count" required>
                </div>

                <!-- Variable Type (NEW) -->
                <div class="mb-4">
                    <label class="block font-medium mb-2">Variable Type: <span class="text-red-500">*</span></label>
                    <select name="variable1_type" class="w-full border border-gray-300 rounded px-3 py-2 variable-type-select" required>
                        <option value="number" selected>Number (Numerical Values)</option>
                        <option value="alphanumeric">Alphanumeric (Text/Options)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Choose number for quantities/measurements, alphanumeric for text options</p>
                </div>

                <!-- Unit of Measure -->
                <div class="mb-4">
                    <label class="block font-medium mb-2">Unit of Measure:</label>
                    <input type="text" name="variable1_unit" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="e.g., stitches, m, cm" value="stitches">
                </div>

                <!-- Number-specific fields (shown by default) -->
                <div class="number-fields">
                    <div class="mb-4">
                        <label class="block font-medium mb-2">Variable Value: <span class="text-red-500">*</span></label>
                        <input type="number" step="0.01" name="variable1_value" class="w-full border border-gray-300 rounded px-3 py-2 variable-value-input" placeholder="e.g., 50, 1, 100" value="50">
                        <p class="text-xs text-gray-500 mt-1">The value for this variable (e.g., 50 stitches, 1 meter)</p>
                    </div>
                </div>

                <!-- Common fields (always shown) -->
                <div class="mb-4">
                    <label class="block font-medium mb-2">Price (KES): <span class="text-red-500">*</span></label>
                    <input type="number" step="0.01" name="variable1_price" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="e.g., 50.00" value="50" required>
                    <p class="text-xs text-gray-500 mt-1">Base price for this variable</p>
                </div>

                <div class="mb-4">
                    <label class="block font-medium mb-2">Rate (Multiplier):</label>
                    <input type="number" step="0.0001" name="variable1_rate" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="e.g., 1.0, 0.5, 2.0" value="1.0">
                    <p class="text-xs text-gray-500 mt-1">Multiplier rate (default: 1.0)</p>
                </div>
            </div>
        </div>

        <button type="button" id="add-variable-btn" class="w-full border-2 border-dashed border-blue-400 text-blue-600 rounded-lg py-3 hover:bg-blue-50 transition flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Add Variable
        </button>
    </div>

    <!-- FORMULA PREVIEW -->
    <div class="mb-8">
        <h3 class="font-semibold text-blue-900 mb-4">FORMULA PREVIEW:</h3>
        <div class="bg-gray-100 border border-gray-300 rounded-lg p-4">
            <code id="formula-preview" class="text-sm text-gray-800">Cost = base + (variable_value Ã— price Ã— rate)</code>
        </div>
        <p class="text-xs text-gray-500 mt-2">Formula calculates based on: Base Cost + sum of (Variable Value Ã— Price Ã— Rate) for each variable</p>
    </div>

    <!-- TEST CALCULATOR -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-5">
        <h3 class="font-semibold text-blue-900 mb-4">TEST CALCULATOR:</h3>
        <p class="text-sm text-gray-600 mb-4">Test your formula with sample values</p>

        <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block font-medium mb-2">Base Cost (KES):</label>
                <input type="number" id="test_base_cost" class="w-full border border-gray-300 rounded px-3 py-2 bg-white" value="100" step="0.01">
            </div>
            <div>
                <label class="block font-medium mb-2">Test Quantity:</label>
                <input type="number" id="test_quantity" class="w-full border border-gray-300 rounded px-3 py-2 bg-white" value="100">
            </div>
        </div>

        <button type="button" id="calculate-test-btn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
            Calculate
        </button>

        <div id="test-result" class="mt-4 hidden">
            <p class="text-lg font-semibold text-blue-900">Result: <span id="test-result-value" class="text-green-600">KES 0.00</span></p>
            <p class="text-sm text-gray-600 mt-1">Per Unit: <span id="test-per-unit" class="font-semibold">KES 0.00</span></p>
        </div>
    </div>
</div>

        <!-- ====================== APPROVAL SETTINGS ====================== -->
        <div class="bg-white border rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-6">APPROVAL SETTINGS:</h2>

            <div class="space-y-3">
                <label class="flex items-start gap-3 cursor-pointer">
                    <input type="radio" name="approval_settings" value="auto_approve" checked class="w-4 h-4 mt-1 text-purple-600">
                    <div>
                        <div class="font-medium">Auto-approve all quantities</div>
                        <div class="text-sm text-gray-500">No PT review needed</div>
                    </div>
                </label>

                <label class="flex items-start gap-3 cursor-pointer">
                    <input type="radio" name="approval_settings" value="require_pt" class="w-4 h-4 mt-1 text-purple-600">
                    <div>
                        <div class="font-medium">Require PT approval for all quotes</div>
                        <div class="text-sm text-gray-500">Manual review required</div>
                    </div>
                </label>

                <label class="flex items-start gap-3 cursor-pointer">
                    <input type="radio" name="approval_settings" value="custom_rules" class="w-4 h-4 mt-1 text-purple-600">
                    <div>
                        <div class="font-medium">Custom approval rules</div>
                        <div class="text-sm text-gray-500">Configure thresholds</div>
                    </div>
                </label>
            </div>
        </div>

        <!-- ====================== FORM ACTIONS ====================== -->
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg z-50">
            <div class="max-w-7xl mx-auto px-8 py-4 flex items-center justify-between">
                <button type="button" onclick="window.history.back()" class="px-6 py-2 text-gray-700 hover:text-gray-900 font-medium transition">
                    Cancel
                </button>
                
                <div class="flex items-center gap-3">
                    <button type="submit" name="action" value="draft" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition">
                        Save as Draft
                    </button>
                    
                    <button type="submit" name="action" value="activate" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Save & Activate
                    </button>
                </div>
            </div>
        </div>

        <div class="h-24"></div>

    </form>

</div>
<script>
(function() {
    'use strict';
    
    console.log('ðŸš€ Process form script starting...');

    document.addEventListener('DOMContentLoaded', function() {
        console.log('âœ… DOM Content Loaded');

        // Get references to sections
        const tierSection = document.getElementById('tier-pricing-section');
        const formulaSection = document.getElementById('formula-pricing-section');

        console.log('Tier Section:', tierSection ? 'Found' : 'NOT FOUND');
        console.log('Formula Section:', formulaSection ? 'Found' : 'NOT FOUND');

        // ===== PRICING METHOD SELECTION =====
        window.selectTierBased = function() {
            console.log('Tier-Based pricing selected');

            const tierCard = document.querySelector('button[onclick="selectTierBased()"]').closest('.border-2');
            const formulaCard = document.querySelector('button[onclick="selectFormulaBased()"]').closest('.border-2');

            if (tierCard) {
                tierCard.classList.remove('border-gray-300', 'bg-white');
                tierCard.classList.add('border-blue-500', 'bg-blue-50');
            }

            if (formulaCard) {
                formulaCard.classList.remove('border-blue-500', 'bg-blue-50');
                formulaCard.classList.add('border-gray-300', 'bg-white');
            }

            if (tierSection) tierSection.style.display = 'block';
            if (formulaSection) formulaSection.style.display = 'none';

            document.getElementById('pricing-method-input').value = 'tier';
            console.log('Pricing method set to: tier');
        };

        window.selectFormulaBased = function() {
            console.log('Formula-Based pricing selected');

            const formulaCard = document.querySelector('button[onclick="selectFormulaBased()"]').closest('.border-2');
            const tierCard = document.querySelector('button[onclick="selectTierBased()"]').closest('.border-2');

            if (formulaCard) {
                formulaCard.classList.remove('border-gray-300', 'bg-white');
                formulaCard.classList.add('border-blue-500', 'bg-blue-50');
            }

            if (tierCard) {
                tierCard.classList.remove('border-blue-500', 'bg-blue-50');
                tierCard.classList.add('border-gray-300', 'bg-white');
            }

            if (formulaSection) formulaSection.style.display = 'block';
            if (tierSection) tierSection.style.display = 'none';

            document.getElementById('pricing-method-input').value = 'formula';
            console.log('Pricing method set to: formula');
        };

        // ===== FORMULA VARIABLES =====
        let variableCount = 1;

        function toggleVariableFields(card, varType) {
            const numberFields = card.querySelector('.number-fields');
            const valueInput = card.querySelector('.variable-value-input');

            if (varType === 'number') {
                if (numberFields) numberFields.style.display = 'block';
                if (valueInput) valueInput.required = true;
            } else {
                if (numberFields) numberFields.style.display = 'none';
                if (valueInput) {
                    valueInput.required = false;
                    valueInput.value = '';
                }
            }
        }

        function attachVariableTypeListener(card) {
            const typeSelect = card.querySelector('.variable-type-select');
            if (typeSelect) {
                typeSelect.addEventListener('change', function() {
                    toggleVariableFields(card, this.value);
                });
                toggleVariableFields(card, typeSelect.value);
            }
        }

        const firstCard = document.querySelector('.variable-card');
        if (firstCard) attachVariableTypeListener(firstCard);

        const addVariableBtn = document.getElementById('add-variable-btn');
        if (addVariableBtn) {
            addVariableBtn.addEventListener('click', function(e) {
                e.preventDefault();
                variableCount++;
                addVariableCard(variableCount);
            });
        }

        function addVariableCard(varNum) {
            const container = document.getElementById('variables-container');
            const variableHTML = `
                <div class="border border-gray-300 rounded-lg p-5 mb-4 bg-white relative variable-card" data-var-num="${varNum}">
                    <button type="button" class="absolute top-3 right-3 text-red-500 hover:text-red-700 remove-variable-btn">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>

                    <h4 class="font-semibold mb-4">VARIABLE ${varNum}</h4>

                    <div class="mb-4">
                        <label class="block font-medium mb-2">Variable Name: <span class="text-red-500">*</span></label>
                        <input type="text" name="variable${varNum}_name" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="e.g., Stitch Count, Size, Position" required>
                    </div>

                    <div class="mb-4">
                        <label class="block font-medium mb-2">Variable Type: <span class="text-red-500">*</span></label>
                        <select name="variable${varNum}_type" class="w-full border border-gray-300 rounded px-3 py-2 variable-type-select" required>
                            <option value="number" selected>Number (Numerical Values)</option>
                            <option value="alphanumeric">Alphanumeric (Text/Options)</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Choose number for quantities/measurements, alphanumeric for text options</p>
                    </div>

                    <div class="mb-4">
                        <label class="block font-medium mb-2">Unit of Measure:</label>
                        <input type="text" name="variable${varNum}_unit" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="e.g., stitches, m, cm">
                    </div>

                    <div class="number-fields">
                        <div class="mb-4">
                            <label class="block font-medium mb-2">Variable Value: <span class="text-red-500">*</span></label>
                            <input type="number" step="0.01" name="variable${varNum}_value" class="w-full border border-gray-300 rounded px-3 py-2 variable-value-input" placeholder="e.g., 50, 1, 100">
                            <p class="text-xs text-gray-500 mt-1">The value for this variable</p>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block font-medium mb-2">Price (KES): <span class="text-red-500">*</span></label>
                        <input type="number" step="0.01" name="variable${varNum}_price" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="e.g., 50.00" required>
                        <p class="text-xs text-gray-500 mt-1">Base price for this variable</p>
                    </div>

                    <div class="mb-4">
                        <label class="block font-medium mb-2">Rate (Multiplier):</label>
                        <input type="number" step="0.0001" name="variable${varNum}_rate" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="e.g., 1.0, 0.5, 2.0" value="1.0">
                        <p class="text-xs text-gray-500 mt-1">Multiplier rate (default: 1.0)</p>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', variableHTML);

            const newCard = container.querySelector(`.variable-card[data-var-num="${varNum}"]`);
            if (newCard) {
                attachVariableTypeListener(newCard);

                // Remove button
                const removeBtn = newCard.querySelector('.remove-variable-btn');
                removeBtn.addEventListener('click', function() {
                    newCard.remove();
                });
            }
        }

        // ===== TIER-BASED MANAGEMENT =====
        let tierCount = 1; // starts at 1 because Tier 1 exists
        const tiersContainer = document.getElementById('tiers-container');
        const addTierBtn = document.getElementById('add-tier-btn');

        if (addTierBtn) {
            addTierBtn.addEventListener('click', function(e) {
                e.preventDefault();
                tierCount++;

                const tierHTML = `
                <div class="border border-red-300 rounded-lg p-5 mb-4 bg-red-50 relative tier-card" data-tier="${tierCount}">
                    <button type="button" class="absolute top-3 right-3 text-red-500 hover:text-red-700 remove-tier-btn">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>

                    <h4 class="font-semibold text-red-700 mb-4">TIER ${tierCount}</h4>

                    <div class="mb-4">
                        <label class="block font-medium mb-2">Quantity Range:</label>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-600">From:</span>
                            <input type="number" name="tier${tierCount}_from" class="border border-gray-300 rounded px-3 py-2 w-24" value="1" min="1" required>
                            <span class="text-sm text-gray-600">To:</span>
                            <input type="number" name="tier${tierCount}_to" class="border border-gray-300 rounded px-3 py-2 w-24" value="500" min="1" required>
                            <span class="text-gray-600">pieces</span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block font-medium mb-2">Price:</label>
                        <div class="flex items-center gap-2">
                            <input type="number" name="tier${tierCount}_price" step="0.01" class="border border-gray-300 rounded px-3 py-2 w-32" value="3000" required>
                            <span class="text-gray-600">KES</span>
                        </div>
                    </div>

                    <div>
                        <label class="block font-medium mb-2">Cost:</label>
                        <div class="flex items-center gap-2 mb-2">
                            <input type="number" name="tier${tierCount}_cost" step="0.01" class="border border-gray-300 rounded px-3 py-2 w-32" value="2000" required>
                            <span class="text-gray-600">KES</span>
                        </div>
                    </div>
                </div>
                `;

                tiersContainer.insertAdjacentHTML('beforeend', tierHTML);

                const newTier = tiersContainer.querySelector(`.tier-card[data-tier="${tierCount}"]`);
                const removeBtn = newTier.querySelector('.remove-tier-btn');
                removeBtn.addEventListener('click', function() {
                    newTier.remove();
                });
            });
        }

        // ===== TIER-BASED TEST CALCULATOR =====
        const tierCalculateBtn = document.getElementById('tier-calculate-btn');
        if (tierCalculateBtn) {
            tierCalculateBtn.addEventListener('click', function() {
                const quantity = parseInt(document.getElementById('tier_test_quantity').value, 10);
                const tiers = document.querySelectorAll('.tier-card');
                let matchedTier = null;
                tiers.forEach(tier => {
                    const from = parseInt(tier.querySelector(`[name^="tier"][name$="_from"]`).value, 10);
                    const to = parseInt(tier.querySelector(`[name^="tier"][name$="_to"]`).value, 10);
                    if (quantity >= from && quantity <= to) matchedTier = tier;
                });
                const resultDiv = document.getElementById('tier-test-result');
                if (matchedTier) {
                    const tierName = matchedTier.querySelector('h4').textContent;
                    const price = parseFloat(matchedTier.querySelector(`[name^="tier"][name$="_price"]`).value);
                    const cost = parseFloat(matchedTier.querySelector(`[name^="tier"][name$="_cost"]`).value);
                    const margin = ((price - cost) / price * 100).toFixed(2);

                    document.getElementById('tier-matched').textContent = tierName;
                    document.getElementById('tier-result-value').textContent = `KES ${price.toFixed(2)}`;
                    document.getElementById('tier-per-unit').textContent = `KES ${(price/quantity).toFixed(2)}`;
                    document.getElementById('tier-margin').textContent = `${margin}%`;
                    resultDiv.classList.remove('hidden');
                } else {
                    alert('No matching tier found for this quantity');
                    resultDiv.classList.add('hidden');
                }
            });
        }

        // ===== FORMULA-BASED TEST CALCULATOR =====
        const calculateTestBtn = document.getElementById('calculate-test-btn');
        if (calculateTestBtn) {
            calculateTestBtn.addEventListener('click', function() {
                const baseCost = parseFloat(document.getElementById('test_base_cost').value) || 0;
                const quantity = parseFloat(document.getElementById('test_quantity').value) || 0;
                let total = baseCost;

                const variables = document.querySelectorAll('.variable-card');
                variables.forEach(v => {
                    const type = v.querySelector('.variable-type-select').value;
                    if (type === 'number') {
                        const val = parseFloat(v.querySelector('.variable-value-input').value) || 0;
                        const price = parseFloat(v.querySelector(`[name$="_price"]`).value) || 0;
                        const rate = parseFloat(v.querySelector(`[name$="_rate"]`).value) || 1;
                        total += val * price * rate;
                    } else {
                        const price = parseFloat(v.querySelector(`[name$="_price"]`).value) || 0;
                        total += price;
                    }
                });

                document.getElementById('test-result-value').textContent = `KES ${total.toFixed(2)}`;
                document.getElementById('test-per-unit').textContent = `KES ${(total/quantity).toFixed(2)}`;
                document.getElementById('test-result').classList.remove('hidden');
            });
        }

    });
})();
</script>



{% endblock %}