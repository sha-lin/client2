{% extends 'base.html' %}
{% load static %}

{% block title %}Create Quote - Print Duka{% endblock %}

{% block extra_css %}
<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .invoice-container {
        background: white;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
        max-width: 210mm;
        margin: 0 auto;
    }

    .header-section {
        border-bottom: 3px solid #000;
    }

    .item-row:hover {
        background-color: #f9fafb;
    }

    .total-section {
        background: #f9fafb;
        border-top: 2px solid #000;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="number"],
    input[type="date"],
    textarea,
    select {
        border: 1px solid #e5e7eb;
        transition: all 0.2s;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="tel"]:focus,
    input[type="number"]:focus,
    input[type="date"]:focus,
    textarea:focus,
    select:focus {
        border-color: #000;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }

    .btn-black {
        background: #000;
        color: white;
        padding: 0.5rem 2rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.2s;
    }

    .btn-black:hover {
        background: #1f2937;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }

    .btn-orange {
        background: #ea580c;
        color: white;
        padding: 0.5rem 2rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.2s;
    }

    .btn-orange:hover {
        background: #c2410c;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }

    .action-buttons {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 2px solid #e5e7eb;
        box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.05);
        z-index: 1000;
    }

    @media print {

        .action-buttons,
        .no-print {
            display: none !important;
        }

        .invoice-container {
            box-shadow: none;
            max-width: 100%;
        }
    }

    .editable-field {
        background: transparent;
        border: 1px dashed transparent;
        transition: all 0.2s;
    }

    .editable-field:hover {
        border-color: #e5e7eb;
        background: #f9fafb;
    }

    .editable-field:focus {
        background: white;
        border-color: #000;
        border-style: solid;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .item-row {
        animation: slideIn 0.3s ease;
    }

    .bg-green-100 {
        background-color: #d1fae5;
    }

    .text-green-700 {
        color: #047857;
    }

    .product-info {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 0.25rem;
    }

    .customization-badge {
        display: inline-block;
        padding: 0.125rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .badge-non-customizable {
        background-color: #dcfce7;
        color: #166534;
    }

    .badge-semi-customizable {
        background-color: #fef3c7;
        color: #92400e;
    }

    .badge-fully-customizable {
        background-color: #fee2e2;
        color: #991b1b;
    }
</style>
{% endblock %}

{% block content %}
<!-- Top Navigation Bar -->
<div
    class="fixed top-0 left-0 right-0 bg-black text-white h-14 flex items-center justify-between px-6 z-50 shadow-lg no-print">
    <div class="flex items-center gap-6">
        <h1 class="text-xl font-bold">Print Duka</h1>
        <span class="text-sm text-gray-300">Create New Quote</span>
    </div>
    <div class="flex items-center gap-4">
        <a href="{% url 'dashboard' %}" class="text-sm hover:text-gray-300 transition">
            ‚Üê Back to Dashboard
        </a>
        <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center font-bold text-sm">
            {{ request.user.first_name.0|default:'U' }}{{ request.user.last_name.0|default:'' }}
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="pt-20 pb-32 px-4 bg-gray-100">
    <div class="invoice-container">
        <form id="quoteForm" method="POST" action="{% url 'create_quote' %}">
            {% csrf_token %}

            <!-- Hidden fields for form submission -->
            <input type="hidden" name="item_count" id="itemCount" value="0">
            <input type="hidden" name="quote_type" id="quoteType" value="client">
            <input type="hidden" name="client_id" id="clientId">
            <input type="hidden" name="lead_id" id="leadId">

            <!-- Header Section -->
            <div class="header-section p-8">
                <div class="grid grid-cols-2 gap-8">
                    <!-- Left Side - Company Info -->
                    <div>
                        <h1 class="text-4xl font-bold text-black mb-6">QUOTE</h1>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-semibold text-gray-600 w-20">From:</span>
                                <span class="font-bold">Print Duka</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-sm font-semibold text-gray-600 w-20">Address:</span>
                                <div class="text-sm">
                                    <p>2nd Flr, Parsonic Business Centre</p>
                                    <p>Kweria Road, Nairobi</p>
                                    <p>P.O BOX 104671-00100</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-semibold text-gray-600 w-20">Email:</span>
                                <span class="text-sm">query@printduka.co.ke</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-semibold text-gray-600 w-20">Phone:</span>
                                <span class="text-sm">+254 755 669937</span>
                            </div>
                        </div>
                    </div>

                    <!-- Right Side - Quote Details -->
                    <div class="text-right">
                        <div class="inline-block text-left space-y-3">
                            <div class="flex items-center gap-4">
                                <span class="text-sm font-semibold text-gray-600 w-24">Quote #:</span>
                                <input type="text" name="quote_number" id="quoteNumber" value="QT-{{ current_year }}-"
                                    class="editable-field px-2 py-1 rounded font-bold w-40">
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="text-sm font-semibold text-gray-600 w-24">Date:</span>
                                <input type="date" name="quote_date" id="quoteDate" value="{{ today }}"
                                    class="editable-field px-2 py-1 rounded" required>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="text-sm font-semibold text-gray-600 w-24">Valid Until:</span>
                                <input type="date" name="valid_until" id="validUntil" value="{{ default_valid_until }}"
                                    class="editable-field px-2 py-1 rounded" required>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bill To Section -->
            <div class="p-8 border-b border-gray-200">
                <div class="grid grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-sm font-bold text-black mb-3">BILL TO</h3>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2 mb-3">
                                <label class="text-xs text-gray-600 w-20">Type:</label>
                                <select id="clientTypeSelect" class="border border-gray-300 rounded px-3 py-2 text-sm"
                                    required>
                                    <option value="">Select type...</option>
                                    <option value="client">Existing Client</option>
                                    <option value="lead">Lead</option>
                                </select>
                            </div>

                            <div id="clientSelectDiv" class="hidden mb-3">
                                <select id="clientSelect"
                                    class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                                    <option value="">Select client...</option>
                                    {% for client in clients %}
                                    <option value="{{ client.id }}" data-name="{{ client.company|default:client.name }}"
                                        data-email="{{ client.email }}" data-phone="{{ client.phone }}"
                                        data-address="{{ client.address }}" data-payment="{{ client.payment_terms }}">
                                        {{ client.client_id }} - {{ client.company|default:client.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div id="leadSelectDiv" class="hidden mb-3">
                                <select id="leadSelect" class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                                    <option value="">Select lead...</option>
                                    {% for lead in leads %}
                                    <option value="{{ lead.id }}" data-name="{{ lead.name }}"
                                        data-email="{{ lead.email }}" data-phone="{{ lead.phone }}">
                                        {{ lead.lead_id }} - {{ lead.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <input type="text" name="client_name" id="clientName" placeholder="Client/Company Name *"
                                class="w-full editable-field px-3 py-2 rounded font-semibold" required readonly>
                            <input type="email" name="client_email" id="clientEmail" placeholder="Email Address"
                                class="w-full editable-field px-3 py-2 rounded text-sm" readonly>
                            <input type="tel" name="client_phone" id="clientPhone" placeholder="Phone Number"
                                class="w-full editable-field px-3 py-2 rounded text-sm" readonly>
                            <textarea name="client_address" id="clientAddress" placeholder="Address (Optional)" rows="2"
                                class="w-full editable-field px-3 py-2 rounded text-sm" readonly></textarea>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-black mb-3">QUOTE DETAILS</h3>
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <label class="text-xs text-gray-600 w-32">Payment Terms:</label>
                                <select name="payment_terms" id="paymentTerms"
                                    class="editable-field px-2 py-1 rounded text-sm flex-1">
                                    <option value="Prepaid">Prepaid</option>
                                    <option value="Net 7">Net 7 Days</option>
                                    <option value="Net 15">Net 15 Days</option>
                                    <option value="Net 30">Net 30 Days</option>
                                    <option value="Net 60">Net 60 Days</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-xs text-gray-600 w-32">Status:</label>
                                <select name="status" id="quoteStatus"
                                    class="editable-field px-2 py-1 rounded text-sm flex-1">
                                    <option value="Draft">Draft</option>
                                    <option value="Quoted" selected>Quoted</option>
                                    <option value="Client Review">Client Review</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Lost">Lost</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Items Table -->
            <div class="p-8">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b-2 border-black">
                                <th class="text-left py-3 px-2 text-sm font-bold w-20">QTY</th>
                                <th class="text-left py-3 px-2 text-sm font-bold">PRODUCT</th>
                                <th class="text-right py-3 px-2 text-sm font-bold w-32">UNIT PRICE</th>
                                <th class="text-right py-3 px-2 text-sm font-bold w-32">AMOUNT</th>
                                <th class="w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody">
                            <!-- Items will be added here by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <button type="button" id="addItemBtn"
                    class="mt-4 px-4 py-2 text-sm text-white bg-black hover:bg-gray-800 rounded font-semibold flex items-center gap-2 transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Add Line Item
                </button>
            </div>

            <!-- Totals Section -->
            <div class="total-section px-8 py-6">
                <div class="flex justify-end">
                    <div class="w-96 space-y-3">
                        <div class="flex justify-between items-center text-sm">
                            <span class="font-semibold">SUBTOTAL</span>
                            <span id="subtotal" class="font-bold">KES 0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" name="include_vat" id="includeVAT" class="rounded">
                                <label for="includeVAT" class="font-semibold cursor-pointer">VAT (16%)</label>
                            </div>
                            <span id="vatAmount" class="font-bold">KES 0.00</span>
                        </div>
                        <div class="flex justify-between items-center pt-3 border-t-2 border-black">
                            <span class="text-lg font-bold">TOTAL</span>
                            <span id="totalAmount" class="text-2xl font-bold">KES 0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Terms & Notes -->
            <div class="p-8 border-t border-gray-200">
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <h3 class="text-sm font-bold text-black mb-2">TERMS & CONDITIONS</h3>
                        <textarea name="terms" id="terms" rows="5"
                            class="w-full editable-field px-3 py-2 rounded text-xs leading-relaxed">1. A 65% advance payment or a valid purchase order (PO) is required to initiate production.
2. The remaining payment must be settled within 14 days after the items are delivered.
3. The quoted price remains valid for 30 days from the date of the initial quotation.
4. Late payments may incur additional charges as per our policy.
5. All items are VAT exclusive unless specified</textarea>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-black mb-2">NOTES / SPECIAL INSTRUCTIONS</h3>
                        <textarea name="notes" id="notes" rows="3"
                            placeholder="Add any special instructions or notes here..."
                            class="w-full editable-field px-3 py-2 rounded text-sm"></textarea>
                    </div>
                </div>
            </div>

            <!-- Payment Information -->
            <div class="p-8 bg-gray-50 border-t border-gray-200">
                <h3 class="text-sm font-bold text-black mb-3">PAYMENT OPTIONS</h3>
                <div class="grid grid-cols-2 gap-6 text-xs">
                    <div>
                        <p class="font-bold mb-1">Account Transfer</p>
                        <p>Bank: I&M Bank Limited</p>
                        <p>Acc name: Print Duka Limited</p>
                        <p>Acc: 04404566816350</p>
                        <p>Branch: Tatu City (Branch code: 044)</p>
                        <p>Swift code: IMBLKENA</p>
                    </div>
                    <div>
                        <p class="font-bold mb-1">M-Pesa</p>
                        <p>Paybill: 542542</p>
                        <p>Account: 35450</p>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Fixed Action Buttons -->
<div class="action-buttons no-print">
    <div class="max-w-7xl mx-auto px-4 py-4">
        <div class="flex justify-end gap-4">
            <!-- Send to PT button - will be shown/hidden based on products -->
            <button type="button" id="sendToPTBtn" class="btn-orange hidden">
                üìã Send to PT for Approval
            </button>
            
            <!-- Download button - will be shown/hidden based on products -->
            <button type="button" id="downloadBtn" class="btn-black">
                üì• Download PDF
            </button>
            
            <!-- Email button - will be shown/hidden based on products -->
            <button type="button" id="emailBtn" class="btn-black">
                üìß Email to Client
            </button>
            
            <!-- Save Draft button -->
            <button type="button" id="saveDraftBtn" class="btn-black">
                üíæ Save Draft
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Quote form initialized ‚úÖ');

        let itemCounter = 0;
        const form = document.getElementById('quoteForm');
        const addItemBtn = document.getElementById('addItemBtn');
        const itemsTableBody = document.getElementById('itemsTableBody');
        const includeVAT = document.getElementById('includeVAT');
        const subtotalField = document.getElementById('subtotal');
        const vatField = document.getElementById('vatAmount');
        const totalField = document.getElementById('totalAmount');
        const itemCountField = document.getElementById('itemCount');

        // Button elements
        const sendToPTBtn = document.getElementById('sendToPTBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const emailBtn = document.getElementById('emailBtn');
        const saveDraftBtn = document.getElementById('saveDraftBtn');

        // Client/Lead selection
        const clientTypeSelect = document.getElementById('clientTypeSelect');
        const clientSelectDiv = document.getElementById('clientSelectDiv');
        const leadSelectDiv = document.getElementById('leadSelectDiv');
        const clientSelect = document.getElementById('clientSelect');
        const leadSelect = document.getElementById('leadSelect');

        // Client details fields
        const clientNameField = document.getElementById('clientName');
        const clientEmailField = document.getElementById('clientEmail');
        const clientPhoneField = document.getElementById('clientPhone');
        const clientAddressField = document.getElementById('clientAddress');
        const paymentTermsField = document.getElementById('paymentTerms');

        // Hidden fields
        const quoteTypeField = document.getElementById('quoteType');
        const clientIdField = document.getElementById('clientId');
        const leadIdField = document.getElementById('leadId');

        // Product data for reference
        const productsData = [
            {% for product in products %}{
                id: {{ product.id }},
                name: "{{ product.name|escapejs }}",
                internal_code: "{{ product.internal_code|escapejs }}",
                customization_level: "{{ product.customization_level }}",
                base_price: {{ product.base_price|default:0 }},
                display_name: "{{ product.internal_code }} - {{ product.name }} ({{ product.get_customization_level_display }})"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        // Handle client/lead type selection
        clientTypeSelect.addEventListener('change', function () {
            const type = this.value;

            if (type === 'client') {
                clientSelectDiv.classList.remove('hidden');
                leadSelectDiv.classList.add('hidden');
                leadSelect.value = '';
                quoteTypeField.value = 'client';
            } else if (type === 'lead') {
                leadSelectDiv.classList.remove('hidden');
                clientSelectDiv.classList.add('hidden');
                clientSelect.value = '';
                quoteTypeField.value = 'lead';
            } else {
                clientSelectDiv.classList.add('hidden');
                leadSelectDiv.classList.add('hidden');
            }

            // Clear fields
            clearClientDetails();
        });

        // Handle client selection
        clientSelect.addEventListener('change', function () {
            const selected = this.options[this.selectedIndex];
            if (this.value) {
                clientIdField.value = this.value;
                clientNameField.value = selected.dataset.name || '';
                clientEmailField.value = selected.dataset.email || '';
                clientPhoneField.value = selected.dataset.phone || '';
                clientAddressField.value = selected.dataset.address || '';
                paymentTermsField.value = selected.dataset.payment || 'Prepaid';
            } else {
                clearClientDetails();
            }
        });

        // Handle lead selection
        leadSelect.addEventListener('change', function () {
            const selected = this.options[this.selectedIndex];
            if (this.value) {
                leadIdField.value = this.value;
                clientNameField.value = selected.dataset.name || '';
                clientEmailField.value = selected.dataset.email || '';
                clientPhoneField.value = selected.dataset.phone || '';
                clientAddressField.value = '';
                paymentTermsField.value = 'Prepaid';
            } else {
                clearClientDetails();
            }
        });

        function clearClientDetails() {
            clientIdField.value = '';
            leadIdField.value = '';
            clientNameField.value = '';
            clientEmailField.value = '';
            clientPhoneField.value = '';
            clientAddressField.value = '';
        }

        // Handle product selection
        window.handleProductSelection = function(selectElement, itemId) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const productId = selectElement.value;
            
            if (!productId) {
                return;
            }

            const product = productsData.find(p => p.id == productId);
            if (!product) return;

            // Update hidden description field
            const descField = document.querySelector(`input[name="description_${itemId}"]`);
            if (descField) {
                descField.value = product.name;
            }

            // Update unit price based on customization level
            const unitPriceField = document.querySelector(`input[name="unit_price_${itemId}"]`);
            const qtyField = document.querySelector(`input[name="quantity_${itemId}"]`);
            
            if (product.customization_level === 'non_customizable') {
                // Auto-fill base price for non-customizable products
                if (unitPriceField) {
                    unitPriceField.value = product.base_price || 0;
                    unitPriceField.readOnly = true;
                    unitPriceField.classList.add('bg-gray-100');
                }
            } else {
                // For semi and fully customizable, clear price and make editable
                if (unitPriceField) {
                    unitPriceField.value = '';
                    unitPriceField.readOnly = false;
                    unitPriceField.classList.remove('bg-gray-100');
                }
            }

            // Recalculate totals
            const row = selectElement.closest('tr');
            if (row && qtyField && unitPriceField) {
                calculateRowTotal(row);
            }

            // Update action buttons visibility
            updateActionButtons();
        };

        // Update action buttons based on products in quote
        function updateActionButtons() {
            const rows = document.querySelectorAll('.item-row');
            let hasNonCustomizable = false;
            let hasSemiOrFullyCustomizable = false;

            rows.forEach(row => {
                const productSelect = row.querySelector('.item-product');
                if (productSelect && productSelect.value) {
                    const selectedOption = productSelect.options[productSelect.selectedIndex];
                    const customizationLevel = selectedOption.dataset.customization;
                    
                    if (customizationLevel === 'non_customizable') {
                        hasNonCustomizable = true;
                    } else if (customizationLevel === 'semi_customizable' || customizationLevel === 'fully_customizable') {
                        hasSemiOrFullyCustomizable = true;
                    }
                }
            });

            // Show/hide buttons based on product types
            if (hasNonCustomizable && !hasSemiOrFullyCustomizable) {
                // Only non-customizable products - show download and email only
                sendToPTBtn.classList.add('hidden');
                downloadBtn.classList.remove('hidden');
                emailBtn.classList.remove('hidden');
            } else if (hasSemiOrFullyCustomizable) {
                // Has semi/fully customizable products - show send to PT button
                sendToPTBtn.classList.remove('hidden');
                downloadBtn.classList.add('hidden');
                emailBtn.classList.add('hidden');
            } else {
                // No products selected - hide all action buttons
                sendToPTBtn.classList.add('hidden');
                downloadBtn.classList.add('hidden');
                emailBtn.classList.add('hidden');
            }
        }

        // Function: Add Line Item
        function addLineItem(data = {}) {
            itemCounter++;
            const row = document.createElement('tr');
            row.className = 'item-row border-b border-gray-200';
            row.dataset.itemId = itemCounter;

            // Generate product options
            const productOptions = ['<option value="">Select a product...</option>'];
            productsData.forEach(product => {
                const customizationClass = `badge-${product.customization_level.replace('_', '-')}`;
                productOptions.push(`
                    <option value="${product.id}" 
                        data-customization="${product.customization_level}"
                        data-base-price="${product.base_price}"
                        data-name="${product.name}"
                        data-sku="${product.internal_code}">
                        ${product.display_name}
                    </option>
                `);
            });

            row.innerHTML = `
                <td class="py-3 px-2">
                    <input type="number" name="quantity_${itemCounter}" 
                        class="item-qty w-16 text-right border border-gray-300 rounded px-2 py-1" 
                        value="${data.qty || 1}" min="1" required>
                </td>
                <td class="py-3 px-2">
                    <select name="product_${itemCounter}" 
                        class="item-product w-full border border-gray-300 rounded px-2 py-1 text-sm" 
                        required onchange="handleProductSelection(this, ${itemCounter})">
                        ${productOptions.join('')}
                    </select>
                    <input type="hidden" name="description_${itemCounter}" 
                        class="item-desc" value="${data.description || ''}">
                </td>
                <td class="py-3 px-2 text-right">
                    <input type="number" name="unit_price_${itemCounter}" 
                        class="item-unitprice w-28 text-right border border-gray-300 rounded px-2 py-1" 
                        step="0.01" value="${data.unitPrice || 0}" min="0" required>
                </td>
                <td class="py-3 px-2 text-right">
                    <input type="number" name="amount_${itemCounter}" 
                        class="item-amount w-28 text-right border border-gray-300 rounded px-2 py-1 bg-gray-50 font-semibold" 
                        readonly value="0.00">
                </td>
                <td class="py-3 px-2 text-center">
                    <button type="button" class="remove-item text-red-600 hover:text-red-800 text-lg" title="Remove">
                        ‚úñ
                    </button>
                </td>
            `;

            itemsTableBody.appendChild(row);
            itemCountField.value = itemCounter;

            attachRowListeners(row);
            calculateRowTotal(row);
            updateTotals();
            updateActionButtons();
        }

        // Attach listeners to a new row
        function attachRowListeners(row) {
            const qty = row.querySelector('.item-qty');
            const unitPrice = row.querySelector('.item-unitprice');
            const removeBtn = row.querySelector('.remove-item');

            [qty, unitPrice].forEach(input => {
                input.addEventListener('input', () => {
                    calculateRowTotal(row);
                    updateActionButtons();
                });
            });

            removeBtn.addEventListener('click', () => {
                row.remove();
                updateTotals();
                updateActionButtons();
            });
        }

        // Calculate row totals
        function calculateRowTotal(row) {
            const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
            const unitPrice = parseFloat(row.querySelector('.item-unitprice').value) || 0;

            const amount = unitPrice * qty;
            row.querySelector('.item-amount').value = amount.toFixed(2);

            updateTotals();
        }

        // Calculate totals
        function updateTotals() {
            let subtotal = 0;
            document.querySelectorAll('.item-amount').forEach(a => {
                subtotal += parseFloat(a.value) || 0;
            });

            subtotalField.textContent = `KES ${subtotal.toLocaleString('en-KE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            const vat = includeVAT.checked ? subtotal * 0.16 : 0;
            vatField.textContent = `KES ${vat.toLocaleString('en-KE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            const total = subtotal + vat;
            totalField.textContent = `KES ${total.toLocaleString('en-KE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        includeVAT.addEventListener('change', updateTotals);
        addItemBtn.addEventListener('click', () => addLineItem());

        // Form validation
        form.addEventListener('submit', function (e) {
            const type = quoteTypeField.value;
            const clientId = clientIdField.value;
            const leadId = leadIdField.value;

            if (!type || (type === 'client' && !clientId) || (type === 'lead' && !leadId)) {
                e.preventDefault();
                alert('Please select a client or lead');
                return false;
            }

            if (itemCounter === 0) {
                e.preventDefault();
                alert('Please add at least one item');
                return false;
            }

            // Validate products are selected
            const productSelects = document.querySelectorAll('.item-product');
            for (let select of productSelects) {
                if (!select.value) {
                    e.preventDefault();
                    alert('Please select a product for all line items');
                    return false;
                }
            }
        });

        // Save Draft button
        saveDraftBtn.addEventListener('click', () => {
            document.getElementById('quoteStatus').value = 'Draft';
            form.submit();
        });

        // Download button
        downloadBtn.addEventListener('click', () => {
            window.print();
        });

        // Email button
        emailBtn.addEventListener('click', () => {
            // Implement email functionality
            alert('Email functionality will be implemented here');
        });

        // Send to PT button
        sendToPTBtn.addEventListener('click', () => {
            // Set status to pending PT approval and submit
            document.getElementById('quoteStatus').value = 'Pending PT Approval';
            form.submit();
        });

        // Add first item by default
        addLineItem();
    });
</script>
{% endblock %}