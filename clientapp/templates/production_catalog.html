{% extends 'base.html' %}

{% block title %}Product Catalog - Production Management{% endblock %}

{% block content %}
<div class="p-8">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h2 class="text-2xl font-medium text-gray-900 mb-1">Product Catalog</h2>
            <p class="text-gray-600">Manage and browse your product inventory</p>
        </div>
        <a href="{% url 'product_create' %}"
            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
            <i data-lucide="plus" class="w-4 h-4"></i>
            Add Product
        </a>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="hidden mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-700">
        <span class="inline-block animate-spin mr-2">⟳</span> Loading products...
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700"></div>

    <!-- Filters and Search -->
    <div class="bg-white rounded-lg border border-gray-200 p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
            <div class="lg:col-span-2 relative">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                <input type="text" id="searchInput" placeholder="Search products by name or ID..."
                    class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <select id="categoryFilter"
                class="px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">All Categories</option>
                <option value="Print Materials">Print Materials</option>
                <option value="Signage">Signage</option>
                <option value="Apparel">Apparel</option>
                <option value="Promotional Items">Promotional Items</option>
                <option value="Packaging">Packaging</option>
            </select>

            <select id="statusFilter"
                class="px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">All Status</option>
                <option value="published">Published</option>
                <option value="draft">Draft</option>
                <option value="archived">Archived</option>
            </select>

            <select id="tierFilter"
                class="px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">All Tiers</option>
                <option value="non_customizable">Non-Custom</option>
                <option value="semi_customizable">Semi-Custom</option>
                <option value="fully_customizable">Fully Custom</option>
            </select>
        </div>
    </div>

    <!-- Results Summary -->
    <div class="mb-4 flex items-center justify-between">
        <p class="text-sm text-gray-600">Showing <span id="productCount">0</span> of <span id="totalCount">0</span> products</p>
        <div class="flex items-center gap-2">
            <select id="pageSizeSelect" class="px-3 py-2 border border-gray-200 rounded text-sm">
                <option value="10">10 per page</option>
                <option value="25" selected>25 per page</option>
                <option value="50">50 per page</option>
            </select>
            <button id="refreshBtn" class="px-4 py-2 border border-gray-200 rounded-lg text-sm hover:bg-gray-50 flex items-center gap-2">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                Refresh
            </button>
        </div>
    </div>

    <!-- Products Table -->
    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr class="border-b border-gray-200">
                    <th class="text-left py-3 px-4 text-sm font-medium text-gray-600">Product</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-gray-600">Category</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-gray-600">Tier</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-gray-600">Base Price</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-gray-600">Status</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-gray-600">Created</th>
                    <th class="text-right py-3 px-4 text-sm font-medium text-gray-600">Actions</th>
                </tr>
            </thead>
            <tbody id="productsTableBody">
                <tr>
                    <td colspan="7" class="py-12 text-center text-gray-500">
                        Loading products...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div id="paginationContainer" class="mt-4 flex items-center justify-between">
        <button id="prevBtn" class="px-4 py-2 border border-gray-200 rounded-lg text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
            ← Previous
        </button>
        <div id="pageInfo" class="text-sm text-gray-600">Page 1</div>
        <button id="nextBtn" class="px-4 py-2 border border-gray-200 rounded-lg text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
            Next →
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // API Configuration
    const API_BASE = '/api/v1';
    let currentPage = 1;
    let pageSize = 25;
    let totalProducts = 0;
    let currentFilters = {
        search: '',
        category: '',
        status: '',
        tier: ''
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        lucide.createIcons();
        setupEventListeners();
        loadProducts();
    });

    function setupEventListeners() {
        // Search with debounce
        const searchInput = document.getElementById('searchInput');
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            currentFilters.search = e.target.value;
            searchTimeout = setTimeout(() => {
                currentPage = 1;
                loadProducts();
            }, 300);
        });

        // Filter changes
        document.getElementById('categoryFilter').addEventListener('change', (e) => {
            currentFilters.category = e.target.value;
            currentPage = 1;
            loadProducts();
        });

        document.getElementById('statusFilter').addEventListener('change', (e) => {
            currentFilters.status = e.target.value;
            currentPage = 1;
            loadProducts();
        });

        document.getElementById('tierFilter').addEventListener('change', (e) => {
            currentFilters.tier = e.target.value;
            currentPage = 1;
            loadProducts();
        });

        // Page size change
        document.getElementById('pageSizeSelect').addEventListener('change', (e) => {
            pageSize = parseInt(e.target.value);
            currentPage = 1;
            loadProducts();
        });

        // Pagination
        document.getElementById('prevBtn').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                loadProducts();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            const maxPages = Math.ceil(totalProducts / pageSize);
            if (currentPage < maxPages) {
                currentPage++;
                loadProducts();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', () => {
            currentPage = 1;
            loadProducts();
        });
    }

    async function loadProducts() {
        showLoading(true);
        hideError();

        try {
            const params = new URLSearchParams();
            params.append('limit', pageSize);
            params.append('offset', (currentPage - 1) * pageSize);

            if (currentFilters.search) params.append('search', currentFilters.search);
            if (currentFilters.category) params.append('category', currentFilters.category);
            if (currentFilters.status) params.append('status', currentFilters.status);
            if (currentFilters.tier) params.append('customization_level', currentFilters.tier);

            const response = await fetch(`${API_BASE}/products/?${params.toString()}`);
            if (!response.ok) throw new Error('Failed to load products');

            const data = await response.json();
            totalProducts = data.count || 0;

            renderProducts(data.results || []);
            updatePagination();
            updateCounters();
        } catch (error) {
            console.error('Error loading products:', error);
            showError('Failed to load products. Please try again.');
            renderEmpty();
        } finally {
            showLoading(false);
        }
    }

    function renderProducts(products) {
        const tbody = document.getElementById('productsTableBody');

        if (products.length === 0) {
            renderEmpty();
            return;
        }

        tbody.innerHTML = products.map(product => `
            <tr class="border-b border-gray-200 hover:bg-gray-50">
                <td class="py-3 px-4">
                    <div>
                        <p class="text-sm text-gray-900">${escapeHtml(product.name)}</p>
                        <p class="text-xs text-gray-500">${escapeHtml(product.internal_code)}</p>
                    </div>
                </td>
                <td class="py-3 px-4 text-sm text-gray-600">${escapeHtml(product.category || '—')}</td>
                <td class="py-3 px-4">
                    <span class="px-2 py-1 text-xs border border-gray-300 rounded">
                        ${escapeHtml(product.customization_level || '—')}
                    </span>
                </td>
                <td class="py-3 px-4 text-sm text-gray-900">
                    KES ${(product.base_price || 0).toLocaleString('en-KE', {minimumFractionDigits: 2})}
                </td>
                <td class="py-3 px-4">
                    <span class="px-2 py-1 text-xs rounded ${getStatusClass(product.status)}">
                        ${escapeHtml(product.status || '—')}
                    </span>
                </td>
                <td class="py-3 px-4 text-sm text-gray-600">
                    ${formatDate(product.created_at)}
                </td>
                <td class="py-3 px-4 text-right">
                    <a href="/production/product/${product.id}/edit/" class="p-2 hover:bg-gray-100 rounded inline-block">
                        <i data-lucide="edit" class="w-4 h-4"></i>
                    </a>
                </td>
            </tr>
        `).join('');

        lucide.createIcons();
    }

    function renderEmpty() {
        const tbody = document.getElementById('productsTableBody');
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="py-12 text-center text-gray-500">
                    No products found matching your criteria.
                </td>
            </tr>
        `;
    }

    function updatePagination() {
        const maxPages = Math.ceil(totalProducts / pageSize);
        document.getElementById('prevBtn').disabled = currentPage <= 1;
        document.getElementById('nextBtn').disabled = currentPage >= maxPages;
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${Math.max(1, maxPages)}`;
    }

    function updateCounters() {
        const showing = Math.min((currentPage - 1) * pageSize + pageSize, totalProducts);
        document.getElementById('productCount').textContent = showing;
        document.getElementById('totalCount').textContent = totalProducts;
    }

    function showLoading(show) {
        document.getElementById('loadingIndicator').classList.toggle('hidden', !show);
    }

    function hideError() {
        document.getElementById('errorMessage').classList.add('hidden');
    }

    function showError(message) {
        const errorEl = document.getElementById('errorMessage');
        errorEl.textContent = message;
        errorEl.classList.remove('hidden');
    }

    function getStatusClass(status) {
        const classes = {
            'published': 'bg-green-100 text-green-700',
            'draft': 'bg-blue-100 text-blue-700',
            'archived': 'bg-gray-100 text-gray-700'
        };
        return classes[status] || 'bg-gray-100 text-gray-700';
    }

    function formatDate(dateString) {
        if (!dateString) return '—';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-KE');
        } catch {
            return '—';
        }
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
</script>
{% endblock %}