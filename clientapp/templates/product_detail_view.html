{% extends 'base.html' %}

{% block title %}{{ product.name }} - Product Details{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 via-white to-blue-50">
    <!-- Navigation Bar -->
    <div class="bg-white border-b border-gray-200 sticky top-0 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-8 py-4">
            <a href="{% url 'product_catalog' %}" class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-800 font-medium transition">
                <i class="fas fa-arrow-left"></i>
                Back to Catalog
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-8 py-12">
        <!-- Header Section -->
        <div class="mb-8">
            <div class="flex items-start justify-between mb-6 flex-wrap gap-4">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-3 mb-2 flex-wrap">
                        <h1 class="text-4xl font-bold text-gray-900">{{ product.name }}</h1>
                    </div>
                    <p class="text-gray-600 text-lg">Product ID: <span class="font-mono font-semibold">{{ product.internal_code }}</span></p>
                </div>
                <div class="flex gap-2 flex-wrap">
                    {% if is_production_team %}
                    <a href="{% url 'product_edit' product.pk %}" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 flex items-center gap-2 font-medium transition shadow-md">
                        <i class="fas fa-edit"></i>
                        Edit Product
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Status Badges - Enhanced -->
            <div class="flex flex-wrap gap-3">
                <!-- Status Badge -->
                <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold shadow-sm
                    {% if product.status == 'published' %}
                        bg-gradient-to-r from-green-100 to-emerald-100 text-green-800 border border-green-300
                    {% elif product.status == 'draft' %}
                        bg-gradient-to-r from-amber-100 to-yellow-100 text-amber-800 border border-amber-300
                    {% else %}
                        bg-gradient-to-r from-gray-100 to-gray-200 text-gray-800 border border-gray-300
                    {% endif %}">
                    <i class="fas fa-circle text-xs mr-2"></i>
                    {{ product.get_status_display }}
                </span>
                
                <!-- Visibility Badge -->
                <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold shadow-sm
                    {% if product.is_visible %}
                        bg-gradient-to-r from-blue-100 to-indigo-100 text-blue-800 border border-blue-300
                    {% else %}
                        bg-gradient-to-r from-gray-100 to-gray-200 text-gray-800 border border-gray-300
                    {% endif %}">
                    <i class="fas {% if product.is_visible %}fa-eye{% else %}fa-eye-slash{% endif %} mr-2"></i>
                    {% if product.is_visible %}Visible{% else %}Hidden{% endif %}
                </span>

                <!-- Stock Badge -->
                <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold shadow-sm
                    {% if product.stock_status == 'in_stock' %}
                        bg-gradient-to-r from-green-100 to-emerald-100 text-green-800 border border-green-300
                    {% elif product.stock_status == 'low_stock' %}
                        bg-gradient-to-r from-yellow-100 to-amber-100 text-yellow-800 border border-yellow-300
                    {% elif product.stock_status == 'out_of_stock' %}
                        bg-gradient-to-r from-red-100 to-rose-100 text-red-800 border border-red-300
                    {% else %}
                        bg-gradient-to-r from-blue-100 to-cyan-100 text-blue-800 border border-blue-300
                    {% endif %}">
                    <i class="fas fa-box mr-2"></i>
                    {{ product.get_stock_status_display }}
                </span>

                <!-- Customization Badge -->
                <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold shadow-sm
                    {% if product.customization_level == 'non_customizable' %}
                        bg-gradient-to-r from-purple-100 to-violet-100 text-purple-800 border border-purple-300
                    {% elif product.customization_level == 'semi_customizable' %}
                        bg-gradient-to-r from-indigo-100 to-blue-100 text-indigo-800 border border-indigo-300
                    {% else %}
                        bg-gradient-to-r from-pink-100 to-rose-100 text-pink-800 border border-pink-300
                    {% endif %}">
                    <i class="fas fa-sliders-h mr-2"></i>
                    {% if product.customization_level == 'non_customizable' %}
                        Fixed Price
                    {% elif product.customization_level == 'semi_customizable' %}
                        Semi-Customizable
                    {% else %}
                        Fully Customizable
                    {% endif %}
                </span>
            </div>
        </div>

    <!-- Tabs Navigation -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8 border border-gray-200">
        <div class="border-b border-gray-200 bg-gray-50">
            <nav class="flex overflow-x-auto" role="tablist">
                <button role="tab" aria-selected="true" aria-controls="general-panel" 
                    class="tab-button active px-6 py-4 border-b-2 border-blue-600 text-blue-600 font-medium whitespace-nowrap hover:bg-blue-50 transition" 
                    onclick="switchTab(event, 'general')">
                    <i class="fas fa-info-circle mr-2"></i>General Information
                </button>
                <button role="tab" aria-selected="false" aria-controls="pricing-panel" 
                    class="tab-button px-6 py-4 border-b-2 border-transparent text-gray-600 hover:text-gray-900 hover:bg-gray-100 font-medium whitespace-nowrap transition" 
                    onclick="switchTab(event, 'pricing')">
                    <i class="fas fa-tag mr-2"></i>Pricing
                </button>
                <button role="tab" aria-selected="false" aria-controls="images-panel" 
                    class="tab-button px-6 py-4 border-b-2 border-transparent text-gray-600 hover:text-gray-900 hover:bg-gray-100 font-medium whitespace-nowrap transition" 
                    onclick="switchTab(event, 'images')">
                    <i class="fas fa-images mr-2"></i>Images & Media
                </button>
                <button role="tab" aria-selected="false" aria-controls="inventory-panel" 
                    class="tab-button px-6 py-4 border-b-2 border-transparent text-gray-600 hover:text-gray-900 hover:bg-gray-100 font-medium whitespace-nowrap transition" 
                    onclick="switchTab(event, 'inventory')">
                    <i class="fas fa-warehouse mr-2"></i>Inventory
                </button>
                <button role="tab" aria-selected="false" aria-controls="history-panel" 
                    class="tab-button px-6 py-4 border-b-2 border-transparent text-gray-600 hover:text-gray-900 hover:bg-gray-100 font-medium whitespace-nowrap transition" 
                    onclick="switchTab(event, 'history')">
                    <i class="fas fa-history mr-2"></i>Change History
                </button>
                {% if seo_data %}
                <button role="tab" aria-selected="false" aria-controls="seo-panel" 
                    class="tab-button px-6 py-4 border-b-2 border-transparent text-gray-600 hover:text-gray-900 hover:bg-gray-100 font-medium whitespace-nowrap transition" 
                    onclick="switchTab(event, 'seo')">
                    <i class="fas fa-search mr-2"></i>SEO
                </button>
                {% endif %}
            </nav>
        </div>

        <!-- Tab Content -->
        <div class="p-8 bg-white">
            <!-- General Information Tab -->
            <div id="general-panel" role="tabpanel" class="tab-panel active">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Main Content -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Descriptions -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Descriptions</h3>
                            <div class="space-y-4">
                                {% if product.short_description %}
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Short Description</label>
                                    <p class="text-gray-900 bg-white p-3 rounded border border-gray-200">
                                        {{ product.short_description }}
                                    </p>
                                </div>
                                {% endif %}
                                
                                {% if product.long_description %}
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Full Description</label>
                                    <div class="text-gray-900 bg-white p-3 rounded border border-gray-200">
                                        {{ product.long_description|striptags }}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Technical Specifications -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Technical Specifications</h3>
                            <div class="space-y-3">
                                {% if product.unit_of_measure %}
                                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                    <label class="text-sm font-medium text-gray-600">Unit of Measure</label>
                                    <p class="text-gray-900">{{ product.get_unit_of_measure_display|default:product.unit_of_measure }}</p>
                                </div>
                                {% endif %}

                                {% if product.weight %}
                                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                    <label class="text-sm font-medium text-gray-600">Weight</label>
                                    <p class="text-gray-900">{{ product.weight }} {% if product.weight_unit %}{{ product.get_weight_unit_display|default:product.weight_unit }}{% endif %}</p>
                                </div>
                                {% endif %}

                                {% if product.length and product.width and product.height %}
                                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                    <label class="text-sm font-medium text-gray-600">Dimensions (L × W × H)</label>
                                    <p class="text-gray-900">{{ product.length }} × {{ product.width }} × {{ product.height }} {% if product.dimension_unit %}{{ product.get_dimension_unit_display|default:product.dimension_unit }}{% endif %}</p>
                                </div>
                                {% endif %}

                                {% if product.warranty %}
                                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                    <label class="text-sm font-medium text-gray-600">Warranty</label>
                                    <p class="text-gray-900">{{ product.get_warranty_display|default:product.warranty }}</p>
                                </div>
                                {% endif %}

                                {% if product.country_of_origin %}
                                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                    <label class="text-sm font-medium text-gray-600">Country of Origin</label>
                                    <p class="text-gray-900">{{ product.get_country_of_origin_display|default:product.country_of_origin }}</p>
                                </div>
                                {% endif %}

                                {% if not product.unit_of_measure and not product.weight and not product.length and not product.warranty and not product.country_of_origin %}
                                <p class="text-sm text-gray-500 py-2">No technical specifications provided</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Categorization -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Categorization</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Primary Category</label>
                                    <p class="text-gray-900">{{ product.primary_category|default:"—" }}</p>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Product Type</label>
                                    <p class="text-gray-900">{{ product.get_product_type_display|default:"—" }}</p>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Product Family</label>
                                    <p class="text-gray-900">{{ product.product_family|default:"—" }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="space-y-6">
                        <!-- Pricing Overview -->
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-6 border border-blue-200">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Pricing</h3>
                            <div class="space-y-3">
                                <div>
                                    <p class="text-sm text-gray-600">Base Price</p>
                                    <p class="text-2xl font-bold text-blue-600">
                                        {% if product.base_price %}
                                            KES {{ product.base_price|floatformat:2 }}
                                        {% else %}
                                            Custom Quote
                                        {% endif %}
                                    </p>
                                </div>
                                {% if product.base_cost %}
                                <div>
                                    <p class="text-sm text-gray-600">Base Cost</p>
                                    <p class="text-gray-900">KES {{ product.base_cost|floatformat:2 }}</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Stock Status -->
                        <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Stock Information</h3>
                            <div class="space-y-3">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Status</p>
                                    <p class="text-gray-900">{{ product.get_stock_status_display }}</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Quantity in Stock</p>
                                    <p class="text-2xl font-bold 
                                        {% if product.stock_quantity > 20 %}
                                            text-green-600
                                        {% elif product.stock_quantity > 5 %}
                                            text-yellow-600
                                        {% else %}
                                            text-red-600
                                        {% endif %}">
                                        {{ product.stock_quantity|default:"0" }}
                                    </p>
                                </div>
                                {% if product.min_stock_level %}
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Minimum Stock Level</p>
                                    <p class="text-gray-900">{{ product.min_stock_level }}</p>
                                </div>
                                {% endif %}
                                {% if product.reorder_quantity %}
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Reorder Quantity</p>
                                    <p class="text-gray-900">{{ product.reorder_quantity }}</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Product Attributes -->
                        <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Attributes</h3>
                            <div class="space-y-3 text-sm">
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-600">Tracking Enabled</span>
                                    <span class="font-medium">
                                        {% if product.tracking_enabled %}
                                            <i class="fas fa-check text-green-600"></i>
                                        {% else %}
                                            <i class="fas fa-times text-gray-400"></i>
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-600">Backorder Allowed</span>
                                    <span class="font-medium">
                                        {% if product.backorder_allowed %}
                                            <i class="fas fa-check text-green-600"></i>
                                        {% else %}
                                            <i class="fas fa-times text-gray-400"></i>
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-600">Returnable</span>
                                    <span class="font-medium">
                                        {% if product.is_returnable %}
                                            <i class="fas fa-check text-green-600"></i>
                                        {% else %}
                                            <i class="fas fa-times text-gray-400"></i>
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pricing Tab -->
            <div id="pricing-panel" role="tabpanel" class="tab-panel hidden">
                <div class="space-y-6">
                    <!-- Quantity-Based Pricing Tiers -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Pricing Tiers</h3>
                        {% if product.quantity_pricing.all %}
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-900">Quantity Range</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-900">Unit Price</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-900">Discount</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-900">Total Price</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    {% for tier in product.quantity_pricing.all %}
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3 text-gray-900">
                                            {% if tier.max_quantity %}
                                                {{ tier.min_quantity }}-{{ tier.max_quantity }} units
                                            {% else %}
                                                {{ tier.min_quantity }}+ units
                                            {% endif %}
                                        </td>
                                        <td class="px-4 py-3 font-semibold text-gray-900">KES {{ tier.unit_price|floatformat:2 }}</td>
                                        <td class="px-4 py-3 text-gray-700">
                                            {% if tier.percentage_discount > 0 %}
                                                {{ tier.percentage_discount }}%
                                            {% else %}
                                                —
                                            {% endif %}
                                        </td>
                                        <td class="px-4 py-3 font-semibold text-green-600">KES {{ tier.unit_price|floatformat:2 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="bg-gray-50 rounded-lg p-6 text-center text-gray-600">
                            <p>No pricing tiers configured</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Base Pricing Configuration -->
                    {% if pricing %}
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Base Pricing Configuration</h3>
                        <div class="space-y-4">
                            {% for price_config in pricing %}
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Pricing Model</label>
                                    <p class="text-gray-900">{{ price_config.get_pricing_model_display }}</p>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Base Cost</label>
                                    <p class="text-gray-900">KES {{ price_config.base_cost|floatformat:2 }}</p>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Default Margin</label>
                                    <p class="text-gray-900">{{ price_config.default_margin }}%</p>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Minimum Margin</label>
                                    <p class="text-gray-900">{{ price_config.minimum_margin }}%</p>
                                </div>
                                {% if price_config.lead_time_value %}
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Lead Time</label>
                                    <p class="text-gray-900">{{ price_config.lead_time_value }} {{ price_config.get_lead_time_unit_display|lower }}</p>
                                </div>
                                {% endif %}
                                {% if price_config.production_method %}
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Production Method</label>
                                    <p class="text-gray-900">{{ price_config.get_production_method_display }}</p>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Customization Options -->
                    {% if product.variables.all %}
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Customization Options</h3>
                        <div class="space-y-4">
                            {% for variable in product.variables.all %}
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div>
                                        <h4 class="font-medium text-gray-900">{{ variable.name }}</h4>
                                        <p class="text-xs text-gray-600 mt-1">Type: {{ variable.get_variable_type_display }} • Pricing: {{ variable.get_pricing_type_display }}</p>
                                    </div>
                                    <span class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded">
                                        {% if variable.variable_type == 'required' %}Required{% else %}Optional{% endif %}
                                    </span>
                                </div>
                                {% if variable.options.all %}
                                <div class="flex flex-wrap gap-2">
                                    {% for option in variable.options.all %}
                                    <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm">
                                        {{ option.name }}
                                        {% if option.price_modifier > 0 %}
                                        <span class="text-gray-500 ml-1">(+KES {{ option.price_modifier }})</span>
                                        {% endif %}
                                    </span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Images Tab -->
            <div id="images-panel" role="tabpanel" class="tab-panel hidden">
                {% if images %}
                <div class="space-y-6">
                    <!-- Primary Image Display -->
                    {% with primary=images|first %}
                    {% if primary.is_primary %}
                    <div class="bg-white rounded-lg overflow-hidden shadow-lg border-2 border-blue-200">
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">Primary Product Image</h3>
                            <span class="px-3 py-1 bg-blue-600 text-white text-xs font-medium rounded-full">Featured</span>
                        </div>
                        <div class="relative bg-gray-100 flex items-center justify-center" style="min-height: 400px;">
                            {% if primary.image %}
                            <img src="{{ primary.image.url }}" alt="{{ primary.alt_text }}" class="max-w-full max-h-96 object-contain">
                            {% else %}
                            <div class="flex flex-col items-center justify-center">
                                <i class="fas fa-image text-gray-400 text-6xl mb-4"></i>
                                <p class="text-gray-500">No image available</p>
                            </div>
                            {% endif %}
                        </div>
                        <div class="p-6 bg-white border-t border-gray-200">
                            <p class="text-sm text-gray-600 mb-2"><strong>Description:</strong></p>
                            <p class="text-gray-900">{{ primary.alt_text }}</p>
                            {% if primary.caption %}
                            <p class="text-sm text-gray-600 mt-2"><strong>Caption:</strong> {{ primary.caption }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% endwith %}

                    <!-- Additional Images Gallery -->
                    {% with additional=images|slice:"1:" %}
                    {% if additional %}
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                            <i class="fas fa-images text-blue-600"></i>
                            Additional Product Images ({{ additional|length }})
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            {% for image in additional %}
                            <div class="group relative bg-gray-100 rounded-lg overflow-hidden shadow hover:shadow-lg transition-shadow cursor-pointer border-2 border-transparent hover:border-blue-400" 
                                 onclick="openImageLightbox('{{ image.image.url }}', '{{ image.alt_text }}')">
                                <div class="relative overflow-hidden bg-gray-100">
                                    {% if image.image %}
                                    <img src="{{ image.image.url }}" alt="{{ image.alt_text }}" class="w-full h-48 object-cover group-hover:scale-110 transition-transform duration-300">
                                    {% else %}
                                    <div class="w-full h-48 flex items-center justify-center bg-gray-300">
                                        <i class="fas fa-image text-gray-400 text-3xl"></i>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Hover Overlay -->
                                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all flex items-center justify-center">
                                        <button class="p-2 bg-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity transform group-hover:scale-100 scale-75">
                                            <i class="fas fa-search-plus text-gray-900 text-xl"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Image Info -->
                                <div class="p-3 bg-white">
                                    <p class="text-xs text-gray-600 truncate" title="{{ image.alt_text }}">{{ image.alt_text|truncatewords:3 }}</p>
                                    <p class="text-xs text-gray-500 mt-1">{{ image.get_image_type_display }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    {% endwith %}
                </div>

                <!-- Lightbox Modal -->
                <div id="imageLightbox" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4" onclick="if(event.target.id === 'imageLightbox') closeLightbox()">
                    <div class="relative bg-white rounded-lg max-w-4xl w-full max-h-96 flex items-center justify-center">
                        <img id="lightboxImage" src="" alt="Product image" class="max-w-full max-h-96 object-contain">
                        
                        <button onclick="closeLightbox()" class="absolute top-4 right-4 bg-gray-800 hover:bg-gray-900 text-white rounded-full w-10 h-10 flex items-center justify-center transition">
                            <i class="fas fa-times text-lg"></i>
                        </button>
                    </div>
                </div>

                {% else %}
                <div class="bg-gray-50 rounded-lg p-12 text-center border-2 border-dashed border-gray-300">
                    <i class="fas fa-image text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-600 text-lg font-medium">No images uploaded yet</p>
                    <p class="text-gray-500 text-sm mt-2">Product images will appear here once they are uploaded</p>
                </div>
                {% endif %}
            </div>

            <!-- Inventory Tab -->
            <div id="inventory-panel" role="tabpanel" class="tab-panel hidden">
                {% if is_production_team %}
                <!-- EDITABLE FORM FOR PRODUCTION TEAM -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-edit text-blue-600 mr-2"></i>
                        <h3 class="text-lg font-semibold text-blue-900">Update Inventory</h3>
                    </div>
                    <form id="inventory-form" class="space-y-4">
                        {% csrf_token %}
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="stock-quantity" class="block text-sm font-medium text-gray-700 mb-2">
                                    Current Stock Quantity
                                </label>
                                <input 
                                    type="number" 
                                    id="stock-quantity" 
                                    name="stock_quantity" 
                                    value="{{ product.stock_quantity|default:0 }}"
                                    min="0"
                                    step="1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                    required
                                >
                            </div>
                            
                            <div>
                                <label for="low-stock-threshold" class="block text-sm font-medium text-gray-700 mb-2">
                                    Low Stock Threshold
                                </label>
                                <input 
                                    type="number" 
                                    id="low-stock-threshold" 
                                    name="low_stock_threshold" 
                                    value="{{ product.low_stock_threshold|default:10 }}"
                                    min="0"
                                    step="1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                >
                            </div>
                            
                            <div>
                                <label for="track-inventory" class="block text-sm font-medium text-gray-700 mb-2">
                                    Track Inventory
                                </label>
                                <select 
                                    id="track-inventory" 
                                    name="track_inventory"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                >
                                    <option value="false" {% if not product.track_inventory %}selected{% endif %}>No</option>
                                    <option value="true" {% if product.track_inventory %}selected{% endif %}>Yes</option>
                                </select>
                            </div>

                            <div>
                                <label for="allow-backorders" class="block text-sm font-medium text-gray-700 mb-2">
                                    Allow Backorders
                                </label>
                                <select 
                                    id="allow-backorders" 
                                    name="allow_backorders"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                >
                                    <option value="false" {% if not product.allow_backorders %}selected{% endif %}>No</option>
                                    <option value="true" {% if product.allow_backorders %}selected{% endif %}>Yes</option>
                                </select>
                            </div>
                        </div>

                        <div class="flex gap-2 justify-end pt-4 border-t">
                            <button 
                                type="button" 
                                id="inventory-cancel-btn"
                                class="px-4 py-2 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md transition"
                            >
                                Cancel
                            </button>
                            <button 
                                type="submit" 
                                id="inventory-save-btn"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition flex items-center gap-2"
                            >
                                <i class="fas fa-save"></i> Save Inventory
                            </button>
                        </div>
                    </form>
                </div>
                {% endif %}

                <!-- DISPLAY SECTION (ALL USERS) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Stock Levels</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm font-medium text-gray-600">Current Stock</label>
                                <p class="text-3xl font-bold text-gray-900">{{ product.stock_quantity|default:"0" }}</p>
                            </div>
                            {% if product.low_stock_threshold %}
                            <div>
                                <label class="text-sm font-medium text-gray-600">Low Stock Threshold</label>
                                <p class="text-2xl font-semibold text-gray-900">{{ product.low_stock_threshold }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Availability Settings</h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Stock Status</span>
                                <span class="font-semibold text-gray-900">{{ product.get_stock_status_display }}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Allow Backorders</span>
                                <span class="font-semibold">
                                    {% if product.allow_backorders %}
                                        <span class="text-green-600"><i class="fas fa-check"></i> Yes</span>
                                    {% else %}
                                        <span class="text-red-600"><i class="fas fa-times"></i> No</span>
                                    {% endif %}
                                </span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Track Inventory</span>
                                <span class="font-semibold">
                                    {% if product.track_inventory %}
                                        <span class="text-green-600"><i class="fas fa-check"></i> Yes</span>
                                    {% else %}
                                        <span class="text-red-600"><i class="fas fa-times"></i> No</span>
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Change History Tab -->
            <div id="history-panel" role="tabpanel" class="tab-panel hidden">
                {% if change_history %}
                <div class="space-y-4">
                    {% for change in change_history %}
                    <div class="bg-gray-50 rounded-lg p-4 border-l-4 border-blue-400">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <p class="font-semibold text-gray-900">{{ change.change_type|upper }}</p>
                                <p class="text-sm text-gray-600">{{ change.changed_by.get_full_name|default:change.changed_by.username }}</p>
                            </div>
                            <p class="text-sm text-gray-500">{{ change.changed_at|date:"M d, Y H:i" }}</p>
                        </div>
                        {% if change.notes %}
                        <p class="text-gray-700 text-sm">{{ change.notes }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="bg-gray-50 rounded-lg p-8 text-center">
                    <i class="fas fa-history text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-600">No changes recorded yet</p>
                </div>
                {% endif %}
            </div>

            <!-- SEO Tab (if available) -->
            {% if seo_data %}
            <div id="seo-panel" role="tabpanel" class="tab-panel hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">SEO Metadata</h3>
                        <div class="space-y-4">
                            {% if seo_data.meta_title %}
                            <div>
                                <label class="text-sm font-medium text-gray-600">Meta Title</label>
                                <p class="text-gray-900 bg-white p-2 rounded border border-gray-200 text-sm">
                                    {{ seo_data.meta_title }}
                                </p>
                            </div>
                            {% endif %}
                            
                            {% if seo_data.meta_description %}
                            <div>
                                <label class="text-sm font-medium text-gray-600">Meta Description</label>
                                <p class="text-gray-900 bg-white p-2 rounded border border-gray-200 text-sm">
                                    {{ seo_data.meta_description }}
                                </p>
                            </div>
                            {% endif %}
                            
                            {% if seo_data.keywords %}
                            <div>
                                <label class="text-sm font-medium text-gray-600">Keywords</label>
                                <p class="text-gray-900 bg-white p-2 rounded border border-gray-200 text-sm">
                                    {{ seo_data.keywords }}
                                </p>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Social Media</h3>
                        <div class="space-y-4">
                            {% if seo_data.og_title %}
                            <div>
                                <label class="text-sm font-medium text-gray-600">OG Title</label>
                                <p class="text-gray-900 text-sm">{{ seo_data.og_title }}</p>
                            </div>
                            {% endif %}
                            
                            {% if seo_data.og_description %}
                            <div>
                                <label class="text-sm font-medium text-gray-600">OG Description</label>
                                <p class="text-gray-900 text-sm">{{ seo_data.og_description }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .tab-panel {
        display: none;
    }

    .tab-panel.active {
        display: block;
    }

    .tab-button {
        position: relative;
        transition: all 0.3s ease;
    }

    .tab-button.active {
        color: #2563eb !important;
        border-color: #2563eb !important;
    }

    .badge {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        background: #e0f2fe;
        color: #0369a1;
    }

    .badge-in_stock { background: #d1fae5; color: #065f46; }
    .badge-low_stock { background: #fef3c7; color: #92400e; }
    .badge-out_of_stock { background: #fee2e2; color: #991b1b; }
    .badge-made_to_order { background: #e0e7ff; color: #3730a3; }
    .badge-discontinued { background: #f3f4f6; color: #6b7280; }

    /* Image Gallery Enhancements */
    .group {
        position: relative;
    }

    #imageLightbox {
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    /* Smooth tab transitions */
    .tab-panel {
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Modern card styling */
    .rounded-xl {
        border-radius: 0.75rem;
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
        .max-w-7xl {
            max-width: 100%;
        }

        h1 {
            font-size: 1.875rem;
        }

        .px-8 {
            padding-left: 1rem;
            padding-right: 1rem;
        }
    }
</style>

<script>
    function switchTab(event, tabName) {
        event.preventDefault();
        
        // Hide all tab panels
        const panels = document.querySelectorAll('.tab-panel');
        panels.forEach(panel => panel.classList.remove('active'));
        
        // Remove active class from all buttons
        const buttons = document.querySelectorAll('.tab-button');
        buttons.forEach(button => {
            button.setAttribute('aria-selected', 'false');
            button.classList.remove('active');
        });
        
        // Show selected tab panel
        const panel = document.getElementById(tabName + '-panel');
        if (panel) {
            panel.classList.add('active');
        }
        
        // Add active class to clicked button
        event.target.closest('.tab-button').classList.add('active');
        event.target.closest('.tab-button').setAttribute('aria-selected', 'true');
    }

    // Image Lightbox Functions
    function openImageLightbox(imageUrl, altText) {
        const lightbox = document.getElementById('imageLightbox');
        const img = document.getElementById('lightboxImage');
        
        if (lightbox && img) {
            img.src = imageUrl;
            img.alt = altText;
            lightbox.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
    }

    function closeLightbox() {
        const lightbox = document.getElementById('imageLightbox');
        if (lightbox) {
            lightbox.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    }

    // Close lightbox on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeLightbox();
        }
    });

    // Inventory Form Handler
    document.addEventListener('DOMContentLoaded', function() {
        const inventoryForm = document.getElementById('inventory-form');
        const cancelBtn = document.getElementById('inventory-cancel-btn');
        
        if (inventoryForm) {
            inventoryForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const saveBtn = document.getElementById('inventory-save-btn');
                const originalText = saveBtn.innerHTML;
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                
                const formData = new FormData(inventoryForm);
                const productId = formData.get('product_id');
                
                try {
                    const response = await fetch(`/api/v1/products/${productId}/update_inventory/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            stock_quantity: parseInt(formData.get('stock_quantity')) || 0,
                            low_stock_threshold: parseInt(formData.get('low_stock_threshold')) || 10,
                            track_inventory: formData.get('track_inventory') === 'true',
                            allow_backorders: formData.get('allow_backorders') === 'true',
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Show success message
                        const successMsg = document.createElement('div');
                        successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-3 rounded-lg shadow-lg z-50';
                        successMsg.innerHTML = '<i class="fas fa-check mr-2"></i> Inventory updated successfully';
                        document.body.appendChild(successMsg);
                        
                        // Remove message after 3 seconds
                        setTimeout(() => successMsg.remove(), 3000);
                        
                        // Reload the page to show updated values
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        const error = await response.json();
                        throw new Error(error.detail || 'Failed to update inventory');
                    }
                } catch (error) {
                    console.error('Error updating inventory:', error);
                    
                    // Show error message
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-3 rounded-lg shadow-lg z-50';
                    errorMsg.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i> Error: ' + error.message;
                    document.body.appendChild(errorMsg);
                    
                    setTimeout(() => errorMsg.remove(), 5000);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalText;
                }
            });
            
            cancelBtn.addEventListener('click', function() {
                location.reload();
            });
        }
    });
</script>
{% endblock %}
