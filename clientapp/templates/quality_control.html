{% extends 'base.html' %}
{% load static %}

{% block title %}QC Inspection - {{ inspection.reference_number }}{% endblock %}

{% block extra_css %}
<style>
    .qc-header {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .back-link {
        color: #3b82f6;
        text-decoration: none;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        margin-bottom: 15px;
    }

    .back-link:hover {
        color: #2563eb;
    }

    .qc-title {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 5px;
    }

    .qc-subtitle {
        font-size: 14px;
        color: #6b7280;
    }

    .qc-meta {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
        font-size: 14px;
        color: #6b7280;
    }

    .qc-container {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 20px;
    }

    .qc-main {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .qc-section {
        background: white;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid #f3f4f6;
    }

    .section-icon {
        font-size: 18px;
    }

    .section-title {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
        flex: 1;
    }

    .checklist-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 0;
        border-bottom: 1px solid #f3f4f6;
    }

    .checklist-item:last-child {
        border-bottom: none;
    }

    .checklist-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .checklist-item input[type="checkbox"]:checked {
        accent-color: #10b981;
    }

    .checklist-label {
        font-size: 14px;
        color: #4b5563;
    }

    .delivery-notes {
        width: 100%;
        min-height: 80px;
        padding: 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        resize: vertical;
    }

    .delivery-notes:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .quality-item {
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid #f3f4f6;
    }

    .quality-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .quality-label {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 12px;
    }

    .rating-buttons {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
    }

    .rating-btn {
        width: 40px;
        height: 40px;
        border: 2px solid #d1d5db;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        color: #6b7280;
        transition: all 0.2s;
    }

    .rating-btn:hover {
        border-color: #3b82f6;
        color: #3b82f6;
    }

    .rating-btn.active {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
    }

    .rating-stars {
        display: flex;
        gap: 4px;
        margin-bottom: 8px;
    }

    .rating-stars span {
        color: #d1d5db;
        font-size: 20px;
        cursor: pointer;
    }

    .rating-stars span.active {
        color: #fbbf24;
    }

    .rating-note {
        font-size: 12px;
        color: #6b7280;
        font-style: italic;
        margin-top: 8px;
    }

    .quality-notes {
        width: 100%;
        min-height: 60px;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 13px;
        resize: vertical;
    }

    .photo-upload-section {
        border: 2px dashed #d1d5db;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        background: #f9fafb;
        cursor: pointer;
        transition: all 0.2s;
    }

    .photo-upload-section:hover {
        border-color: #3b82f6;
        background: #eff6ff;
    }

    .upload-icon {
        font-size: 32px;
        color: #9ca3af;
        margin-bottom: 10px;
    }

    .upload-text {
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 8px;
    }

    .upload-link {
        color: #3b82f6;
        font-size: 14px;
    }

    .photo-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-top: 20px;
    }

    .photo-slot {
        aspect-ratio: 1;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f9fafb;
        position: relative;
        overflow: hidden;
    }

    .photo-slot img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .photo-slot .placeholder {
        color: #9ca3af;
        font-size: 12px;
    }

    .photo-slot .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 24px;
        height: 24px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 12px;
    }

    .upload-tips {
        margin-top: 15px;
        padding: 12px;
        background: #f9fafb;
        border-radius: 6px;
    }

    .upload-tips-title {
        font-size: 12px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
    }

    .upload-tips ul {
        margin: 0;
        padding-left: 20px;
        font-size: 12px;
        color: #6b7280;
    }

    .qc-score {
        background: #f0fdf4;
        border: 2px solid #10b981;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
    }

    .score-label {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 8px;
    }

    .score-value {
        font-size: 48px;
        font-weight: 700;
        color: #10b981;
        margin-bottom: 8px;
    }

    .score-bar {
        width: 100%;
        height: 8px;
        background: #d1fae5;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 8px;
    }

    .score-bar-fill {
        height: 100%;
        background: linear-gradient(to right, #10b981, #059669);
        transition: width 0.3s;
    }

    .score-calculation {
        font-size: 11px;
        color: #6b7280;
        margin-top: 10px;
    }

    .grade-scale {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
    }

    .grade-scale-title {
        font-size: 12px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 10px;
    }

    .grade-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        font-size: 12px;
    }

    .grade-item .grade {
        font-weight: 600;
    }

    .grade-item.excellent .grade {
        color: #10b981;
    }

    .grade-item.good .grade {
        color: #3b82f6;
    }

    .grade-item.acceptable .grade {
        color: #f59e0b;
    }

    .grade-item.below .grade {
        color: #ef4444;
    }

    .decision-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .decision-options {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 20px;
    }

    .decision-option {
        padding: 16px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: start;
        gap: 12px;
    }

    .decision-option:hover {
        border-color: #3b82f6;
        background: #eff6ff;
    }

    .decision-option.selected {
        border-color: #10b981;
        background: #f0fdf4;
    }

    .decision-option.selected.pass {
        border-color: #10b981;
    }

    .decision-option.selected.conditions {
        border-color: #f59e0b;
        background: #fffbeb;
    }

    .decision-option.selected.fail {
        border-color: #ef4444;
        background: #fef2f2;
    }

    .decision-radio {
        margin-top: 2px;
    }

    .decision-content {
        flex: 1;
    }

    .decision-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 4px;
    }

    .decision-desc {
        font-size: 12px;
        color: #6b7280;
    }

    .decision-bullets {
        margin: 8px 0 0 0;
        padding-left: 20px;
        font-size: 12px;
        color: #6b7280;
    }

    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .sidebar-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .sidebar-title {
        font-size: 14px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f3f4f6;
        font-size: 13px;
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .info-label {
        color: #6b7280;
    }

    .info-value {
        font-weight: 600;
        color: #1f2937;
    }

    .sampling-reqs {
        font-size: 13px;
        color: #4b5563;
        line-height: 1.6;
    }

    .sampling-reqs li {
        margin-bottom: 6px;
    }

    .inspection-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        background: #dbeafe;
        color: #1e40af;
    }

    .qc-history-item {
        padding: 12px;
        background: #f9fafb;
        border-radius: 6px;
        margin-bottom: 10px;
    }

    .history-vendor {
        font-size: 13px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 4px;
    }

    .history-details {
        font-size: 12px;
        color: #6b7280;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .history-score {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-weight: 600;
    }

    .history-score.high {
        color: #10b981;
    }

    .history-score.medium {
        color: #f59e0b;
    }

    .delivery-prep {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .prep-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-label {
        font-size: 13px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 8px;
        display: block;
    }

    .form-select,
    .form-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
    }

    .notify-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #4b5563;
        cursor: pointer;
    }

    .bottom-actions {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .btn {
        padding: 12px 24px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-secondary {
        background: white;
        color: #4b5563;
        border: 1px solid #d1d5db;
    }

    .btn-secondary:hover {
        background: #f9fafb;
    }

    .btn-primary {
        background: #3b82f6;
        color: white;
    }

    .btn-primary:hover {
        background: #2563eb;
    }

    .btn-primary:disabled {
        background: #9ca3af;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="qc-header">
        <a href="{% url 'production2_dashboard' %}" class="back-link">‚Üê Back to Dashboard</a>

        <div class="qc-title">QC Inspection</div>
        <div class="qc-subtitle">{{ inspection.reference_number }} | {{ job.title }}</div>

        <div class="qc-meta">
            <div class="meta-group">
                <div>
                    <span class="meta-label">Vendor:</span>
                    <span class="meta-value">{{ vendor.name }}</span>
                </div>
                <div>
                    <span class="meta-label">Delivered:</span>
                    <span class="meta-value">{{ inspection.delivered_date|date:"M d, Y, g:i A" }}</span>
                </div>
            </div>
            <div class="meta-group" style="text-align: right;">
                <div>
                    <span class="meta-label">Warehouse Location:</span>
                    <span class="meta-value">{{ inspection.warehouse_location }}</span>
                </div>
                <div>
                    <span class="inspection-status">Inspected: {{ inspection.inspected_quantity }} pcs</span>
                </div>
            </div>
        </div>
    </div>

    <div class="qc-container">
        <!-- Main Content -->
        <div class="qc-main">
            <!-- Delivery Checklist -->
            <div class="qc-section">
                <div class="section-header">
                    <h3 class="section-title">Delivery Checklist</h3>
                </div>

                <div class="checklist-item">
                    <input type="checkbox" id="check1">
                    <label for="check1" class="checklist-label">Packaging intact (no damage)</label>
                </div>
                <div class="checklist-item">
                    <input type="checkbox" id="check2">
                    <label for="check2" class="checklist-label">Correct quantity received</label>
                </div>
                <div class="checklist-item">
                    <input type="checkbox" id="check3">
                    <label for="check3" class="checklist-label">Anonymous Job ID label present</label>
                </div>
                <div class="checklist-item">
                    <input type="checkbox" id="check4">
                    <label for="check4" class="checklist-label">Sealed boxes/packaging</label>
                </div>
                <div class="checklist-item">
                    <input type="checkbox" id="check5">
                    <label for="check5" class="checklist-label">No visible damage to contents</label>
                </div>

                <div class="form-group" style="margin-top: 24px;">
                    <label class="form-label">Delivery Notes</label>
                    <textarea class="delivery-notes" id="deliveryNotes"
                        placeholder="Record any observations about the delivery condition..."></textarea>
                </div>
            </div>

            <!-- Quality Inspection -->
            <div class="qc-section">
                <div class="section-header">
                    <h3 class="section-title">Quality Inspection (Rate 1-5)</h3>
                </div>

                <!-- Print Quality -->
                <div class="quality-item">
                    <div class="quality-label">1. Print Quality</div>
                    <div class="rating-buttons" data-rating-group="print-quality">
                        <button class="rating-btn" data-value="1">1</button>
                        <button class="rating-btn" data-value="2">2</button>
                        <button class="rating-btn" data-value="3">3</button>
                        <button class="rating-btn" data-value="4">4</button>
                        <button class="rating-btn" data-value="5">5</button>
                    </div>
                    <div class="rating-stars" data-stars-group="print-quality">
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                    </div>
                    <div class="rating-note">Not rated</div>
                    <textarea class="quality-notes"
                        placeholder="Notes on print quality..."></textarea>
                </div>

                <!-- Color Accuracy -->
                <div class="quality-item">
                    <div class="quality-label">2. Color Accuracy</div>
                    <div class="rating-buttons" data-rating-group="color-accuracy">
                        <button class="rating-btn" data-value="1">1</button>
                        <button class="rating-btn" data-value="2">2</button>
                        <button class="rating-btn" data-value="3">3</button>
                        <button class="rating-btn" data-value="4">4</button>
                        <button class="rating-btn" data-value="5">5</button>
                    </div>
                    <div class="rating-stars" data-stars-group="color-accuracy">
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                    </div>
                    <div class="rating-note">Not rated</div>
                    <textarea class="quality-notes"
                        placeholder="Notes on color accuracy..."></textarea>
                </div>

                <!-- Material Quality -->
                <div class="quality-item">
                    <div class="quality-label">3. Material Quality</div>
                    <div class="rating-buttons" data-rating-group="material-quality">
                        <button class="rating-btn" data-value="1">1</button>
                        <button class="rating-btn" data-value="2">2</button>
                        <button class="rating-btn" data-value="3">3</button>
                        <button class="rating-btn" data-value="4">4</button>
                        <button class="rating-btn" data-value="5">5</button>
                    </div>
                    <div class="rating-stars" data-stars-group="material-quality">
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                    </div>
                    <div class="rating-note">Not rated</div>
                    <textarea class="quality-notes"
                        placeholder="Notes on material quality..."></textarea>
                </div>

                <!-- Finishing Quality -->
                <div class="quality-item">
                    <div class="quality-label">4. Finishing Quality</div>
                    <div class="rating-buttons" data-rating-group="finishing-quality">
                        <button class="rating-btn" data-value="1">1</button>
                        <button class="rating-btn" data-value="2">2</button>
                        <button class="rating-btn" data-value="3">3</button>
                        <button class="rating-btn" data-value="4">4</button>
                        <button class="rating-btn" data-value="5">5</button>
                    </div>
                    <div class="rating-stars" data-stars-group="finishing-quality">
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                    </div>
                    <div class="rating-note">Not rated</div>
                    <textarea class="quality-notes"
                        placeholder="Notes on finishing quality..."></textarea>
                </div>

                <!-- Overall Quality -->
                <div class="quality-item">
                    <div class="quality-label">5. Overall Quality</div>
                    <div class="rating-buttons" data-rating-group="overall-quality">
                        <button class="rating-btn" data-value="1">1</button>
                        <button class="rating-btn" data-value="2">2</button>
                        <button class="rating-btn" data-value="3">3</button>
                        <button class="rating-btn" data-value="4">4</button>
                        <button class="rating-btn" data-value="5">5</button>
                    </div>
                    <div class="rating-stars" data-stars-group="overall-quality">
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                    </div>
                    <div class="rating-note">Not rated</div>
                    <textarea class="quality-notes"
                        placeholder="Notes on overall quality..."></textarea>
                </div>
            </div>

            <!-- Inspection Photos -->
            <div class="qc-section">
                <div class="section-header">
                    <h3 class="section-title">Inspection Photos (Min 2, Max 10)</h3>
                </div>

                <div class="photo-upload-section" onclick="document.getElementById('photoInput').click()">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">Drag & Drop or Click to Upload</div>
                    <div class="upload-link">Select Photos</div>
                </div>
                <input type="file" id="photoInput" accept="image/*" multiple style="display: none;">

                <div class="photo-grid">
                    <div class="photo-slot">
                        <span class="placeholder">Photo 1</span>
                    </div>
                    <div class="photo-slot">
                        <span class="placeholder">Photo 2</span>
                    </div>
                    <div class="photo-slot">
                        <span class="placeholder">Photo 3</span>
                    </div>
                    <div class="photo-slot">
                        <span class="placeholder">Photo 4</span>
                    </div>
                    <div class="photo-slot">
                        <span class="placeholder">Photo 5</span>
                    </div>
                    <div class="photo-slot">
                        <span class="placeholder">Photo 6</span>
                    </div>
                </div>

                <div class="upload-tips">
                    <div class="upload-tips-title">Photography Guidelines</div>
                    <ul>
                        <li>Capture overall product view</li>
                        <li>Close-ups of print quality</li>
                        <li>Document any defects or issues</li>
                        <li>Show packaging condition</li>
                    </ul>
                </div>
            </div>

            <!-- QC Decision -->
            <div class="decision-section">
                <div class="section-header">
                    <h3 class="section-title">QC Decision</h3>
                </div>

                <div class="decision-options">
                    <div class="decision-option" data-decision="pass">
                        <input type="radio" name="qc-decision" value="pass" class="decision-radio">
                        <div class="decision-content">
                            <div class="decision-title">PASS - Approve for Delivery</div>
                            <div class="decision-desc">Quality meets or exceeds standards</div>
                            <ul class="decision-bullets">
                                <li>Vendor VPS +1.0 point</li>
                                <li>Ready for client delivery</li>
                            </ul>
                        </div>
                    </div>

                    <div class="decision-option" data-decision="conditions">
                        <input type="radio" name="qc-decision" value="conditions" class="decision-radio">
                        <div class="decision-content">
                            <div class="decision-title">PASS WITH CONDITIONS</div>
                            <div class="decision-desc">Minor issues, requires AM approval</div>
                            <ul class="decision-bullets">
                                <li>May need client notification</li>
                                <li>Document conditions clearly</li>
                            </ul>
                        </div>
                    </div>

                    <div class="decision-option" data-decision="fail">
                        <input type="radio" name="qc-decision" value="fail" class="decision-radio">
                        <div class="decision-content">
                            <div class="decision-title">FAIL - Reject & Request Rework</div>
                            <div class="decision-desc">Quality below standards</div>
                            <ul class="decision-bullets">
                                <li>Vendor VPS -2.0 points</li>
                                <li>Rework workflow triggered</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delivery Preparation -->
            <div class="delivery-prep">
                <div class="section-header">
                    <h3 class="section-title">Delivery Preparation</h3>
                </div>

                <div class="prep-grid">
                    <div>
                        <div class="form-group">
                            <label class="form-label">Shelf Location</label>
                            <select class="form-select" id="shelfLocation">
                                <option value="">Select location...</option>
                                <option value="A-15">A-15</option>
                                <option value="A-16">A-16</option>
                                <option value="B-10">B-10</option>
                                <option value="B-11">B-11</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Packaging Verification</label>
                            <div class="checklist-item">
                                <input type="checkbox" id="pack1">
                                <label for="pack1" class="checklist-label">All items properly packed</label>
                            </div>
                            <div class="checklist-item">
                                <input type="checkbox" id="pack2">
                                <label for="pack2" class="checklist-label">Anonymous Job ID label applied</label>
                            </div>
                            <div class="checklist-item">
                                <input type="checkbox" id="pack3">
                                <label for="pack3" class="checklist-label">Quantity marked on boxes</label>
                            </div>
                            <div class="checklist-item">
                                <input type="checkbox" id="pack4">
                                <label for="pack4" class="checklist-label">Fragile stickers (if needed)</label>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="form-group">
                            <label class="form-label">Box Count</label>
                            <input type="number" class="form-input" value="1" min="1">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Notes to Account Manager</label>
                            <textarea class="delivery-notes" style="min-height: 140px;"
                                id="notesToAM" placeholder="Provide any important information for the account manager..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 24px;">
                    <label class="form-label">Notifications</label>
                    <div class="notify-group">
                        <label class="checkbox-label">
                            <input type="checkbox" checked>
                            Notify Account Manager
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" checked>
                            Send email notification
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox">
                            Mark as urgent
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- QC Score -->
            <div class="qc-score">
                <div class="score-label">QC Score (Auto-calculated)</div>
                <div class="score-value" id="totalScore">--%</div>
                <div class="score-bar">
                    <div class="score-bar-fill" id="scoreBar" style="width: 0%"></div>
                </div>
                <div class="score-calculation">
                    Complete all quality ratings to calculate score
                </div>

                <div class="grade-scale">
                    <div class="grade-scale-title">Grade Scale</div>
                    <div class="grade-item">
                        <span>A (90-100%)</span>
                        <span class="grade">Excellent</span>
                    </div>
                    <div class="grade-item">
                        <span>B (80-89%)</span>
                        <span class="grade">Good</span>
                    </div>
                    <div class="grade-item">
                        <span>C (70-79%)</span>
                        <span class="grade">Acceptable</span>
                    </div>
                    <div class="grade-item">
                        <span>D (60-69%)</span>
                        <span class="grade">Below Standard</span>
                    </div>
                    <div class="grade-item">
                        <span>F (Below 60%)</span>
                        <span class="grade">Failed</span>
                    </div>
                </div>
            </div>

            <!-- Item Summary -->
            <div class="sidebar-section">
                <div class="sidebar-title">Item Summary</div>
                <div class="info-row">
                    <span class="info-label">Quote #</span>
                    <span class="info-value">{{ job.quote.quote_id }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Client</span>
                    <span class="info-value">{{ job.client.name }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Product</span>
                    <span class="info-value">{{ job.product }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Quantity</span>
                    <span class="info-value">{{ job.quantity }} pcs</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Vendor</span>
                    <span class="info-value">{{ vendor.name }}</span>
                </div>
                {% if job.vendor_cost %}
                <div class="info-row">
                    <span class="info-label">Vendor Cost</span>
                    <span class="info-value">{{ job.vendor_cost|floatformat:0 }} KES</span>
                </div>
                {% endif %}
            </div>

            <!-- Sampling Requirements -->
            <div class="sidebar-section">
                <div class="sidebar-title">Sampling Requirements</div>
                <div style="margin-bottom: 16px;">
                    <div class="info-label">Total Quantity: {{ job.quantity }} pcs</div>
                    <div class="info-value">Required Sample: {{ inspection.inspected_quantity }} pcs</div>
                </div>

                <div class="sampling-reqs">
                    <strong>Sampling Standard:</strong>
                    <ul style="margin-top: 10px; padding-left: 20px;">
                        <li>Under 100 pcs: 20% sample</li>
                        <li>100-1000: 10% sample</li>
                        <li>1000-5000: 5% sample</li>
                        <li>Over 5000: 5% sample (min 250)</li>
                    </ul>
                </div>
            </div>

            <!-- Vendor QC History -->
            <div class="sidebar-section">
                <div class="sidebar-title">Vendor QC History</div>

                {% if vendor_history %}
                    {% for history in vendor_history %}
                    <div class="qc-history-item">
                        <div class="history-vendor">{{ vendor.name }}</div>
                        <div class="history-details">
                            <div>{{ history.date|date:"M d, Y" }}: {{ history.score }}%</div>
                            <div>{{ history.product }}</div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div style="padding: 20px; text-align: center; color: #999; font-size: 13px;">
                        No previous QC history
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Bottom Actions -->
    <div class="bottom-actions">
        <button class="btn btn-secondary" onclick="saveDraft()">
            Save Draft
        </button>
        <div>
            <button class="btn btn-primary" onclick="submitQC()" id="submitBtn">
                Submit QC & Handoff to AM ‚Üí
            </button>
        </div>
    </div>
</div>

<script>
    // Rating button functionality
    document.querySelectorAll('.rating-buttons').forEach(group => {
        const buttons = group.querySelectorAll('.rating-btn');
        const groupName = group.dataset.ratingGroup;
        const starsGroup = document.querySelector(`[data-stars-group="${groupName}"]`);

        buttons.forEach(btn => {
            btn.addEventListener('click', function () {
                buttons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                const value = parseInt(this.dataset.value);
                if (starsGroup) {
                    const stars = starsGroup.querySelectorAll('span');
                    stars.forEach((star, index) => {
                        if (index < value) {
                            star.classList.add('active');
                        } else {
                            star.classList.remove('active');
                        }
                    });
                }

                const note = this.closest('.quality-item').querySelector('.rating-note');
                const starText = '‚òÖ'.repeat(value) + '‚òÜ'.repeat(5 - value);
                note.textContent = `Selected: ${value}/5 ${starText}`;

                calculateScore();
            });
        });
    });

    // Calculate QC Score
    function calculateScore() {
        const ratings = [];
        document.querySelectorAll('.rating-buttons').forEach(group => {
            const activeBtn = group.querySelector('.rating-btn.active');
            if (activeBtn) {
                ratings.push(parseInt(activeBtn.dataset.value));
            }
        });

        if (ratings.length === 5) {
            const average = ratings.reduce((a, b) => a + b, 0) / ratings.length;
            const percentage = (average / 5) * 100;

            document.getElementById('totalScore').textContent = percentage.toFixed(0) + '%';
            document.getElementById('scoreBar').style.width = percentage + '%';
        } else {
            document.getElementById('totalScore').textContent = '--% ';
            document.getElementById('scoreBar').style.width = '0%';
        }
    }

    // Decision option selection
    document.querySelectorAll('.decision-option').forEach(option => {
        option.addEventListener('click', function () {
            document.querySelectorAll('.decision-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            this.classList.add('selected');
            this.querySelector('input[type="radio"]').checked = true;
        });
    });

    // Photo upload handling
    document.getElementById('photoInput').addEventListener('change', function (e) {
        const files = e.target.files;
        const photoSlots = document.querySelectorAll('.photo-slot');

        Array.from(files).forEach((file, index) => {
            if (index < photoSlots.length) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    photoSlots[index].innerHTML = `
                        <img src="${e.target.result}" alt="Photo ${index + 1}">
                        <button class="remove-btn" onclick="removePhoto(${index})">√ó</button>
                    `;
                };
                reader.readAsDataURL(file);
            }
        });
    });

    function removePhoto(index) {
        const photoSlots = document.querySelectorAll('.photo-slot');
        photoSlots[index].innerHTML = `<span class="placeholder">Photo ${index + 1}</span>`;
    }

    function saveDraft() {
        alert('QC inspection draft saved successfully!');
    }

    function submitQC() {
        const formData = {
            inspection_id: {{ inspection.id }},
            print_quality: parseInt(document.querySelector('[data-rating-group="print-quality"] .rating-btn.active')?.dataset.value || 0),
            color_accuracy: parseInt(document.querySelector('[data-rating-group="color-accuracy"] .rating-btn.active')?.dataset.value || 0),
            material_quality: parseInt(document.querySelector('[data-rating-group="material-quality"] .rating-btn.active')?.dataset.value || 0),
            finishing_quality: parseInt(document.querySelector('[data-rating-group="finishing-quality"] .rating-btn.active')?.dataset.value || 0),
            overall_quality: parseInt(document.querySelector('[data-rating-group="overall-quality"] .rating-btn.active')?.dataset.value || 0),
            delivery_notes: document.getElementById('deliveryNotes').value,
            notes_to_am: document.getElementById('notesToAM').value,
            decision: document.querySelector('input[name="qc-decision"]:checked')?.value
        };

        // Validation
        if (!formData.decision) {
            alert('Please select a QC decision');
            return;
        }

        if (formData.print_quality === 0 || formData.color_accuracy === 0 || 
            formData.material_quality === 0 || formData.finishing_quality === 0 || 
            formData.overall_quality === 0) {
            alert('Please complete all quality ratings');
            return;
        }

        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';

        fetch('{% url "submit_qc" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('QC inspection submitted successfully!');
                window.location.href = '{% url "production2_dashboard" %}';
            } else {
                alert('Error: ' + data.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit QC & Handoff to AM ‚Üí';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while submitting the QC inspection');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit QC & Handoff to AM ‚Üí';
        });
    }
</script>
{% endblock %}