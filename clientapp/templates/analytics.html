{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .analytics-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: #fff;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #f3f4f6;
    }

    .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .stat-title {
        font-size: 0.85rem;
        color: #6b7280;
        font-weight: 500;
    }

    .stat-icon {
        color: #9ca3af;
        font-size: 1.1rem;
    }

    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 0.25rem;
    }

    .stat-change {
        font-size: 0.8rem;
        color: #10b981;
    }

    .stat-change.negative {
        color: #ef4444;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .chart-card {
        background: #fff;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #f3f4f6;
    }

    .chart-card.full-width {
        grid-column: 1 / -1;
    }

    .chart-header {
        margin-bottom: 1.5rem;
    }

    .chart-title {
        font-size: 1rem;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 0.25rem;
    }

    .chart-subtitle {
        font-size: 0.85rem;
        color: #9ca3af;
    }

    .chart-container {
        position: relative;
        height: 100%;
        width: 100%;
    }

    /* Insights Section */
    .insights-grid {
        display: grid;
        gap: 1rem;
    }

    .insight-card {
        padding: 1.25rem;
        border-radius: 8px;
        border-left: 4px solid;
        display: flex;
        align-items: flex-start;
        gap: 1rem;
    }

    .insight-card.success {
        background: #d1fae5;
        border-color: #10b981;
    }

    .insight-card.info {
        background: #dbeafe;
        border-color: #3b82f6;
    }

    .insight-card.warning {
        background: #fef3c7;
        border-color: #f59e0b;
    }

    .insight-icon {
        font-size: 1.25rem;
        margin-top: 0.15rem;
    }

    .insight-card.success .insight-icon {
        color: #059669;
    }

    .insight-card.info .insight-icon {
        color: #2563eb;
    }

    .insight-card.warning .insight-icon {
        color: #d97706;
    }

    .insight-content {
        flex: 1;
    }

    .insight-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 0.25rem;
    }

    .insight-description {
        font-size: 0.85rem;
        color: #374151;
        line-height: 1.5;
    }

    @media (max-width: 1200px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 968px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="analytics-container">
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">Total Quotes</span>
                <i class="fas fa-file-invoice stat-icon"></i>
            </div>
            <div class="stat-value">{{ total_quotes }}</div>
            <div class="stat-change">Live Data</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">Conversion Rate</span>
                <i class="fas fa-percent stat-icon"></i>
            </div>
            <div class="stat-value">{{ conversion_rate }}%</div>
            <div class="stat-change">Approved / Total</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">Avg Deal Size</span>
                <i class="fas fa-coins stat-icon"></i>
            </div>
            <div class="stat-value">KES {{ avg_deal_size|floatformat:0|intcomma }}</div>
            <div class="stat-change">Per Approved Quote</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">Avg Turnaround</span>
                <i class="fas fa-clock stat-icon"></i>
            </div>
            <div class="stat-value">{{ avg_turnaround }}h</div>
            <div class="stat-change">Creation to Approval</div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Revenue Trend</div>
                <div class="chart-subtitle">Monthly approved quote value</div>
            </div>
            <div class="chart-container" style="height: 240px;">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Client Distribution</div>
                <div class="chart-subtitle">B2B vs B2C Clients</div>
            </div>
            <div class="chart-container" style="height: 240px; display: flex; justify-content: center;">
                <canvas id="clientChart"></canvas>
            </div>
        </div>

        <div class="chart-card full-width">
            <div class="chart-header">
                <div class="chart-title">Top Products by Revenue</div>
                <div class="chart-subtitle">Best performing products</div>
            </div>
            <div class="chart-container" style="height: 300px;">
                <canvas id="productsChart"></canvas>
            </div>
        </div>

        <div class="chart-card full-width">
            <div class="chart-header">
                <div class="chart-title">Key Insights</div>
                <div class="chart-subtitle">Data-driven recommendations for workflow optimization</div>
            </div>
            <div class="insights-grid">
                <div class="insight-card success">
                    <i class="fas fa-arrow-trend-up insight-icon"></i>
                    <div class="insight-content">
                        <div class="insight-title">Instant Quote Adoption Increasing</div>
                        <div class="insight-description">65% of quotes now use catalog pricing, reducing PT workload by
                            40% compared to Q3</div>
                    </div>
                </div>
                <div class="insight-card info">
                    <i class="fas fa-lightbulb insight-icon"></i>
                    <div class="insight-content">
                        <div class="insight-title">Faster Turnaround Times</div>
                        <div class="insight-description">Quote to approval time reduced to 2.3 hours, meeting the speed
                            prioritize goal</div>
                    </div>
                </div>
                <div class="insight-card warning">
                    <i class="fas fa-chart-line insight-icon"></i>
                    <div class="insight-content">
                        <div class="insight-title">Opportunity: Expand Catalog</div>
                        <div class="insight-description">23 fully custom jobs this month could be added to catalog to
                            enable instant quoting</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Revenue Chart
    const ctxRevenue = document.getElementById('revenueChart').getContext('2d');
    new Chart(ctxRevenue, {
        type: 'bar',
        data: {
            labels: {{ revenue_labels| safe }},
        datasets: [{
            label: 'Revenue (KES)',
            data: {{ revenue_data| safe }},
        backgroundColor: '#3b82f6',
        borderRadius: 4,
        barThickness: 20
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: { display: false }
            },
            x: {
                grid: { display: false }
            }
        }
    }
    });

    // Client Chart
    const ctxClient = document.getElementById('clientChart').getContext('2d');
    new Chart(ctxClient, {
        type: 'doughnut',
        data: {
            labels: ['B2B', 'B2C'],
            datasets: [{
                data: [{{ b2b_clients }}, {{ b2c_clients }}],
        backgroundColor: ['#8b5cf6', '#10b981'],
        borderWidth: 0
    }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: {
            legend: { position: 'right' }
        }
    }
    });

    // Products Chart
    const ctxProducts = document.getElementById('productsChart').getContext('2d');
    new Chart(ctxProducts, {
        type: 'bar',
        data: {
            labels: {{ top_product_labels| safe }},
        datasets: [{
            label: 'Revenue (KES)',
            data: {{ top_product_data| safe }},
        backgroundColor: '#f59e0b',
        borderRadius: 4,
        barThickness: 30
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
            legend: { display: false }
        },
        scales: {
            x: {
                beginAtZero: true,
                grid: { display: false }
            },
            y: {
                grid: { display: false }
            }
        }
    }
    });
</script>
{% endblock %}