{% extends 'base.html' %}
{% load static %}

{% block title %}{% if product %}Edit Product{% else %}Add Product{% endif %} - Production Management{% endblock %}

{% block content %}
<div class="p-8 max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <a href="{% url 'production_catalog' %}"
            class="inline-flex items-center gap-2 text-gray-600 hover:text-gray-900 mb-4 transition-colors">
            <i data-lucide="arrow-left" class="w-4 h-4"></i>
            ← Back to Products
        </a>

        <div class="flex items-start justify-between">
            <div>
                <div class="flex items-center gap-3 mb-2">
                    <h1 class="text-2xl font-semibold text-gray-900">
                        {% if product %}Edit Product: {{ product.name }}{% else %}Create New Product{% endif %}
                    </h1>
                    {% if product %}
                    <span class="px-3 py-1 text-xs font-medium bg-blue-100 text-blue-700 rounded-full">
                        {{ product.status|title }}
                    </span>
                    {% else %}
                    <span class="px-3 py-1 text-xs font-medium bg-gray-100 text-gray-600 rounded-full">
                        New Draft
                    </span>
                    {% endif %}
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button type="button"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 flex items-center gap-2 transition-all">
                    <i data-lucide="eye" class="w-4 h-4"></i>
                    Preview
                </button>
                <button type="submit" form="productForm" name="action" value="save_draft"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 flex items-center gap-2 transition-all">
                    <i data-lucide="save" class="w-4 h-4"></i>
                    Save Draft
                </button>
                <button type="submit" form="productForm" name="action" value="publish"
                    class="px-6 py-2 bg-black text-white rounded-lg text-sm font-medium hover:bg-gray-800 flex items-center gap-2 transition-all shadow-sm">
                    <i data-lucide="check" class="w-4 h-4"></i>
                    Publish Product
                </button>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="mb-8">
        <div class="border-b border-gray-200">
            <nav class="flex gap-8">
                <button
                    class="tab-button active pb-4 border-b-2 border-black text-black font-semibold text-sm transition-all"
                    data-tab="general">
                    General Info
                </button>
                <button
                    class="tab-button pb-4 border-b-2 border-transparent text-gray-500 hover:text-gray-900 font-medium text-sm transition-all"
                    data-tab="pricing">
                    Pricing & Variables
                </button>
                <button
                    class="tab-button pb-4 border-b-2 border-transparent text-gray-500 hover:text-gray-900 font-medium text-sm transition-all"
                    data-tab="images">
                    Images & Media
                </button>
                <button
                    class="tab-button pb-4 border-b-2 border-transparent text-gray-500 hover:text-gray-900 font-medium text-sm transition-all"
                    data-tab="ecommerce">
                    E-commerce & SEO
                </button>
                <button
                    class="tab-button pb-4 border-b-2 border-transparent text-gray-500 hover:text-gray-900 font-medium text-sm transition-all"
                    data-tab="analytics">
                    Analytics
                </button>
                <button
                    class="tab-button pb-4 border-b-2 border-transparent text-gray-500 hover:text-gray-900 font-medium text-sm transition-all"
                    data-tab="history">
                    History
                </button>
            </nav>
        </div>
    </div>

    <!-- Unsaved Changes Indicator -->
    <div id="unsavedIndicator" class="hidden fixed bottom-6 right-6 flex items-center gap-3 bg-yellow-50 border border-yellow-200 rounded-lg p-4 shadow-lg z-50 animate-pulse">
        <div class="flex items-center gap-2 text-yellow-700 text-sm font-medium">
            <div class="w-2 h-2 bg-yellow-500 rounded-full"></div>
            <span id="unsavedText">You have unsaved changes</span>
        </div>
        <div class="flex gap-2">
            <button type="button" id="autoSaveBtn" class="px-3 py-1 bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-medium rounded transition-colors">
                Save Now
            </button>
        </div>
    </div>

    <!-- Auto-save Status -->
    <div id="autoSaveStatus" class="fixed top-4 right-4 flex items-center gap-2 text-xs font-medium px-3 py-2 rounded-lg z-40 transition-all duration-300 opacity-0 pointer-events-none">
        <div class="w-2 h-2 rounded-full bg-green-500"></div>
        <span>Auto-saved at <span id="lastSaveTime">--:--</span></span>
    </div>

    <!-- Main Form -->
    <form id="productForm" method="post" enctype="multipart/form-data" data-product-id="{{ product.id|default:'new' }}">
        {% csrf_token %}
        <input type="hidden" name="next_tab" id="next_tab_input" value="">
        
        <!-- Hidden fields with default values for required fields -->
        <input type="hidden" name="product_type" value="{{ product.product_type|default:'physical' }}">
        <input type="hidden" name="unit_of_measure" value="{{ product.unit_of_measure|default:'pieces' }}">
        <input type="hidden" name="weight_unit" value="{{ product.weight_unit|default:'kg' }}">
        <input type="hidden" name="dimension_unit" value="{{ product.dimension_unit|default:'cm' }}">
        <input type="hidden" name="warranty" value="{{ product.warranty|default:'satisfaction-guarantee' }}">
        <input type="hidden" name="country_of_origin" value="{{ product.country_of_origin|default:'kenya' }}">

        <!-- Tab Content Container -->
        <div id="tabContent">

            <!-- 1. GENERAL INFO TAB -->
            <div class="tab-content" data-content="general">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Left Column: Basic Info -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-gray-100 bg-gray-50/50">
                                <h3 class="text-base font-bold text-gray-900">Basic Information</h3>
                            </div>
                            <div class="p-6 space-y-5">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                                        Product Name <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" name="name" required value="{{ product.name|default:'' }}"
    placeholder="Enter product name"
    class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
{% if general_form and general_form.errors.name %}
    <div class="text-xs text-red-600 mt-1">{{ general_form.errors.name|join:', ' }}</div>
{% endif %}
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                                            Internal Code <span class="text-red-500">*</span>
                                        </label>
                                        <input type="text" name="internal_code"
    value="{{ product.internal_code|default:'' }}" placeholder="PRD-BC-001"
    class="w-full px-4 py-2.5 border border-gray-300 rounded-lg bg-gray-50 focus:outline-none">
{% if general_form and general_form.errors.internal_code %}
    <div class="text-xs text-red-600 mt-1">{{ general_form.errors.internal_code|join:", " }}</div>
{% endif %}
                                    </div>
                                    <div class="flex items-end pb-2.5">
                                        <label class="flex items-center gap-2 cursor-pointer group">
                                            <input type="checkbox" name="auto_generate_code" checked
                                                class="w-4 h-4 rounded text-blue-600 border-gray-300 focus:ring-blue-500">
                                            <span
                                                class="text-sm text-gray-600 group-hover:text-gray-900 transition-colors">Auto-generate
                                                from name</span>
                                        </label>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                                        Short Description <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" name="short_description" maxlength="150"
    value="{{ product.short_description|default:'' }}"
    placeholder="Brief summary for catalog (max 150 chars)"
    class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
{% if general_form and general_form.errors.short_description %}
    <div class="text-xs text-red-600 mt-1">{{ general_form.errors.short_description|join:", " }}</div>
{% endif %}
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                                        Long Description <span class="text-red-500">*</span>
                                    </label>
                                    <textarea name="long_description" rows="6"
    placeholder="Detailed product description, features, and benefits..."
    class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all resize-none">{{ product.long_description|default:'' }}</textarea>
{% if general_form and general_form.errors.long_description %}
    <div class="text-xs text-red-600 mt-1">{{ general_form.errors.long_description|join:", " }}</div>
{% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-gray-100 bg-gray-50/50">
                                <h3 class="text-base font-bold text-gray-900">Technical Specifications</h3>
                            </div>
                            <div class="p-6 space-y-4">
                                <!-- Unit of Measure -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Unit of Measure</label>
                                    <select name="unit_of_measure" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                                        <option value="pieces" {% if product.unit_of_measure == 'pieces' %}selected{% endif %}>Pieces</option>
                                        <option value="packs" {% if product.unit_of_measure == 'packs' %}selected{% endif %}>Packs</option>
                                        <option value="sets" {% if product.unit_of_measure == 'sets' %}selected{% endif %}>Sets</option>
                                        <option value="sqm" {% if product.unit_of_measure == 'sqm' %}selected{% endif %}>m²</option>
                                        <option value="other" {% if product.unit_of_measure == 'other' %}selected{% endif %}>Other</option>
                                    </select>
                                    {% if general_form and general_form.errors.unit_of_measure %}
                                    <div class="text-xs text-red-600 mt-1">{{ general_form.errors.unit_of_measure|join:", " }}</div>
                                    {% endif %}
                                </div>

                                <!-- Weight with Unit -->
                                <div class="grid grid-cols-3 gap-3">
                                    <div class="col-span-2">
                                        <label class="block text-sm font-semibold text-gray-700 mb-1.5">Weight</label>
                                        <input type="number" step="0.01" name="weight" value="{{ product.weight|default:'' }}" placeholder="0.00" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                                        {% if general_form and general_form.errors.weight %}
                                        <div class="text-xs text-red-600 mt-1">{{ general_form.errors.weight|join:", " }}</div>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-1.5">Unit</label>
                                        <select name="weight_unit" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                                            <option value="gsm" {% if product.weight_unit == 'gsm' %}selected{% endif %}>GSM (g/m²)</option>
                                            <option value="kg" {% if product.weight_unit == 'kg' %}selected{% endif %}>kg</option>
                                            <option value="g" {% if product.weight_unit == 'g' %}selected{% endif %}>g</option>
                                        </select>
                                        {% if general_form and general_form.errors.weight_unit %}
                                        <div class="text-xs text-red-600 mt-1">{{ general_form.errors.weight_unit|join:", " }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Dimensions -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Dimensions (Length × Width × Height)</label>
                                    <div class="grid grid-cols-4 gap-3">
                                        <input type="number" step="0.01" name="length" value="{{ product.length|default:'' }}" placeholder="Length" class="px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                                        <input type="number" step="0.01" name="width" value="{{ product.width|default:'' }}" placeholder="Width" class="px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                                        <input type="number" step="0.01" name="height" value="{{ product.height|default:'' }}" placeholder="Height" class="px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                                        <select name="dimension_unit" class="px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                                            <option value="cm" {% if product.dimension_unit == 'cm' %}selected{% endif %}>cm</option>
                                            <option value="mm" {% if product.dimension_unit == 'mm' %}selected{% endif %}>mm</option>
                                            <option value="in" {% if product.dimension_unit == 'in' %}selected{% endif %}>in</option>
                                        </select>
                                    </div>
                                    {% if general_form and general_form.errors.length %}
                                    <div class="text-xs text-red-600 mt-1">{{ general_form.errors.length|join:", " }}</div>
                                    {% endif %}
                                    {% if general_form and general_form.errors.dimension_unit %}
                                    <div class="text-xs text-red-600 mt-1">{{ general_form.errors.dimension_unit|join:", " }}</div>
                                    {% endif %}
                                </div>

                                <!-- Warranty -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Warranty</label>
                                    <select name="warranty" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                                        <option value="satisfaction-guarantee" {% if product.warranty == 'satisfaction-guarantee' %}selected{% endif %}>Satisfaction Guarantee - Reprint if defective</option>
                                        <option value="no-warranty" {% if product.warranty == 'no-warranty' %}selected{% endif %}>No Warranty</option>
                                        <option value="30-days" {% if product.warranty == '30-days' %}selected{% endif %}>30 Days</option>
                                        <option value="90-days" {% if product.warranty == '90-days' %}selected{% endif %}>90 Days</option>
                                    </select>
                                    {% if general_form and general_form.errors.warranty %}
                                    <div class="text-xs text-red-600 mt-1">{{ general_form.errors.warranty|join:", " }}</div>
                                    {% endif %}
                                </div>

                                <!-- Country of Origin -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Country of Origin</label>
                                    <select name="country_of_origin" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                                        <option value="kenya" {% if product.country_of_origin == 'kenya' %}selected{% endif %}>Kenya</option>
                                        <option value="china" {% if product.country_of_origin == 'china' %}selected{% endif %}>China</option>
                                        <option value="india" {% if product.country_of_origin == 'india' %}selected{% endif %}>India</option>
                                        <option value="uae" {% if product.country_of_origin == 'uae' %}selected{% endif %}>UAE</option>
                                    </select>
                                    {% if general_form and general_form.errors.country_of_origin %}
                                    <div class="text-xs text-red-600 mt-1">{{ general_form.errors.country_of_origin|join:", " }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Classification & Status -->
                    <div class="space-y-6">
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-gray-100 bg-gray-50/50">
                                <h3 class="text-base font-bold text-gray-900">Classification</h3>
                            </div>
                            <div class="p-6 space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Primary
                                        Category</label>
                                    <select name="primary_category"
    class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none">
{% if general_form and general_form.errors.primary_category %}
    <div class="text-xs text-red-600 mt-1">{{ general_form.errors.primary_category|join:", " }}</div>
{% endif %}
                                        <option value="print-products" {% if product.primary_category == 'print-products' %}selected{% endif %}>Print Products</option>
                                        <option value="signage" {% if product.primary_category == 'signage' %}selected{% endif %}>Signage</option>
                                        <option value="apparel" {% if product.primary_category == 'apparel' %}selected{% endif %}>Apparel</option>
                                        <option value="promotional" {% if product.primary_category == 'promotional' %}selected{% endif %}>Promotional Items</option>
                                    </select>
{% if general_form and general_form.errors.country_of_origin %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.country_of_origin|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.warranty %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.warranty|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.dimension_unit %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.dimension_unit|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.weight_unit %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.weight_unit|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.unit_of_measure %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.unit_of_measure|join:", " }}</div>
{% endif %}
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Sub-Category</label>
                                    <select name="sub_category"
                                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none">
                                        <option value="business-cards" {% if product.sub_category == 'business-cards' %}selected{% endif %}>Business Cards</option>
                                        <option value="flyers" {% if product.sub_category == 'flyers' %}selected{% endif %}>Flyers & Brochures</option>
                                        <option value="posters" {% if product.sub_category == 'posters' %}selected{% endif %}>Posters</option>
                                        <option value="banners" {% if product.sub_category == 'banners' %}selected{% endif %}>Banners</option>
                                    </select>
{% if general_form and general_form.errors.country_of_origin %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.country_of_origin|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.warranty %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.warranty|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.dimension_unit %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.dimension_unit|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.weight_unit %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.weight_unit|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.unit_of_measure %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.unit_of_measure|join:", " }}</div>
{% endif %}
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Product
                                        Family</label>
                                    <input type="text" name="product_family"
                                        value="{{ product.product_family|default:'' }}"
                                        placeholder="e.g., Corporate Stationery"
                                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none">
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-gray-100 bg-gray-50/50">
                                <h3 class="text-base font-bold text-gray-900">Visibility & Badges</h3>
                            </div>
                            <div class="p-6 space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Visibility</label>
                                    <select name="visibility"
                                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none">
                                        <option value="catalog-search" {% if product.visibility == 'catalog-search' %}selected{% endif %}>Visible Everywhere</option>
                                        <option value="catalog-only" {% if product.visibility == 'catalog-only' %}selected{% endif %}>Catalog Only</option>
                                        <option value="hidden" {% if product.visibility == 'hidden' %}selected{% endif %}>Hidden</option>
                                    </select>
{% if general_form and general_form.errors.country_of_origin %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.country_of_origin|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.warranty %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.warranty|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.dimension_unit %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.dimension_unit|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.weight_unit %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.weight_unit|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.unit_of_measure %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.unit_of_measure|join:", " }}</div>
{% endif %}
                                </div>
                                <div class="space-y-3 pt-2">
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" name="feature_product" {% if product.feature_product %}checked{% endif %} class="w-4 h-4 rounded text-blue-600 border-gray-300">
                                        <span class="text-sm text-gray-700 font-medium">Featured Product</span>
                                    </label>
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" name="bestseller_badge" {% if product.bestseller_badge %}checked{% endif %} class="w-4 h-4 rounded text-blue-600 border-gray-300">
                                        <span class="text-sm text-gray-700 font-medium">Bestseller Badge</span>
                                    </label>
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" name="new_arrival" {% if product.new_arrival %}checked{% endif %} class="w-4 h-4 rounded text-blue-600 border-gray-300">
                                        <span class="text-sm text-gray-700 font-medium">New Arrival Badge</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. PRICING & VARIABLES TAB -->
            <div class="tab-content hidden" data-content="pricing">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Left Column: Pricing Config -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-gray-100 bg-gray-50/50">
                                <h3 class="text-base font-bold text-gray-900">Pricing Strategy</h3>
                            </div>
                            <div class="p-6 space-y-6">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-3">Customization
                                        Level</label>
                                    <div class="grid grid-cols-3 gap-4">
                                        <label
                                            class="relative flex flex-col p-4 border rounded-xl cursor-pointer hover:bg-gray-50 transition-all group">
                                            <input type="radio" name="customization_level" value="non_customizable" {% if product.customization_level == 'non_customizable' %}checked{% endif %} class="sr-only peer">
                                            <div
                                                class="w-full h-full border-2 border-transparent peer-checked:border-black rounded-xl absolute inset-0 pointer-events-none">
                                            </div>
                                            <span class="text-sm font-bold text-gray-900 mb-1">Non-Customizable</span>
                                            <span class="text-xs text-gray-500">Fixed product, single price
                                                point.</span>
                                        </label>
                                        <label
                                            class="relative flex flex-col p-4 border rounded-xl cursor-pointer hover:bg-gray-50 transition-all group">
                                            <input type="radio" name="customization_level" value="semi_customizable" {% if product.customization_level == 'semi_customizable' %}checked{% endif %} class="sr-only peer">
                                            <div
                                                class="w-full h-full border-2 border-transparent peer-checked:border-black rounded-xl absolute inset-0 pointer-events-none">
                                            </div>
                                            <span class="text-sm font-bold text-gray-900 mb-1">Semi-Customizable</span>
                                            <span class="text-xs text-gray-500">Base product with optional
                                                add-ons.</span>
                                        </label>
                                        <label
                                            class="relative flex flex-col p-4 border rounded-xl cursor-pointer hover:bg-gray-50 transition-all group">
                                            <input type="radio" name="customization_level" value="fully_customizable" {% if product.customization_level == 'fully_customizable' or not product %}checked{% endif %} class="sr-only peer">
                                            <div
                                                class="w-full h-full border-2 border-transparent peer-checked:border-black rounded-xl absolute inset-0 pointer-events-none">
                                            </div>
                                            <span class="text-sm font-bold text-gray-900 mb-1">Fully Customizable</span>
                                            <span class="text-xs text-gray-500">Complex pricing based on
                                                formulas.</span>
                                        </label>
                                    </div>
                                </div>

                                <div id="base-cost-section" class="pt-4 border-t border-gray-100">
                                    <div class="grid grid-cols-2 gap-6">
                                        <div>
                                            <label class="block text-sm font-semibold text-gray-700 mb-1.5">Base Cost
                                                (EVP) <span class="text-red-500">*</span></label>
                                            <div class="relative">
                                                <span
                                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-medium">KES</span>
                                                <input type="number" name="base_cost" id="id_base_cost" step="0.01"
                                                    value="{{ product.pricing.base_cost|default:'15.00' }}"
                                                    class="w-full pl-14 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none">
                                            </div>
                                            <p class="text-xs text-gray-500 mt-1.5">Lowest possible vendor cost per
                                                piece.</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-gray-700 mb-1.5">Default
                                                Margin (%)</label>
                                            <div class="relative">
                                                <input type="number" name="return_margin" id="id_return_margin"
                                                    step="0.1"
                                                    value="{{ product.pricing.return_margin|default:'30.0' }}"
                                                    class="w-full pr-10 pl-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none">
                                                <span
                                                    class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 font-medium">%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Base Price Section (for Non-Customizable and Semi-Customizable) -->
                                <div id="base-price-section" class="pt-4 border-t border-gray-100">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-1.5">Base Price (Selling Price)
                                            <span id="base-price-required" class="text-red-500">*</span>
                                            <span id="base-price-optional" class="text-gray-400 text-xs font-normal">(Optional for Fully Customizable)</span>
                                        </label>
                                        <div class="relative">
                                            <span
                                                class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-medium">KES</span>
                                            <input type="number" name="base_price" id="id_base_price" step="0.01"
                                                value="{{ product.base_price|default:'' }}"
                                                class="w-full pl-14 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none">
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1.5">
                                            <span id="base-price-help-non">Selling price for non-customizable products. Required.</span>
                                            <span id="base-price-help-semi" class="hidden">Base selling price. Additional costs from variables will be added. Required.</span>
                                            <span id="base-price-help-full" class="hidden">Not used for fully customizable products. Leave empty.</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tier Process Selection -->
                        <div id="tier-process-section"
                            class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-gray-100 bg-gray-50/50 flex items-center justify-between">
                                <h3 class="text-base font-bold text-gray-900">Volume Pricing (Tiers)</h3>
                                <span
                                    class="px-2 py-1 bg-green-100 text-green-700 text-[10px] font-bold uppercase rounded">Optional</span>
                            </div>
                            <div class="p-6 space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Select Tier
                                        Process</label>
                                    <select name="tier_process" id="id_tier_process"
                                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none">
                                        <option value="">-- No Tier Pricing --</option>
                                        {% for process in processes %}
                                        {% if process.pricing_type == 'tier' %}
                                        <option value="{{ process.id }}" {% if product.pricing.tier_process_id == process.id %}selected{% endif %}>{{ process.process_name }}</option>
                                        {% endif %}
                                        {% endfor %}
                                    </select>
{% if general_form and general_form.errors.country_of_origin %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.country_of_origin|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.warranty %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.warranty|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.dimension_unit %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.dimension_unit|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.weight_unit %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.weight_unit|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.unit_of_measure %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.unit_of_measure|join:", " }}</div>
{% endif %}
                                </div>
                                <div id="tier-preview-container"
                                    class="hidden mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                    <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Tier
                                        Preview</h4>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead>
                                                <tr>
                                                    <th
                                                        class="px-3 py-2 text-left text-[10px] font-bold text-gray-400 uppercase">
                                                        Quantity</th>
                                                    <th
                                                        class="px-3 py-2 text-right text-[10px] font-bold text-gray-400 uppercase">
                                                        Cost</th>
                                                    <th
                                                        class="px-3 py-2 text-right text-[10px] font-bold text-gray-400 uppercase">
                                                        Price</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tier-preview-body" class="divide-y divide-gray-100"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Formula Process Selection -->
                        <div id="formula-process-section"
                            class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-gray-100 bg-gray-50/50 flex items-center justify-between">
                                <h3 class="text-base font-bold text-gray-900">Customization Pricing (Formula)</h3>
                                <span
                                    class="px-2 py-1 bg-blue-100 text-blue-700 text-[10px] font-bold uppercase rounded">Required
                                    for Fully</span>
                            </div>
                            <div class="p-6 space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Select Formula
                                        Process</label>
                                    <select name="formula_process" id="id_formula_process"
                                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none">
                                        <option value="">-- No Formula Pricing --</option>
                                        {% for process in processes %}
                                        {% if process.pricing_type == 'formula' %}
<option value="{{ process.id }}" {% if product.pricing.formula_process_id == process.id %}selected{% endif %}>{{ process.process_name }}</option>
                                        {% endif %}
                                        {% endfor %}
                                    </select>
{% if general_form and general_form.errors.country_of_origin %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.country_of_origin|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.warranty %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.warranty|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.dimension_unit %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.dimension_unit|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.weight_unit %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.weight_unit|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.unit_of_measure %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.unit_of_measure|join:", " }}</div>
{% endif %}
                                </div>
                                <div id="formula-variables-preview"
                                    class="hidden mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                    <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Process
                                        Variables</h4>
                                    <ul id="variables-list" class="space-y-2"></ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Testing & Vendor -->
                    <div class="space-y-6">
                        <div class="bg-gray-900 rounded-xl p-6 text-white shadow-lg">
                            <h3 class="text-base font-bold mb-4 flex items-center gap-2">
                                <i data-lucide="calculator" class="w-5 h-5 text-blue-400"></i>
                                Test Your Pricing
                            </h3>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1.5">Test
                                        Quantity</label>
                                    <input type="number" id="test-quantity" value="1" min="1"
                                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-blue-500/50 outline-none">
                                </div>

                                <div id="test-variables-grid" class="space-y-3">
                                    <!-- Dynamic variables inputs -->
                                </div>

                                <div class="pt-6 border-t border-gray-800 space-y-3">
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="text-gray-400">Total Estimated Cost</span>
                                        <span class="font-bold text-blue-400" id="calculated-cost-display">KES
                                            0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-400 text-sm">Recommended Price</span>
                                        <span class="text-2xl font-black text-white" id="calculated-price-display">KES
                                            0.00</span>
                                    </div>
                                    <div id="price-breakdown"
                                        class="text-[10px] text-gray-500 font-mono space-y-1 pt-2">
                                        <!-- Breakdown lines -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-gray-100 bg-gray-50/50">
                                <h3 class="text-base font-bold text-gray-900">Production & Vendor</h3>
                            </div>
                            <div class="p-6 space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Primary
                                        Vendor</label>
                                    <select name="primary_vendor"
                                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none">
                                        <option value="">-- Select Vendor --</option>
                                        {% for vendor in vendors %}
                                        <option value="{{ vendor.id }}" {% if product.pricing.primary_vendor_id == vendor.id %}selected{% endif %}>{{ vendor.name }}</option>
                                        {% endfor %}
                                    </select>
{% if general_form and general_form.errors.country_of_origin %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.country_of_origin|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.warranty %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.warranty|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.dimension_unit %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.dimension_unit|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.weight_unit %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.weight_unit|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.unit_of_measure %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.unit_of_measure|join:", " }}</div>
{% endif %}
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-1.5">Lead
                                            Time</label>
                                        <input type="number" name="lead_time_value"
                                            value="{{ product.pricing.lead_time_value|default:'3' }}"
                                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-1.5">Unit</label>
                                        <select name="lead_time_unit"
                                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg outline-none">
                                            <option value="days" {% if product.pricing.lead_time_unit == 'days' %}selected{% endif %}>Days</option>
                                            <option value="weeks" {% if product.pricing.lead_time_unit == 'weeks' %}selected{% endif %}>Weeks</option>
                                        </select>
{% if general_form and general_form.errors.country_of_origin %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.country_of_origin|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.warranty %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.warranty|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.dimension_unit %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.dimension_unit|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.weight_unit %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.weight_unit|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.unit_of_measure %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.unit_of_measure|join:", " }}</div>
{% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. IMAGES & MEDIA TAB -->
            <div class="tab-content hidden" data-content="images">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Catalog Preview Section -->
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl border border-blue-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-blue-100 bg-blue-50/50">
                                <div class="flex items-center gap-2 mb-1">
                                    <i data-lucide="eye" class="w-5 h-5 text-blue-600"></i>
                                    <h3 class="text-base font-bold text-blue-900">Catalog Preview</h3>
                                </div>
                                <p class="text-xs text-blue-700 mt-1">This is how your images will appear in the catalog</p>
                            </div>
                            <div class="p-6">
                                <!-- Product Card Preview -->
                                <div class="bg-white rounded-lg overflow-hidden shadow-md border border-gray-200 max-w-sm">
                                    <!-- Primary Image Display -->
                                    <div class="relative aspect-square bg-gray-100 flex items-center justify-center overflow-hidden group">
                                        <div id="catalog-preview-primary" class="w-full h-full">
                                            {% if primary_image %}
                                                <img src="{{ primary_image.image.url }}" class="w-full h-full object-cover" alt="Primary product image">
                                            {% else %}
                                                <div class="flex flex-col items-center justify-center h-full">
                                                    <i data-lucide="image" class="w-12 h-12 text-gray-300 mb-2"></i>
                                                    <span class="text-sm text-gray-400">No primary image yet</span>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <!-- Badge overlay -->
                                        <div class="absolute top-3 right-3 bg-red-500 text-white px-2 py-1 rounded text-xs font-bold hidden" id="catalog-badge">
                                            Sale
                                        </div>
                                    </div>
                                    <!-- Product Info -->
                                    <div class="p-4">
                                        <h4 class="text-sm font-semibold text-gray-900 truncate">{{ product.name|default:'Product Name' }}</h4>
                                        <p class="text-xs text-gray-500 line-clamp-2 mt-1">{{ product.short_description|default:'Product description' }}</p>
                                        <div class="flex items-center justify-between mt-3">
                                            <span class="text-lg font-bold text-gray-900">KES {{ product.base_price|default:0|floatformat:2 }}</span>
                                            <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">In Stock</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Gallery Images Preview -->
                                <div class="mt-4 pt-4 border-t border-blue-100">
                                    <p class="text-xs font-semibold text-blue-900 mb-2">Gallery Preview ({{ gallery_images_count }} images)</p>
                                    <div class="flex gap-2 overflow-x-auto pb-2">
                                        {% for img in gallery_images|slice:":5" %}
                                            <img src="{{ img.image.url }}" class="w-16 h-16 rounded object-cover border border-blue-200 flex-shrink-0" alt="Gallery image">
                                        {% empty %}
                                            <div class="text-xs text-blue-600">Upload additional images to display here</div>
                                        {% endfor %}
                                        {% if gallery_images_count > 5 %}
                                            <div class="w-16 h-16 rounded bg-blue-100 border border-blue-200 flex items-center justify-center flex-shrink-0">
                                                <span class="text-xs text-blue-700 font-semibold">+{{ gallery_images_count|add:'-5' }}</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Product Gallery Section -->
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-gray-100 bg-gray-50/50 flex items-center justify-between">
                                <div>
                                    <h3 class="text-base font-bold text-gray-900">Product Gallery</h3>
                                    <p class="text-xs text-gray-500 mt-1">Upload product images (PNG, JPG, Max 2MB each, recommended 1280×1280px)</p>
                                </div>
                                <span class="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded-full font-semibold">{{ product.images.count|default:0 }}/11</span>
                            </div>
                            <div class="p-6">
                                <div class="mb-6">
                                    <label class="block text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                        <i data-lucide="star" class="w-4 h-4 text-amber-500 fill-amber-500"></i>
                                        Primary Image <span class="text-red-500">*</span>
                                        <span class="text-xs text-gray-500 font-normal">(Hero image shown first)</span>
                                    </label>
                                    <div class="relative group">
                                        <div id="primary-image-container" class="relative aspect-square max-w-xs rounded-xl border-2 border-dashed border-gray-300 flex flex-col items-center justify-center bg-gray-50 hover:bg-gray-100 transition-all cursor-pointer overflow-hidden">
                                            {% if primary_image %}
                                                <img id="primary-image-preview" src="{{ primary_image.image.url }}" class="w-full h-full object-cover rounded-xl">
                                                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center rounded-xl">
                                                    <span class="text-white text-sm font-semibold px-3 py-1 bg-black/60 rounded">Replace Image</span>
                                                </div>
                                            {% else %}
                                                <i data-lucide="image-plus" class="w-12 h-12 text-gray-400 mb-2"></i>
                                                <span class="text-sm font-semibold text-gray-500">Click to upload primary image</span>
                                                <span class="text-xs text-gray-400 mt-1">PNG, JPG (Max 2MB)</span>
                                            {% endif %}
                                        </div>
                                        <input type="file" name="primary_image" id="primary_image_input" accept="image/*" class="hidden">
                                        <input type="hidden" name="delete_primary_image" id="delete_primary_image" value="0">
                                    </div>
                                </div>

                                <div class="mt-8 pt-6 border-t border-gray-200">
                                    <label class="block text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                        <i data-lucide="images" class="w-4 h-4 text-blue-500"></i>
                                        Additional Gallery Images <span class="text-gray-400 text-xs font-normal">(Up to 10 more)</span>
                                    </label>
                                    <div class="grid grid-cols-4 gap-3" id="gallery-images-container">
                                        {% if existing_images %}
                                            {% for img in existing_images %}
                                                <div class="gallery-image-item aspect-square rounded-lg border border-gray-200 overflow-hidden relative group shadow-sm hover:shadow-md transition-shadow" data-image-id="{{ img.id }}">
                                                    <img src="{{ img.image.url }}" class="w-full h-full object-cover" alt="Gallery image">
                                                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/40 transition-colors flex items-center justify-center">
                                                        <button type="button" class="delete-gallery-image p-2 bg-red-500 text-white rounded-md hover:bg-red-600 opacity-0 group-hover:opacity-100 transition-opacity" data-image-id="{{ img.id }}" title="Delete image">
                                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                        </button>
                                                    </div>
                                                    <span class="absolute top-2 right-2 bg-gray-700 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">Delete</span>
                                                </div>
                                            {% endfor %}
                                        {% endif %}
                                        
                                        <!-- Add more images slot -->
                                        {% if not existing_images or gallery_images_count < 10 %}
                                        <div class="aspect-square rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center bg-gray-50 hover:bg-blue-50 transition-all cursor-pointer relative group">
                                            <div class="text-center">
                                                <i data-lucide="plus" class="w-8 h-8 text-gray-400 group-hover:text-blue-500 mx-auto mb-1 transition-colors"></i>
                                                <span class="text-xs text-gray-500 group-hover:text-blue-600 block font-semibold">Add Images</span>
                                                <span class="text-[10px] text-gray-400">Drag or click</span>
                                            </div>
                                            <input type="file" name="gallery_images" id="gallery_images_input" accept="image/*" multiple class="absolute inset-0 opacity-0 cursor-pointer">
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="mt-3 p-3 bg-blue-50 border border-blue-100 rounded-lg">
                                        <p class="text-xs text-blue-700">
                                            <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                                            <strong>Pro tip:</strong> Upload high-quality images (at least 800×800px). Customers will use these to zoom in and view details.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Product Videos Section -->
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-gray-100 bg-gray-50/50">
                                <div class="flex items-center gap-2 mb-1">
                                    <i data-lucide="play-circle" class="w-5 h-5 text-red-500"></i>
                                    <h3 class="text-base font-bold text-gray-900">Product Videos</h3>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">YouTube, Vimeo, or direct video links</p>
                            </div>
                            <div class="p-6 space-y-4">
                                <div id="video-list" class="space-y-3">
                                    {% for video in product.videos.all %}
                                    <div
                                        class="flex items-center gap-4 p-4 bg-gray-50 rounded-lg border border-gray-200 hover:border-gray-300 transition-colors">
                                        <div class="w-14 h-14 bg-gradient-to-br from-red-400 to-red-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                            <i data-lucide="play" class="w-6 h-6 text-white fill-white"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-semibold text-gray-900 truncate">{{ video.get_video_type_display }}</p>
                                            <p class="text-xs text-gray-500 truncate">{{ video.video_url }}</p>
                                        </div>
                                        <button type="button" class="delete-video p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded transition-colors" data-video-id="{{ video.id }}" title="Delete video">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="flex gap-2 pt-2">
                                    <input type="url" id="new-video-url" placeholder="Paste YouTube, Vimeo, or video URL..."
                                        class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg text-sm outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500/20">
                                    <button type="button" id="add-video-btn"
                                        class="px-6 py-2.5 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 transition-colors flex items-center gap-2">
                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                        Add
                                    </button>
                                </div>
                                <div class="mt-3 p-3 bg-amber-50 border border-amber-100 rounded-lg">
                                    <p class="text-xs text-amber-700">
                                        <i data-lucide="alert-circle" class="w-3 h-3 inline mr-1"></i>
                                        Videos help increase customer engagement. Include product demos, unboxing, or tutorials.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- Media Guidelines Card -->
                        <div class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-xl border border-purple-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-purple-100">
                                <div class="flex items-center gap-2 mb-1">
                                    <i data-lucide="lightbulb" class="w-5 h-5 text-purple-600"></i>
                                    <h3 class="text-base font-bold text-purple-900">Image Guidelines</h3>
                                </div>
                            </div>
                            <div class="p-6 space-y-4 text-sm">
                                <div class="bg-white/60 rounded-lg p-3 border border-purple-100">
                                    <p class="font-semibold text-purple-900 mb-2 flex items-center gap-2">
                                        <i data-lucide="image" class="w-4 h-4 text-purple-600"></i>
                                        Primary Image
                                    </p>
                                    <ul class="space-y-1 text-purple-700 text-xs ml-1">
                                        <li>• Size: 1280×1280px (square)</li>
                                        <li>• File size: Max 2MB</li>
                                        <li>• Format: JPG or PNG</li>
                                        <li>• Shows first in catalog</li>
                                        <li>• Customers will zoom on this</li>
                                    </ul>
                                </div>

                                <div class="bg-white/60 rounded-lg p-3 border border-purple-100">
                                    <p class="font-semibold text-purple-900 mb-2 flex items-center gap-2">
                                        <i data-lucide="images" class="w-4 h-4 text-blue-600"></i>
                                        Gallery Images
                                    </p>
                                    <ul class="space-y-1 text-purple-700 text-xs ml-1">
                                        <li>• Up to 10 additional images</li>
                                        <li>• Min 800×800px recommended</li>
                                        <li>• File size: Max 2MB each</li>
                                        <li>• Show different angles/details</li>
                                        <li>• Mock-ups or in-use photos</li>
                                    </ul>
                                </div>

                                <div class="bg-white/60 rounded-lg p-3 border border-purple-100">
                                    <p class="font-semibold text-purple-900 mb-2 flex items-center gap-2">
                                        <i data-lucide="play" class="w-4 h-4 text-red-600"></i>
                                        Video Tips
                                    </p>
                                    <ul class="space-y-1 text-purple-700 text-xs ml-1">
                                        <li>• Link YouTube or Vimeo videos</li>
                                        <li>• Product demos boost sales</li>
                                        <li>• Keep videos under 5 minutes</li>
                                        <li>• Use auto-play with mute</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Image Stats Card -->
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-gray-100 bg-gray-50/50">
                                <h3 class="text-base font-bold text-gray-900">Media Statistics</h3>
                            </div>
                            <div class="p-6 space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Primary Image</span>
                                    <span class="text-lg font-bold text-gray-900">
                                        {% if has_primary_image %}
                                            <span class="text-green-600">✓</span>
                                        {% else %}
                                            <span class="text-gray-300">—</span>
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Gallery Images</span>
                                    <span class="px-3 py-1 bg-blue-50 text-blue-700 text-sm font-semibold rounded">
                                        {{ gallery_images_count|default:0 }}/10
                                    </span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Videos</span>
                                    <span class="px-3 py-1 bg-red-50 text-red-700 text-sm font-semibold rounded">
                                        {{ product.videos.count|default:0 }}
                                    </span>
                                </div>
                                <div class="pt-3 border-t border-gray-200">
                                    <div class="flex items-center justify-between text-sm font-semibold">
                                        <span class="text-gray-700">Catalog Ready</span>
                                        {% if has_primary_image %}
                                            <span class="text-green-600">Yes ✓</span>
                                        {% else %}
                                            <span class="text-red-600">Add Primary Image</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quality Check Card -->
                        <div class="bg-green-50 rounded-xl border border-green-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-green-100">
                                <div class="flex items-center gap-2 mb-1">
                                    <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                                    <h3 class="text-base font-bold text-green-900">Quality Checklist</h3>
                                </div>
                            </div>
                            <div class="p-6 space-y-2">
                                <label class="flex items-center gap-3 cursor-pointer hover:bg-green-100/30 p-2 rounded transition-colors">
                                    <input type="checkbox" class="w-4 h-4 rounded border-green-300" id="check-primary">
                                    <span class="text-sm text-green-900">Primary image is high quality</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer hover:bg-green-100/30 p-2 rounded transition-colors">
                                    <input type="checkbox" class="w-4 h-4 rounded border-green-300" id="check-gallery">
                                    <span class="text-sm text-green-900">Gallery shows different angles</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer hover:bg-green-100/30 p-2 rounded transition-colors">
                                    <input type="checkbox" class="w-4 h-4 rounded border-green-300" id="check-colors">
                                    <span class="text-sm text-green-900">Colors accurately represent product</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer hover:bg-green-100/30 p-2 rounded transition-colors">
                                    <input type="checkbox" class="w-4 h-4 rounded border-green-300" id="check-focused">
                                    <span class="text-sm text-green-900">Product is in focus (not blurry)</span>
                                </label>
                            </div>
                        </div>

                        <!-- Downloadable Files Card -->
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-gray-100 bg-gray-50/50">
                                <div class="flex items-center gap-2 mb-1">
                                    <i data-lucide="download" class="w-5 h-5 text-orange-600"></i>
                                    <h3 class="text-base font-bold text-gray-900">Downloadable Files</h3>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Specs, templates, or design files</p>
                            </div>
                            <div class="p-6 space-y-4">
                                <div id="file-list" class="space-y-2">
                                    {% for file in product.downloadable_files.all %}
                                    <div
                                        class="flex items-center justify-between p-2 hover:bg-gray-50 rounded-lg transition-colors">
                                        <div class="flex items-center gap-2">
                                            <i data-lucide="file-text" class="w-4 h-4 text-orange-500"></i>
                                            <span class="text-sm text-gray-700 truncate">{{ file.file_name }}</span>
                                        </div>
                                        <button type="button" class="delete-file text-gray-400 hover:text-red-500 transition-colors" data-file-id="{{ file.id }}">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                                <label
                                    class="block w-full py-3 border-2 border-dashed border-gray-200 rounded-xl text-center cursor-pointer hover:bg-orange-50 hover:border-orange-300 transition-all group">
                                    <i data-lucide="upload-cloud" class="w-6 h-6 text-gray-300 group-hover:text-orange-500 mx-auto mb-1 transition-colors"></i>
                                    <span class="text-xs font-bold text-gray-400 group-hover:text-orange-600">Upload Files</span>
                                    <input type="file" name="new_downloadable_files" multiple class="hidden">
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. E-COMMERCE & SEO TAB -->
            <div class="tab-content hidden" data-content="ecommerce">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-gray-100 bg-gray-50/50">
                                <h3 class="text-base font-bold text-gray-900">Search Engine Optimization</h3>
                            </div>
                            <div class="p-6 space-y-5">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Meta Title</label>
                                    <input type="text" name="meta_title" value="{{ product.seo.meta_title|default:'' }}"
                                        maxlength="60"
                                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg outline-none focus:border-blue-500">
                                    <div class="flex justify-between mt-1">
                                        <p class="text-[10px] text-gray-400">Recommended: 50-60 characters</p>
                                        <p class="text-[10px] text-gray-400 char-count">0/60</p>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">URL Slug</label>
                                    <div class="flex">
                                        <span
                                            class="inline-flex items-center px-4 bg-gray-50 border border-r-0 border-gray-300 rounded-l-lg text-gray-400 text-sm">printduka.com/p/</span>
                                        <input type="text" name="slug" value="{{ product.seo.slug|default:'' }}"
                                            class="flex-1 px-4 py-2.5 border border-gray-300 rounded-r-lg outline-none focus:border-blue-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Meta
                                        Description</label>
                                    <textarea name="meta_description" rows="3" maxlength="160"
                                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg outline-none focus:border-blue-500 resize-none">{{ product.seo.meta_description|default:'' }}</textarea>
                                    <div class="flex justify-between mt-1">
                                        <p class="text-[10px] text-gray-400">Recommended: 150-160 characters</p>
                                        <p class="text-[10px] text-gray-400 char-count">0/160</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-gray-100 bg-gray-50/50">
                                <h3 class="text-base font-bold text-gray-900">Store Settings</h3>
                            </div>
                            <div class="p-6 space-y-4">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" name="show_price" {% if product.seo.show_price|default:True %}checked{% endif %} class="w-4 h-4 rounded text-blue-600 border-gray-300">
                                    <span class="text-sm text-gray-700 font-medium">Show Price to Customers</span>
                                </label>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Stock Status</label>
                                    <select name="show_stock_status"
                                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg outline-none">
                                        <option value="in-stock-only" {% if product.seo.show_stock_status == 'in-stock-only' %}selected{% endif %}>Show "In Stock" only</option>
                                        <option value="always" {% if product.seo.show_stock_status == 'always' %}selected{% endif %}>Always show level</option>
                                        <option value="never" {% if product.seo.show_stock_status == 'never' %}selected{% endif %}>Never show</option>
                                    </select>
{% if general_form and general_form.errors.country_of_origin %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.country_of_origin|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.warranty %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.warranty|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.dimension_unit %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.dimension_unit|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.weight_unit %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.weight_unit|join:", " }}</div>
{% endif %}
{% if general_form and general_form.errors.unit_of_measure %}
<div class="text-xs text-red-600 mt-1">{{ general_form.errors.unit_of_measure|join:", " }}</div>
{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. ANALYTICS TAB -->
                        <!-- 5. ANALYTICS TAB (Gap #7 Fix - Enhanced Analytics) -->
            <div class="tab-content hidden" data-content="analytics">
                {% if product and product.status == 'published' %}
                <!-- Metrics Cards -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-sm font-medium text-gray-500">Total Orders</span>
                            <i data-lucide="shopping-cart" class="w-5 h-5 text-blue-500"></i>
                        </div>
                        <p class="text-3xl font-bold text-gray-900">{{ product.quotes.count|default:'0' }}</p>
                        <p class="text-xs text-gray-400 mt-1">All time quotes</p>
                    </div>
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-sm font-medium text-gray-500">Stock Status</span>
                            <i data-lucide="package" class="w-5 h-5 text-orange-500"></i>
                        </div>
                        <p class="text-lg font-bold text-gray-900">{{ product.get_stock_status_display|default:'Made to Order' }}</p>
                        {% if product.track_inventory %}
                        <p class="text-xs text-gray-400 mt-1">{{ product.stock_quantity }} units in stock</p>
                        {% else %}
                        <p class="text-xs text-gray-400 mt-1">Inventory tracking disabled</p>
                        {% endif %}
                    </div>
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-sm font-medium text-gray-500">Total Edits</span>
                            <i data-lucide="edit-3" class="w-5 h-5 text-purple-500"></i>
                        </div>
                        <p class="text-3xl font-bold text-gray-900">{{ product.change_history.count|default:'0' }}</p>
                        <p class="text-xs text-gray-400 mt-1">Changes recorded</p>
                    </div>
                </div>
                <!-- Product Summary Card -->
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
                    <h3 class="text-base font-bold text-gray-900 mb-4">Product Summary</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-2xl font-bold text-gray-900">{{ product.created_at|timesince }}</p>
                            <p class="text-xs text-gray-500">Age</p>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-2xl font-bold text-gray-900">{{ product.images.count|default:'0' }}</p>
                            <p class="text-xs text-gray-500">Images</p>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-2xl font-bold text-gray-900">{{ product.variables.count|default:'0' }}</p>
                            <p class="text-xs text-gray-500">Variables</p>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-2xl font-bold text-gray-900">{{ product.faqs.count|default:'0' }}</p>
                            <p class="text-xs text-gray-500">FAQs</p>
                        </div>
                    </div>
                </div>
                <!-- Inventory Info (Gap #1) -->
                {% if product.track_inventory %}
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 mt-6">
                    <h3 class="text-base font-bold text-gray-900 mb-4">Inventory Status</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-100">
                            <p class="text-xs text-blue-600 font-medium mb-1">Current Stock</p>
                            <p class="text-2xl font-bold text-blue-900">{{ product.stock_quantity }}</p>
                        </div>
                        <div class="p-4 bg-amber-50 rounded-lg border border-amber-100">
                            <p class="text-xs text-amber-600 font-medium mb-1">Low Stock Alert</p>
                            <p class="text-2xl font-bold text-amber-900">{{ product.low_stock_threshold }}</p>
                        </div>
                        <div class="p-4 {% if product.stock_quantity <= product.low_stock_threshold %}bg-red-50 border-red-100{% else %}bg-green-50 border-green-100{% endif %} rounded-lg border">
                            <p class="text-xs {% if product.stock_quantity <= product.low_stock_threshold %}text-red-600{% else %}text-green-600{% endif %} font-medium mb-1">Status</p>
                            <p class="text-lg font-bold {% if product.stock_quantity <= product.low_stock_threshold %}text-red-900{% else %}text-green-900{% endif %}">
                                {% if product.stock_quantity <= 0 %}Out of Stock{% elif product.stock_quantity <= product.low_stock_threshold %}Low Stock{% else %}In Stock{% endif %}
                            </p>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% else %}
                <!-- Placeholder for unpublished products -->
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-12 text-center">
                    <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i data-lucide="bar-chart-3" class="w-10 h-10 text-gray-300"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">No Performance Data Yet</h3>
                    <p class="text-gray-500 max-w-sm mx-auto">Once your product is published and starts receiving views and orders, you'll see detailed analytics here.</p>
                </div>
                {% endif %}
            </div>

            <!-- 6. HISTORY TAB (Gap #4 Fix - Enhanced with field changes) -->
            <div class="tab-content hidden" data-content="history">
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-gray-100 bg-gray-50/50 flex items-center justify-between">
                        <h3 class="text-base font-bold text-gray-900">Product Change Log</h3>
                        <span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">{{ product.change_history.count|default:'0' }} changes</span>
                    </div>
                    <div class="p-6">
                        {% if product.change_history.all %}
                        <div class="flow-root">
                            <ul role="list" class="-mb-8">
                                {% for entry in product.change_history.all %}
                                <li>
                                    <div class="relative pb-8">
                                        {% if not forloop.last %}
                                        <span class="absolute left-5 top-5 -ml-px h-full w-0.5 bg-gray-100" aria-hidden="true"></span>
                                        {% endif %}
                                        <div class="relative flex items-start space-x-3">
                                            <div class="relative">
                                                <div class="h-10 w-10 rounded-full {% if entry.change_type == 'published' %}bg-green-50 border-green-200{% elif entry.change_type == 'created' %}bg-blue-50 border-blue-200{% elif entry.change_type == 'field_updated' %}bg-amber-50 border-amber-200{% else %}bg-gray-50 border-gray-200{% endif %} border flex items-center justify-center ring-8 ring-white">
                                                    <i data-lucide="{% if entry.change_type == 'created' %}plus{% elif entry.change_type == 'published' %}check{% elif entry.change_type == 'field_updated' %}edit-2{% else %}history{% endif %}"
                                                        class="w-4 h-4 {% if entry.change_type == 'published' %}text-green-500{% elif entry.change_type == 'created' %}text-blue-500{% elif entry.change_type == 'field_updated' %}text-amber-500{% else %}text-gray-500{% endif %}"></i>
                                                </div>
                                            </div>
                                            <div class="min-w-0 flex-1 py-1">
                                                <div class="text-sm text-gray-500">
                                                    <span class="font-bold text-gray-900">{{ entry.changed_by.get_full_name|default:entry.changed_by.username }}</span>
                                                    {% if entry.change_type == 'field_updated' %}
                                                        changed <span class="font-semibold text-gray-700">{{ entry.field_changed }}</span>
                                                    {% elif entry.change_type == 'published' %}
                                                        published this product
                                                    {% elif entry.change_type == 'created' %}
                                                        created this product
                                                    {% elif entry.notes %}
                                                        {{ entry.notes }}
                                                    {% else %}
                                                        {{ entry.change_type|title }}
                                                    {% endif %}
                                                </div>
                                                <!-- Show old/new values for field changes -->
                                                {% if entry.old_value or entry.new_value %}
                                                <div class="mt-2 p-3 bg-gray-50 rounded-lg text-xs font-mono border border-gray-100">
                                                    {% if entry.old_value %}
                                                    <div class="flex items-start gap-2 text-red-600 mb-1">
                                                        <span class="text-gray-400 select-none">−</span>
                                                        <span class="truncate">{{ entry.old_value|truncatechars:80 }}</span>
                                                    </div>
                                                    {% endif %}
                                                    {% if entry.new_value %}
                                                    <div class="flex items-start gap-2 text-green-600">
                                                        <span class="text-gray-400 select-none">+</span>
                                                        <span class="truncate">{{ entry.new_value|truncatechars:80 }}</span>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                {% endif %}
                                                <div class="mt-2 text-xs text-gray-400">
                                                    <i data-lucide="clock" class="w-3 h-3 inline-block mr-1"></i>
                                                    {{ entry.changed_at|date:"M d, Y" }} at {{ entry.changed_at|time:"H:i" }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% else %}
                        <div class="text-center py-12">
                            <i data-lucide="history" class="w-12 h-12 text-gray-200 mx-auto mb-4"></i>
                            <p class="text-gray-500 font-medium">No changes recorded yet.</p>
                            <p class="text-xs text-gray-400 mt-1">Changes will be logged automatically when you edit and save this product.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Success/Error Toast (Optional) -->
{% if messages %}
<div class="fixed bottom-8 right-8 z-50 space-y-3">
    {% for message in messages %}
    <div
        class="flex items-center gap-3 px-4 py-3 rounded-xl shadow-2xl border {% if message.tags == 'success' %}bg-green-900 border-green-800 text-white{% else %}bg-red-900 border-red-800 text-white{% endif %} animate-bounce">
        <i data-lucide="{% if message.tags == 'success' %}check-circle{% else %}alert-circle{% endif %}"
            class="w-5 h-5"></i>
        <p class="text-sm font-bold">{{ message }}</p>
    </div>
    {% endfor %}
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/product-api-handler.js' %}?v=20260128001"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        lucide.createIcons();

        // --- TAB SYSTEM (FIRST - this must work regardless of API) ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const nextTabInput = document.getElementById('next_tab_input');

        function switchTab(tabId) {
            console.log('Switching to tab:', tabId);
            tabButtons.forEach(btn => {
                if (btn.dataset.tab === tabId) {
                    btn.classList.add('active', 'border-black', 'text-black');
                    btn.classList.remove('border-transparent', 'text-gray-500');
                } else {
                    btn.classList.remove('active', 'border-black', 'text-black');
                    btn.classList.add('border-transparent', 'text-gray-500');
                }
            });

            tabContents.forEach(content => {
                if (content.dataset.content === tabId) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });

            // Update URL for deep linking
            const url = new URL(window.location);
            url.searchParams.set('tab', tabId);
            window.history.pushState({}, '', url);

            lucide.createIcons();
        }

        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                console.log('Tab button clicked:', btn.dataset.tab);
                switchTab(btn.dataset.tab);
            });
        });

        // Handle initial tab from URL
        const urlParams = new URLSearchParams(window.location.search);
        const initialTab = urlParams.get('tab');
        if (initialTab) switchTab(initialTab);

        // === API HANDLER INITIALIZATION (wrapped in try-catch) ===
        let apiHandler = null;
        try {
            if (typeof ProductAPIHandler !== 'undefined') {
                const productId = document.getElementById('productForm').dataset.productId;
                apiHandler = new ProductAPIHandler(productId);

                apiHandler.initializeFormHandlers({
                    onSaveDraft: () => {
                        console.log('Draft saved via API');
                    },
                    onPublish: () => {
                        apiHandler.showNotification('Product published successfully!', 'success');
                        setTimeout(() => {
                            window.location.href = '{% url "production_catalog" %}';
                        }, 2000);
                    },
                    onImageUpload: (result) => {
                        // Reload image preview
                        const primaryImagePreview = document.getElementById('primary-image-preview');
                        if (primaryImagePreview && result.image) {
                            primaryImagePreview.src = result.image;
                        }
                    },
                    onGalleryUpload: (result) => {
                        // DO NOT reload - keep form intact
                        // Just show a success message
                        console.log('Gallery images uploaded successfully');
                    },
                    onVideoAdd: (result) => {
                        // DO NOT reload - keep form intact
                        // Just show a success message
                        console.log('Video added successfully');
                    }
                });

                // Setup auto-save only for editing existing products
                // Auto-save is disabled for new product creation to prevent draft spam
                {% if product %}
                apiHandler.setupAutoSave(30000);
                {% endif %}
                console.log('API Handler initialized successfully');
            } else {
                console.warn('ProductAPIHandler class not found - API functionality disabled');
            }
        } catch (e) {
            console.error('Failed to initialize API Handler:', e);
        }

        // --- PRICING LOGIC ---
        const customizationRadios = document.querySelectorAll('input[name="customization_level"]');
        const tierSection = document.getElementById('tier-process-section');
        const formulaSection = document.getElementById('formula-process-section');
        const baseCostSection = document.getElementById('base-cost-section');

        function updatePricingUI() {
            const level = document.querySelector('input[name="customization_level"]:checked').value;

            if (level === 'non_customizable') {
                tierSection.classList.remove('hidden');
                formulaSection.classList.add('hidden');
                baseCostSection.classList.remove('hidden');
            } else if (level === 'semi_customizable') {
                tierSection.classList.remove('hidden');
                formulaSection.classList.remove('hidden');
                baseCostSection.classList.remove('hidden');
            } else {
                tierSection.classList.add('hidden');
                formulaSection.classList.remove('hidden');
                baseCostSection.classList.remove('hidden');
            }
        }

        customizationRadios.forEach(radio => radio.addEventListener('change', updatePricingUI));
        
        // Function to update base_price field visibility and requirements
        function updateBasePriceField() {
            const selectedLevel = document.querySelector('input[name="customization_level"]:checked')?.value || 'non_customizable';
            const basePriceSection = document.getElementById('base-price-section');
            const basePriceInput = document.getElementById('id_base_price');
            const basePriceRequired = document.getElementById('base-price-required');
            const basePriceOptional = document.getElementById('base-price-optional');
            const helpNon = document.getElementById('base-price-help-non');
            const helpSemi = document.getElementById('base-price-help-semi');
            const helpFull = document.getElementById('base-price-help-full');
            
            if (basePriceSection) {
                if (selectedLevel === 'fully_customizable') {
                    // Hide base_price for fully customizable
                    basePriceSection.style.display = 'none';
                    if (basePriceInput) basePriceInput.value = '';
                } else {
                    // Show base_price for non and semi
                    basePriceSection.style.display = 'block';
                    basePriceRequired.style.display = 'inline';
                    basePriceOptional.style.display = 'none';
                    
                    if (selectedLevel === 'non_customizable') {
                        if (helpNon) helpNon.style.display = 'inline';
                        if (helpSemi) helpSemi.style.display = 'none';
                        if (helpFull) helpFull.style.display = 'none';
                    } else if (selectedLevel === 'semi_customizable') {
                        if (helpNon) helpNon.style.display = 'none';
                        if (helpSemi) helpSemi.style.display = 'inline';
                        if (helpFull) helpFull.style.display = 'none';
                    }
                }
            }
        }
        
        // Update on page load
        updateBasePriceField();
        
        // Update when customization level changes
        customizationRadios.forEach(radio => {
            radio.addEventListener('change', updateBasePriceField);
        });
        updatePricingUI();


        // --- TIER PREVIEW ---
        const tierSelect = document.getElementById('id_tier_process');
        const tierPreview = document.getElementById('tier-preview-container');
        const tierBody = document.getElementById('tier-preview-body');

        tierSelect.addEventListener('change', function () {
            const processId = this.value;
            if (!processId) {
                tierPreview.classList.add('hidden');
                return;
            }

            fetch(`/ajax/process/${processId}/tiers/`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        tierBody.innerHTML = data.tiers.map(t => `
                            <tr>
                                <td class="px-3 py-2 text-xs text-gray-600">${t.quantity_from} - ${t.quantity_to || '∞'}</td>
                                <td class="px-3 py-2 text-xs text-right text-gray-600">KES ${t.cost.toFixed(2)}</td>
                                <td class="px-3 py-2 text-xs text-right font-bold text-gray-900">KES ${t.price.toFixed(2)}</td>
                            </tr>
                        `).join('');
                        tierPreview.classList.remove('hidden');
                    }
                });
        });
        if (tierSelect.value) tierSelect.dispatchEvent(new Event('change'));


        // --- FORMULA & CALCULATOR ---
        const formulaSelect = document.getElementById('id_formula_process');
        const formulaPreview = document.getElementById('formula-variables-preview');
        const variablesList = document.getElementById('variables-list');
        const testGrid = document.getElementById('test-variables-grid');
        const testQuantity = document.getElementById('test-quantity');

        let testVariables = {};

        formulaSelect.addEventListener('change', function () {
            const processId = this.value;
            if (!processId) {
                formulaPreview.classList.add('hidden');
                testGrid.innerHTML = '';
                return;
            }

            fetch(`/ajax/process/${processId}/variables/`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        // Update preview list
                        variablesList.innerHTML = data.variables.map(v => `
                            <li class="flex justify-between text-xs">
                                <span class="text-gray-500">${v.name}</span>
                                <span class="font-bold text-gray-700">${v.type}</span>
                            </li>
                        `).join('');
                        formulaPreview.classList.remove('hidden');

                        // Build test inputs
                        testVariables = {};
                        testGrid.innerHTML = data.variables.map(v => {
                            testVariables[v.name] = v.default_value || '';
                            const inputType = v.type === 'number' ? 'number' : 'text';
                            return `
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">${v.name}</label>
                                    <input type="${inputType}" data-var="${v.name}" value="${v.default_value || ''}"
                                        class="test-var-input w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm text-white outline-none focus:border-blue-500">
                                </div>
                            `;
                        }).join('');

                        // Add listeners to new inputs
                        document.querySelectorAll('.test-var-input').forEach(input => {
                            input.addEventListener('input', (e) => {
                                testVariables[e.target.dataset.var] = e.target.value;
                                calculatePricing();
                            });
                        });

                        calculatePricing();
                    }
                });
        });

        function calculatePricing() {
            const processId = formulaSelect.value;
            const customizationLevel = document.querySelector('input[name="customization_level"]:checked').value;
            const quantity = parseFloat(testQuantity.value) || 1;
            const margin = parseFloat(document.getElementById('id_return_margin').value) || 30;
            const costDisplay = document.getElementById('calculated-cost-display');
            const priceDisplay = document.getElementById('calculated-price-display');
            const breakdownDisplay = document.getElementById('price-breakdown');

            // Non-customizable: base cost logic
            if (customizationLevel === 'non_customizable' || !processId) {
                // Grab base cost from visible form field
                const baseCost = parseFloat(document.getElementById('id_base_cost')?.value || 15);
                const cost = baseCost * quantity;
                const price = cost * (1 + (margin / 100));
                costDisplay.textContent = `KES ${cost.toLocaleString()}`;
                priceDisplay.textContent = `KES ${price.toLocaleString()}`;
                breakdownDisplay.innerHTML = `<div class='flex justify-between'><span>Base Cost</span><span>Base × Qty = KES ${baseCost} × ${quantity} = KES ${cost.toLocaleString()}</span></div>`;
                return;
            }

            // Formula-based using process
            fetch(`/ajax/process/${processId}/calculate/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    variables: testVariables,
                    quantity: parseInt(quantity)
                })
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const cost = data.total_cost;
                        const price = cost * (1 + (margin / 100));
                        costDisplay.textContent = `KES ${cost.toLocaleString()}`;
                        priceDisplay.textContent = `KES ${price.toLocaleString()}`;
                        breakdownDisplay.innerHTML = data.breakdown.map(b => `
                        <div class="flex justify-between">
                            <span>${b.component}</span>
                            <span>${b.calculation} = KES ${b.amount.toLocaleString()}</span>
                        </div>
                    `).join('');
                    }
                });
        }

        testQuantity.addEventListener('input', calculatePricing);
        document.getElementById('id_return_margin').addEventListener('input', calculatePricing);

        if (formulaSelect.value) formulaSelect.dispatchEvent(new Event('change'));

        // ===== IMAGES & MEDIA TAB FUNCTIONALITY =====
        const primaryImageInput = document.getElementById('primary_image_input');
        const primaryImageContainer = document.getElementById('primary-image-container');
        const galleryImagesInput = document.getElementById('gallery_images_input');
        const galleryContainer = document.getElementById('gallery-images-container');

        // Primary image upload
        if (primaryImageContainer && primaryImageInput) {
            primaryImageContainer.addEventListener('click', () => {
                primaryImageInput.click();
            });

            primaryImageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 2 * 1024 * 1024) {
                        alert('Image size must be less than 2MB');
                        return;
                    }
                    if (!file.type.startsWith('image/')) {
                        alert('Please select an image file');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        if (primaryImageContainer) {
                            primaryImageContainer.innerHTML = `
                                <img src="${e.target.result}" class="w-full h-full object-cover rounded-xl">
                                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center rounded-xl">
                                    <span class="text-white text-sm font-semibold px-3 py-1 bg-black/60 rounded">Change Image</span>
                                </div>
                            `;
                            lucide.createIcons();
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Gallery images upload
        if (galleryImagesInput && galleryContainer) {
            galleryImagesInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                const maxImages = 10;
                const currentImages = galleryContainer.querySelectorAll('.gallery-image-item').length - 1;
                
                if (currentImages + files.length > maxImages) {
                    alert(`You can only upload up to ${maxImages} additional images.`);
                    return;
                }

                files.forEach(file => {
                    if (file.size > 2 * 1024 * 1024) {
                        alert(`${file.name} is too large (max 2MB)`);
                        return;
                    }
                    if (!file.type.startsWith('image/')) {
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageDiv = document.createElement('div');
                        imageDiv.className = 'gallery-image-item aspect-square rounded-lg border border-gray-200 overflow-hidden relative group';
                        imageDiv.innerHTML = `
                            <img src="${e.target.result}" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                <button type="button" class="remove-gallery-preview p-2 bg-red-500 text-white rounded-md hover:bg-red-600">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        `;
                        
                        const addButton = galleryContainer.querySelector('.border-dashed');
                        if (addButton) {
                            galleryContainer.insertBefore(imageDiv, addButton);
                        }
                        lucide.createIcons();
                        
                        imageDiv.querySelector('.remove-gallery-preview')?.addEventListener('click', () => {
                            imageDiv.remove();
                        });
                    };
                    reader.readAsDataURL(file);
                });
                
                // NOTE: Do NOT clear the file input - we need the files to persist for form submission
            });
        }

        // Delete existing gallery images
        document.querySelectorAll('.delete-gallery-image').forEach(btn => {
            btn.addEventListener('click', function() {
                const imageId = this.dataset.imageId;
                if (confirm('Delete this image?')) {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'delete_images[]';
                    hiddenInput.value = imageId;
                    document.getElementById('productForm').appendChild(hiddenInput);
                    this.closest('.gallery-image-item').remove();
                }
            });
        });

        // ========== AUTO-SAVE & UNSAVED CHANGES FUNCTIONALITY ==========
        const form = document.getElementById('productForm');
        const unsavedIndicator = document.getElementById('unsavedIndicator');
        const autoSaveStatus = document.getElementById('autoSaveStatus');
        const autoSaveBtn = document.getElementById('autoSaveBtn');
        const currentProductId = form.dataset.productId;

        let hasUnsavedChanges = false;
        let autoSaveTimeout = null;
        let initialFormState = null;

        // Intercept form submission to inject stored gallery files
        form.addEventListener('submit', function(e) {
            // Only modify if we have files to submit
            if (galleryFilesToSubmit && galleryFilesToSubmit.length > 0) {
                // Create a new FormData from the form
                const formData = new FormData(form);
                
                // Remove any existing gallery_images entries
                formData.delete('gallery_images');
                
                // Add all stored gallery files
                galleryFilesToSubmit.forEach((file) => {
                    formData.append('gallery_images', file, file.name);
                });
                
                // Clear the form's current file input
                const fileInput = form.querySelector('input[name="gallery_images"]');
                if (fileInput) {
                    fileInput.value = '';
                }
                
                // Replace form submission with FormData submission
                // Note: Regular form submission will include FormData, so we let it proceed
                // The key is that we've already deleted and re-added the files to FormData
            }
        });

        // Store initial form state
        function storeInitialState() {
            initialFormState = new FormData(form);
        }

        // Check if form has changes
        function hasFormChanged() {
            if (!initialFormState) return false;
            
            const currentFormData = new FormData(form);
            const initialKeys = Array.from(initialFormState.keys());
            const currentKeys = Array.from(currentFormData.keys());

            if (initialKeys.length !== currentKeys.length) return true;

            for (let key of initialKeys) {
                const initialValue = initialFormState.get(key);
                const currentValue = currentFormData.get(key);
                if (initialValue !== currentValue) return true;
            }

            return false;
        }

        // Show unsaved changes indicator
        function showUnsavedIndicator() {
            hasUnsavedChanges = true;
            unsavedIndicator.classList.remove('hidden');
        }

        // Hide unsaved changes indicator
        function hideUnsavedIndicator() {
            hasUnsavedChanges = false;
            unsavedIndicator.classList.add('hidden');
        }

        // Show auto-save status
        function showAutoSaveStatus() {
            const now = new Date();
            const time = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('lastSaveTime').textContent = time;
            
            autoSaveStatus.classList.remove('opacity-0');
            autoSaveStatus.classList.add('opacity-100');

            setTimeout(() => {
                autoSaveStatus.classList.add('opacity-0');
                autoSaveStatus.classList.remove('opacity-100');
            }, 3000);
        }

        // Auto-save function
        async function autoSaveProduct() {
            if (!hasUnsavedChanges) return;

            try {
                const formData = new FormData(form);
                formData.set('action', 'auto_save');

                // Determine which endpoint to use based on whether product exists
                let url;
                if (currentProductId === 'new' || !currentProductId) {
                    url = '/production/products/create/';  // CORRECTED URL
                } else {
                    url = `/production/products/${currentProductId}/edit/`;  // CORRECTED URL
                }

                const response = await fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // If this was a new product auto-save, update the product ID
                    if (data.product_id && (currentProductId === 'new' || !currentProductId)) {
                        form.dataset.productId = data.product_id;
                        window.currentProductId = data.product_id;
                        
                        // CRITICAL: Update API handler's productId so publish works
                        if (typeof apiHandler !== 'undefined' && apiHandler) {
                            apiHandler.productId = data.product_id;
                        }
                    }
                    
                    hideUnsavedIndicator();
                    showAutoSaveStatus();
                    storeInitialState();
                } else {
                    console.error('Auto-save failed:', response.statusText);
                }
            } catch (error) {
                console.error('Auto-save error:', error);
            }
        }

        // Real-time field validation
        function validateField(field) {
            const fieldName = field.name;
            const fieldValue = field.value.trim();
            let isValid = true;
            let errorMessage = '';

            // Remove existing error message
            const existingError = field.parentElement.querySelector('.field-error');
            if (existingError) {
                existingError.remove();
            }

            // Validation rules
            switch (fieldName) {
                case 'name':
                    if (!fieldValue) {
                        isValid = false;
                        errorMessage = 'Product name is required';
                    } else if (fieldValue.length < 3) {
                        isValid = false;
                        errorMessage = 'Product name must be at least 3 characters';
                    } else if (fieldValue.length > 255) {
                        isValid = false;
                        errorMessage = 'Product name cannot exceed 255 characters';
                    }
                    break;

                case 'short_description':
                    if (!fieldValue) {
                        isValid = false;
                        errorMessage = 'Short description is required';
                    } else if (fieldValue.length > 150) {
                        isValid = false;
                        errorMessage = 'Short description cannot exceed 150 characters';
                    }
                    break;

                case 'long_description':
                    if (!fieldValue) {
                        isValid = false;
                        errorMessage = 'Long description is required';
                    }
                    break;

                case 'base_price':
                    if (fieldValue && isNaN(parseFloat(fieldValue))) {
                        isValid = false;
                        errorMessage = 'Base price must be a valid number';
                    }
                    break;

                case 'weight':
                case 'length':
                case 'width':
                case 'height':
                    if (fieldValue && isNaN(parseFloat(fieldValue))) {
                        isValid = false;
                        errorMessage = `${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)} must be a valid number`;
                    }
                    break;
            }

            // Show/hide error
            if (!isValid) {
                field.classList.add('border-red-500', 'focus:ring-red-500');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'field-error text-xs text-red-600 mt-1';
                errorDiv.textContent = errorMessage;
                field.parentElement.appendChild(errorDiv);
            } else {
                field.classList.remove('border-red-500', 'focus:ring-red-500');
            }

            return isValid;
        }

        // Attach change listeners to all form fields
        form.querySelectorAll('input, select, textarea').forEach(field => {
            // Skip hidden fields and file inputs (don't trigger unsaved warning for image uploads)
            if (field.type === 'hidden' || field.type === 'file') return;

            field.addEventListener('change', () => {
                if (hasFormChanged()) {
                    showUnsavedIndicator();
                    
                    // Clear existing auto-save timeout
                    if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
                    
                    // Set new auto-save timeout (30 seconds)
                    autoSaveTimeout = setTimeout(autoSaveProduct, 30000);
                }
            });

            field.addEventListener('blur', () => {
                if (field.type !== 'hidden' && field.name) {
                    validateField(field);
                }
            });

            // Character counter for text fields
            if (field.type === 'text' || field.tagName === 'TEXTAREA') {
                field.addEventListener('input', () => {
                    const maxLength = field.maxLength;
                    if (maxLength && maxLength > 0) {
                        const charCount = field.value.length;
                        let counter = field.parentElement.querySelector('.char-count');
                        if (!counter) {
                            counter = document.createElement('div');
                            counter.className = 'char-count text-xs text-gray-500 mt-1';
                            field.parentElement.appendChild(counter);
                        }
                        counter.textContent = `${charCount}/${maxLength} characters`;
                        if (charCount >= maxLength * 0.8) {
                            counter.classList.add('limit');
                        } else {
                            counter.classList.remove('limit');
                        }
                    }
                });
            }
        });

        // Manual save button
        autoSaveBtn.addEventListener('click', (e) => {
            e.preventDefault();
            autoSaveProduct();
        });

        // Track if form is being intentionally submitted
        let isFormSubmitting = false;

        // Clear unsaved changes flag when form is submitted (publish, save draft, etc)
        // This prevents the "Changes you made may not be saved" warning when intentionally submitting
        const submitButtons = form.querySelectorAll('button[type="submit"]');
        submitButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                // Mark that form is being intentionally submitted
                isFormSubmitting = true;
                // Clear the unsaved changes flag so beforeunload won't warn
                hasUnsavedChanges = false;
                hideUnsavedIndicator();
            });
        });

        // Warn about unsaved changes ONLY when leaving page without submitting
        // Do NOT warn if user clicked a submit button (Publish, Save Draft)
        window.addEventListener('beforeunload', (e) => {
            // Only show warning if there are unsaved changes AND form is not being submitted
            if (hasUnsavedChanges && !isFormSubmitting) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });

        // Initialize
        storeInitialState();
    });
</script>
<style>
    .tab-button.active {
        color: black !important;
        border-color: black !important;
    }

    input:focus,
    select:focus,
    textarea:focus {
        border-color: #3b82f6 !important;
    }

    .char-count {
        transition: color 0.2s;
    }

    .char-count.limit {
        color: #ef4444;
    }

    /* Hide unsaved changes indicator - using auto-save instead */
    #unsavedIndicator {
        display: none !important;
    }
</style>
{% endblock %}